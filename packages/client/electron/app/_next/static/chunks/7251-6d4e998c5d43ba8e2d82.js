(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7251],{60235:function(e,t,n){"use strict";n.d(t,{Z:function(){return xe}});var r=n(49182),i=n(39337),a=n(13987),o=n(29569),s=n(89306),l=n(64414),u=n(36595),c=n(47396),f=n(483),d=n(34452),h=n(88203),p=n(86463),v=n(16090),m=n(17356),y=n(67200),g=n(52020),x=n(95812),A=function e(){(0,r.Z)(this,e),this.assets=new Map,this.assetsLoaded=!1};A.instance=new A;var T=n(88334),S=n(60773),E=n(65648),P=n(52288);function _(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,s.Z)(e);if(t){var i=(0,s.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,o.Z)(this,n)}}var w=function(e){(0,a.Z)(n,e);var t=_(n);function n(){return(0,r.Z)(this,n),t.apply(this,arguments)}return n}(E.w);function F(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,s.Z)(e);if(t){var i=(0,s.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,o.Z)(this,n)}}w._schema={value:{default:null,type:P.Yk.Ref}};var b=function(e){(0,a.Z)(n,e);var t=F(n);function n(){return(0,r.Z)(this,n),t.apply(this,arguments)}return n}(E.w),D=n(60645);function R(e){return(R="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"===typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function N(e,t,n){var r=n.value;if("function"!==typeof r)throw new TypeError("@boundMethod decorator can only be applied to methods not: ".concat(R(r)));var i=!1;return{configurable:!0,get:function(){if(i||this===e.prototype||this.hasOwnProperty(t)||"function"!==typeof r)return r;var n=r.bind(this);return i=!0,Object.defineProperty(this,t,{configurable:!0,get:function(){return n},set:function(e){r=e,delete this[t]}}),i=!1,n},set:function(e){r=e}}}function L(e){var t;return"undefined"!==typeof Reflect&&"function"===typeof Reflect.ownKeys?t=Reflect.ownKeys(e.prototype):(t=Object.getOwnPropertyNames(e.prototype),"function"===typeof Object.getOwnPropertySymbols&&(t=t.concat(Object.getOwnPropertySymbols(e.prototype)))),t.forEach((function(t){if("constructor"!==t){var n=Object.getOwnPropertyDescriptor(e.prototype,t);"function"===typeof n.value&&Object.defineProperty(e.prototype,t,N(e,t,n))}})),e}function I(){return 1===arguments.length?L.apply(void 0,arguments):N.apply(void 0,arguments)}var k=function(e,t,n,r){var i,a=arguments.length,o=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(o=(a<3?i(o):a>3?i(t,n,o):i(t,n))||o);return a>3&&o&&Object.defineProperty(t,n,o),o},M=function(){function e(){(0,r.Z)(this,e),this.manager=void 0!==this.manager?this.manager:u.tEQ}return(0,i.Z)(e,[{key:"load",value:function(e,t,n,r){var i=this,a=new u.xEZ,o=new u.hH6(this.manager);return o.setResponseType("arraybuffer"),o.setPath(this.path),o.load(e,(function(e){a.image=i.parse(e),a.needsUpdate=!0,void 0!==t&&t(a)}),n,r),a}},{key:"parse",value:function(e){var t=0,n=1,r=2,i=3,a=9,o=10,s=11,l=48,u=4,c=0,f=1,d=2,h=3;e.length<19&&console.error("TGALoader: Not enough data to contain header.");var p=new Uint8Array(e),v=0,m={id_length:p[v++],colormap_type:p[v++],image_type:p[v++],colormap_index:p[v++]|p[v++]<<8,colormap_length:p[v++]|p[v++]<<8,colormap_size:p[v++],origin:[p[v++]|p[v++]<<8,p[v++]|p[v++]<<8],width:p[v++]|p[v++]<<8,height:p[v++]|p[v++]<<8,pixel_size:p[v++],flags:p[v++]};!function(e){switch(e.image_type){case n:case a:(e.colormap_length>256||24!==e.colormap_size||1!==e.colormap_type)&&console.error("TGALoader: Invalid type colormap data for indexed type.");break;case r:case i:case o:case s:e.colormap_type&&console.error("TGALoader: Invalid type colormap data for colormap type.");break;case t:console.error("TGALoader: No data.");default:console.error('TGALoader: Invalid type "%s".',e.image_type)}(e.width<=0||e.height<=0)&&console.error("TGALoader: Invalid image size."),8!==e.pixel_size&&16!==e.pixel_size&&24!==e.pixel_size&&32!==e.pixel_size&&console.error('TGALoader: Invalid pixel size "%s".',e.pixel_size)}(m),m.id_length+v>e.length&&console.error("TGALoader: No data."),v+=m.id_length;var y=!1,g=!1,x=!1;switch(m.image_type){case a:y=!0,g=!0;break;case n:g=!0;break;case o:y=!0;break;case r:break;case s:y=!0,x=!0;break;case i:x=!0}var A="undefined"!==typeof OffscreenCanvas,T=A?new OffscreenCanvas(m.width,m.height):document.createElement("canvas");T.width=m.width,T.height=m.height;var S=T.getContext("2d"),E=S.createImageData(m.width,m.height),P=function(e,t,n,r,i){var a,o,s=n.pixel_size>>3,l=n.width*n.height*s;if(t&&(o=i.subarray(r,r+=n.colormap_length*(n.colormap_size>>3))),e){var u,c,f;a=new Uint8Array(l);for(var d=0,h=new Uint8Array(s);d<l;)if(c=1+(127&(u=i[r++])),128&u){for(f=0;f<s;++f)h[f]=i[r++];for(f=0;f<c;++f)a.set(h,d+f*s);d+=s*c}else{for(c*=s,f=0;f<c;++f)a[d+f]=i[r++];d+=c}}else a=i.subarray(r,r+=t?n.width*n.height:l);return{pixel_data:a,palettes:o}}(y,g,m,v,p);!function(e,t,n,r,i){var a,o,s,p,v,y;switch((m.flags&l)>>u){default:case d:a=0,s=1,v=t,o=0,p=1,y=n;break;case c:a=0,s=1,v=t,o=n-1,p=-1,y=-1;break;case h:a=t-1,s=-1,v=-1,o=0,p=1,y=n;break;case f:a=t-1,s=-1,v=-1,o=n-1,p=-1,y=-1}if(x)switch(m.pixel_size){case 8:!function(e,t,n,r,i,a,o,s){var l,u,c,f=0,d=m.width;for(c=t;c!==r;c+=n)for(u=i;u!==o;u+=a,f++)l=s[f],e[4*(u+d*c)+0]=l,e[4*(u+d*c)+1]=l,e[4*(u+d*c)+2]=l,e[4*(u+d*c)+3]=255}(e,o,p,y,a,s,v,r);break;case 16:!function(e,t,n,r,i,a,o,s){var l,u,c=0,f=m.width;for(u=t;u!==r;u+=n)for(l=i;l!==o;l+=a,c+=2)e[4*(l+f*u)+0]=s[c+0],e[4*(l+f*u)+1]=s[c+0],e[4*(l+f*u)+2]=s[c+0],e[4*(l+f*u)+3]=s[c+1]}(e,o,p,y,a,s,v,r);break;default:console.error("TGALoader: Format not supported.")}else switch(m.pixel_size){case 8:!function(e,t,n,r,i,a,o,s,l){var u,c,f,d=l,h=0,p=m.width;for(f=t;f!==r;f+=n)for(c=i;c!==o;c+=a,h++)u=s[h],e[4*(c+p*f)+3]=255,e[4*(c+p*f)+2]=d[3*u+0],e[4*(c+p*f)+1]=d[3*u+1],e[4*(c+p*f)+0]=d[3*u+2]}(e,o,p,y,a,s,v,r,i);break;case 16:!function(e,t,n,r,i,a,o,s){var l,u,c,f=0,d=m.width;for(c=t;c!==r;c+=n)for(u=i;u!==o;u+=a,f+=2)l=s[f+0]+(s[f+1]<<8),e[4*(u+d*c)+0]=(31744&l)>>7,e[4*(u+d*c)+1]=(992&l)>>2,e[4*(u+d*c)+2]=(31&l)>>3,e[4*(u+d*c)+3]=32768&l?0:255}(e,o,p,y,a,s,v,r);break;case 24:!function(e,t,n,r,i,a,o,s){var l,u,c=0,f=m.width;for(u=t;u!==r;u+=n)for(l=i;l!==o;l+=a,c+=3)e[4*(l+f*u)+3]=255,e[4*(l+f*u)+2]=s[c+0],e[4*(l+f*u)+1]=s[c+1],e[4*(l+f*u)+0]=s[c+2]}(e,o,p,y,a,s,v,r);break;case 32:!function(e,t,n,r,i,a,o,s){var l,u,c=0,f=m.width;for(u=t;u!==r;u+=n)for(l=i;l!==o;l+=a,c+=4)e[4*(l+f*u)+2]=s[c+0],e[4*(l+f*u)+1]=s[c+1],e[4*(l+f*u)+0]=s[c+2],e[4*(l+f*u)+3]=s[c+3]}(e,o,p,y,a,s,v,r);break;default:console.error("TGALoader: Format not supported.")}}(E.data,m.width,m.height,P.pixel_data,P.palettes);return S.putImageData(E,0,0),A?T.transferToImageBitmap():T}},{key:"setPath",value:function(e){return this.path=e,this}}]),e}();function O(e,t,n){var r=n.length-e-1;if(t>=n[r])return r-1;if(t<=n[e])return e;for(var i=e,a=r,o=Math.floor((i+a)/2);t<n[o]||t>=n[o+1];)t<n[o]?a=o:i=o,o=Math.floor((i+a)/2);return o}function C(e,t,n,r){var i=[],a=[],o=[];i[0]=1;for(var s=1;s<=n;++s){a[s]=t-r[e+1-s],o[s]=r[e+s]-t;for(var l=0,u=0;u<s;++u){var c=o[u+1],f=a[s-u],d=i[u]/(c+f);i[u]=l+c*d,l=f*d}i[s]=l}return i}function U(e,t){for(var n=1,r=2;r<=e;++r)n*=r;for(var i=1,a=2;a<=t;++a)i*=a;for(var o=2;o<=e-t;++o)i*=o;return n/i}function B(e,t,n,r,i){return function(e){for(var t=e.length,n=[],r=[],i=0;i<t;++i){var a=e[i];n[i]=new u.Pa4(a.x,a.y,a.z),r[i]=a.w}for(var o=[],s=0;s<t;++s){for(var l=n[s].clone(),c=1;c<=s;++c)l.sub(o[s-c].clone().multiplyScalar(U(s,c)*r[c]));o[s]=l.divideScalar(r[0])}return o}(function(e,t,n,r,i){for(var a=i<e?i:e,o=[],s=O(e,r,t),l=function(e,t,n,r,i){for(var a=[],o=0;o<=n;++o)a[o]=0;for(var s=[],l=0;l<=r;++l)s[l]=a.slice(0);for(var u=[],c=0;c<=n;++c)u[c]=a.slice(0);u[0][0]=1;for(var f=a.slice(0),d=a.slice(0),h=1;h<=n;++h){f[h]=t-i[e+1-h],d[h]=i[e+h]-t;for(var p=0,v=0;v<h;++v){var m=d[v+1],y=f[h-v];u[h][v]=m+y;var g=u[v][h-1]/u[h][v];u[v][h]=p+m*g,p=y*g}u[h][h]=p}for(var x=0;x<=n;++x)s[0][x]=u[x][n];for(var A=0;A<=n;++A){for(var T=0,S=1,E=[],P=0;P<=n;++P)E[P]=a.slice(0);E[0][0]=1;for(var _=1;_<=r;++_){var w=0,F=A-_,b=n-_;A>=_&&(E[S][0]=E[T][0]/u[b+1][F],w=E[S][0]*u[F][b]);for(var D=A-1<=b?_-1:n-A,R=F>=-1?1:-F;R<=D;++R)E[S][R]=(E[T][R]-E[T][R-1])/u[b+1][F+R],w+=E[S][R]*u[F+R][b];A<=b&&(E[S][_]=-E[T][_-1]/u[b+1][A],w+=E[S][_]*u[A][b]),s[_][A]=w;var N=T;T=S,S=N}}for(var L=n,I=1;I<=r;++I){for(var k=0;k<=n;++k)s[I][k]*=L;L*=n-I}return s}(s,r,e,a,t),c=[],f=0;f<n.length;++f){var d=n[f].clone(),h=d.w;d.x*=h,d.y*=h,d.z*=h,c[f]=d}for(var p=0;p<=a;++p){for(var v=c[s-e].clone().multiplyScalar(l[p][0]),m=1;m<=e;++m)v.add(c[s-e+m].clone().multiplyScalar(l[p][m]));o[p]=v}for(var y=a+1;y<=i+1;++y)o[y]=new u.Ltg(0,0,0);return o}(e,t,n,r,i))}function X(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,s.Z)(e);if(t){var i=(0,s.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,o.Z)(this,n)}}M=k([I],M);var Z,z=function(e){(0,a.Z)(n,e);var t=X(n);function n(e,i,a,o,s){var l;(0,r.Z)(this,n),(l=t.call(this)).degree=e,l.knots=i,l.controlPoints=[],l.startKnot=o||0,l.endKnot=s||l.knots.length-1;for(var c=0;c<a.length;++c){var f=a[c];l.controlPoints[c]=new u.Ltg(f.x,f.y,f.z,f.w)}return l}return(0,i.Z)(n,[{key:"getPoint",value:function(e,t){var n=t||new u.Pa4,r=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),i=function(e,t,n,r){for(var i=O(e,r,t),a=C(i,r,e,t),o=new u.Ltg(0,0,0,0),s=0;s<=e;++s){var l=n[i-e+s],c=a[s],f=l.w*c;o.x+=l.x*f,o.y+=l.y*f,o.z+=l.z*f,o.w+=l.w*c}return o}(this.degree,this.knots,this.controlPoints,r);return 1!=i.w&&i.divideScalar(i.w),n.set(i.x,i.y,i.z)}},{key:"getTangent",value:function(e,t){var n=t||new u.Pa4,r=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),i=B(this.degree,this.knots,this.controlPoints,r,1);return n.copy(i[1]).normalize(),n}}]),n}(u.Hyl),G=function(e,t,n,r){var i,a=arguments.length,o=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(o=(a<3?i(o):a>3?i(t,n,o):i(t,n))||o);return a>3&&o&&Object.defineProperty(t,n,o),o},Y=Z=function(){function e(t){(0,r.Z)(this,e),this.manager=t||u.tEQ}return(0,i.Z)(e,[{key:"load",value:function(e,t,n,r){var i=this,a=e.split("/").pop();Z.serverUrl=e.split(a)[0];var o=new u.hH6(this.manager);o.setPath(""),o.setResponseType("arraybuffer"),o.load(e,(function(n){try{t(i.parse(n,""))}catch(a){setTimeout((function(){r&&r(a),i.manager.itemError(e),console.log("load error")}),0)}}),n,r)}},{key:"setPath",value:function(e){return this.path=e,this}},{key:"setResourcePath",value:function(e){return this.resourcePath=e,this}},{key:"setCrossOrigin",value:function(e){return this.crossOrigin=e,this}},{key:"parse",value:function(e,t){if(function(e){var t="Kaydara FBX Binary  \0";return e.byteLength>=t.length&&t===se(e,0,t.length)}(e))Z.fbxTree=(new j).parse(e);else{var n=se(e);if(!function(e){var t=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"],n=0;function r(t){var r=e[t-1];return e=e.slice(n+t),n++,r}for(var i=0;i<t.length;++i){if(r(1)===t[i])return!1}return!0}(n))throw new Error("FBXLoader: Unknown format.");if($(n)<7e3)throw new Error("FBXLoader: FBX version not supported, FileVersion: "+$(n));Z.fbxTree=(new W).parse(n)}var r=new u.dpR(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new Q(r).parse(Z.fbxTree)}}]),e}();Y=Z=G([I],Y);var Q=function(){function e(t){(0,r.Z)(this,e),this.textureLoader=t}return(0,i.Z)(e,[{key:"parse",value:function(e){Y.connections=this.parseConnections();var t=this.parseImages(),n=this.parseTextures(t),r=this.parseMaterials(n),i=this.parseDeformers(),a=(new H).parse(i);return this.parseScene(i,a,r),Y.sceneGraph}},{key:"parseConnections",value:function(){var e=new Map;"Connections"in Y.fbxTree&&Y.fbxTree.Connections.connections.forEach((function(t){var n=t[0],r=t[1],i=t[2];e.has(n)||e.set(n,{parents:[],children:[]});var a={ID:r,relationship:i};e.get(n).parents.push(a),e.has(r)||e.set(r,{parents:[],children:[]});var o={ID:n,relationship:i};e.get(r).children.push(o)}));return e}},{key:"parseImages",value:function(){var e={},t={};if("Video"in Y.fbxTree.Objects){var n=Y.fbxTree.Objects.Video;for(var r in n){var i=n[r],a=parseInt(r),o=i.RelativeFilename.split("\\").pop()||i.Filename.split("\\").pop();if(e[a]="".concat(Y.serverUrl).concat(o),"Content"in i){var s=i.Content instanceof ArrayBuffer&&i.Content.byteLength>0,l="string"===typeof i.Content&&""!==i.Content;if(s||l){var u=this.parseImage(n[r]);t[i.RelativeFilename||i.Filename]=u}}}}for(var c in e){var f=e[c];void 0!==t[f]?e[c]=t[f]:e[c]=e[c].split("\\").pop()}return e}},{key:"parseImage",value:function(e){var t,n=e.Content,r=e.RelativeFilename||e.Filename,i=r.slice(r.lastIndexOf(".")+1).toLowerCase();switch(i){case"bmp":t="image/bmp";break;case"jpg":case"jpeg":t="image/jpeg";break;case"png":t="image/png";break;case"tif":t="image/tiff";break;case"tga":if("function"!==typeof new M)return void console.warn("FBXLoader: TGALoader is required to load TGA textures");if(null===this.textureLoader.manager.getHandler(".tga")){var a=new M;a.setPath(this.textureLoader.path),this.textureLoader.manager.addHandler(/\.tga$/i,a)}t="image/tga";break;default:return void console.warn('FBXLoader: Image type "'+i+'" is not supported.')}if("string"===typeof n)return"data:"+t+";base64,"+n;var o=new Uint8Array(n);return window.URL.createObjectURL(new Blob([o],{type:t}))}},{key:"parseTextures",value:function(e){var t=new Map;if("Texture"in Y.fbxTree.Objects){var n=Y.fbxTree.Objects.Texture;for(var r in n){var i=this.parseTexture(n[r],e);t.set(parseInt(r),i)}}return t}},{key:"parseTexture",value:function(e,t){var n=this.loadTexture(e,t);n.ID=e.id,n.name=e.attrName;var r=e.WrapModeU,i=e.WrapModeV,a=void 0!==r?r.value:0,o=void 0!==i?i.value:0;if(n.wrapS=0===a?u.rpg:u.uWy,n.wrapT=0===o?u.rpg:u.uWy,"Scaling"in e){var s=e.Scaling.value;n.repeat.x=s[0],n.repeat.y=s[1]}return n}},{key:"loadTexture",value:function(e,t){var n,r,i=this.textureLoader.path,a=Y.connections.get(e.id).children;void 0!==a&&a.length>0&&void 0!==t[a[0].ID]&&(0!==(n=t[a[0].ID]).indexOf("blob:")&&0!==n.indexOf("data:")||this.textureLoader.setPath(void 0));var o=e.FileName.slice(-3).toLowerCase();if("tga"===o){var s=this.textureLoader.getHandler(".tga");null===s?(console.warn("FBXLoader: TGALoader not found, creating empty placeholder texture for",n),r=new u.xEZ):r=s.load(n)}else"psd"===o?(console.warn("FBXLoader: PSD textures are not supported, creating empty placeholder texture for",n),r=new u.xEZ):r=this.textureLoader.load(n);return this.textureLoader.setPath(i),r}},{key:"parseMaterials",value:function(e){var t=new Map;if("Material"in Y.fbxTree.Objects){var n=Y.fbxTree.Objects.Material;for(var r in n){var i=this.parseMaterial(n[r],e);null!==i&&t.set(parseInt(r),i)}}return t}},{key:"parseMaterial",value:function(e,t){var n=e.id,r=e.attrName,i=e.ShadingModel;if("object"===typeof i&&(i=i.value),!Y.connections.has(n))return null;var a,o=this.parseParameters(e,t,n);switch(i.toLowerCase()){case"phong":a=new u.xoR;break;case"lambert":a=new u.YBo;break;default:console.warn('FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',i),a=new u.xoR}return a.setValues(o),a.name=r,a}},{key:"parseParameters",value:function(e,t,n){var r=this,i={};return e.BumpFactor&&(i.bumpScale=e.BumpFactor.value),e.Diffuse?i.color=(new u.Ilk).fromArray(e.Diffuse.value):e.DiffuseColor&&"Color"===e.DiffuseColor.type&&(i.color=(new u.Ilk).fromArray(e.DiffuseColor.value)),e.DisplacementFactor&&(i.displacementScale=e.DisplacementFactor.value),e.Emissive?i.emissive=(new u.Ilk).fromArray(e.Emissive.value):e.EmissiveColor&&"Color"===e.EmissiveColor.type&&(i.emissive=(new u.Ilk).fromArray(e.EmissiveColor.value)),e.EmissiveFactor&&(i.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(i.opacity=parseFloat(e.Opacity.value)),i.opacity<1&&(i.transparent=!0),e.ReflectionFactor&&(i.reflectivity=e.ReflectionFactor.value),e.Shininess&&(i.shininess=e.Shininess.value),e.Specular?i.specular=(new u.Ilk).fromArray(e.Specular.value):e.SpecularColor&&"Color"===e.SpecularColor.type&&(i.specular=(new u.Ilk).fromArray(e.SpecularColor.value)),Y.connections.get(n).children.forEach((function(e){var n=e.relationship;switch(n){case"Bump":i.bumpMap=r.getTexture(t,e.ID);break;case"Maya|TEX_ao_map":i.aoMap=r.getTexture(t,e.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":i.map=r.getTexture(t,e.ID);break;case"DisplacementColor":i.displacementMap=r.getTexture(t,e.ID);break;case"EmissiveColor":i.emissiveMap=r.getTexture(t,e.ID);break;case"NormalMap":case"Maya|TEX_normal_map":i.normalMap=r.getTexture(t,e.ID);break;case"ReflectionColor":i.envMap=r.getTexture(t,e.ID),i.envMap.mapping=u.dSO;break;case"SpecularColor":i.specularMap=r.getTexture(t,e.ID);break;case"TransparentColor":i.alphaMap=r.getTexture(t,e.ID),i.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("FBXLoader: %s map is not supported in js, skipping texture.",n)}})),i}},{key:"getTexture",value:function(e,t){return"LayeredTexture"in Y.fbxTree.Objects&&t in Y.fbxTree.Objects.LayeredTexture&&(console.warn("FBXLoader: layered textures are not supported in js. Discarding all but first layer."),t=Y.connections.get(t).children[0].ID),e.get(t)}},{key:"parseDeformers",value:function(){var e={},t={};if("Deformer"in Y.fbxTree.Objects){var n=Y.fbxTree.Objects.Deformer;for(var r in n){var i=n[r],a=Y.connections.get(parseInt(r));if("Skin"===i.attrType){var o=this.parseSkeleton(a,n);o.ID=r,a.parents.length>1&&console.warn("FBXLoader: skeleton attached to more than one geometry is not supported."),o.geometryID=a.parents[0].ID,e[r]=o}else if("BlendShape"===i.attrType){var s={id:r};s.rawTargets=this.parseMorphTargets(a,n),s.id=r,a.parents.length>1&&console.warn("FBXLoader: morph target attached to more than one geometry is not supported."),t[r]=s}}}return{skeletons:e,morphTargets:t}}},{key:"parseSkeleton",value:function(e,t){var n=[];return e.children.forEach((function(e){var r=t[e.ID];if("Cluster"===r.attrType){var i={ID:e.ID,indices:[],weights:[],transformLink:(new u.yGw).fromArray(r.TransformLink.a)};"Indexes"in r&&(i.indices=r.Indexes.a,i.weights=r.Weights.a),n.push(i)}})),{rawBones:n,bones:[]}}},{key:"parseMorphTargets",value:function(e,t){for(var n=[],r=0;r<e.children.length;r++){var i=e.children[r],a=t[i.ID],o={name:a.attrName,initialWeight:a.DeformPercent,id:a.id,fullWeights:a.FullWeights.a};if("BlendShapeChannel"!==a.attrType)return;o.geoID=Y.connections.get(parseInt(i.ID)).children.filter((function(e){return void 0===e.relationship}))[0].ID,n.push(o)}return n}},{key:"parseScene",value:function(e,t,n){var r=this;Y.sceneGraph=new u.ZAu;var i=this.parseModels(e.skeletons,t,n),a=Y.fbxTree.Objects.Model;i.forEach((function(e){var t=a[e.ID];r.setLookAtProperties(e,t),Y.connections.get(e.ID).parents.forEach((function(t){var n=i.get(t.ID);void 0!==n&&n.add(e)})),null===e.parent&&Y.sceneGraph.add(e)})),this.bindSkeleton(e.skeletons,t,i),this.createAmbientLight(),this.setupMorphMaterials(),Y.sceneGraph.traverse((function(e){if(e.userData.transformData){e.parent&&(e.userData.transformData.parentMatrixWorld=e.parent.matrix);var t=ie(e.userData.transformData);e.applyMatrix(t)}}));var o=(new V).parse();1===Y.sceneGraph.children.length&&Y.sceneGraph.children[0].isGroup&&(Y.sceneGraph.children[0].animations=o,Y.sceneGraph=Y.sceneGraph.children[0]),Y.sceneGraph.animations=o}},{key:"parseModels",value:function(e,t,n){var r=new Map,i=Y.fbxTree.Objects.Model;for(var a in i){var o=parseInt(a),s=i[a],l=Y.connections.get(o),c=this.buildSkeleton(l,e,o,s.attrName);if(!c){switch(s.attrType){case"Camera":c=this.createCamera(l);break;case"Light":c=this.createLight(l);break;case"Mesh":c=this.createMesh(l,t,n);break;case"NurbsCurve":c=this.createCurve(l,t);break;case"LimbNode":case"Root":c=new u.N$j;break;case"Null":default:c=new u.ZAu}c.name=u.iUV.sanitizeNodeName(s.attrName),c.ID=o}this.getTransformData(c,s),r.set(o,c)}return r}},{key:"buildSkeleton",value:function(e,t,n,r){var i=null;return e.parents.forEach((function(e){var a=function(a){var o=t[a];o.rawBones.forEach((function(t,a){if(t.ID===e.ID){var s=i;(i=new u.N$j).matrixWorld.copy(t.transformLink),i.name=u.iUV.sanitizeNodeName(r),i.ID=n,o.bones[a]=i,null!==s&&i.add(s)}}))};for(var o in t)a(o)})),i}},{key:"createCamera",value:function(e){var t,n;if(e.children.forEach((function(e){var t=Y.fbxTree.Objects.NodeAttribute[e.ID];void 0!==t&&(n=t)})),void 0===n)t=new u.Tme;else{var r=0;void 0!==n.CameraProjectionType&&1===n.CameraProjectionType.value&&(r=1);var i=1;void 0!==n.NearPlane&&(i=n.NearPlane.value/1e3);var a=1e3;void 0!==n.FarPlane&&(a=n.FarPlane.value/1e3);var o=window.innerWidth,s=window.innerHeight;void 0!==n.AspectWidth&&void 0!==n.AspectHeight&&(o=n.AspectWidth.value,s=n.AspectHeight.value);var l=o/s,c=45;void 0!==n.FieldOfView&&(c=n.FieldOfView.value);var f=n.FocalLength?n.FocalLength.value:null;switch(r){case 0:t=new u.cPb(c,l,i,a),null!==f&&t.setFocalLength(f);break;case 1:t=new u.iKG(-o/2,o/2,s/2,-s/2,i,a);break;default:console.warn("FBXLoader: Unknown camera type "+r+"."),t=new u.Tme}}return t}},{key:"createLight",value:function(e){var t,n;if(e.children.forEach((function(e){var t=Y.fbxTree.Objects.NodeAttribute[e.ID];void 0!==t&&(n=t)})),void 0===n)t=new u.Tme;else{var r;r=void 0===n.LightType?0:n.LightType.value;var i=16777215;void 0!==n.Color&&(i=(new u.Ilk).fromArray(n.Color.value));var a=void 0===n.Intensity?1:n.Intensity.value/100;void 0!==n.CastLightOnObject&&0===n.CastLightOnObject.value&&(a=0);var o=0;void 0!==n.FarAttenuationEnd&&(o=void 0!==n.EnableFarAttenuation&&0===n.EnableFarAttenuation.value?0:n.FarAttenuationEnd.value);switch(r){case 0:t=new u.cek(i,a,o,1);break;case 1:t=new u.Ox3(i,a);break;case 2:var s=Math.PI/3;void 0!==n.InnerAngle&&(s=u.M8C.degToRad(n.InnerAngle.value));var l=0;void 0!==n.OuterAngle&&(l=u.M8C.degToRad(n.OuterAngle.value),l=Math.max(l,1)),t=new u.PMe(i,a,o,s,l,1);break;default:console.warn("FBXLoader: Unknown light type "+n.LightType.value+", defaulting to a PointLight."),t=new u.cek(i,a)}void 0!==n.CastShadows&&1===n.CastShadows.value&&(t.castShadow=!0)}return t}},{key:"createMesh",value:function(e,t,n){var r,i=null,a=null,o=[];return e.children.forEach((function(e){t.has(e.ID)&&(i=t.get(e.ID)),n.has(e.ID)&&o.push(n.get(e.ID))})),o.length>1?a=o:o.length>0?a=o[0]:(a=new u.xoR({color:13421772}),o.push(a)),"color"in i.attributes&&o.forEach((function(e){})),i.FBX_Deformer?(o.forEach((function(e){e.skinning=!0})),(r=new u.TUv(i,a)).normalizeSkinWeights()):r=new u.Kj0(i,a),r}},{key:"createCurve",value:function(e,t){var n=e.children.reduce((function(e,n){return t.has(n.ID)&&(e=t.get(n.ID)),e}),null),r=new u.nls({color:3342591,linewidth:1});return new u.x12(n,r)}},{key:"getTransformData",value:function(e,t){var n={};"InheritType"in t&&(n.inheritType=parseInt(t.InheritType.value)),n.eulerOrder="RotationOrder"in t?ae(t.RotationOrder.value):"ZYX","Lcl_Translation"in t&&(n.translation=t.Lcl_Translation.value),"PreRotation"in t&&(n.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(n.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(n.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(n.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(n.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(n.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(n.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(n.rotationPivot=t.RotationPivot.value),e.userData.transformData=n}},{key:"setLookAtProperties",value:function(e,t){"LookAtProperty"in t&&Y.connections.get(e.ID).children.forEach((function(t){if("LookAtProperty"===t.relationship){var n=Y.fbxTree.Objects.Model[t.ID];if("Lcl_Translation"in n){var r=n.Lcl_Translation.value;void 0!==e.target?(e.target.position.fromArray(r),Y.sceneGraph.add(e.target)):e.lookAt((new u.Pa4).fromArray(r))}}}))}},{key:"bindSkeleton",value:function(e,t,n){var r=this.parsePoseNodes(),i=function(i){var a=e[i];Y.connections.get(parseInt(a.ID)).parents.forEach((function(e){if(t.has(e.ID)){var i=e.ID;Y.connections.get(i).parents.forEach((function(e){n.has(e.ID)&&n.get(e.ID).bind(new u.OdW(a.bones),r[e.ID])}))}}))};for(var a in e)i(a)}},{key:"parsePoseNodes",value:function(){var e={};if("Pose"in Y.fbxTree.Objects){var t=Y.fbxTree.Objects.Pose;for(var n in t)if("BindPose"===t[n].attrType){var r=t[n].PoseNode;Array.isArray(r)?r.forEach((function(t){e[t.Node]=(new u.yGw).fromArray(t.Matrix.a)})):e[r.Node]=(new u.yGw).fromArray(r.Matrix.a)}}return e}},{key:"createAmbientLight",value:function(){if("GlobalSettings"in Y.fbxTree&&"AmbientColor"in Y.fbxTree.GlobalSettings){var e=Y.fbxTree.GlobalSettings.AmbientColor.value,t=e[0],n=e[1],r=e[2];if(0!==t||0!==n||0!==r){var i=new u.Ilk(t,n,r);Y.sceneGraph.add(new u.Mig(i,1))}}}},{key:"setupMorphMaterials",value:function(){var e=this;Y.sceneGraph.traverse((function(t){t.isMesh&&t.geometry.morphAttributes.position&&t.geometry.morphAttributes.position.length&&(Array.isArray(t.material)?t.material.forEach((function(n,r){e.setupMorphMaterial(t,n,r)})):e.setupMorphMaterial(t,t.material))}))}},{key:"setupMorphMaterial",value:function(e,t,n){var r=e.uuid,i=t.uuid,a=!1;if(Y.sceneGraph.traverse((function(e){e.isMesh&&(Array.isArray(e.material)?e.material.forEach((function(t){t.uuid===i&&e.uuid!==r&&(a=!0)})):e.material.uuid===i&&e.uuid!==r&&(a=!0))})),a){var o=t.clone();o.morphTargets=!0,void 0===n?e.material=o:e.material[n]=o}else t.morphTargets=!0}}]),e}();Q=G([I],Q);var H=function(){function e(){(0,r.Z)(this,e)}return(0,i.Z)(e,[{key:"parse",value:function(e){var t=new Map;if("Geometry"in Y.fbxTree.Objects){var n=Y.fbxTree.Objects.Geometry;for(var r in n){var i=Y.connections.get(parseInt(r)),a=this.parseGeometry(i,n[r],e);t.set(parseInt(r),a)}}return t}},{key:"parseGeometry",value:function(e,t,n){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,n);case"NurbsCurve":return this.parseNurbsGeometry(t)}}},{key:"parseMeshGeometry",value:function(e,t,n){var r=n.skeletons,i=n.morphTargets,a=e.parents.map((function(e){return Y.fbxTree.Objects.Model[e.ID]}));if(0!==a.length){var o=e.children.reduce((function(e,t){return void 0!==r[t.ID]&&(e=r[t.ID]),e}),null),s=e.children.reduce((function(e,t){return void 0!==i[t.ID]&&(e=i[t.ID]),e}),null),l=a[0],u={};"RotationOrder"in l&&(u.eulerOrder=ae(l.RotationOrder.value)),"InheritType"in l&&(u.inheritType=parseInt(l.InheritType.value)),"GeometricTranslation"in l&&(u.translation=l.GeometricTranslation.value),"GeometricRotation"in l&&(u.rotation=l.GeometricRotation.value),"GeometricScaling"in l&&(u.scale=l.GeometricScaling.value);var c=ie(u);return this.genGeometry(t,o,s,c)}}},{key:"genGeometry",value:function(e,t,n,r){var i=new u.u9r;e.attrName&&(i.name=e.attrName);var a=this.parseGeoNode(e,t),o=this.genBuffers(a),s=new u.a$l(o.vertex,3);if(r.applyToBufferAttribute(s),i.addAttribute("position",s),o.colors.length>0&&i.addAttribute("color",new u.a$l(o.colors,3)),t&&(i.addAttribute("skinIndex",new u.qlB(o.weightsIndices,4)),i.addAttribute("skinWeight",new u.a$l(o.vertexWeights,4)),i.FBX_Deformer=t),o.normal.length>0){var l=new u.a$l(o.normal,3),c=(new u.Vkp).getNormalMatrix(r);l.applyMatrix3(c),i.addAttribute("normal",l)}if(o.uvs.forEach((function(e,t){var n="uv"+(t+1).toString();0===t&&(n="uv"),i.addAttribute(n,new u.a$l(o.uvs[t],2))})),a.material&&"AllSame"!==a.material.mappingType){var f=o.materialIndex[0],d=0;if(o.materialIndex.forEach((function(e,t){e!==f&&(i.addGroup(d,t-d,f),f=e,d=t)})),i.groups.length>0){var h=i.groups[i.groups.length-1],p=h.start+h.count;p!==o.materialIndex.length&&i.addGroup(p,o.materialIndex.length-p,f)}0===i.groups.length&&i.addGroup(0,o.materialIndex.length,o.materialIndex[0])}return this.addMorphTargets(i,e,n,r),i}},{key:"parseGeoNode",value:function(e,t){var n={};if(n.vertexPositions=void 0!==e.Vertices?e.Vertices.a:[],n.vertexIndices=void 0!==e.PolygonVertexIndex?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(n.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(n.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(n.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){n.uv=[];for(var r=0;e.LayerElementUV[r];)n.uv.push(this.parseUVs(e.LayerElementUV[r])),r++}return n.weightTable={},null!==t&&(n.skeleton=t,t.rawBones.forEach((function(e,t){e.indices.forEach((function(r,i){void 0===n.weightTable[r]&&(n.weightTable[r]=[]),n.weightTable[r].push({id:t,weight:e.weights[i]})}))}))),n}},{key:"genBuffers",value:function(e){var t=this,n={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]},r=0,i=0,a=!1,o=[],s=[],l=[],u=[],c=[],f=[];return e.vertexIndices.forEach((function(d,h){var p=!1;d<0&&(d^=-1,p=!0);var v=[],m=[];if(o.push(3*d,3*d+1,3*d+2),e.color){var y=te(h,r,d,e.color);l.push(y[0],y[1],y[2])}if(e.skeleton){if(void 0!==e.weightTable[d]&&e.weightTable[d].forEach((function(e){m.push(e.weight),v.push(e.id)})),m.length>4){a||(console.warn("FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),a=!0);var g=[0,0,0,0],x=[0,0,0,0];m.forEach((function(e,t){var n=e,r=v[t];x.forEach((function(e,t,i){if(n>e){i[t]=n,n=e;var a=g[t];g[t]=r,r=a}}))})),v=g,m=x}for(;m.length<4;)m.push(0),v.push(0);for(var A=0;A<4;++A)c.push(m[A]),f.push(v[A])}if(e.normal){var T=te(h,r,d,e.normal);s.push(T[0],T[1],T[2])}if(e.material&&"AllSame"!==e.material.mappingType)te(h,r,d,e.material)[0];e.uv&&e.uv.forEach((function(e,t){var n=te(h,r,d,e);void 0===u[t]&&(u[t]=[]),u[t].push(n[0]),u[t].push(n[1])})),i++,p&&(t.genFace(n,e,o,undefined,s,l,u,c,f,i),r++,i=0,o=[],s=[],l=[],u=[],c=[],f=[])})),n}},{key:"genFace",value:function(e,t,n,r,i,a,o,s,l,u){for(var c=function(u){e.vertex.push(t.vertexPositions[n[0]]),e.vertex.push(t.vertexPositions[n[1]]),e.vertex.push(t.vertexPositions[n[2]]),e.vertex.push(t.vertexPositions[n[3*(u-1)]]),e.vertex.push(t.vertexPositions[n[3*(u-1)+1]]),e.vertex.push(t.vertexPositions[n[3*(u-1)+2]]),e.vertex.push(t.vertexPositions[n[3*u]]),e.vertex.push(t.vertexPositions[n[3*u+1]]),e.vertex.push(t.vertexPositions[n[3*u+2]]),t.skeleton&&(e.vertexWeights.push(s[0]),e.vertexWeights.push(s[1]),e.vertexWeights.push(s[2]),e.vertexWeights.push(s[3]),e.vertexWeights.push(s[4*(u-1)]),e.vertexWeights.push(s[4*(u-1)+1]),e.vertexWeights.push(s[4*(u-1)+2]),e.vertexWeights.push(s[4*(u-1)+3]),e.vertexWeights.push(s[4*u]),e.vertexWeights.push(s[4*u+1]),e.vertexWeights.push(s[4*u+2]),e.vertexWeights.push(s[4*u+3]),e.weightsIndices.push(l[0]),e.weightsIndices.push(l[1]),e.weightsIndices.push(l[2]),e.weightsIndices.push(l[3]),e.weightsIndices.push(l[4*(u-1)]),e.weightsIndices.push(l[4*(u-1)+1]),e.weightsIndices.push(l[4*(u-1)+2]),e.weightsIndices.push(l[4*(u-1)+3]),e.weightsIndices.push(l[4*u]),e.weightsIndices.push(l[4*u+1]),e.weightsIndices.push(l[4*u+2]),e.weightsIndices.push(l[4*u+3])),t.color&&(e.colors.push(a[0]),e.colors.push(a[1]),e.colors.push(a[2]),e.colors.push(a[3*(u-1)]),e.colors.push(a[3*(u-1)+1]),e.colors.push(a[3*(u-1)+2]),e.colors.push(a[3*u]),e.colors.push(a[3*u+1]),e.colors.push(a[3*u+2])),t.material&&"AllSame"!==t.material.mappingType&&(e.materialIndex.push(r),e.materialIndex.push(r),e.materialIndex.push(r)),t.normal&&(e.normal.push(i[0]),e.normal.push(i[1]),e.normal.push(i[2]),e.normal.push(i[3*(u-1)]),e.normal.push(i[3*(u-1)+1]),e.normal.push(i[3*(u-1)+2]),e.normal.push(i[3*u]),e.normal.push(i[3*u+1]),e.normal.push(i[3*u+2])),t.uv&&t.uv.forEach((function(t,n){void 0===e.uvs[n]&&(e.uvs[n]=[]),e.uvs[n].push(o[n][0]),e.uvs[n].push(o[n][1]),e.uvs[n].push(o[n][2*(u-1)]),e.uvs[n].push(o[n][2*(u-1)+1]),e.uvs[n].push(o[n][2*u]),e.uvs[n].push(o[n][2*u+1])}))},f=2;f<u;f++)c(f)}},{key:"addMorphTargets",value:function(e,t,n,r){var i=this;null!==n&&(e.morphAttributes.position=[],n.rawTargets.forEach((function(n){var a=Y.fbxTree.Objects.Geometry[n.geoID];void 0!==a&&i.genMorphGeometry(e,t,a,r,n.name)})))}},{key:"genMorphGeometry",value:function(e,t,n,r,i){var a=new u.u9r;n.attrName&&(a.name=n.attrName);for(var o=void 0!==t.PolygonVertexIndex?t.PolygonVertexIndex.a:[],s=void 0!==t.Vertices?t.Vertices.a.slice():[],l=void 0!==n.Vertices?n.Vertices.a:[],c=void 0!==n.Indexes?n.Indexes.a:[],f=0;f<c.length;f++){var d=3*c[f];s[d]+=l[3*f],s[d+1]+=l[3*f+1],s[d+2]+=l[3*f+2]}var h={vertexIndices:o,vertexPositions:s},p=this.genBuffers(h),v=new u.a$l(p.vertex,3);v.name=i||n.attrName,r.applyToBufferAttribute(v),e.morphAttributes.position.push(v)}},{key:"parseNormals",value:function(e){var t=e.MappingInformationType,n=e.ReferenceInformationType,r=e.Normals.a,i=[];return"IndexToDirect"===n&&("NormalIndex"in e?i=e.NormalIndex.a:"NormalsIndex"in e&&(i=e.NormalsIndex.a)),{dataSize:3,buffer:r,indices:i,mappingType:t,referenceType:n}}},{key:"parseUVs",value:function(e){var t=e.MappingInformationType,n=e.ReferenceInformationType,r=e.UV.a,i=[];return"IndexToDirect"===n&&(i=e.UVIndex.a),{dataSize:2,buffer:r,indices:i,mappingType:t,referenceType:n}}},{key:"parseVertexColors",value:function(e){var t=e.MappingInformationType,n=e.ReferenceInformationType,r=e.Colors.a,i=[];return"IndexToDirect"===n&&(i=e.ColorIndex.a),{dataSize:4,buffer:r,indices:i,mappingType:t,referenceType:n}}},{key:"parseMaterialIndices",value:function(e){var t=e.MappingInformationType,n=e.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:n};for(var r=e.Materials.a,i=[],a=0;a<r.length;++a)i.push(a);return{dataSize:1,buffer:r,indices:i,mappingType:t,referenceType:n}}},{key:"parseNurbsGeometry",value:function(e){var t=parseInt(e.Order);if(isNaN(t))return console.error("FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new u.u9r;for(var n,r,i=t-1,a=e.KnotVector.a,o=[],s=e.Points.a,l=0,c=s.length;l<c;l+=4)o.push((new u.Ltg).fromArray(s,l));if("Closed"===e.Form)o.push(o[0]);else if("Periodic"===e.Form){n=i,r=a.length-1-n;for(var f=0;f<i;++f)o.push(o[f])}var d=new z(i,a,o,n,r).getPoint(7*o.length),h=new Float32Array(3*Number(d.length)),p=new u.u9r;return p.addAttribute("position",new u.TlE(h,3)),p}}]),e}(),V=function(){function e(){(0,r.Z)(this,e)}return(0,i.Z)(e,[{key:"parse",value:function(){var e=[],t=this.parseClips();if(void 0!==t)for(var n in t){var r=t[n],i=this.addClip(r);e.push(i)}return e}},{key:"parseClips",value:function(){if(void 0!==Y.fbxTree.Objects.AnimationCurve){var e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);var t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}}},{key:"parseAnimationCurveNodes",value:function(){var e=Y.fbxTree.Objects.AnimationCurveNode,t=new Map;for(var n in e){var r=e[n];if(null!==r.attrName.match(/S|R|T|DeformPercent/)){var i={id:r.id,attr:r.attrName,curves:{}};t.set(i.id,i)}}return t}},{key:"parseAnimationCurves",value:function(e){var t=Y.fbxTree.Objects.AnimationCurve;for(var n in t){var r={id:t[n].id,times:t[n].KeyTime.a.map(J),values:t[n].KeyValueFloat.a},i=Y.connections.get(r.id);if(void 0!==i){var a=i.parents[0].ID,o=i.parents[0].relationship;o.match(/X/)?e.get(a).curves.x=r:o.match(/Y/)?e.get(a).curves.y=r:o.match(/Z/)?e.get(a).curves.z=r:o.match(/d|DeformPercent/)&&e.has(a)&&(e.get(a).curves.morph=r)}}}},{key:"parseAnimationLayers",value:function(e){var t=Y.fbxTree.Objects.AnimationLayer,n=new Map,r=function(t){var r=[],i=Y.connections.get(parseInt(t));void 0!==i&&(i.children.forEach((function(t,n){if(e.has(t.ID)){var i=e.get(t.ID);if(void 0!==i.curves.x||void 0!==i.curves.y||void 0!==i.curves.z){if(void 0===r[n]){var a=Y.connections.get(t.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID;if(void 0!==a){var o=Y.fbxTree.Objects.Model[a.toString()],s={modelName:u.iUV.sanitizeNodeName(o.attrName),ID:o.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};Y.sceneGraph.traverse((function(e){e.ID===o.id&&(s.transform=e.matrix,e.userData.transformData&&(s.eulerOrder=e.userData.transformData.eulerOrder))})),s.transform||(s.transform=new u.yGw),"PreRotation"in o&&(s.preRotation=o.PreRotation.value),"PostRotation"in o&&(s.postRotation=o.PostRotation.value),r[n]=s}}r[n]&&(r[n][i.attr]=i)}else if(void 0!==i.curves.morph){if(void 0===r[n]){var l=Y.connections.get(t.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID,c=Y.connections.get(l).parents[0].ID,f=Y.connections.get(c).parents[0].ID,d=Y.connections.get(f).parents[0].ID,h=Y.fbxTree.Objects.Model[d],p={modelName:u.iUV.sanitizeNodeName(h.attrName),morphName:Y.fbxTree.Objects.Deformer[l].attrName};r[n]=p}r[n][i.attr]=i}}})),n.set(parseInt(t),r))};for(var i in t)r(i);return n}},{key:"parseAnimStacks",value:function(e){var t=Y.fbxTree.Objects.AnimationStack,n={};for(var r in t){var i=Y.connections.get(parseInt(r)).children;i.length>1&&console.warn("FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");var a=e.get(i[0].ID);n[r]={name:t[r].attrName,layer:a}}return n}},{key:"addClip",value:function(e){var t=this,n=[];return e.layer.forEach((function(e){n=n.concat(t.generateTracks(e))})),new u.m7l(e.name,-1,n)}},{key:"generateTracks",value:function(e){var t=[],n=new u.Pa4,r=new u._fP,i=new u.Pa4;if(e.transform&&e.transform.decompose(n,r,i),n=n.toArray(),r=(new u.USm).setFromQuaternion(r,e.eulerOrder).toArray(),i=i.toArray(),void 0!==e.T&&Object.keys(e.T.curves).length>0){var a=this.generateVectorTrack(e.modelName,e.T.curves,n,"position");void 0!==a&&t.push(a)}if(void 0!==e.R&&Object.keys(e.R.curves).length>0){var o=this.generateRotationTrack(e.modelName,e.R.curves,r,e.preRotation,e.postRotation,e.eulerOrder);void 0!==o&&t.push(o)}if(void 0!==e.S&&Object.keys(e.S.curves).length>0){var s=this.generateVectorTrack(e.modelName,e.S.curves,i,"scale");void 0!==s&&t.push(s)}if(void 0!==e.DeformPercent){var l=this.generateMorphTrack(e);void 0!==l&&t.push(l)}return t}},{key:"generateVectorTrack",value:function(e,t,n,r){var i=this.getTimesForAllAxes(t),a=this.getKeyframeTrackValues(i,t,n);return new u.yC1(e+"."+r,i,a)}},{key:"generateRotationTrack",value:function(e,t,n,r,i,a){void 0!==t.x&&(this.interpolateRotations(t.x),t.x.values=t.x.values.map(u.M8C.degToRad)),void 0!==t.y&&(this.interpolateRotations(t.y),t.y.values=t.y.values.map(u.M8C.degToRad)),void 0!==t.z&&(this.interpolateRotations(t.z),t.z.values=t.z.values.map(u.M8C.degToRad));var o=this.getTimesForAllAxes(t),s=this.getKeyframeTrackValues(o,t,n);void 0!==r&&((r=r.map(u.M8C.degToRad)).push(a),r=(new u.USm).fromArray(r),r=(new u._fP).setFromEuler(r)),void 0!==i&&((i=i.map(u.M8C.degToRad)).push(a),i=(new u.USm).fromArray(i),i=(new u._fP).setFromEuler(i).inverse());for(var l=new u._fP,c=new u.USm,f=[],d=0;d<s.length;d+=3)c.set(s[d],s[d+1],s[d+2],a),l.setFromEuler(c),void 0!==r&&l.premultiply(r),void 0!==i&&l.multiply(i),l.toArray(f,d/3*4);return new u.iLg(e+".quaternion",o,f)}},{key:"generateMorphTrack",value:function(e){var t=e.DeformPercent.curves.morph,n=t.values.map((function(e){return e/100})),r=Y.sceneGraph.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new u.dUE(e.modelName+".morphTargetInfluences["+r+"]",t.times,n)}},{key:"getTimesForAllAxes",value:function(e){var t=[];return void 0!==e.x&&(t=t.concat(e.x.times)),void 0!==e.y&&(t=t.concat(e.y.times)),void 0!==e.z&&(t=t.concat(e.z.times)),t=t.sort((function(e,t){return e-t})).filter((function(e,t,n){return n.indexOf(e)==t}))}},{key:"getKeyframeTrackValues",value:function(e,t,n){var r=n,i=[],a=-1,o=-1,s=-1;return e.forEach((function(e){if(t.x&&(a=t.x.times.indexOf(e)),t.y&&(o=t.y.times.indexOf(e)),t.z&&(s=t.z.times.indexOf(e)),-1!==a){var n=t.x.values[a];i.push(n),r[0]=n}else i.push(r[0]);if(-1!==o){var l=t.y.values[o];i.push(l),r[1]=l}else i.push(r[1]);if(-1!==s){var u=t.z.values[s];i.push(u),r[2]=u}else i.push(r[2])})),i}},{key:"interpolateRotations",value:function(e){for(var t=1;t<e.values.length;t++){var n=e.values[t-1],r=e.values[t]-n,i=Math.abs(r);if(i>=180){for(var a=i/180,o=r/a,s=n+o,l=e.times[t-1],u=(e.times[t]-l)/a,c=l+u,f=[],d=[];c<e.times[t];)f.push(c),c+=u,d.push(s),s+=o;e.times=le(e.times,t,f),e.values=le(e.values,t,d)}}}}]),e}(),W=function(){function e(){(0,r.Z)(this,e)}return(0,i.Z)(e,[{key:"getPrevNode",value:function(){return this.nodeStack[this.currentIndent-2]}},{key:"getCurrentNode",value:function(){return this.nodeStack[this.currentIndent-1]}},{key:"getCurrentProp",value:function(){return this.currentProp}},{key:"pushStack",value:function(e){this.nodeStack.push(e),this.currentIndent+=1}},{key:"popStack",value:function(){this.nodeStack.pop(),this.currentIndent-=1}},{key:"setCurrentProp",value:function(e,t){this.currentProp=e,this.currentPropName=t}},{key:"parse",value:function(e){var t=this;this.currentIndent=0,this.allNodes=new K,this.nodeStack=[],this.currentProp=[],this.currentPropName="";var n=e.split(/[\r\n]+/);return n.forEach((function(e,r){var i=e.match(/^[\s\t]*;/),a=e.match(/^[\s\t]*$/);if(!i&&!a){var o=e.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),s=e.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),l=e.match("^\\t{"+(t.currentIndent-1)+"}}");o?t.parseNodeBegin(e,o):s?t.parseNodeProperty(e,s,n[++r]):l?t.popStack():e.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(e)}})),this.allNodes}},{key:"parseNodeBegin",value:function(e,t){var n=t[1].trim().replace(/^"/,"").replace(/"$/,""),r=t[2].split(",").map((function(e){return e.trim().replace(/^"/,"").replace(/"$/,"")})),i={name:n},a=this.parseNodeAttr(r),o=this.getCurrentNode();0===this.currentIndent?this.allNodes.add(n,i):n in o?("PoseNode"===n?o.PoseNode.push(i):void 0!==o[n].id&&(o[n]={},o[n][o[n].id]=o[n]),""!==a.id&&(o[n][a.id]=i)):"number"===typeof a.id?(o[n]={},o[n][a.id]=i):"Properties70"!==n&&(o[n]="PoseNode"===n?[i]:i),"number"===typeof a.id&&(i.id=a.id),""!==a.name&&(i.attrName=a.name),""!==a.type&&(i.attrType=a.type),this.pushStack(i)}},{key:"parseNodeAttr",value:function(e){var t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));var n="",r="";return e.length>1&&(n=e[1].replace(/^(\w+)::/,""),r=e[2]),{id:t,name:n,type:r}}},{key:"parseNodeProperty",value:function(e,t,n){var r=t[1].replace(/^"/,"").replace(/"$/,"").trim(),i=t[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===r&&","===i&&(i=n.replace(/"/g,"").replace(/,$/,"").trim());var a=this.getCurrentNode();if("Properties70"!==a.name){if("C"===r){var o=i.split(",").slice(1),s=parseInt(o[0]),l=parseInt(o[1]),u=i.split(",").slice(3);r="connections",function(e,t){for(var n=0,r=e.length,i=t.length;n<i;n++,r++)e[r]=t[n]}(i=[s,l],u=u.map((function(e){return e.trim().replace(/^"/,"")}))),void 0===a[r]&&(a[r]=[])}"Node"===r&&(a.id=i),r in a&&Array.isArray(a[r])?a[r].push(i):"a"!==r?a[r]=i:a.a=i,this.setCurrentProp(a,r),"a"===r&&","!==i.slice(-1)&&(a.a=oe(i))}else this.parseNodeSpecialProperty(e,r,i)}},{key:"parseNodePropertyContinued",value:function(e){var t=this.getCurrentNode();t.a+=e,","!==e.slice(-1)&&(t.a=oe(t.a))}},{key:"parseNodeSpecialProperty",value:function(e,t,n){var r=n.split('",').map((function(e){return e.trim().replace(/^\"/,"").replace(/\s/,"_")})),i=r[0],a=r[1],o=r[2],s=r[3],l=r[4];switch(a){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":l=parseFloat(l);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":l=oe(l)}this.getPrevNode()[i]={type:a,type2:o,flag:s,value:l},this.setCurrentProp(this.getPrevNode(),i)}}]),e}(),j=function(){function e(){(0,r.Z)(this,e)}return(0,i.Z)(e,[{key:"parse",value:function(e){var t=new q(e);t.skip(23);var n=t.getUint32();console.log("FBXLoader: FBX binary version: "+n);for(var r=new K;!this.endOfContent(t);){var i=this.parseNode(t,n);null!==i&&r.add(i.name,i)}return r}},{key:"endOfContent",value:function(e){return e.size()%16===0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}},{key:"parseNode",value:function(e,t){var n={},r=t>=7500?e.getUint64():e.getUint32(),i=t>=7500?e.getUint64():e.getUint32(),a=(t>=7500?e.getUint64():e.getUint32(),e.getUint8()),o=e.getString(a);if(0===r)return null;for(var s=[],l=0;l<i;l++)s.push(this.parseProperty(e));var u=s.length>0?s[0]:"",c=s.length>1?s[1]:"",f=s.length>2?s[2]:"";for(n.singleProperty=1===i&&e.getOffset()===r;r>e.getOffset();){var d=this.parseNode(e,t);null!==d&&this.parseSubNode(o,n,d)}return n.propertyList=s,"number"===typeof u&&(n.id=u),""!==c&&(n.attrName=c),""!==f&&(n.attrType=f),""!==o&&(n.name=o),n}},{key:"parseSubNode",value:function(e,t,n){if(!0===n.singleProperty){var r=n.propertyList[0];Array.isArray(r)?(t[n.name]=n,n.a=r):t[n.name]=r}else if("Connections"===e&&"C"===n.name){var i=[];n.propertyList.forEach((function(e,t){0!==t&&i.push(e)})),void 0===t.connections&&(t.connections=[]),t.connections.push(i)}else if("Properties70"===n.name){Object.keys(n).forEach((function(e){t[e]=n[e]}))}else if("Properties70"===e&&"P"===n.name){var a,o=n.propertyList[0],s=n.propertyList[1],l=n.propertyList[2],u=n.propertyList[3];0===o.indexOf("Lcl ")&&(o=o.replace("Lcl ","Lcl_")),0===s.indexOf("Lcl ")&&(s=s.replace("Lcl ","Lcl_")),a="Color"===s||"ColorRGB"===s||"Vector"===s||"Vector3D"===s||0===s.indexOf("Lcl_")?[n.propertyList[4],n.propertyList[5],n.propertyList[6]]:n.propertyList[4],t[o]={type:s,type2:l,flag:u,value:a}}else void 0===t[n.name]?"number"===typeof n.id?(t[n.name]={},t[n.name][n.id]=n):t[n.name]=n:"PoseNode"===n.name?(Array.isArray(t[n.name])||(t[n.name]=[t[n.name]]),t[n.name].push(n)):void 0===t[n.name][n.id]&&(t[n.name][n.id]=n)}},{key:"parseProperty",value:function(e){var t=e.getString(1);switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":var n=e.getUint32();return e.getArrayBuffer(n);case"S":var r=e.getUint32();return e.getString(r);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":var i=e.getUint32(),a=e.getUint32();e.getUint32();if(0===a)switch(t){case"b":case"c":return e.getBooleanArray(i);case"d":return e.getFloat64Array(i);case"f":return e.getFloat32Array(i);case"i":return e.getInt32Array(i);case"l":return e.getInt64Array(i)}default:throw new Error("FBXLoader: Unknown property type "+t)}}}]),e}(),q=function(){function e(t,n){(0,r.Z)(this,e),this.dv=new DataView(t),this.offset=0,this.littleEndian=void 0===n||n}return(0,i.Z)(e,[{key:"getOffset",value:function(){return this.offset}},{key:"size",value:function(){return this.dv.buffer.byteLength}},{key:"skip",value:function(e){this.offset+=e}},{key:"getBoolean",value:function(){return 1===(1&this.getUint8())}},{key:"getBooleanArray",value:function(e){for(var t=[],n=0;n<e;n++)t.push(this.getBoolean());return t}},{key:"getUint8",value:function(){var e=this.dv.getUint8(this.offset);return this.offset+=1,e}},{key:"getInt16",value:function(){var e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}},{key:"getInt32",value:function(){var e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}},{key:"getInt32Array",value:function(e){for(var t=[],n=0;n<e;n++)t.push(this.getInt32());return t}},{key:"getUint32",value:function(){var e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}},{key:"getInt64",value:function(){var e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,4294967295===(e=4294967295&~e)&&(t=t+1&4294967295),-(4294967296*t+(e=e+1&4294967295))):4294967296*t+e}},{key:"getInt64Array",value:function(e){for(var t=[],n=0;n<e;n++)t.push(this.getInt64());return t}},{key:"getUint64",value:function(){var e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e}},{key:"getFloat32",value:function(){var e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}},{key:"getFloat32Array",value:function(e){for(var t=[],n=0;n<e;n++)t.push(this.getFloat32());return t}},{key:"getFloat64",value:function(){var e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}},{key:"getFloat64Array",value:function(e){for(var t=[],n=0;n<e;n++)t.push(this.getFloat64());return t}},{key:"getArrayBuffer",value:function(e){var t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}},{key:"getString",value:function(e){for(var t=[],n=0;n<e;n++)t[n]=this.getUint8();var r=t.indexOf(0);return r>=0&&(t=t.slice(0,r)),u.Zp0.decodeText(new Uint8Array(t))}}]),e}(),K=function(){function e(){(0,r.Z)(this,e)}return(0,i.Z)(e,[{key:"add",value:function(e,t){this[e]=t}}]),e}();function $(e){var t=e.match(/FBXVersion: (\d+)/);if(t)return parseInt(t[1]);throw new Error("FBXLoader: Cannot find the version number for the file given.")}function J(e){return e/46186158e3}var ee=[];function te(e,t,n,r){var i;switch(r.mappingType){case"ByPolygonVertex":i=e;break;case"ByPolygon":i=t;break;case"ByVertice":i=n;break;case"AllSame":i=r.indices[0];break;default:console.warn("FBXLoader: unknown attribute mapping type "+r.mappingType)}"IndexToDirect"===r.referenceType&&(i=r.indices[i]);var a=i*r.dataSize,o=a+r.dataSize;return function(e,t,n,r){for(var i=n,a=0;i<r;i++,a++)e[a]=t[i];return e}(ee,r.buffer,a,o)}var ne=new u.USm,re=new u.Pa4;function ie(e){var t=new u.yGw,n=new u.yGw,r=new u.yGw,i=new u.yGw,a=new u.yGw,o=new u.yGw,s=new u.yGw,l=new u.yGw,c=new u.yGw,f=new u.yGw,d=new u.yGw,h=e.inheritType?e.inheritType:0;if(e.translation&&t.setPosition(re.fromArray(e.translation)),e.preRotation){var p=e.preRotation.map(u.M8C.degToRad);p.push(e.eulerOrder),n.makeRotationFromEuler(ne.fromArray(p))}if(e.rotation){var v=e.rotation.map(u.M8C.degToRad);v.push(e.eulerOrder),r.makeRotationFromEuler(ne.fromArray(v))}if(e.postRotation){var m=e.postRotation.map(u.M8C.degToRad);m.push(e.eulerOrder),i.makeRotationFromEuler(ne.fromArray(m))}e.scale&&a.scale(re.fromArray(e.scale)),e.scalingOffset&&s.setPosition(re.fromArray(e.scalingOffset)),e.scalingPivot&&o.setPosition(re.fromArray(e.scalingPivot)),e.rotationOffset&&l.setPosition(re.fromArray(e.rotationOffset)),e.rotationPivot&&c.setPosition(re.fromArray(e.rotationPivot)),e.parentMatrixWorld&&(f=e.parentMatrixWorld);var y=n.multiply(r).multiply(i),g=new u.yGw;f.extractRotation(g);var x=new u.yGw;x.copyPosition(f);var A,T=x.invert().multiply(f),S=g.invert().multiply(T),E=a;if(0===h)A=g.multiply(y).multiply(S).multiply(E);else if(1===h)A=g.multiply(S).multiply(y).multiply(E);else{var P=(new u.yGw).copy(a),_=S.multiply(P.invert());A=g.multiply(y).multiply(_).multiply(E)}var w=t.multiply(l).multiply(c).multiply(n).multiply(r).multiply(i).multiply(c.invert()).multiply(s).multiply(o).multiply(a).multiply(o.invert()),F=(new u.yGw).copyPosition(w),b=f.multiply(F);return d.copyPosition(b),w=d.multiply(A)}function ae(e){var t=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return 6===(e=e||0)?(console.warn("FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),t[0]):t[e]}function oe(e){return e.split(",").map((function(e){return parseFloat(e)}))}function se(e,t,n){return void 0===t&&(t=0),void 0===n&&(n=e.byteLength),u.Zp0.decodeText(new Uint8Array(e,t,n))}function le(e,t,n){return e.slice(0,t).concat(n).concat(e.slice(t))}var ue=n(4635),ce=n(13385);function fe(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,s.Z)(e);if(t){var i=(0,s.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,o.Z)(this,n)}}var de={0:5,1:15,2:30},he=new RegExp(/^(.*)_LOD(\d+)$/);function pe(e){var t;if(!!!(null===(t=e.children)||void 0===t?void 0:t.find((function(e){return String(e.name).match(he)}))))return e;var n=new Map;return e.children.forEach((function(e){var t=e.name.match(he);if(t){var r=(0,l.Z)(t,3),i=(r[0],r[1]),a=r[2];i&&a&&(n.has(i)||n.set(i,[]),n.get(i).push({object:e,level:a}))}})),n.forEach((function(e,t){var n=new u.z8B;n.name=t,e[0].object.parent.add(n),e.forEach((function(e){var t=e.level,r=e.object;n.addLevel(r,de[t])}))})),e}function ve(e,t,n){n(e,t);for(var r=0;r<e.children.length;r++)ve(e.children[r],t.children[r],n)}function me(e){var t=new Map,n=new Map,r=e.clone();return ve(e,r,(function(e,r){t.set(r,e),n.set(e,r)})),r.traverse((function(e){if(e instanceof u.TUv){var r=e,i=t.get(e),a=i.skeleton.bones;r.skeleton=i.skeleton.clone(),r.bindMatrix.copy(i.bindMatrix),r.skeleton.bones=a.map((function(e){return n.get(e)})),r.bind(r.skeleton,r.bindMatrix)}})),r}function ye(e,t,n){var r=function(e){for(var t=0,n=0,r=e.length;n<r;)t=(t<<5)-t+e.charCodeAt(n++)<<0;return"".concat(t).concat(e.substr(Math.max(e.length-7,0)))}(e);if(A.instance.assets.has(r))n(t,{asset:me(A.instance.assets.get(r))});else{var i=function(e){if(e==ce.h.FBX)return new Y;if(e==ce.h.glTF)return D.nZ();if(e==ce.h.PNG)return new u.dpR;if(e==ce.h.JPEG)return new u.dpR;if(e==ce.h.VRM)return D.nZ()}(ge(e));if(null==i)return void console.error("Asset loader failed ",e,t);i.load(e,(function(e){void 0!==e&&D.aG(e),e.scene&&(e=e.scene),A.instance.assets.set(r,e),n(t,{asset:e})}))}}function ge(e){return/\.(?:gltf|glb)$/.test(e)?ce.h.glTF:/\.(?:fbx)$/.test(e)?ce.h.FBX:/\.(?:vrm)$/.test(e)?ce.h.VRM:/\.(?:png)$/.test(e)?ce.h.PNG:/\.(?:jpg|jpeg|)$/.test(e)?ce.h.JPEG:null}var xe=function(e){(0,a.Z)(n,e);var t=fe(n);function n(){var e;return(0,r.Z)(this,n),(e=t.call(this)).updateType=m.V.Fixed,e.loaded=new Map,e.loadingCount=0,e}return(0,i.Z)(n,[{key:"execute",value:function(){var e,t=this;this.queryResults.toLoad.all.forEach((function(e){var n=(0,v.tu)(e,x.rl);(0,v.tu)(e,S.e)?console.log("??? already has AssetLoaderState"):(0,v.Tk)(e,S.e);var r,i=(0,v.Ei)(e,T.g);if(i.assetType=ge(i.url),i.assetClass=(r=i.url,/\.(?:gltf|glb|vrm|fbx|obj)$/.test(r)?ue.e.Model:/\.png|jpg|jpeg$/.test(r)?ue.e.Image:null),c.C&&(t.loadingCount++,d.NL.instance.dispatchEvent({type:d.NL.EVENTS.ENTITY_LOADED,left:t.loadingCount})),!n||c.C)try{ye(i.url,e,(function(e,n){var r=n.asset;t.loaded.set(e,r),c.C&&(t.loadingCount--,0===t.loadingCount?d.NL.instance.dispatchEvent({type:d.NL.EVENTS.SCENE_LOADED,loaded:!0}):d.NL.instance.dispatchEvent({type:d.NL.EVENTS.ENTITY_LOADED,left:t.loadingCount}))}))}catch(a){console.log("**** Loading error; failed to load because ",a)}})),this.loaded.forEach((function(e,t){var n=(0,v.Xr)(t,T.g);n&&n.assetClass===ue.e.Model&&((0,v.Tk)(t,w,{value:e}),function(e,t,n){var r,i=null!==(r=n.scene)&&void 0!==r?r:n,a=new Map;i.traverse((function(e){var n,r,i;if(e.isMesh)if(e.receiveShadow=t.receiveShadow,e.castShadow=t.castShadow,t.envMapOverride&&(e.material.envMap=t.envMapOverride),a.has(e.material))e.material=a.get(e.material);else if(null===(i=null===(r=null===(n=null===e||void 0===e?void 0:e.material)||void 0===n?void 0:n.userData)||void 0===r?void 0:r.gltfExtensions)||void 0===i?void 0:i.KHR_materials_clearcoat){var o=new u.EJi({});o.setValues(e.material),o.clearcoat=e.material.userData.gltfExtensions.KHR_materials_clearcoat.clearcoatFactor,o.clearcoatRoughness=e.material.userData.gltfExtensions.KHR_materials_clearcoat.clearcoatRoughnessFactor,o.defines={STANDARD:"",PHYSICAL:""},a.set(e.material,o),e.material=o}})),a.clear(),i=pe(i),n.children.length&&n.children.forEach((function(e){return pe(e)})),t.parent?t.parent.add(i):((0,v.tu)(e,g.S)?void 0!==(0,v.Xr)(e,g.S).value?(0,v.Ei)(e,g.S).value.add(i):(0,v.Ei)(e,g.S).value=i:(0,y.o)(e,{obj3d:i}),i.children.forEach((function(t){var n=(0,v.JP)();(0,y.o)(n,{obj3d:t,parentEntity:e})})))}(t,n,e)),(0,v.Ei)(t,T.g).loaded=!0,n.onLoaded.length>0&&n.onLoaded.forEach((function(n){return n(t,{asset:e})}))})),null===(e=this.loaded)||void 0===e||e.clear(),this.queryResults.toUnload.all.forEach((function(e){if(console.log("Entity should be unloaded",e),(0,v.aT)(e,S.e),(0,v.aT)(e,b),(0,v.tu)(e,g.S)){var t=(0,v.Xr)(e,g.S,!0).value;if(void 0==t)return;f.D4.scene.remove(t),t.parent&&t.parent.remove(t),(0,v.aT)(e,g.S);for(var n=e.componentTypes.length-1;n>=0;n--){var r=e.componentTypes[n];r.isObject3DTagComponent&&(0,v.aT)(e,r)}t.entity=null}}))}}]),n}(h.x);xe.queries={models:{components:[w]},toLoad:{components:[T.g,(0,p.yo)(S.e)],listen:{added:!0,removed:!0}},toUnload:{components:[S.e,b,(0,p.yo)(T.g)]}}},21769:function(e,t,n){"use strict";n.d(t,{D:function(){return C}});var r=n(49182),i=n(39337),a=n(13987),o=n(29569),s=n(89306),l=n(16090),u=n(7331),c=n(36595),f=n(67200),d=n(17209),h=n(97762),p=n(35490),v=n(49903),m=n(483),y=n(88203),g=n(95812),x=n(5450),A=n(83659),T=n(82552),S=n(77213),E=n(95070),P=n(74203),_=n(94223),w=n(73505),F=n(47509);function b(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,s.Z)(e);if(t){var i=(0,s.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,o.Z)(this,n)}}var D=new c.Pa4(0,0,1),R=new c.Pa4,N=new c.Pa4(0,1,0),L=new c.Pa4,I=Math.PI/180,k=new c.yGw,M=new c.Pa4,O=[0,0],C=function(e){(0,a.Z)(n,e);var t=b(n);function n(){var e;(0,r.Z)(this,n),(e=t.call(this)).prevState=[0,0];var i=(0,l.JP)();return(0,l.Tk)(i,S.M),(0,l.Tk)(i,d.q4),(0,f.o)(i,{obj3d:m.D4.camera}),(0,l.Tk)(i,T.U),(0,l.Tk)(i,A.X),n.activeCamera=i,e}return(0,i.Z)(n,[{key:"execute",value:function(e){var t,r,i,a=this;null===(t=this.queryResults.followCameraComponent.added)||void 0===t||t.forEach((function(e){S.M.instance.followTarget=e})),null===(r=this.queryResults.cameraComponent.all)||void 0===r||r.forEach((function(e){if(!p.s){var t=(0,l.Xr)(e,S.M);if(t.followTarget&&(0,l.tu)(t.followTarget,E.F)){var r=(0,l.Ei)(e,A.X);r.position||(r.position=new c.Pa4),r.rotation||(r.rotation=new c._fP);var i=(0,l.Ei)(t.followTarget,g.rl),o=(0,l.Ei)(t.followTarget,T.U),s=(0,l.Xr)(t.followTarget,u.I),f=(0,l.Ei)(t.followTarget,E.F),d=function(e,t,n){var r={currentInputValue:O,inputValue:O};if(!(null===e||void 0===e?void 0:e.data.has(t)))return r;var i=e.data.get(t);return r.currentInputValue=i.value,r.inputValue=i.lifecycleState===h.q.ENDED||JSON.stringify(r.currentInputValue)===JSON.stringify(n)?O:r.currentInputValue,r}(s,x.Q.LOOKTURN_PLAYERONE,a.prevState),m=d.inputValue,y=d.currentInputValue;a.prevState=y,f.locked&&i?f.theta=180*Math.atan2(i.orientation.x,i.orientation.z)/Math.PI+180:f.locked&&(f.theta=180*Math.atan2(o.rotation.z,o.rotation.x)/Math.PI),f.theta-=m[0]*((0,v.i)()?60:100),f.theta%=360,f.phi-=m[1]*((0,v.i)()?60:100),f.phi=Math.min(85,Math.max(-70,f.phi)),(f.locked||f.mode===P.r.FirstPerson)&&(o.rotation.setFromAxisAngle(N,(f.theta-180)*(Math.PI/180)),i.orientation.copy(D).applyQuaternion(o.rotation),o.rotation.setFromUnitVectors(D,i.orientation.clone().setY(0))),r.rotationRate=(0,v.i)()||f.mode===P.r.FirstPerson?5:3.5,r.positionRate=(0,v.i)()||f.mode===P.r.FirstPerson?3.5:2;var b=f.distance;f.mode===P.r.FirstPerson?b=.01:f.mode===P.r.ShoulderCam?b=f.minDistance:f.mode===P.r.TopDown&&(b=f.maxDistance);var C,U=f.mode===P.r.TopDown?85:f.phi;if(i){var B=f.offset.clone().applyQuaternion(i.tiltContainer.quaternion);C=i.tiltContainer.getWorldPosition(M).add(B)}else r.rotationRate=7,r.positionRate=15,C=o.position;var X=new F.AO(C.x,C.y,C.z),Z=(0,l.Ei)(n.activeCamera,T.U),z=new F.AO(Z.position.x,Z.position.y,Z.position.z),G={collisionFilterMask:w.p.Default|w.p.Car,skipBackfaces:!0};i||(G.collisionFilterMask=w.p.Default),f.rayHasHit=_.F.physicsWorld.raycastClosest(X,z,G,f.rayResult),f.mode!==P.r.FirstPerson&&f.rayHasHit&&f.rayResult.distance<b&&f.rayResult.distance>.1&&(b=f.rayResult.distance-.5),r.position.set(C.x+b*Math.sin(f.theta*I)*Math.cos(U*I),C.y+b*Math.sin(U*I),C.z+b*Math.cos(f.theta*I)*Math.cos(U*I)),R.copy(r.position),R=R.sub(C).normalize(),k.lookAt(R,L,N),r.rotation.setFromRotationMatrix(k),i?i.viewVector=new c.Pa4(0,0,-1).applyQuaternion(r.rotation):Z.rotation.copy(r.rotation),f.mode===P.r.FirstPerson&&r.position.copy(C)}}})),null===(i=this.queryResults.cameraComponent.changed)||void 0===i||i.forEach((function(e){}))}}]),n}(y.x);C.queries={cameraComponent:{components:[S.M,T.U],listen:{added:!0,changed:!0}},followCameraComponent:{components:[E.F,T.U],listen:{added:!0,changed:!0}}}},99814:function(e,t,n){"use strict";n.d(t,{B7:function(){return p}});var r=n(49182),i=n(39337),a=n(48533),o=n.n(a),s=n(58700),l=n(47396),u=n(46365),c=n(483),f=n(34452),d=n(52194),h=1e4;function p(e,t,n){var r,i=t||60,a=n||20,p=0,y=0,g=0,x=120,A=1/x,T=0,S={fixed:0,net:0,update:0,render:0},E={fixed:0,net:0,update:0,render:0};function P(t,n){null!==p&&(y+=g=(t-p)/1e3,_&&_.run(g),w&&w.run(g),(0,d.y)(g,n),e.update&&e.update(g,y)),p=t}f.NL.instance.addEventListener(d.T.EVENTS.XR_START,function(){var e=(0,s.Z)(o().mark((function e(t){return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:I();case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),f.NL.instance.addEventListener(d.T.EVENTS.XR_SESSION,function(){var e=(0,s.Z)(o().mark((function e(t){var n,r,i;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:console.log("STARTING XR",null===(n=c.D4.renderer)||void 0===n?void 0:n.xr),null===(i=null===(r=c.D4.renderer)||void 0===r?void 0:r.xr)||void 0===i||i.setAnimationLoop(P);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),f.NL.instance.addEventListener(d.T.EVENTS.XR_END,function(){var e=(0,s.Z)(o().mark((function e(t){return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:c.D4.renderer.setAnimationLoop(null),L();case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());var _=e.fixedUpdate?new m(i,e.fixedUpdate):null,w=e.fixedUpdate?new m(a,e.networkUpdate):null,F=l.C?requestAnimationFrame:v;function b(t){1;(r=F(b),null!==p)&&(y+=g=(t-p)/1e3,_&&(R("fixed"),_.run(g),N("fixed")),w&&(R("net"),w.run(g),N("net")),(T+=g)>A&&(e.update&&(R("update"),e.update(g,y),N("update")),T%=A));p=t,e.render&&(R("render"),e.render(),N("render"))}var D=new Map;function R(e){var t;D.has(e)?t=D.get(e):(t={time:0,ticks:0},D.set(e,t)),t.ticks=c.D4.tick,t.time=(0,u.z)()}function N(e){var t=D.get(e);S[e]+=c.D4.tick-t.ticks,E[e]+=(0,u.z)()-t.time}function L(){p=null,r=F(b),c.D4.tick,(0,u.z)(),(0,u.z)(),(0,u.z)()+h}function I(){cancelAnimationFrame(r)}return{start:L,stop:I}}function v(e){setImmediate((function(){return e(Date.now())}))}var m=function(){function e(t,n){(0,r.Z)(this,e),this.subsequentErrorsLimit=10,this.subsequentErrorsResetLimit=1e3,this.subsequentErrorsShown=0,this.shownErrorPreviously=!1,this.accumulator=0,this.timestep=1/t,this.limit=1e3*this.timestep,this.updatesLimit=t,this.callback=n}return(0,i.Z)(e,[{key:"canRun",value:function(e){return this.accumulator+e>this.timestep}},{key:"run",value:function(e){var t=(0,u.z)(),n=0,r=0;this.accumulator+=e;for(var i=this.accumulator<this.timestep,a=n>this.limit,o=r>this.updatesLimit;!i&&!a&&!o;)this.callback(this.accumulator),this.accumulator-=this.timestep,++r,n=(0,u.z)()-t,i=this.accumulator<this.timestep,a=n>this.limit,o=r>=this.updatesLimit;i?(this.subsequentErrorsShown=0,this.shownErrorPreviously=!1):(this.subsequentErrorsShown<=this.subsequentErrorsLimit||this.subsequentErrorsShown>this.subsequentErrorsResetLimit&&(console.error("FixedTimestep",this.subsequentErrorsResetLimit," subsequent errors catched"),this.subsequentErrorsShown=this.subsequentErrorsLimit-1),this.shownErrorPreviously&&this.subsequentErrorsShown++,this.shownErrorPreviously=!0,this.accumulator=this.accumulator%this.timestep)}}]),e}()},3780:function(e,t,n){"use strict";n.d(t,{n:function(){return P}});var r=n(49182),i=n(39337),a=n(94780),o=n(13987),s=n(29569),l=n(89306),u=n(88203),c=n(95812),f=n(36595),d=n(16090),h=n(483),p=n(82552),v=n(81924),m=n(52020),y=n(47509);function g(e,t){var n;if("undefined"===typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"===typeof e)return x(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return x(e,t)}(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function x(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var A=function(){function e(t,n,i){(0,r.Z)(this,e),this._particleMaterial=new f.UY4,this.tmpVec0=new y.AO,this.tmpVec1=new y.AO,this.tmpVec2=new y.AO,this.tmpQuat0=new y._f,i=i||{},this.scene=t,this.world=n,this.enabled=!1,this._meshes=[],this._material=new f.vBJ({color:65280,wireframe:!0}),this._particleMaterial=new f.UY4({color:16711680,size:10,sizeAttenuation:!1,depthTest:!1}),this._sphereGeometry=new f.Aip(1),this._boxGeometry=new f.nvb(1,1,1),this._planeGeometry=new f.BKK(10,10,10,10),this._particleGeometry=new f.u9r,this._particleGeometry.setFromPoints([new f.Pa4(0,0,0)])}return(0,i.Z)(e,[{key:"setEnabled",value:function(e){this.enabled=e;var t,n=g(this._meshes);try{for(n.s();!(t=n.n()).done;){t.value.visible=this.enabled}}catch(r){n.e(r)}finally{n.f()}}},{key:"update",value:function(){if(this.enabled){for(var e=this.world.bodies,t=this._meshes,n=this.tmpVec0,r=this.tmpQuat0,i=0,a=0;a!==e.length;a++)for(var o=e[a],s=0;s!==o.shapes.length;s++){var l=o.shapes[s];this._updateMesh(i,o,l);var u=t[i];u&&(o.quaternion.vmult(o.shapeOffsets[s],n),o.position.vadd(n,n),o.quaternion.mult(o.shapeOrientations[s],r),u.position.x=n.x,u.position.y=n.y,u.position.z=n.z,u.quaternion.x=r.x,u.quaternion.y=r.y,u.quaternion.z=r.z,u.quaternion.w=r.w),i++}for(var c=i;c<t.length;c++){var f=t[c];f&&this.scene.remove(f)}t.length=i}}},{key:"_updateMesh",value:function(e,t,n){var r=this._meshes[e];this._typeMatch(r,n)||(r&&this.scene.remove(r),r=this._meshes[e]=this._createMesh(n)),this._scaleMesh(r,n)}},{key:"_typeMatch",value:function(e,t){if(!e)return!1;var n=e.geometry;return n instanceof f.xo$&&t instanceof y.aL||n instanceof f.DvJ&&t instanceof y.xu||n instanceof f._12&&t instanceof y.JO||n.id===t.id&&t instanceof y.YD||n.id===t.id&&t instanceof y.np||n.id===t.id&&t instanceof y.f4}},{key:"_createMesh",value:function(e){var t,n,r,i,a,o=this._material,s=[];switch(e.type){case y.bn.types.SPHERE:t=new f.Kj0(this._sphereGeometry,o);break;case y.bn.types.BOX:t=new f.Kj0(this._boxGeometry,o);break;case y.bn.types.PLANE:t=new f.Kj0(this._planeGeometry,o);break;case y.bn.types.PARTICLE:t=new f.woe(this._particleGeometry,this._particleMaterial);break;case y.bn.types.CONVEXPOLYHEDRON:n=new f.u9r,s=[];for(var l=0;l<e.vertices.length;l+=1){var u=e.vertices[l];s.push(new f.Pa4(u.x,u.y,u.z))}n.setFromPoints(s),t=new f.Kj0(n,o),e.id=n.id;break;case y.bn.types.TRIMESH:console.log("creatin trimesh debug"),n=new f.u9r,s=[];for(var c=0;c<e.vertices.length;c+=3)s.push(new f.Pa4(e.vertices[c],e.vertices[c+1],e.vertices[c+2]));n.setFromPoints(s),n.setIndex(Array.from(e.indices)),t=new f.Kj0(n,o),e.id=n.id;break;case y.bn.types.HEIGHTFIELD:n=new f.u9r,r=this.tmpVec0,i=this.tmpVec1,a=this.tmpVec2;for(var d=0;d<e.data.length-1;d++)for(var h=0;h<e.data[d].length-1;h++)for(var p=0;p<2;p++)e.getConvexTrianglePillar(d,h,0===p),r.copy(e.pillarConvex.vertices[0]),i.copy(e.pillarConvex.vertices[1]),a.copy(e.pillarConvex.vertices[2]),r.vadd(e.pillarOffset,r),i.vadd(e.pillarOffset,i),a.vadd(e.pillarOffset,a),s.push(new f.Pa4(r.x,r.y,r.z),new f.Pa4(i.x,i.y,i.z),new f.Pa4(a.x,a.y,a.z));n.setFromPoints(s),t=new f.Kj0(n,o),e.id=n.id;break;default:t=new f.Kj0}return t&&t.geometry&&this.scene.add(t),t}},{key:"_scaleMesh",value:function(e,t){switch(t.type){case y.bn.types.SPHERE:var n=t.radius;e.scale.set(n,n,n);break;case y.bn.types.BOX:var r=t.halfExtents;e.scale.copy(new f.Pa4(r.x,r.y,r.z)),e.scale.multiplyScalar(2);break;case y.bn.types.CONVEXPOLYHEDRON:e.scale.set(1,1,1);break;case y.bn.types.TRIMESH:var i=t.scale;e.scale.copy(new f.Pa4(i.x,i.y,i.z));break;case y.bn.types.HEIGHTFIELD:e.scale.set(1,1,1)}}}]),e}(),T=n(94223),S=n(34452);function E(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,l.Z)(e);if(t){var i=(0,l.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,s.Z)(this,n)}}var P=function(e){(0,o.Z)(n,e);var t=E(n);function n(){var e;return(0,r.Z)(this,n),e=t.call(this),n.instance=(0,a.Z)(e),e.physicsDebugRenderer=new A(h.D4.scene,T.F.physicsWorld),e.helpersByEntity={viewVector:new Map,velocityArrow:new Map},S.NL.instance.addEventListener(n.EVENTS.TOGGLE_AVATAR,(function(t){var n=t.enabled;e.helpersByEntity.viewVector.forEach((function(e){e.visible=n})),e.helpersByEntity.velocityArrow.forEach((function(e){e.visible=n}))})),S.NL.instance.addEventListener(n.EVENTS.TOGGLE_PHYSICS,(function(t){var n=t.enabled;e.physicsDebugRenderer.setEnabled(n)})),e}return(0,i.Z)(n,[{key:"execute",value:function(e,t){var n,r,i,a,o,s,l,u=this;null===(r=null===(n=this.queryResults.characterDebug)||void 0===n?void 0:n.added)||void 0===r||r.forEach((function(e){var t=(0,d.Xr)(e,c.rl),n=new f.Pa4(0,2,0);if(!t||!t.viewVector)return console.warn("actor.viewVector is null");var r=new f.tGC(t.viewVector.clone().normalize(),n,.5,16776960);r.visible=!1,h.D4.scene.add(r),u.helpersByEntity.viewVector.set(e,r);var i=new f.tGC(new f.Pa4,new f.Pa4(0,0,0),.5,255);i.visible=!1,h.D4.scene.add(i),u.helpersByEntity.velocityArrow.set(e,i)})),null===(a=null===(i=this.queryResults.characterDebug)||void 0===i?void 0:i.removed)||void 0===a||a.forEach((function(e){var t=u.helpersByEntity.viewVector.get(e);h.D4.scene.remove(t);var n=u.helpersByEntity.velocityArrow.get(e);h.D4.scene.remove(n)})),null===(s=null===(o=this.queryResults.characterDebug)||void 0===o?void 0:o.all)||void 0===s||s.forEach((function(e){var t=(0,d.Xr)(e,c.rl),n=(0,d.Xr)(e,p.U),r=u.helpersByEntity.viewVector.get(e);null!=r&&(r.setDirection(t.viewVector.clone().setY(0).normalize()),r.position.copy(n.position));var i=u.helpersByEntity.velocityArrow.get(e);null!=i&&(i.setDirection(t.velocity.clone().normalize()),i.setLength(t.velocity.length()),i.position.copy(n.position))})),null===(l=this.queryResults.boundingBoxComponent)||void 0===l||l.added.forEach((function(e){var t=(0,d.Xr)(e,v.k);if(t.boxArray.length)t.dynamic&&t.boxArray.forEach((function(e,t){var n=new f.fQA(e);n.visible=!1,h.D4.scene.add(n)}));else{var n=new f.ZzF;if(n.copy(t.box),t.dynamic){var r=(0,d.Xr)(e,m.S);n.applyMatrix4(r.value.matrixWorld)}var i=new f.GQ(n);i.visible=!1,h.D4.scene.add(i)}})),this.physicsDebugRenderer.update()}}]),n}(u.x);P.EVENTS={TOGGLE_PHYSICS:"DEBUG_HELPERS_SYSTEM_TOGGLE_PHYSICS",TOGGLE_AVATAR:"DEBUG_HELPERS_SYSTEM_TOGGLE_AVATAR"},P.queries={characterDebug:{components:[c.rl],listen:{added:!0,removed:!0}},boundingBoxComponent:{components:[v.k],listen:{added:!0,removed:!0}}}},51462:function(e,t,n){"use strict";n.d(t,{$6:function(){return o},Cr:function(){return l}});var r=n(483),i=n(46365),a=n(17356);function o(e,t){if(!e.isSystem)throw new Error("System '".concat(e.name,"' does not extend 'System' class"));void 0!==s(e)&&console.warn("System '".concat(e.name,"' already registered."));var n=new e(t);return r.D4.systems.push(n),n.execute&&(r.D4.systemsToExecute.push(n),r.D4.systemsToExecute.sort((function(e,t){return e.priority-t.priority||e.order-t.order}))),n}function s(e){return r.D4.systems.find((function(t){return t instanceof e}))}function l(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:a.V.Free;if(e.initialized&&r===e.updateType){var o=(0,i.z)();e.execute(t,n),e.executeTime=(0,i.z)()-o,e.clearEventQueues()}}},77138:function(e,t,n){"use strict";n.d(t,{s:function(){return f}});var r=n(49182),i=n(13987),a=n(29569),o=n(89306),s=n(36595),l=n(65648),u=n(52288);function c(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,o.Z)(e);if(t){var i=(0,o.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,a.Z)(this,n)}}var f=function(e){(0,i.Z)(n,e);var t=c(n);function n(){var e;return(0,r.Z)(this,n),(e=t.apply(this,arguments)).headPosition=new s.Pa4(0,0,0),e.headRotation=new s._fP,e.controllerLeft=null,e.controllerRight=null,e.controllerPositionLeft=new s.Pa4,e.controllerPositionRight=new s.Pa4,e.controllerRotationLeft=new s._fP,e.controllerRotationRight=new s._fP,e.controllerGripLeft=null,e.controllerGripRight=null,e.leftHandPhysicsBody=null,e.rightHandPhysicsBody=null,e}return n}(l.w);f._schema={headPosition:{type:u.Yk.Ref,default:null},headRotation:{type:u.Yk.Ref,default:null},controllerLeft:{type:u.Yk.Ref,default:null},controllerRight:{type:u.Yk.Ref,default:null},controllerPositionLeft:{type:u.Yk.Ref,default:null},controllerPositionRight:{type:u.Yk.Ref,default:null},controllerRotationLeft:{type:u.Yk.Ref,default:null},controllerRotationRight:{type:u.Yk.Ref,default:null},controllerGripLeft:{type:u.Yk.Ref,default:null},controllerGripRight:{type:u.Yk.Ref,default:null},leftHandPhysicsBody:{type:u.Yk.Ref,default:null},rightHandPhysicsBody:{type:u.Yk.Ref,default:null}}},6290:function(e,t,n){"use strict";n.d(t,{d:function(){return V}});var r=n(15194),i=n(49182),a=n(39337),o=n(13987),s=n(29569),l=n(89306),u=n(483),c=n(36595),f=n(77094),d=n(97762),h=n(45744),p=n(47396);function v(e,t){return t>=1||e<t&&e>-t?0:Math.sign(e)*(Math.abs(e)-t)/(1-t)}var m,y,g,x,A,T,S,E,P,_=n(5418),w=n(5450),F=function(e){g.buttons[e.index].touched!==(u.D4.gamepadButtons[e.index]===f.E.ON)&&(m.data.set(D[e.index],{type:_.n.BUTTON,value:g.buttons[e.index].touched?f.E.ON:f.E.OFF,lifecycleState:g.buttons[e.index].touched?d.q.STARTED:d.q.ENDED}),u.D4.gamepadButtons[e.index]=g.buttons[e.index].touched?1:0)},b=function(e){var t=x=2*e.inputIndex,n=x+1;if(A=v(g.axes[t],u.D4.gamepadThreshold),T=v(g.axes[n],u.D4.gamepadThreshold),e.mappedInputValue===w.Q.MOVEMENT_PLAYERONE){var r=A;A=-T,T=-r}S=u.D4.gamepadInput[t],E=u.D4.gamepadInput[n],A===S&&T===E||(u.D4.inputState.set(e.mappedInputValue,{type:_.n.TWODIM,value:[A,T]}),u.D4.gamepadInput[t]=A,u.D4.gamepadInput[n]=T)},D={0:h.p6.A,1:h.p6.B,2:h.p6.X,3:h.p6.Y,4:h.p6.LBumper,5:h.p6.RBumper,6:h.p6.LTrigger,7:h.p6.RTrigger,8:h.p6.Back,9:h.p6.Start,10:h.p6.LStick,11:h.p6.RString,12:h.p6.DPad1,13:h.p6.DPad2,14:h.p6.DPad3,15:h.p6.DPad4},R=[0,0],N=Date.now(),L=function(e){var t,n,r=X(e.event.touches[0].clientX,e.event.touches[0].clientY,window.innerWidth,window.innerHeight),i=[r.x,r.y];if(1==e.event.touches.length){var a=h.Md.Touch1Position,o=u.D4.inputState.has(a);u.D4.inputState.set(a,{type:_.n.TWODIM,value:i,lifecycleState:o?d.q.CHANGED:d.q.STARTED});var s="touchstart"===e.event.type,l=h.Md.Touch1Movement,f=[0,0];!s&&R&&(f[0]=2*(i[0]-R[0]),f[1]=2*(i[1]-R[1])),R=i,u.D4.inputState.set(l,{type:_.n.TWODIM,value:f,lifecycleState:u.D4.inputState.has(l)?d.q.CHANGED:d.q.STARTED})}else if(e.event.touches.length>=2){var p=X(e.event.touches[1].clientX,e.event.touches[1].clientY,window.innerWidth,window.innerHeight),v=[p.x,p.y];u.D4.inputState.set(h.Md.Touch1Position,{type:_.n.TWODIM,value:i,lifecycleState:d.q.CHANGED}),u.D4.inputState.set(h.Md.Touch2Position,{type:_.n.TWODIM,value:v,lifecycleState:d.q.CHANGED});var m=h.Md.Scale;if(function(){var e,t,n,r;return Boolean((null===(e=u.D4.inputState.get(h.ez.Left))||void 0===e?void 0:e.value[0])||(null===(t=u.D4.inputState.get(h.ez.Left))||void 0===t?void 0:t.value[1])||(null===(n=u.D4.inputState.get(h.ez.Right))||void 0===n?void 0:n.value[0])||(null===(r=u.D4.inputState.get(h.ez.Right))||void 0===r?void 0:r.value[1]))}()){if(u.D4.inputState.has(m)){var y=u.D4.inputState.get(m).value;u.D4.inputState.set(m,{type:_.n.ONEDIM,value:y,lifecycleState:d.q.ENDED})}return}var g=null===(t=u.D4.prevInputState.get(h.Md.Touch1Position))||void 0===t?void 0:t.value,x=null===(n=u.D4.prevInputState.get(h.Md.Touch2Position))||void 0===n?void 0:n.value;if("touchstart"===e.event.type||!g||!x)return;if(!u.D4.inputState.has(h.Md.Touch1Position)||!u.D4.inputState.has(h.Md.Touch2Position))return void console.warn("handleTouchScale requires POINTER1_POSITION and POINTER2_POSITION to be set and updated.");var A=(new c.FM8).fromArray(u.D4.inputState.get(h.Md.Touch1Position).value),T=(new c.FM8).fromArray(u.D4.inputState.get(h.Md.Touch2Position).value),S=(new c.FM8).fromArray(g),E=(new c.FM8).fromArray(x),P=A.distanceTo(T),w=.01*(S.distanceTo(E)-P),F=Math.sign(w);if(u.D4.inputState.has(m)){var b=u.D4.inputState.get(m).value;u.D4.inputState.set(m,{type:_.n.ONEDIM,value:b+F,lifecycleState:d.q.CHANGED})}else u.D4.inputState.set(m,{type:_.n.ONEDIM,value:F,lifecycleState:d.q.STARTED})}},I=function(e){var t=e.event,n=e.value;if(t.targetTouches.length){var r=h.Md.Touch;if(!r)return;if(n===f.E.ON){if(1==t.targetTouches.length){var i=Date.now(),a=h.Md.DoubleTouch;i-N<200?u.D4.inputState.has(a)?u.D4.inputState.set(a,{type:_.n.BUTTON,value:f.E.ON,lifecycleState:d.q.CONTINUED}):u.D4.inputState.set(a,{type:_.n.BUTTON,value:f.E.ON,lifecycleState:d.q.STARTED}):u.D4.inputState.has(a)&&u.D4.inputState.set(a,{type:_.n.BUTTON,value:f.E.OFF,lifecycleState:d.q.ENDED}),N=i}if(u.D4.inputState.has(r)&&u.D4.inputState.get(r).value===n)return void(u.D4.inputState.get(r).lifecycleState!==d.q.CONTINUED&&u.D4.inputState.set(r,{type:_.n.BUTTON,value:n,lifecycleState:d.q.CONTINUED}));u.D4.inputState.set(r,{type:_.n.BUTTON,value:n,lifecycleState:d.q.STARTED})}else u.D4.inputState.set(r,{type:_.n.BUTTON,value:n,lifecycleState:d.q.ENDED})}else{var o=h.Md.DoubleTouch;u.D4.inputState.has(o)&&u.D4.inputState.set(o,{type:_.n.BUTTON,value:f.E.OFF,lifecycleState:d.q.ENDED})}};function k(e){var t=e.event.detail.button;if(e.value===f.E.ON){if(u.D4.inputState.has(t)&&u.D4.inputState.get(t).value===e.value)return void(u.D4.inputState.get(t).lifecycleState!==d.q.CONTINUED&&u.D4.inputState.set(t,{type:_.n.BUTTON,value:e.value,lifecycleState:d.q.CONTINUED}));u.D4.inputState.set(t,{type:_.n.BUTTON,value:e.value,lifecycleState:d.q.STARTED})}else u.D4.inputState.set(t,{type:_.n.BUTTON,value:e.value,lifecycleState:d.q.ENDED})}var M=function(e){var t=[0,0];t[0]=e.event.clientX/window.innerWidth*2-1,t[1]=e.event.clientY/window.innerHeight*-2+1,e.value===f.E.ON?(u.D4.inputState.set(e.event.button,{type:_.n.BUTTON,value:e.value,lifecycleState:d.q.STARTED}),u.D4.inputState.set(h.kT.MouseClickDownPosition,{type:_.n.TWODIM,value:t,lifecycleState:d.q.STARTED})):(u.D4.inputState.set(e.event.button,{type:_.n.BUTTON,value:e.value,lifecycleState:d.q.ENDED}),u.D4.inputState.set(h.kT.MouseClickDownPosition,{type:_.n.TWODIM,value:t,lifecycleState:d.q.ENDED}),u.D4.inputState.set(h.kT.MouseClickDownTransformRotation,{type:_.n.TWODIM,value:t,lifecycleState:d.q.ENDED}))},O=function(e){var t=e.event.target;if("INPUT"!==(null===t||void 0===t?void 0:t.tagName)&&"SELECT"!==(null===t||void 0===t?void 0:t.tagName)&&"TEXTAREA"!==(null===t||void 0===t?void 0:t.tagName)){var n=e.event.key.toLowerCase();if(e.value===f.E.ON){if(u.D4.inputState.has(n)&&u.D4.inputState.get(n).value===e.value)return void(u.D4.inputState.get(n).lifecycleState!==d.q.CONTINUED&&u.D4.inputState.set(n,{type:_.n.BUTTON,value:e.value,lifecycleState:d.q.CONTINUED}));u.D4.inputState.set(n,{type:_.n.BUTTON,value:e.value,lifecycleState:d.q.STARTED})}else u.D4.inputState.set(n,{type:_.n.BUTTON,value:e.value,lifecycleState:d.q.ENDED})}},C={37:1,38:1,39:1,40:1};function U(e){e.preventDefault()}function B(e){if(C[e.keyCode])return U(e),!1}function X(e,t,n,r){return{x:e/n*2-1,y:t/r*-2+1}}var Z={onAdded:[{behavior:function(){p.C&&(window.addEventListener("DOMMouseScroll",U,!1),window.addEventListener("keydown",B,!1))}}],onRemoved:[{behavior:function(){p.C&&(window.removeEventListener("DOMMouseScroll",U,!1),window.removeEventListener("keydown",B,!1))}}],eventBindings:{contextmenu:[{behavior:function(e){e.event.preventDefault()}}],mousemove:[{behavior:function(e){var t=X(e.event.clientX,e.event.clientY,window.innerWidth,window.innerHeight),n=[t.x,t.y],r=h.kT.MousePosition,i=h.kT.MouseMovement,a=h.kT.MouseClickDownMovement;u.D4.inputState.set(r,{type:_.n.TWODIM,value:n,lifecycleState:u.D4.inputState.has(r)?d.q.CHANGED:d.q.STARTED});var o=function(e,t,n,r){return{x:e/(n/2),y:-t/(r/2)}}(e.event.movementX,e.event.movementY,window.innerWidth,window.innerHeight),s=[o.x,o.y];u.D4.inputState.set(i,{type:_.n.TWODIM,value:s,lifecycleState:u.D4.inputState.has(i)?d.q.CHANGED:d.q.STARTED});var l=u.D4.inputState.get(h.kT.MouseClickDownPosition);l&&l.lifecycleState!==d.q.ENDED&&u.D4.inputState.set(a,{type:_.n.TWODIM,value:s,lifecycleState:u.D4.inputState.has(a)?d.q.CHANGED:d.q.STARTED})}}],mouseup:[{behavior:M,args:{value:f.E.OFF}}],mousedown:[{behavior:M,args:{value:f.E.ON}}],wheel:[{behavior:function(e){var t,n=null===(t=e.event)||void 0===t?void 0:t.deltaY;if(u.D4.inputState.has(h.kT.MouseScroll)){var r=u.D4.inputState.get(h.kT.MouseScroll).value;if(r===n)return void u.D4.inputState.set(h.kT.MouseScroll,{type:_.n.ONEDIM,value:n,lifecycleState:d.q.UNCHANGED});u.D4.inputState.set(h.kT.MouseScroll,{type:_.n.ONEDIM,value:r+Math.sign(n),lifecycleState:d.q.CHANGED})}else u.D4.inputState.set(h.kT.MouseScroll,{type:_.n.ONEDIM,value:Math.sign(n),lifecycleState:d.q.STARTED})},passive:!0}],mouseleave:[{behavior:function(e){if([h.kT.LeftButton,h.kT.MiddleButton,h.kT.RightButton].forEach((function(e){u.D4.inputState.has(e)&&u.D4.inputState.set(e,{type:_.n.BUTTON,value:f.E.OFF,lifecycleState:d.q.ENDED})})),u.D4.inputState.has(h.kT.MouseClickDownPosition)){var t=u.D4.inputState.get(h.kT.MouseClickDownPosition).value;0===t[0]&&0===t[1]||u.D4.inputState.set(h.kT.MouseClickDownPosition,{type:_.n.TWODIM,value:[0,0],lifecycleState:d.q.ENDED})}if(u.D4.inputState.has(h.kT.MouseClickDownTransformRotation)){var n=u.D4.inputState.get(h.kT.MouseClickDownTransformRotation).value;0===n[0]&&0===n[1]||u.D4.inputState.set(h.kT.MouseClickDownTransformRotation,{type:_.n.TWODIM,value:[0,0],lifecycleState:d.q.ENDED})}}}],touchstart:[{behavior:I,passive:!0,args:{value:f.E.ON}},{behavior:L,passive:!0}],touchend:[{behavior:I,passive:!0,args:{value:f.E.OFF}}],touchcancel:[{behavior:I,passive:!0,args:{value:f.E.OFF}}],touchmove:[{behavior:L,passive:!0}],keyup:[{behavior:O,element:"document",args:{value:f.E.OFF}}],keydown:[{behavior:O,element:"document",args:{value:f.E.ON}}],gamepadconnected:[{behavior:function(e){console.log("A gamepad connected:",e.event.gamepad,e.event.gamepad.mapping),"standard"!==e.event.gamepad.mapping&&console.error("Non-standard gamepad mapping detected, it could be handled not properly."),u.D4.gamepadConnected=!0,g=e.event.gamepad;for(var t=0;t<g.buttons.length;t++)"undefined"===typeof u.D4.gamepadButtons[t]&&(u.D4.gamepadButtons[t]=0)},element:"window"}],gamepaddisconnected:[{behavior:function(e){if(console.log("A gamepad disconnected:",e.event.gamepad),u.D4.gamepadConnected=!1,m.schema&&u.D4.gamepadButtons)for(var t=0;t<u.D4.gamepadButtons.length;t++)u.D4.gamepadButtons[t]===f.E.ON&&m.data.set(D[t],{type:_.n.BUTTON,value:f.E.OFF}),u.D4.gamepadButtons[t]=0},element:"window"}],stickmove:[{behavior:function(e){var t=e.event.detail,n=t.stick,r=t.value;if(n){var i=[r.x,r.y,r.angleRad];if(u.D4.inputState.has(n)){var a=u.D4.inputState.get(n);JSON.stringify(a)!==JSON.stringify(i)&&u.D4.inputState.set(n,{type:_.n.TWODIM,value:i,lifecycleState:d.q.CHANGED})}else u.D4.inputState.set(n,{type:_.n.TWODIM,value:i,lifecycleState:d.q.STARTED})}},element:"document"}],mobilegamepadbuttondown:[{behavior:k,element:"document",args:{value:f.E.ON}}],mobilegamepadbuttonup:[{behavior:k,element:"document",args:{value:f.E.OFF}}]}},z=n(88203),G=n(17356),Y=n(34452);function Q(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function H(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,l.Z)(e);if(t){var i=(0,l.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,s.Z)(this,n)}}var V=function(e){(0,o.Z)(n,e);var t=H(n);function n(e){var a,o;return(0,i.Z)(this,n),(a=t.call(this,e)).updateType=G.V.Fixed,a.needSend=!1,a.switchId=1,a.boundListeners=[],a.onProcessInput=e.onProcessInput,Z.onAdded.forEach((function(e){e.behavior()})),null===(o=Object.keys(Z.eventBindings))||void 0===o||o.forEach((function(e){Z.eventBindings[e].forEach((function(t){var n,i=null!==(n=u.D4.viewportElement)&&void 0!==n?n:document;if(t.element)switch(t.element){case"window":i=window;break;case"document":i=document;break;case"viewport":default:i=u.D4.viewportElement}var o=i;if(o){var s=function(e){return t.behavior(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Q(Object(n),!0).forEach((function(t){(0,r.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Q(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({event:e},t.args))};return t.passive&&function(){var e=!1;try{var t=Object.defineProperty({},"passive",{get:function(){e=!0}});window.addEventListener("testPassive",null,t),window.removeEventListener("testPassive",null,t)}catch(n){}return e}()?o.addEventListener(e,s,{passive:t.passive}):o.addEventListener(e,s),a.boundListeners.push({domElement:o,eventName:e,listener:s}),[o,e,s]}return console.warn("DOM Element not found:",o),!1}))})),a}return(0,a.Z)(n,[{key:"dispose",value:function(){Z.onRemoved.forEach((function(e){e.behavior()})),this.boundListeners.forEach((function(e){var t=e.domElement,n=e.eventName,r=e.listener;t.removeEventListener(n,r)}))}},{key:"execute",value:function(e){!function(){if(u.D4.gamepadConnected)for(y=navigator.getGamepads(),P=0;P<y.length;P++){if(!y[P])return;if((g=y[P]).axes&&(g.axes.length>=2&&b({gamepad:g,inputIndex:0,mappedInputValue:h.ez.Left}),g.axes.length>=4&&b({gamepad:g,inputIndex:1,mappedInputValue:h.ez.Right})),!g.buttons)return;for(P=0;P<g.buttons.length;P++)F({gamepad:g,index:P,mappedInputValue:P})}}();var t=new Map;u.D4.inputState.forEach((function(e,t){u.D4.prevInputState.has(t)&&(e.type!==_.n.BUTTON?e.lifecycleState!==d.q.ENDED&&(e.lifecycleState=JSON.stringify(e.value)===JSON.stringify(u.D4.prevInputState.get(t).value)?d.q.UNCHANGED:d.q.CHANGED,u.D4.inputState.set(t,e)):u.D4.prevInputState.get(t).lifecycleState===d.q.STARTED&&e.lifecycleState===d.q.STARTED&&(e.lifecycleState=d.q.CONTINUED,u.D4.inputState.set(t,e)))})),u.D4.inputState.forEach((function(e,n){var r;e.lifecycleState===d.q.UNCHANGED&&(null===(r=u.D4.prevInputState.get(n))||void 0===r?void 0:r.lifecycleState)===d.q.UNCHANGED||t.set(n,{type:e.type,value:e.value,lifecycleState:e.lifecycleState})})),Y.NL.instance.dispatchEvent({type:n.EVENTS.PROCESS_INPUT,data:t}),u.D4.prevInputState.clear(),u.D4.inputState.forEach((function(e,t){u.D4.prevInputState.set(t,e),e.lifecycleState===d.q.ENDED&&u.D4.inputState.delete(t)}))}}]),n}(z.x);V.EVENTS={PROCESS_INPUT:"CLIENT_INPUT_SYSTEM_PROCESS_EVENT"}},44590:function(e,t,n){"use strict";n.d(t,{V:function(){return O}});var r=n(15194),i=n(77866),a=n(49182),o=n(39337),s=n(13987),l=n(29569),u=n(89306),c=n(77094),f=n(97762),d=n(47396),h=n(88203),p=n(86463),v=n(16090),m=n(17356),y=n(61467),g=n(30999),x=n(77301),A=n(86433),T=n(95812),S=n(92226),E=n(46104),P=n(94223),_=n(77138),w=n(7331),F=n(93228),b=n(5418),D=n(5450),R=n(41912),N=n(34452),L=n(6290);function I(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function k(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?I(Object(n),!0).forEach((function(t){(0,r.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):I(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function M(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,u.Z)(e);if(t){var i=(0,u.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,l.Z)(this,n)}}var O=function(e){(0,s.Z)(n,e);var t=M(n);function n(e){var r,i=e.useWebXR;return(0,a.Z)(this,n),(r=t.call(this)).updateType=m.V.Fixed,r.needSend=!1,r.switchId=1,r.useWebXR=!1,r.stateUpdates=[],r.useWebXR=i,d.C&&(r.leftControllerId=0,r.rightControllerId=1),N.NL.instance.addEventListener(S.FJ.FACE_INPUT,(function(e){var t=e.detection;(0,S.$6)(y.Z.instance.localClientEntity,t)})),N.NL.instance.addEventListener(S.FJ.LIP_INPUT,(function(e){var t=e.pucker,n=e.widen,r=e.open;(0,S.ju)(y.Z.instance.localClientEntity,t,n,r)})),N.NL.instance.addEventListener(L.d.EVENTS.PROCESS_INPUT,(function(e){var t=e.data;r.stateUpdates.push(t)})),r}return(0,o.Z)(n,[{key:"dispose",value:function(){}},{key:"execute",value:function(e){var t,r,a,o,s,l,u=this;if(this.useWebXR&&(null===(t=this.queryResults.controllersComponent.added)||void 0===t||t.forEach((function(e){return function(e){var t=(0,v.Ei)(e,_.s);console.warn(t),t.leftHandPhysicsBody=(0,E.bz)("sphere",t.controllerPositionLeft,t.controllerRotationLeft,{x:.08,y:.08,z:.08},null),t.rightHandPhysicsBody=(0,E.bz)("sphere",t.controllerPositionRight,t.controllerRotationRight,{x:.08,y:.08,z:.08},null)}(e)})),null===(r=this.queryResults.controllersComponent.removed)||void 0===r||r.forEach((function(e){return(t={leftControllerPhysicsBody:u.leftControllerId,rightControllerPhysicsBody:u.rightControllerId}).leftControllerPhysicsBody&&(P.F.physicsWorld.removeBody(t.leftControllerPhysicsBody),P.F.physicsWorld.removeBody(t.rightControllerPhysicsBody)),void console.warn(t);var t})),null===(a=this.queryResults.controllersComponent.all)||void 0===a||a.forEach((function(e){var t=(0,v.Xr)(e,_.s);null!==t.leftHandPhysicsBody&&null!==t.rightHandPhysicsBody&&(u.leftControllerId=t.leftHandPhysicsBody,u.rightControllerId=t.rightHandPhysicsBody),t.leftHandPhysicsBody.position.set(t.controllerPositionLeft.x,t.controllerPositionLeft.y,t.controllerPositionLeft.z),t.rightHandPhysicsBody.position.set(t.controllerPositionRight.x,t.controllerPositionRight.y,t.controllerPositionRight.z),t.leftHandPhysicsBody.quaternion.set(t.controllerRotationLeft.x,t.controllerRotationLeft.y,t.controllerRotationLeft.z,t.controllerRotationLeft.w),t.rightHandPhysicsBody.quaternion.set(t.controllerRotationRight.x,t.controllerRotationRight.y,t.controllerRotationRight.z,t.controllerRotationRight.w)}))),n.inputReceiverEntity){var d=(0,i.Z)(this.stateUpdates);this.stateUpdates=[],null===d||void 0===d||d.forEach((function(t){var r,i,a,o=(0,v.Ei)(n.inputReceiverEntity,w.I);t.forEach((function(e,t){o.schema.inputMap.has(t)&&o.data.set(o.schema.inputMap.get(t),e)})),o.data.forEach((function(e,t){o.prevData.has(t)&&(e.type!==b.n.BUTTON?e.lifecycleState!==f.q.ENDED&&o.prevData.has(t)&&(JSON.stringify(e.value)===JSON.stringify(o.prevData.get(t).value)?e.lifecycleState=f.q.UNCHANGED:e.lifecycleState=f.q.CHANGED,o.data.set(t,e)):o.prevData.get(t).lifecycleState===f.q.STARTED&&e.lifecycleState===f.q.STARTED&&(e.lifecycleState=f.q.CONTINUED,o.data.set(t,e)))})),o.data.forEach((function(t,r){var i,a,s,l,u,d,h;if(o.schema.inputButtonBehaviors[r])t.value===c.E.ON?(void 0===t.lifecycleState&&(t.lifecycleState=f.q.STARTED),t.lifecycleState===f.q.STARTED?null===(i=o.schema.inputButtonBehaviors[r].started)||void 0===i||i.forEach((function(t){t.behavior(n.inputReceiverEntity,t.args,e)})):t.lifecycleState===f.q.CONTINUED?null===(a=o.schema.inputButtonBehaviors[r].continued)||void 0===a||a.forEach((function(t){return t.behavior(n.inputReceiverEntity,t.args,e)})):console.error("Unexpected lifecycleState",r,t.lifecycleState,f.q[t.lifecycleState],"prev",f.q[null===(s=o.prevData.get(r))||void 0===s?void 0:s.lifecycleState])):null===(l=o.schema.inputButtonBehaviors[r].ended)||void 0===l||l.forEach((function(t){return t.behavior(n.inputReceiverEntity,t.args,e)}));else if(o.schema.inputAxisBehaviors[r])switch(void 0===t.lifecycleState&&(t.lifecycleState=f.q.STARTED),t.lifecycleState){case f.q.STARTED:null===(u=o.schema.inputAxisBehaviors[r].started)||void 0===u||u.forEach((function(t){return t.behavior(n.inputReceiverEntity,t.args,e)}));break;case f.q.CHANGED:null===(d=o.schema.inputAxisBehaviors[r].changed)||void 0===d||d.forEach((function(t){t.behavior(n.inputReceiverEntity,t.args,e)}));break;case f.q.UNCHANGED:null===(h=o.schema.inputAxisBehaviors[r].unchanged)||void 0===h||h.forEach((function(t){return t.behavior(n.inputReceiverEntity,t.args,e)}));break;case f.q.ENDED:console.warn("Patch fix, need to handle properly: ",f.q.ENDED);break;default:console.error("Unexpected lifecycleState",t.lifecycleState,f.q[t.lifecycleState])}})),o.prevData.clear(),o.data.forEach((function(e,t){o.prevData.set(t,e)}));var s=!1;(0,v.tu)(y.Z.instance.networkObjects[y.Z.instance.localAvatarNetworkId].component.entity,F.$)||u.needSend?(0,v.tu)(y.Z.instance.networkObjects[y.Z.instance.localAvatarNetworkId].component.entity,F.$)&&u.needSend&&(u.needSend=!1,s=!0):(u.needSend=!0,s=!0,u.switchId=(0,v.Xr)(n.inputReceiverEntity,x.H).networkId),o.lastData.clear(),o.data.forEach((function(e,t){return o.lastData.set(t,e)}));var l=null===(r=g.j.instance)||void 0===r?void 0:r.get();if(void 0!==l){var d={networkId:y.Z.instance.localAvatarNetworkId,buttons:[],axes1d:[],axes2d:[],axes6DOF:[],viewVector:{x:0,y:0,z:0},snapShotTime:null!==(i=l.time-y.Z.instance.timeSnaphotCorrection)&&void 0!==i?i:0,switchInputs:s?u.switchId:0};o.data.forEach((function(e,t){e.type===b.n.BUTTON?d.buttons.push({input:t,value:e.value,lifecycleState:e.lifecycleState}):e.type===b.n.ONEDIM?d.axes1d.push({input:t,value:e.value,lifecycleState:e.lifecycleState}):e.type===b.n.TWODIM?d.axes2d.push({input:t,value:e.value,lifecycleState:e.lifecycleState}):e.type===b.n.SIXDOF&&(d.axes6DOF.push({input:t,x:e.value.x,y:e.value.y,z:e.value.z,qX:e.value.qX,qY:e.value.qX,qZ:e.value.qZ,qW:e.value.qW}),console.log("*********** Pushing 6DOF input from client input system"))}));var h=(0,v.Ei)(n.inputReceiverEntity,T.rl);if(h){var p=(null===(a=o.data.get(D.Q.WALK))||void 0===a?void 0:a.value)===c.E.ON;h.moveSpeed=p?T.W:T.CT,d.viewVector.x=h.viewVector.x,d.viewVector.y=h.viewVector.y,d.viewVector.z=h.viewVector.z}var m=A.DA.toBuffer(d);N.NL.instance.dispatchEvent({type:R.T.EVENTS.SEND_DATA,buffer:m},!1,[m]),o.data.forEach((function(e,t){e.type===b.n.BUTTON&&e.lifecycleState===f.q.ENDED&&o.data.delete(t)}))}else o.data.forEach((function(e,t){e.type===b.n.BUTTON&&e.lifecycleState===f.q.ENDED&&o.data.delete(t)}))}))}null===(o=this.queryResults.localClientInput.added)||void 0===o||o.forEach((function(e){if(n.inputReceiverEntity=e,u._inputComponent=(0,v.Xr)(e,w.I),void 0===u._inputComponent)return console.warn("Tried to execute on a newly added input component, but it was undefined");u._inputComponent.schema.onAdded.forEach((function(t){t.behavior(e,k({},t.args))}))})),this.queryResults.localClientInput.removed.forEach((function(t){if(u._inputComponent=(0,v.Xr)(t,w.I),void 0===u._inputComponent)return console.warn("Tried to execute on a newly added input component, but it was undefined");u._inputComponent.data.size&&u._inputComponent.data.forEach((function(n,r){var i;n.type===b.n.BUTTON&&u._inputComponent.schema.inputButtonBehaviors[r]&&(n.lifecycleState!==f.q.ENDED&&(null===(i=u._inputComponent.schema.inputButtonBehaviors[r].ended)||void 0===i||i.forEach((function(n){return n.behavior(t,n.args,e)}))),u._inputComponent.data.delete(r))}))})),null===(s=this.queryResults.networkClientInput.added)||void 0===s||s.forEach((function(e){var t;if(u._inputComponent=(0,v.Xr)(e,w.I),void 0===u._inputComponent)return console.warn("Tried to execute on a newly added input component, but it was undefined");null===(t=u._inputComponent.schema.onAdded)||void 0===t||t.forEach((function(t){t.behavior(e,k({},t.args))}))})),null===(l=this.queryResults.networkClientInput.removed)||void 0===l||l.forEach((function(e){var t,n,r;u._inputComponent=(0,v.Xr)(e,w.I),null===(r=null===(n=null===(t=u._inputComponent)||void 0===t?void 0:t.schema)||void 0===n?void 0:n.onRemoved)||void 0===r||r.forEach((function(t){t.behavior(e,t.args)}))}))}}]),n}(h.x);O.queries={networkClientInput:{components:[x.H,w.I,(0,p.yo)(F.$)],listen:{added:!0,removed:!0}},localClientInput:{components:[w.I,F.$],listen:{added:!0,removed:!0}},controllersComponent:{components:[w.I,F.$,_.s],listen:{added:!0,removed:!0}}}},86433:function(e,t,n){"use strict";n.d(t,{DA:function(){return m}});var r=n(15194),i=n(49182),a=n(39337),o=n(97157),s=n(61467);function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){(0,r.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var c=new o.Schema({input:o.uint8,value:o.uint8,lifecycleState:o.uint8}),f=new o.Schema({input:o.uint8,value:o.float32,lifecycleState:o.uint8}),d=new o.Schema({input:o.uint8,value:[o.float32],lifecycleState:o.uint8}),h=new o.Schema({input:o.uint8,x:o.float32,y:o.float32,z:o.float32,qX:o.float32,qY:o.float32,qZ:o.float32,qW:o.float32}),p=new o.Schema({x:o.float32,y:o.float32,z:o.float32}),v=new o.Schema({networkId:o.uint32,axes1d:[f],axes2d:[d],axes6DOF:[h],buttons:[c],viewVector:p,snapShotTime:o.uint32,switchInputs:o.uint32});var m=function(){function e(){(0,i.Z)(this,e)}return(0,a.Z)(e,null,[{key:"toBuffer",value:function(t){var n=u(u({},t),{},{snapShotTime:t.snapShotTime});return s.Z.instance.packetCompression?e.model.toBuffer(n):n}},{key:"fromBuffer",value:function(t){var n=s.Z.instance.packetCompression?e.model.fromBuffer(t):t;return u(u({},n),{},{snapShotTime:Number(n.snapShotTime)})}}]),e}();m.model=new o.Model(v)},16254:function(e,t,n){"use strict";n.d(t,{p:function(){return v}});var r=n(49182),i=n(39337),a=n(13987),o=n(29569),s=n(89306),l=n(64838),u=n(86463),c=n(16090),f=n(10651);function d(e,t){var n;if("undefined"===typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"===typeof e)return h(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return h(e,t)}(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function h(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function p(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,s.Z)(e);if(t){var i=(0,s.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,o.Z)(this,n)}}var v=function(e){(0,a.Z)(n,e);var t=p(n);function n(e){var i;return(0,r.Z)(this,n),i=t.call(this),(0,u.RM)(l.V),i}return(0,i.Z)(n,[{key:"execute",value:function(e,t){var n,r,i=d(this.queryResults.emitters.added);try{for(i.s();!(r=i.n()).done;){var a=r.value;(0,c.Ei)(a,l.V);this.clearEventQueues()}}catch(u){i.e(u)}finally{i.f()}null===(n=this.queryResults.emitters.all)||void 0===n||n.forEach((function(t){var n,r=(0,c.Ei)(t,l.V);(0,f.Ne)(t,r),null===(n=r.particleEmitterMesh)||void 0===n||n.update(e)}));var o,s=d(this.queryResults.emitters.removed);try{for(s.s();!(o=s.n()).done;)o.value}catch(u){s.e(u)}finally{s.f()}}}]),n}(n(88203).x);v.queries={emitters:{components:[l.V],listen:{added:!0,removed:!0}}}},83697:function(e,t,n){"use strict";n.d(t,{x:function(){return y}});var r=n(49182),i=n(39337),a=n(13987),o=n(29569),s=n(89306),l=n(52020),u=n(88203),c=n(16090),f=n(17356),d=n(74861),h=n(35926);function p(e,t){var n;if("undefined"===typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"===typeof e)return v(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return v(e,t)}(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function v(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function m(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,s.Z)(e);if(t){var i=(0,s.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,o.Z)(this,n)}}var y=function(e){(0,a.Z)(n,e);var t=m(n);function n(e){var i;return(0,r.Z)(this,n),(i=t.call(this,e)).updateType=f.V.Fixed,i}return(0,i.Z)(n,[{key:"execute",value:function(e,t){var n,r=p(this.queryResults.highlights.added);try{for(r.s();!(n=r.n()).done;){var i=n.value;(0,c.Xr)(i,l.S).value.traverse((function(e){var t,n;void 0!==e&&(null===(n=null===(t=d.eq.composer)||void 0===t?void 0:t.outlineEffect)||void 0===n||n.selection.add(e))}))}}catch(u){r.e(u)}finally{r.f()}var a,o=p(this.queryResults.highlights.removed);try{for(o.s();!(a=o.n()).done;){var s=a.value;(0,c.Xr)(s,l.S).value.traverse((function(e){var t,n;void 0!==e&&(null===(n=null===(t=d.eq.composer)||void 0===t?void 0:t.outlineEffect)||void 0===n||n.selection.delete(e))}))}}catch(u){o.e(u)}finally{o.f()}}}]),n}(u.x);y.queries={highlights:{components:[l.S,h.o],listen:{removed:!0,added:!0}}}},74861:function(e,t,n){"use strict";n.d(t,{eq:function(){return Ht}});var r=n(63290),i=n(15194),a=n(49182),o=n(39337),s=n(94780),l=n(42828),u=n(13987),c=n(29569),f=n(89306),d=n(36595),h=new d.yGw,p=function(){function e(t){(0,a.Z)(this,e),t=t||{},this.vertices={near:[new d.Pa4,new d.Pa4,new d.Pa4,new d.Pa4],far:[new d.Pa4,new d.Pa4,new d.Pa4,new d.Pa4]},void 0!==t.projectionMatrix&&this.setFromProjectionMatrix(t.projectionMatrix,t.maxFar||1e4)}return(0,o.Z)(e,[{key:"setFromProjectionMatrix",value:function(e,t){var n=0===e.elements[11];return h.copy(e).invert(),this.vertices.near[0].set(1,1,-1),this.vertices.near[1].set(1,-1,-1),this.vertices.near[2].set(-1,-1,-1),this.vertices.near[3].set(-1,1,-1),this.vertices.near.forEach((function(e){e.applyMatrix4(h)})),this.vertices.far[0].set(1,1,1),this.vertices.far[1].set(1,-1,1),this.vertices.far[2].set(-1,-1,1),this.vertices.far[3].set(-1,1,1),this.vertices.far.forEach((function(e){e.applyMatrix4(h);var r=Math.abs(e.z);n?e.z*=Math.min(t/r,1):e.multiplyScalar(Math.min(t/r,1))})),this.vertices}},{key:"split",value:function(t,n){for(;t.length>n.length;)n.push(new e);n.length=t.length;for(var r=0;r<t.length;r++){var i=n[r];if(0===r)for(var a=0;a<4;a++)i.vertices.near[a].copy(this.vertices.near[a]);else for(var o=0;o<4;o++)i.vertices.near[o].lerpVectors(this.vertices.near[o],this.vertices.far[o],t[r-1]);if(r===t-1)for(var s=0;s<4;s++)i.vertices.far[s].copy(this.vertices.far[s]);else for(var l=0;l<4;l++)i.vertices.far[l].lerpVectors(this.vertices.near[l],this.vertices.far[l],t[r])}}},{key:"toSpace",value:function(e,t){for(var n=0;n<4;n++)t.vertices.near[n].copy(this.vertices.near[n]).applyMatrix4(e),t.vertices.far[n].copy(this.vertices.far[n]).applyMatrix4(e)}}]),e}(),v={lights_fragment_begin:"\nGeometricContext geometry;\n\ngeometry.position = - vViewPosition;\ngeometry.normal = normal;\ngeometry.viewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\n\n#ifdef CLEARCOAT\n\n\tgeometry.clearcoatNormal = clearcoatNormal;\n\n#endif\n\nIncidentLight directLight;\n\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\n\t\tpointLight = pointLights[ i ];\n\n\t\tgetPointDirectLightIrradiance( pointLight, geometry, directLight );\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\n\tSpotLight spotLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\n\t\tspotLight = spotLights[ i ];\n\n\t\tgetSpotDirectLightIrradiance( spotLight, geometry, directLight );\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if ( NUM_DIR_LIGHTS > 0) && defined( RE_Direct ) && defined( USE_CSM ) && defined( CSM_CASCADES )\n\n\tDirectionalLight directionalLight;\n\tfloat linearDepth = (vViewPosition.z) / (shadowFar - cameraNear);\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\n\t#if defined( USE_SHADOWMAP ) && defined( CSM_FADE )\n\tvec2 cascade;\n\tfloat cascadeCenter;\n\tfloat closestEdge;\n\tfloat margin;\n\tfloat csmx;\n\tfloat csmy;\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n\n\t\t// NOTE: Depth gets larger away from the camera.\n\t\t// cascade.x is closer, cascade.y is further\n\t\tcascade = CSM_cascades[ i ];\n\t\tcascadeCenter = ( cascade.x + cascade.y ) / 2.0;\n\t\tclosestEdge = linearDepth < cascadeCenter ? cascade.x : cascade.y;\n\t\tmargin = 0.25 * pow( closestEdge, 2.0 );\n\t\tcsmx = cascade.x - margin / 2.0;\n\t\tcsmy = cascade.y + margin / 2.0;\n\t\tif( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS && linearDepth >= csmx && ( linearDepth < csmy || UNROLLED_LOOP_INDEX == CSM_CASCADES - 1 ) ) {\n\n\t\t\tfloat dist = min( linearDepth - csmx, csmy - linearDepth );\n\t\t\tfloat ratio = clamp( dist / margin, 0.0, 1.0 );\n\t\t\tif( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS ) {\n\n\t\t\t\tvec3 prevColor = directLight.color;\n\t\t\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\t\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\n\t\t\t\tbool shouldFadeLastCascade = UNROLLED_LOOP_INDEX == CSM_CASCADES - 1 && linearDepth > cascadeCenter;\n\t\t\t\tdirectLight.color = mix( prevColor, directLight.color, shouldFadeLastCascade ? ratio : 1.0 );\n\n\t\t\t}\n\n\t\t\tReflectedLight prevLight = reflectedLight;\n\t\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\n\t\t\tbool shouldBlend = UNROLLED_LOOP_INDEX != CSM_CASCADES - 1 || UNROLLED_LOOP_INDEX == CSM_CASCADES - 1 && linearDepth < cascadeCenter;\n\t\t\tfloat blendRatio = shouldBlend ? ratio : 1.0;\n\n\t\t\treflectedLight.directDiffuse = mix( prevLight.directDiffuse, reflectedLight.directDiffuse, blendRatio );\n\t\t\treflectedLight.directSpecular = mix( prevLight.directSpecular, reflectedLight.directSpecular, blendRatio );\n\t\t\treflectedLight.indirectDiffuse = mix( prevLight.indirectDiffuse, reflectedLight.indirectDiffuse, blendRatio );\n\t\t\treflectedLight.indirectSpecular = mix( prevLight.indirectSpecular, reflectedLight.indirectSpecular, blendRatio );\n\n\t\t}\n\n\t}\n\t#pragma unroll_loop_end\n\t#else\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tif(linearDepth >= CSM_cascades[UNROLLED_LOOP_INDEX].x && linearDepth < CSM_cascades[UNROLLED_LOOP_INDEX].y) directLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\n\t\t#endif\n\n\t\tif(linearDepth >= CSM_cascades[UNROLLED_LOOP_INDEX].x && (linearDepth < CSM_cascades[UNROLLED_LOOP_INDEX].y || UNROLLED_LOOP_INDEX == CSM_CASCADES - 1)) RE_Direct( directLight, geometry, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n\t#endif\n\n#endif\n\n\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct ) && !defined( USE_CSM ) && !defined( CSM_CASCADES )\n\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\n\t\tdirectionalLight = directionalLights[ i ];\n\n\t\tgetDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\n\tRectAreaLight rectAreaLight;\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if defined( RE_IndirectDiffuse )\n\n\tvec3 iblIrradiance = vec3( 0.0 );\n\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\n\tirradiance += getLightProbeIrradiance( lightProbe, geometry );\n\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\n\t\t}\n\t\t#pragma unroll_loop_end\n\n\t#endif\n\n#endif\n\n#if defined( RE_IndirectSpecular )\n\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n\n#endif\n",lights_pars_begin:"\n#if defined( USE_CSM ) && defined( CSM_CASCADES )\nuniform vec2 CSM_cascades[CSM_CASCADES];\nuniform float cameraNear;\nuniform float shadowFar;\n#endif\n\t"+d.WdD.lights_pars_begin},m=new d.yGw,y=new p,g=new d.Pa4,x=new d.ZzF,A=[],T=[],S=function(){function e(t){(0,a.Z)(this,e),t=t||{},this.camera=t.camera,this.parent=t.parent,this.cascades=t.cascades||3,this.maxFar=t.maxFar||1e5,this.mode=t.mode||"practical",this.shadowMapSize=t.shadowMapSize||2048,this.shadowBias=t.shadowBias||1e-6,this.lightDirection=t.lightDirection||new d.Pa4(1,-1,1).normalize(),this.lightIntensity=t.lightIntensity||1,this.lightNear=t.lightNear||1,this.lightFar=t.lightFar||2e3,this.lightMargin=t.lightMargin||200,this.customSplitsCallback=t.customSplitsCallback,this.fade=!1,this.mainFrustum=new p,this.frustums=[],this.breaks=[],this.lights=[],this.shaders=new Map,this.createLights(),this.updateFrustums(),this.injectInclude()}return(0,o.Z)(e,[{key:"setShadowMapSize",value:function(e){if(this.shadowMapSize!==e){this.shadowMapSize=e;for(var t=0;t<this.cascades;t++)this.lights[t].shadow.mapSize.width=e,this.lights[t].shadow.mapSize.height=e,this.lights[t].shadow.map&&(this.lights[t].shadow.map.dispose(),this.lights[t].shadow.map=null)}}},{key:"createLights",value:function(){for(var e=0;e<this.cascades;e++){var t=new d.Ox3(16777215,this.lightIntensity);t.castShadow=!0,t.shadow.mapSize.width=this.shadowMapSize,t.shadow.mapSize.height=this.shadowMapSize,t.shadow.camera.near=this.lightNear,t.shadow.camera.far=this.lightFar,t.shadow.bias=this.shadowBias,this.parent.add(t),this.parent.add(t.target),this.lights.push(t)}}},{key:"initCascades",value:function(){var e=this.camera;e.updateProjectionMatrix(),this.mainFrustum.setFromProjectionMatrix(e.projectionMatrix,this.maxFar),this.mainFrustum.split(this.breaks,this.frustums)}},{key:"updateShadowBounds",value:function(){for(var e=this.frustums,t=0;t<e.length;t++){var n=this.lights[t].shadow.camera,r=this.frustums[t],i=r.vertices.near,a=r.vertices.far,o=a[0],s=void 0;s=o.distanceTo(a[2])>o.distanceTo(i[2])?a[2]:i[2];var l=o.distanceTo(s);if(this.fade){var u=this.camera,c=Math.max(u.far,this.maxFar),f=r.vertices.far[0].z/(c-u.near);l+=.25*Math.pow(f,2)*(c-u.near)}n.left=-l/2,n.right=l/2,n.top=l/2,n.bottom=-l/2,n.updateProjectionMatrix()}}},{key:"getBreaks",value:function(){var e=this.camera,t=Math.min(e.far,this.maxFar);switch(this.breaks.length=0,this.mode){case"uniform":n(this.cascades,e.near,t,this.breaks);break;case"logarithmic":r(this.cascades,e.near,t,this.breaks);break;case"practical":!function(e,t,i,a,o){A.length=0,T.length=0,r(e,t,i,T),n(e,t,i,A);for(var s=1;s<e;s++)o.push(d.M8C.lerp(A[s-1],T[s-1],a));o.push(1)}(this.cascades,e.near,t,.5,this.breaks);break;case"custom":void 0===this.customSplitsCallback&&console.error("CSM: Custom split scheme callback not defined."),this.customSplitsCallback(this.cascades,e.near,t,this.breaks)}function n(e,t,n,r){for(var i=1;i<e;i++)r.push((t+(n-t)*i/e)/n);r.push(1)}function r(e,t,n,r){for(var i=1;i<e;i++)r.push(t*Math.pow(n/t,i/e)/n);r.push(1)}}},{key:"update",value:function(){for(var e=this.camera,t=this.frustums,n=0;n<t.length;n++){var r=this.lights[n],i=r.shadow.camera,a=(i.right-i.left)/this.shadowMapSize,o=(i.top-i.bottom)/this.shadowMapSize;r.shadow.camera.updateMatrixWorld(!0),m.multiplyMatrices(r.shadow.camera.matrixWorldInverse,e.matrixWorld),t[n].toSpace(m,y);var s=y.vertices.near,l=y.vertices.far;x.makeEmpty();for(var u=0;u<4;u++)x.expandByPoint(s[u]),x.expandByPoint(l[u]);x.getCenter(g),g.z=x.max.z+this.lightMargin,g.x=Math.floor(g.x/a)*a,g.y=Math.floor(g.y/o)*o,g.applyMatrix4(r.shadow.camera.matrixWorld),r.position.copy(g),r.target.position.copy(g),r.target.position.x+=this.lightDirection.x,r.target.position.y+=this.lightDirection.y,r.target.position.z+=this.lightDirection.z}}},{key:"injectInclude",value:function(){d.WdD.lights_fragment_begin=v.lights_fragment_begin,d.WdD.lights_pars_begin=v.lights_pars_begin}},{key:"setupMaterial",value:function(e){e.defines=e.defines||{},e.defines.USE_CSM=1,e.defines.CSM_CASCADES=this.cascades,this.fade&&(e.defines.CSM_FADE="");var t=[],n=this,r=this.shaders;e.onBeforeCompile=function(i){var a=Math.min(n.camera.far,n.maxFar);n.getExtendedBreaks(t),i.uniforms.CSM_cascades={value:t},i.uniforms.cameraNear={value:n.camera.near},i.uniforms.shadowFar={value:a},r.set(e,i)},r.set(e,null)}},{key:"updateUniforms",value:function(){var e=Math.min(this.camera.far,this.maxFar);this.shaders.forEach((function(t,n){if(null!==t){var r=t.uniforms;this.getExtendedBreaks(r.CSM_cascades.value),r.cameraNear.value=this.camera.near,r.shadowFar.value=e}!this.fade&&"CSM_FADE"in n.defines?(delete n.defines.CSM_FADE,n.needsUpdate=!0):this.fade&&!("CSM_FADE"in n.defines)&&(n.defines.CSM_FADE="",n.needsUpdate=!0)}),this)}},{key:"getExtendedBreaks",value:function(e){for(;e.length<this.breaks.length;)e.push(new d.FM8);e.length=this.breaks.length;for(var t=0;t<this.cascades;t++){var n=this.breaks[t],r=this.breaks[t-1]||0;e[t].x=r,e[t].y=n}}},{key:"updateFrustums",value:function(){this.getBreaks(),this.initCascades(),this.updateShadowBounds(),this.updateUniforms()}},{key:"remove",value:function(){for(var e=0;e<this.lights.length;e++)this.parent.remove(this.lights[e])}},{key:"dispose",value:function(){var e=this.shaders;e.forEach((function(e,t){delete t.onBeforeCompile,delete t.defines.USE_CSM,delete t.defines.CSM_CASCADES,delete t.defines.CSM_FADE,null!==e&&(delete e.uniforms.CSM_cascades,delete e.uniforms.cameraNear,delete e.uniforms.shadowFar),t.needsUpdate=!0})),e.clear()}}]),e}(),E=n(46365),P=n(483),_=n(88203),w=-1,F=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:w,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:w,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;(0,a.Z)(this,e),this.resizable=t,this.base=new d.FM8(1,1),this.target=new d.FM8(n,r),this.s=i}return(0,o.Z)(e,[{key:"scale",get:function(){return this.s},set:function(e){this.s=e,this.target.x=w,this.target.y=w,this.resizable.setSize(this.base.x,this.base.y)}},{key:"width",get:function(){var e=this.base,t=this.target;return t.x!==w?t.x:t.y!==w?Math.round(t.y*(e.x/e.y)):Math.round(e.x*this.s)},set:function(e){this.target.x=e,this.resizable.setSize(this.base.x,this.base.y)}},{key:"height",get:function(){var e=this.base,t=this.target;return t.y!==w?t.y:t.x!==w?Math.round(t.x/(e.x/e.y)):Math.round(e.y*this.s)},set:function(e){this.target.y=e,this.resizable.setSize(this.base.x,this.base.y)}}],[{key:"AUTO_SIZE",get:function(){return w}}]),e}(),b="#include <common>\n\nuniform sampler2D inputBuffer;\n\n#ifdef RANGE\n\n\tuniform vec2 range;\n\n#elif defined(THRESHOLD)\n\n\tuniform float threshold;\n\tuniform float smoothing;\n\n#endif\n\nvarying vec2 vUv;\n\nvoid main() {\n\n\tvec4 texel = texture2D(inputBuffer, vUv);\n\tfloat l = linearToRelativeLuminance(texel.rgb);\n\n\t#ifdef RANGE\n\n\t\t// Apply a luminance range mask.\n\t\tfloat low = step(range.x, l);\n\t\tfloat high = step(l, range.y);\n\n\t\tl *= low * high;\n\n\t#elif defined(THRESHOLD)\n\n\t\tl = smoothstep(threshold, threshold + smoothing, l);\n\n\t#endif\n\n\t#ifdef COLOR\n\n\t\tgl_FragColor = vec4(texel.rgb * l, l);\n\n\t#else\n\n\t\tgl_FragColor = vec4(l);\n\n\t#endif\n\n}\n",D="varying vec2 vUv;\n\nvoid main() {\n\n\tvUv = position.xy * 0.5 + 0.5;\n\tgl_Position = vec4(position.xy, 1.0, 1.0);\n\n}\n";function R(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var N=function(e){(0,u.Z)(n,e);var t=R(n);function n(){var e,r=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;(0,a.Z)(this,n);var o=null!==i;return(e=t.call(this,{type:"LuminanceMaterial",uniforms:{inputBuffer:new d.xWb(null),threshold:new d.xWb(0),smoothing:new d.xWb(1),range:new d.xWb(o?i:new d.FM8)},fragmentShader:b,vertexShader:D,depthWrite:!1,depthTest:!1})).toneMapped=!1,e.colorOutput=r,e.useThreshold=!0,e.useRange=o,e}return(0,o.Z)(n,[{key:"setColorOutputEnabled",value:function(e){this.colorOutput=e}},{key:"setLuminanceRangeEnabled",value:function(e){this.useRange=e}},{key:"threshold",get:function(){return this.uniforms.threshold.value},set:function(e){this.uniforms.threshold.value=e}},{key:"smoothing",get:function(){return this.uniforms.smoothing.value},set:function(e){this.uniforms.smoothing.value=e}},{key:"useThreshold",get:function(){return void 0!==this.defines.THRESHOLD},set:function(e){e?this.defines.THRESHOLD="1":delete this.defines.THRESHOLD,this.needsUpdate=!0}},{key:"colorOutput",get:function(){return void 0!==this.defines.COLOR},set:function(e){e?this.defines.COLOR="1":delete this.defines.COLOR,this.needsUpdate=!0}},{key:"useRange",get:function(){return void 0!==this.defines.RANGE},set:function(e){e?this.defines.RANGE="1":delete this.defines.RANGE,this.needsUpdate=!0}},{key:"luminanceRange",get:function(){return this.useRange},set:function(e){this.useRange=e}}]),n}(d.jyz),L=0,I=2,k=10,M=13,O=16;function C(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var U=new Map([[L,null],[1,"vec4 blend(const in vec4 x, const in vec4 y, const in float opacity) {\n\treturn min(x + y, 1.0) * opacity + x * (1.0 - opacity);\n}"],[I,"vec3 blend(const in vec3 x, const in vec3 y, const in float opacity) {\n\n\treturn y * opacity + x * (1.0 - opacity);\n\n}\n\nvec4 blend(const in vec4 x, const in vec4 y, const in float opacity) {\n\n\tfloat a = min(y.a, opacity);\n\n\treturn vec4(blend(x.rgb, y.rgb, a), max(x.a, a));\n\n}"],[3,"vec4 blend(const in vec4 x, const in vec4 y, const in float opacity) {\n\n\treturn (x + y) * 0.5 * opacity + x * (1.0 - opacity);\n\n}"],[4,"float blend(const in float x, const in float y) {\n\treturn (y == 0.0) ? y : max(1.0 - (1.0 - x) / y, 0.0);\n}\n\nvec4 blend(const in vec4 x, const in vec4 y, const in float opacity) {\n\tvec4 z = vec4(blend(x.r, y.r), blend(x.g, y.g), blend(x.b, y.b), blend(x.a, y.a));\n\treturn z * opacity + x * (1.0 - opacity);\n}"],[5,"float blend(const in float x, const in float y) {\n\treturn (y == 1.0) ? y : min(x / (1.0 - y), 1.0);\n}\n\nvec4 blend(const in vec4 x, const in vec4 y, const in float opacity) {\n\tvec4 z = vec4(blend(x.r, y.r), blend(x.g, y.g), blend(x.b, y.b), blend(x.a, y.a));\n\treturn z * opacity + x * (1.0 - opacity);\n}"],[6,"vec4 blend(const in vec4 x, const in vec4 y, const in float opacity) {\n\n\treturn min(x, y) * opacity + x * (1.0 - opacity);\n\n}\n"],[7,"vec4 blend(const in vec4 x, const in vec4 y, const in float opacity) {\n\n\treturn abs(x - y) * opacity + x * (1.0 - opacity);\n\n}\n"],[8,"vec4 blend(const in vec4 x, const in vec4 y, const in float opacity) {\n\n\treturn (x + y - 2.0 * x * y) * opacity + x * (1.0 - opacity);\n\n}\n"],[9,"vec4 blend(const in vec4 x, const in vec4 y, const in float opacity) {\n\n\treturn max(x, y) * opacity + x * (1.0 - opacity);\n\n}\n"],[k,"vec4 blend(const in vec4 x, const in vec4 y, const in float opacity) {\n\n\treturn x * y * opacity + x * (1.0 - opacity);\n\n}\n"],[11,"float blend(const in float x, const in float y) {\n\n\treturn (y > 0.0) ? min(x / y, 1.0) : 1.0;\n\n}\n\nvec4 blend(const in vec4 x, const in vec4 y, const in float opacity) {\n\n\tvec4 z = vec4(blend(x.r, y.r), blend(x.g, y.g), blend(x.b, y.b), blend(x.a, y.a));\n\n\treturn z * opacity + x * (1.0 - opacity);\n\n}\n"],[12,"vec4 blend(const in vec4 x, const in vec4 y, const in float opacity) {\n\n\treturn (1.0 - abs(1.0 - x - y)) * opacity + x * (1.0 - opacity);\n\n}\n"],[M,"vec4 blend(const in vec4 x, const in vec4 y, const in float opacity) {\n\n\treturn y * opacity + x * (1.0 - opacity);\n\n}\n"],[14,"float blend(const in float x, const in float y) {\n\n\treturn (x < 0.5) ? (2.0 * x * y) : (1.0 - 2.0 * (1.0 - x) * (1.0 - y));\n\n}\n\nvec4 blend(const in vec4 x, const in vec4 y, const in float opacity) {\n\n\tvec4 z = vec4(blend(x.r, y.r), blend(x.g, y.g), blend(x.b, y.b), blend(x.a, y.a));\n\n\treturn z * opacity + x * (1.0 - opacity);\n\n}\n"],[15,"float blend(const in float x, const in float y) {\n\n\treturn (y == 1.0) ? y : min(x * x / (1.0 - y), 1.0);\n\n}\n\nvec4 blend(const in vec4 x, const in vec4 y, const in float opacity) {\n\n\tvec4 z = vec4(blend(x.r, y.r), blend(x.g, y.g), blend(x.b, y.b), blend(x.a, y.a));\n\n\treturn z * opacity + x * (1.0 - opacity);\n\n}\n"],[O,"vec4 blend(const in vec4 x, const in vec4 y, const in float opacity) {\n\n\treturn (1.0 - (1.0 - x) * (1.0 - y)) * opacity + x * (1.0 - opacity);\n\n}\n"],[17,"float blend(const in float x, const in float y) {\n\n\treturn (y < 0.5) ?\n\t\t(2.0 * x * y + x * x * (1.0 - 2.0 * y)) :\n\t\t(sqrt(x) * (2.0 * y - 1.0) + 2.0 * x * (1.0 - y));\n\n}\n\nvec4 blend(const in vec4 x, const in vec4 y, const in float opacity) {\n\n\tvec4 z = vec4(blend(x.r, y.r), blend(x.g, y.g), blend(x.b, y.b), blend(x.a, y.a));\n\n\treturn z * opacity + x * (1.0 - opacity);\n\n}\n"],[18,"vec4 blend(const in vec4 x, const in vec4 y, const in float opacity) {\n\n\treturn max(x + y - 1.0, 0.0) * opacity + x * (1.0 - opacity);\n\n}\n"]]),B=function(e){(0,u.Z)(n,e);var t=C(n);function n(e){var r,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return(0,a.Z)(this,n),(r=t.call(this)).blendFunction=e,r.opacity=new d.xWb(i),r}return(0,o.Z)(n,[{key:"getBlendFunction",value:function(){return this.blendFunction}},{key:"setBlendFunction",value:function(e){this.blendFunction=e,this.dispatchEvent({type:"change"})}},{key:"getShaderCode",value:function(){return U.get(this.blendFunction)}}]),n}(d.pBf);function X(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var Z=function(e){(0,u.Z)(n,e);var t=X(n);function n(e,r){var i,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=o.attributes,l=void 0===s?z.NONE:s,u=o.blendFunction,c=void 0===u?O:u,f=o.defines,d=void 0===f?new Map:f,h=o.uniforms,p=void 0===h?new Map:h,v=o.extensions,m=void 0===v?null:v,y=o.vertexShader,g=void 0===y?null:y;return(0,a.Z)(this,n),(i=t.call(this)).name=e,i.attributes=l,i.fragmentShader=r,i.vertexShader=g,i.defines=d,i.uniforms=p,i.extensions=m,i.blendMode=new B(c),i.blendMode.addEventListener("change",(function(e){return i.setChanged()})),i}return(0,o.Z)(n,[{key:"setChanged",value:function(){this.dispatchEvent({type:"change"})}},{key:"getAttributes",value:function(){return this.attributes}},{key:"setAttributes",value:function(e){this.attributes=e,this.setChanged()}},{key:"getFragmentShader",value:function(){return this.fragmentShader}},{key:"setFragmentShader",value:function(e){this.fragmentShader=e,this.setChanged()}},{key:"getVertexShader",value:function(){return this.vertexShader}},{key:"setVertexShader",value:function(e){this.vertexShader=e,this.setChanged()}},{key:"setDepthTexture",value:function(e){}},{key:"update",value:function(e,t,n){}},{key:"setSize",value:function(e,t){}},{key:"initialize",value:function(e,t,n){}},{key:"dispose",value:function(){for(var e=0,t=Object.keys(this);e<t.length;e++){var n=t[e];null!==this[n]&&"function"===typeof this[n].dispose&&this[n].dispose()}}}]),n}(d.pBf),z={NONE:0,DEPTH:1,CONVOLUTION:2},G="#include <common>\n#include <dithering_pars_fragment>\n\nuniform sampler2D inputBuffer;\n\nvarying vec2 vUv0;\nvarying vec2 vUv1;\nvarying vec2 vUv2;\nvarying vec2 vUv3;\n\nvoid main() {\n\n\t// Sample top left texel.\n\tvec4 sum = texture2D(inputBuffer, vUv0);\n\n\t// Sample top right texel.\n\tsum += texture2D(inputBuffer, vUv1);\n\n\t// Sample bottom right texel.\n\tsum += texture2D(inputBuffer, vUv2);\n\n\t// Sample bottom left texel.\n\tsum += texture2D(inputBuffer, vUv3);\n\n\t// Compute the average.\n\tgl_FragColor = sum * 0.25;\n\n\t#include <dithering_fragment>\n\n}\n",Y="uniform vec2 texelSize;\nuniform vec2 halfTexelSize;\nuniform float kernel;\nuniform float scale;\n\n/* Packing multiple texture coordinates into one varying and using a swizzle to\nextract them in the fragment shader still causes a dependent texture read. */\nvarying vec2 vUv0;\nvarying vec2 vUv1;\nvarying vec2 vUv2;\nvarying vec2 vUv3;\n\nvoid main() {\n\n\tvec2 uv = position.xy * 0.5 + 0.5;\n\tvec2 dUv = (texelSize * vec2(kernel) + halfTexelSize) * scale;\n\n\tvUv0 = vec2(uv.x - dUv.x, uv.y + dUv.y);\n\tvUv1 = vec2(uv.x + dUv.x, uv.y + dUv.y);\n\tvUv2 = vec2(uv.x + dUv.x, uv.y - dUv.y);\n\tvUv3 = vec2(uv.x - dUv.x, uv.y - dUv.y);\n\n\tgl_Position = vec4(position.xy, 1.0, 1.0);\n\n}\n";function Q(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var H=function(e){(0,u.Z)(n,e);var t=Q(n);function n(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new d.FM8;return(0,a.Z)(this,n),(e=t.call(this,{type:"ConvolutionMaterial",uniforms:{inputBuffer:new d.xWb(null),texelSize:new d.xWb(new d.FM8),halfTexelSize:new d.xWb(new d.FM8),kernel:new d.xWb(0),scale:new d.xWb(1)},fragmentShader:G,vertexShader:Y,depthWrite:!1,depthTest:!1})).toneMapped=!1,e.setTexelSize(r.x,r.y),e.kernelSize=W.LARGE,e}return(0,o.Z)(n,[{key:"getKernel",value:function(){return V[this.kernelSize]}},{key:"setTexelSize",value:function(e,t){this.uniforms.texelSize.value.set(e,t),this.uniforms.halfTexelSize.value.set(e,t).multiplyScalar(.5)}}]),n}(d.jyz),V=[new Float32Array([0,0]),new Float32Array([0,1,1]),new Float32Array([0,1,1,2]),new Float32Array([0,1,2,2,3]),new Float32Array([0,1,2,3,4,4,5]),new Float32Array([0,1,2,3,4,5,7,8,9,10])],W={VERY_SMALL:0,SMALL:1,MEDIUM:2,LARGE:3,VERY_LARGE:4,HUGE:5},j="uniform sampler2D texture;\nuniform float intensity;\n\nvoid mainImage(const in vec4 inputColor, const in vec2 uv, out vec4 outputColor) {\n\n\toutputColor = clamp(texture2D(texture, uv) * intensity, 0.0, 1.0);\n\n}\n",q=new d.V1s,K=null;var $=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Pass",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new d.xsS,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:q;(0,a.Z)(this,e),this.name=t,this.scene=n,this.camera=r,this.screen=null,this.rtt=!0,this.needsSwap=!0,this.needsDepthTexture=!1,this.enabled=!0}return(0,o.Z)(e,[{key:"getFullscreenMaterial",value:function(){return null!==this.screen?this.screen.material:null}},{key:"setFullscreenMaterial",value:function(e){var t=this.screen;null!==t?t.material=e:((t=new d.Kj0(function(){if(null===K){var e=new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),t=new Float32Array([0,0,2,0,0,2]);void 0!==(K=new d.u9r).setAttribute?(K.setAttribute("position",new d.TlE(e,3)),K.setAttribute("uv",new d.TlE(t,2))):(K.addAttribute("position",new d.TlE(e,3)),K.addAttribute("uv",new d.TlE(t,2)))}return K}(),e)).frustumCulled=!1,null===this.scene&&(this.scene=new d.xsS),this.scene.add(t),this.screen=t)}},{key:"getDepthTexture",value:function(){return null}},{key:"setDepthTexture",value:function(e){}},{key:"render",value:function(e,t,n,r,i){throw new Error("Render method not implemented!")}},{key:"setSize",value:function(e,t){}},{key:"initialize",value:function(e,t,n){}},{key:"dispose",value:function(){var e,t,n=this.getFullscreenMaterial();null!==n&&n.dispose(),null===(t=null===(e=this.screen)||void 0===e?void 0:e.geometry)||void 0===t||t.dispose();for(var r=0,i=Object.keys(this);r<i.length;r++){var a=i[r];null!==this[a]&&"function"===typeof this[a].dispose&&this[a].dispose()}this.scene=null,this.camera=null,this.screen=null}},{key:"renderToScreen",get:function(){return!this.rtt},set:function(e){if(this.rtt===e){var t=this.getFullscreenMaterial();null!==t&&(t.needsUpdate=!0),this.rtt=!e}}}]),e}();function J(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var ee=function(e){(0,u.Z)(n,e);var t=J(n);function n(e){var r,i=e.resolutionScale,o=void 0===i?.5:i,l=e.width,u=void 0===l?F.AUTO_SIZE:l,c=e.height,f=void 0===c?F.AUTO_SIZE:c,h=e.kernelSize,p=void 0===h?W.LARGE:h;return(0,a.Z)(this,n),(r=t.call(this,"BlurPass")).renderTargetA=new d.dd2(1,1,{minFilter:d.wem,magFilter:d.wem,stencilBuffer:!1,depthBuffer:!1}),r.renderTargetA.texture.name="Blur.Target.A",r.renderTargetB=r.renderTargetA.clone(),r.renderTargetB.texture.name="Blur.Target.B",r.resolution=new F((0,s.Z)(r),u,f,o),r.convolutionMaterial=new H,r.ditheredConvolutionMaterial=new H,r.ditheredConvolutionMaterial.dithering=!0,r.dithering=!1,r.kernelSize=p,r}return(0,o.Z)(n,[{key:"getResolutionScale",value:function(){return this.resolution.scale}},{key:"setResolutionScale",value:function(e){this.resolution.scale=e}},{key:"render",value:function(e,t,n,r,i){var a,o,s,l=this.scene,u=this.camera,c=this.renderTargetA,f=this.renderTargetB,d=this.convolutionMaterial,h=d.uniforms,p=d.getKernel(),v=t;for(this.setFullscreenMaterial(d),o=0,s=p.length-1;o<s;++o)a=0===(1&o)?c:f,h.kernel.value=p[o],h.inputBuffer.value=v.texture,e.setRenderTarget(a),e.render(l,u),v=a;this.dithering&&(h=(d=this.ditheredConvolutionMaterial).uniforms,this.setFullscreenMaterial(d)),h.kernel.value=p[o],h.inputBuffer.value=v.texture,e.setRenderTarget(this.renderToScreen?null:n),e.render(l,u)}},{key:"setSize",value:function(e,t){var n=this.resolution;n.base.set(e,t);var r=n.width,i=n.height;this.renderTargetA.setSize(r,i),this.renderTargetB.setSize(r,i),this.convolutionMaterial.setTexelSize(1/r,1/i),this.ditheredConvolutionMaterial.setTexelSize(1/r,1/i)}},{key:"initialize",value:function(e,t,n){t||n!==d.ywz||(this.renderTargetA.texture.format=d.UCm,this.renderTargetB.texture.format=d.UCm),void 0!==n&&(this.renderTargetA.texture.type=n,this.renderTargetB.texture.type=n)}},{key:"width",get:function(){return this.resolution.width},set:function(e){this.resolution.width=e}},{key:"height",get:function(){return this.resolution.height},set:function(e){this.resolution.height=e}},{key:"scale",get:function(){return this.convolutionMaterial.uniforms.scale.value},set:function(e){this.convolutionMaterial.uniforms.scale.value=e,this.ditheredConvolutionMaterial.uniforms.scale.value=e}},{key:"kernelSize",get:function(){return this.convolutionMaterial.kernelSize},set:function(e){this.convolutionMaterial.kernelSize=e,this.ditheredConvolutionMaterial.kernelSize=e}}],[{key:"AUTO_SIZE",get:function(){return F.AUTO_SIZE}}]),n}($);function te(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var ne=function(e){(0,u.Z)(n,e);var t=te(n);function n(e){var r,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"inputBuffer";return(0,a.Z)(this,n),(r=t.call(this,"ShaderPass")).setFullscreenMaterial(e),r.uniform=null,r.setInput(i),r}return(0,o.Z)(n,[{key:"setInput",value:function(e){var t=this.getFullscreenMaterial();if(this.uniform=null,null!==t){var n=t.uniforms;void 0!==n&&void 0!==n[e]&&(this.uniform=n[e])}}},{key:"render",value:function(e,t,n,r,i){null!==this.uniform&&null!==t&&(this.uniform.value=t.texture),e.setRenderTarget(this.renderToScreen?null:n),e.render(this.scene,this.camera)}}]),n}($);function re(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var ie=function(e){(0,u.Z)(n,e);var t=re(n);function n(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=r.blendFunction,o=void 0===i?O:i,l=r.luminanceThreshold,u=void 0===l?.9:l,c=r.luminanceSmoothing,f=void 0===c?.025:c,h=r.resolutionScale,p=void 0===h?.5:h,v=r.intensity,m=void 0===v?1:v,y=r.width,g=void 0===y?F.AUTO_SIZE:y,x=r.height,A=void 0===x?F.AUTO_SIZE:x,T=r.kernelSize,S=void 0===T?W.LARGE:T;return(0,a.Z)(this,n),(e=t.call(this,"BloomEffect",j,{blendFunction:o,uniforms:new Map([["texture",new d.xWb(null)],["intensity",new d.xWb(m)]])})).renderTarget=new d.dd2(1,1,{minFilter:d.wem,magFilter:d.wem,stencilBuffer:!1,depthBuffer:!1}),e.renderTarget.texture.name="Bloom.Target",e.renderTarget.texture.generateMipmaps=!1,e.uniforms.get("texture").value=e.renderTarget.texture,e.blurPass=new ee({resolutionScale:p,width:g,height:A,kernelSize:S}),e.blurPass.resolution.resizable=(0,s.Z)(e),e.luminancePass=new ne(new N(!0)),e.luminanceMaterial.threshold=u,e.luminanceMaterial.smoothing=f,e}return(0,o.Z)(n,[{key:"getResolutionScale",value:function(){return this.resolution.scale}},{key:"setResolutionScale",value:function(e){this.resolution.scale=e}},{key:"update",value:function(e,t,n){var r=this.renderTarget;this.luminancePass.enabled?(this.luminancePass.render(e,t,r),this.blurPass.render(e,r,r)):this.blurPass.render(e,t,r)}},{key:"setSize",value:function(e,t){this.blurPass.setSize(e,t),this.renderTarget.setSize(this.resolution.width,this.resolution.height)}},{key:"initialize",value:function(e,t,n){this.blurPass.initialize(e,t,n),t||n!==d.ywz||(this.renderTarget.texture.format=d.UCm),void 0!==n&&(this.renderTarget.texture.type=n)}},{key:"texture",get:function(){return this.renderTarget.texture}},{key:"luminanceMaterial",get:function(){return this.luminancePass.getFullscreenMaterial()}},{key:"resolution",get:function(){return this.blurPass.resolution}},{key:"width",get:function(){return this.resolution.width},set:function(e){this.resolution.width=e}},{key:"height",get:function(){return this.resolution.height},set:function(e){this.resolution.height=e}},{key:"dithering",get:function(){return this.blurPass.dithering},set:function(e){this.blurPass.dithering=e}},{key:"kernelSize",get:function(){return this.blurPass.kernelSize},set:function(e){this.blurPass.kernelSize=e}},{key:"distinction",get:function(){return console.warn(this.name,"The distinction field has been removed, use luminanceMaterial.threshold and luminanceMaterial.smoothing instead."),1},set:function(e){console.warn(this.name,"The distinction field has been removed, use luminanceMaterial.threshold and luminanceMaterial.smoothing instead.")}},{key:"intensity",get:function(){return this.uniforms.get("intensity").value},set:function(e){this.uniforms.get("intensity").value=e}}]),n}(Z),ae="#include <packing>\n#include <clipping_planes_pars_fragment>\n\n#ifdef GL_FRAGMENT_PRECISION_HIGH\n\n\tuniform highp sampler2D depthBuffer;\n\n#else\n\n\tuniform mediump sampler2D depthBuffer;\n\n#endif\n\nuniform float cameraNear;\nuniform float cameraFar;\n\nvarying float vViewZ;\nvarying vec4 vProjTexCoord;\n\nvoid main() {\n\n\t#include <clipping_planes_fragment>\n\n\t// Transform into Cartesian coordinate (not mirrored).\n\tvec2 projTexCoord = (vProjTexCoord.xy / vProjTexCoord.w) * 0.5 + 0.5;\n\tprojTexCoord = clamp(projTexCoord, 0.002, 0.998);\n\n\tfloat fragCoordZ = unpackRGBAToDepth(texture2D(depthBuffer, projTexCoord));\n\n\t#ifdef PERSPECTIVE_CAMERA\n\n\t\tfloat viewZ = perspectiveDepthToViewZ(fragCoordZ, cameraNear, cameraFar);\n\n\t#else\n\n\t\tfloat viewZ = orthographicDepthToViewZ(fragCoordZ, cameraNear, cameraFar);\n\n\t#endif\n\n\tfloat depthTest = (-vViewZ > -viewZ) ? 1.0 : 0.0;\n\n\tgl_FragColor.rg = vec2(0.0, depthTest);\n\n}\n",oe="#include <common>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvarying float vViewZ;\nvarying vec4 vProjTexCoord;\n\nvoid main() {\n\n\t#include <skinbase_vertex>\n\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\n\tvViewZ = mvPosition.z;\n\tvProjTexCoord = gl_Position;\n\n\t#include <clipping_planes_vertex>\n\n}\n";function se(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var le=function(e){(0,u.Z)(n,e);var t=se(n);function n(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments.length>1?arguments[1]:void 0;return(0,a.Z)(this,n),(e=t.call(this,{type:"DepthComparisonMaterial",uniforms:{depthBuffer:new d.xWb(r),cameraNear:new d.xWb(.3),cameraFar:new d.xWb(1e3)},fragmentShader:ae,vertexShader:oe,depthWrite:!1,depthTest:!1,morphTargets:!0,skinning:!0})).toneMapped=!1,e.adoptCameraSettings(i),e}return(0,o.Z)(n,[{key:"adoptCameraSettings",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;null!==e&&(this.uniforms.cameraNear.value=e.near,this.uniforms.cameraFar.value=e.far,e instanceof d.cPb?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA)}}]),n}(d.jyz),ue=n(78940);function ce(e,t,n,r){return(ce="undefined"!==typeof Reflect&&Reflect.set?Reflect.set:function(e,t,n,r){var a,o=(0,ue.Z)(e,t);if(o){if((a=Object.getOwnPropertyDescriptor(o,t)).set)return a.set.call(r,n),!0;if(!a.writable)return!1}if(a=Object.getOwnPropertyDescriptor(r,t)){if(!a.writable)return!1;a.value=n,Object.defineProperty(r,t,a)}else(0,i.Z)(r,t,n);return!0})(e,t,n,r)}function fe(e,t,n,r,i){if(!ce(e,t,n,r||e)&&i)throw new Error("failed to set property");return n}function de(e,t){var n;if("undefined"===typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"===typeof e)return he(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return he(e,t)}(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function he(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var pe=!1,ve=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;(0,a.Z)(this,e),this.originalMaterials=new Map,this.material=null,this.materialInstanced=null,this.materialSkinning=null,this.setMaterial(t)}return(0,o.Z)(e,[{key:"setMaterial",value:function(e){this.disposeMaterials(),null!==e&&(this.material=e,this.materialInstanced=e.clone(),this.materialInstanced.uniforms=Object.assign({},e.uniforms),this.materialSkinning=e.clone(),this.materialSkinning.uniforms=Object.assign({},e.uniforms),this.materialSkinning.skinning=!0)}},{key:"render",value:function(e,t,n){var r=this.material,i=this.materialSkinning,a=this.materialInstanced,o=this.originalMaterials,s=e.shadowMap.enabled,l=e.sortObjects;if(e.shadowMap.enabled=!1,e.sortObjects=!1,pe){var u=0;t.traverse((function(e){e.isMesh&&(o.set(e,e.material),e.isInstancedMesh?e.material=a:e.isSkinnedMesh?e.material=i:e.material=r,++u)})),e.render(t,n);var c,f=de(o);try{for(f.s();!(c=f.n()).done;){var d=c.value;d[0].material=d[1]}}catch(p){f.e(p)}finally{f.f()}u!==o.size&&o.clear()}else{var h=t.overrideMaterial;t.overrideMaterial=r,e.render(t,n),t.overrideMaterial=h}e.shadowMap.enabled=s,e.sortObjects=l}},{key:"disposeMaterials",value:function(){null!==this.materialInstanced&&this.materialInstanced.dispose(),null!==this.materialSkinning&&this.materialSkinning.dispose()}},{key:"dispose",value:function(){this.originalMaterials.clear(),this.disposeMaterials()}}],[{key:"workaroundEnabled",get:function(){return pe},set:function(e){pe=e}}]),e}();function me(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var ye=new d.Ilk,ge=function(e){(0,u.Z)(n,e);var t=me(n);function n(){var e,r=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],o=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return(0,a.Z)(this,n),(e=t.call(this,"ClearPass",null,null)).needsSwap=!1,e.color=r,e.depth=i,e.stencil=o,e.overrideClearColor=null,e.overrideClearAlpha=-1,e}return(0,o.Z)(n,[{key:"render",value:function(e,t,n,r,i){var a=this.overrideClearColor,o=this.overrideClearAlpha,s=e.getClearAlpha(),l=null!==a,u=o>=0;l?(ye.copy(e.getClearColor(ye)),e.setClearColor(a,u?o:s)):u&&e.setClearAlpha(o),e.setRenderTarget(this.renderToScreen?null:t),e.clear(this.color,this.depth,this.stencil),l?e.setClearColor(ye,s):u&&e.setClearAlpha(s)}}]),n}($);function xe(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var Ae=function(e){(0,u.Z)(n,e);var t=xe(n);function n(e,r){var i,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return(0,a.Z)(this,n),(i=t.call(this,"RenderPass",e,r)).needsSwap=!1,i.clearPass=new ge,i.depthTexture=null,i.overrideMaterialManager=null===o?null:new ve(o),i}return(0,o.Z)(n,[{key:"getClearPass",value:function(){return this.clearPass}},{key:"getDepthTexture",value:function(){return this.depthTexture}},{key:"setDepthTexture",value:function(e){this.depthTexture=e}},{key:"render",value:function(e,t,n,r,i){var a=this.scene,o=this.camera,s=this.renderToScreen?null:t;null===this.depthTexture||this.renderToScreen||(t.depthTexture=this.depthTexture,void 0!==n&&(n.depthTexture=null)),this.clear&&this.clearPass.render(e,t),e.setRenderTarget(s),null!==this.overrideMaterialManager?this.overrideMaterialManager.render(e,a,o):e.render(a,o)}},{key:"renderToScreen",get:function(){return(0,l.Z)((0,f.Z)(n.prototype),"renderToScreen",this)},set:function(e){fe((0,f.Z)(n.prototype),"renderToScreen",e,this,!0),this.clearPass.renderToScreen=e}},{key:"overrideMaterial",get:function(){var e=this.overrideMaterialManager;return null!==e?e.material:null},set:function(e){var t=this.overrideMaterialManager;null!==e&&null!==t?t.setMaterial(e):null===e?(t.dispose(),this.overrideMaterialManager=null):this.overrideMaterialManager=new ve(e)}},{key:"clear",get:function(){return this.clearPass.enabled},set:function(e){this.clearPass.enabled=e}}]),n}($);function Te(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Se(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var Ee=function(e){(0,u.Z)(n,e);var t=Se(n);function n(e,r,o){var l;(0,a.Z)(this,n),l=t.call(this,"DepthPass");var u=o=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Te(Object(n),!0).forEach((function(t){(0,i.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Te(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({resolutionScale:1,width:F.AUTO_SIZE,height:F.AUTO_SIZE},o),c=u.resolutionScale,f=u.width,h=u.height,p=u.renderTarget;l.needsSwap=!1,l.renderPass=new Ae(e,r,new d.lRF({depthPacking:d.mSO}));var v=l.renderPass.getClearPass();return v.overrideClearColor=new d.Ilk(16777215),v.overrideClearAlpha=1,l.renderTarget=p,void 0===l.renderTarget&&(l.renderTarget=new d.dd2(1,1,{minFilter:d.TyD,magFilter:d.TyD,stencilBuffer:!1}),l.renderTarget.texture.name="DepthPass.Target"),l.resolution=new F((0,s.Z)(l),f,h,c),l}return(0,o.Z)(n,[{key:"getResolutionScale",value:function(){return this.resolutionScale}},{key:"setResolutionScale",value:function(e){this.resolutionScale=e,this.setSize(this.resolution.base.x,this.resolution.base.y)}},{key:"render",value:function(e,t,n,r,i){var a=this.renderToScreen?null:this.renderTarget;this.renderPass.render(e,a)}},{key:"setSize",value:function(e,t){var n=this.resolution;n.base.set(e,t),this.renderTarget.setSize(n.width,n.height)}},{key:"texture",get:function(){return this.renderTarget.texture}}]),n}($),Pe="uniform sampler2D inputBuffer;\n\nvarying vec2 vUv0;\nvarying vec2 vUv1;\nvarying vec2 vUv2;\nvarying vec2 vUv3;\n\nvoid main() {\n\n\tvec2 c0 = texture2D(inputBuffer, vUv0).rg;\n\tvec2 c1 = texture2D(inputBuffer, vUv1).rg;\n\tvec2 c2 = texture2D(inputBuffer, vUv2).rg;\n\tvec2 c3 = texture2D(inputBuffer, vUv3).rg;\n\n\tfloat d0 = (c0.x - c1.x) * 0.5;\n\tfloat d1 = (c2.x - c3.x) * 0.5;\n\tfloat d = length(vec2(d0, d1));\n\n\tfloat a0 = min(c0.y, c1.y);\n\tfloat a1 = min(c2.y, c3.y);\n\tfloat visibilityFactor = min(a0, a1);\n\n\tgl_FragColor.rg = (1.0 - visibilityFactor > 0.001) ? vec2(d, 0.0) : vec2(0.0, d);\n\n}\n",_e="uniform vec2 texelSize;\n\nvarying vec2 vUv0;\nvarying vec2 vUv1;\nvarying vec2 vUv2;\nvarying vec2 vUv3;\n\nvoid main() {\n\n\tvec2 uv = position.xy * 0.5 + 0.5;\n\n\tvUv0 = vec2(uv.x + texelSize.x, uv.y);\n\tvUv1 = vec2(uv.x - texelSize.x, uv.y);\n\tvUv2 = vec2(uv.x, uv.y + texelSize.y);\n\tvUv3 = vec2(uv.x, uv.y - texelSize.y);\n\n\tgl_Position = vec4(position.xy, 1.0, 1.0);\n\n}\n";function we(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var Fe=function(e){(0,u.Z)(n,e);var t=we(n);function n(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new d.FM8;return(0,a.Z)(this,n),(e=t.call(this,{type:"OutlineMaterial",uniforms:{inputBuffer:new d.xWb(null),texelSize:new d.xWb(new d.FM8)},fragmentShader:Pe,vertexShader:_e,depthWrite:!1,depthTest:!1})).toneMapped=!1,e.setTexelSize(r.x,r.y),e.uniforms.maskTexture=e.uniforms.inputBuffer,e}return(0,o.Z)(n,[{key:"setTexelSize",value:function(e,t){this.uniforms.texelSize.value.set(e,t)}}]),n}(d.jyz);function be(e,t){var n;if("undefined"===typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"===typeof e)return De(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return De(e,t)}(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function De(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Re(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var Ne=function(e){(0,u.Z)(n,e);var t=Re(n);function n(e){var r,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10;return(0,a.Z)(this,n),(r=t.call(this)).currentLayer=i,void 0!==e&&r.set(e),r}return(0,o.Z)(n,[{key:"clear",value:function(){var e,t=this.layer,r=be(this);try{for(r.s();!(e=r.n()).done;){e.value.layers.disable(t)}}catch(i){r.e(i)}finally{r.f()}return(0,l.Z)((0,f.Z)(n.prototype),"clear",this).call(this)}},{key:"set",value:function(e){this.clear();var t,n=be(e);try{for(n.s();!(t=n.n()).done;){var r=t.value;this.add(r)}}catch(i){n.e(i)}finally{n.f()}return this}},{key:"indexOf",value:function(e){return this.has(e)?0:-1}},{key:"add",value:function(e){return e.layers.enable(this.layer),(0,l.Z)((0,f.Z)(n.prototype),"add",this).call(this,e),this}},{key:"delete",value:function(e){return this.has(e)&&e.layers.disable(this.layer),(0,l.Z)((0,f.Z)(n.prototype),"delete",this).call(this,e)}},{key:"setVisible",value:function(e){var t,n=be(this);try{for(n.s();!(t=n.n()).done;){var r=t.value;e?r.layers.enable(0):r.layers.disable(0)}}catch(i){n.e(i)}finally{n.f()}return this}},{key:"layer",get:function(){return this.currentLayer},set:function(e){var t,n=this.currentLayer,r=be(this);try{for(r.s();!(t=r.n()).done;){var i=t.value;i.layers.disable(n),i.layers.enable(e)}}catch(a){r.e(a)}finally{r.f()}this.currentLayer=e}}]),n}((0,n(49135).Z)(Set));function Le(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var Ie=function(e){(0,u.Z)(n,e);var t=Le(n);function n(e,r,i){var o,l=i.blendFunction,u=void 0===l?O:l,c=i.patternTexture,f=void 0===c?null:c,h=i.edgeStrength,p=void 0===h?1:h,v=i.pulseSpeed,m=void 0===v?0:v,y=i.visibleEdgeColor,g=void 0===y?16777215:y,x=i.hiddenEdgeColor,A=void 0===x?2230538:x,T=i.resolutionScale,S=void 0===T?.5:T,E=i.width,P=void 0===E?F.AUTO_SIZE:E,_=i.height,w=void 0===_?F.AUTO_SIZE:_,b=i.kernelSize,D=void 0===b?W.VERY_SMALL:b,R=i.blur,N=void 0!==R&&R,L=i.xRay,k=void 0===L||L;(0,a.Z)(this,n),(o=t.call(this,"OutlineEffect","uniform sampler2D edgeTexture;\nuniform sampler2D maskTexture;\n\nuniform vec3 visibleEdgeColor;\nuniform vec3 hiddenEdgeColor;\nuniform float pulse;\nuniform float edgeStrength;\n\n#ifdef USE_PATTERN\n\n\tuniform sampler2D patternTexture;\n\tvarying vec2 vUvPattern;\n\n#endif\n\nvoid mainImage(const in vec4 inputColor, const in vec2 uv, out vec4 outputColor) {\n\n\tvec2 edge = texture2D(edgeTexture, uv).rg;\n\tvec2 mask = texture2D(maskTexture, uv).rg;\n\n\t#ifndef X_RAY\n\n\t\tedge.y = 0.0;\n\n\t#endif\n\n\tedge *= (edgeStrength * mask.x * pulse);\n\tvec3 color = edge.x * visibleEdgeColor + edge.y * hiddenEdgeColor;\n\n\tfloat visibilityFactor = 0.0;\n\n\t#ifdef USE_PATTERN\n\n\t\tvec4 patternColor = texture2D(patternTexture, vUvPattern);\n\n\t\t#ifdef X_RAY\n\n\t\t\tfloat hiddenFactor = 0.5;\n\n\t\t#else\n\n\t\t\tfloat hiddenFactor = 0.0;\n\n\t\t#endif\n\n\t\tvisibilityFactor = (1.0 - mask.y > 0.0) ? 1.0 : hiddenFactor;\n\t\tvisibilityFactor *= (1.0 - mask.x) * patternColor.a;\n\t\tcolor += visibilityFactor * patternColor.rgb;\n\n\t#endif\n\n\tfloat alpha = max(max(edge.x, edge.y), visibilityFactor);\n\n\t#ifdef ALPHA\n\n\t\t// Alpha blending already accounts for input alpha.\n\t\toutputColor = vec4(color, alpha);\n\n\t#else\n\n\t\t// Preserve input alpha.\n\t\toutputColor = vec4(color, max(alpha, inputColor.a));\n\n\t#endif\n\n}\n",{uniforms:new Map([["maskTexture",new d.xWb(null)],["edgeTexture",new d.xWb(null)],["edgeStrength",new d.xWb(p)],["visibleEdgeColor",new d.xWb(new d.Ilk(g))],["hiddenEdgeColor",new d.xWb(new d.Ilk(A))],["pulse",new d.xWb(1)],["patternScale",new d.xWb(1)],["patternTexture",new d.xWb(null)]])})).blendMode.addEventListener("change",(function(e){o.blendMode.getBlendFunction()===I?o.defines.set("ALPHA","1"):o.defines.delete("ALPHA"),o.setChanged()})),o.blendMode.setBlendFunction(u),o.setPatternTexture(f),o.xRay=k,o.scene=e,o.camera=r,o.renderTargetMask=new d.dd2(1,1,{minFilter:d.wem,magFilter:d.wem,stencilBuffer:!1,format:d.UCm}),o.renderTargetMask.texture.name="Outline.Mask",o.uniforms.get("maskTexture").value=o.renderTargetMask.texture,o.renderTargetOutline=o.renderTargetMask.clone(),o.renderTargetOutline.texture.name="Outline.Edges",o.renderTargetOutline.depthBuffer=!1,o.renderTargetBlurredOutline=o.renderTargetOutline.clone(),o.renderTargetBlurredOutline.texture.name="Outline.BlurredEdges",o.clearPass=new ge,o.clearPass.overrideClearColor=new d.Ilk(0),o.clearPass.overrideClearAlpha=1,o.depthPass=new Ee(e,r),o.maskPass=new Ae(e,r,new le(o.depthPass.texture,r));var M=o.maskPass.getClearPass();return M.overrideClearColor=new d.Ilk(16777215),M.overrideClearAlpha=1,o.blurPass=new ee({resolutionScale:S,width:P,height:w,kernelSize:D}),o.blurPass.resolution.resizable=(0,s.Z)(o),o.blur=N,o.outlinePass=new ne(new Fe),o.outlinePass.getFullscreenMaterial().uniforms.inputBuffer.value=o.renderTargetMask.texture,o.time=0,o.selection=new Ne,o.pulseSpeed=m,o}return(0,o.Z)(n,[{key:"setPatternTexture",value:function(e){null!==e?(e.wrapS=e.wrapT=d.rpg,this.defines.set("USE_PATTERN","1"),this.uniforms.get("patternTexture").value=e,this.setVertexShader("uniform float patternScale;\n\nvarying vec2 vUvPattern;\n\nvoid mainSupport(const in vec2 uv) {\n\n\tvUvPattern = uv * vec2(aspect, 1.0) * patternScale;\n\n}\n")):(this.defines.delete("USE_PATTERN"),this.uniforms.get("patternTexture").value=null,this.setVertexShader(null)),this.setChanged()}},{key:"getResolutionScale",value:function(){return this.resolution.scale}},{key:"setResolutionScale",value:function(e){this.resolution.scale=e}},{key:"setSelection",value:function(e){return this.selection.set(e),this}},{key:"clearSelection",value:function(){return this.selection.clear(),this}},{key:"selectObject",value:function(e){return this.selection.add(e),this}},{key:"deselectObject",value:function(e){return this.selection.delete(e),this}},{key:"update",value:function(e,t,n){var r=this.scene,i=this.camera,a=this.selection,o=this.uniforms.get("pulse"),s=r.background,l=i.layers.mask;a.size>0?(r.background=null,o.value=1,this.pulseSpeed>0&&(o.value=.625+.375*Math.cos(this.time*this.pulseSpeed*10)),this.time+=n,a.setVisible(!1),this.depthPass.render(e),a.setVisible(!0),i.layers.set(a.layer),this.maskPass.render(e,this.renderTargetMask),i.layers.mask=l,r.background=s,this.outlinePass.render(e,null,this.renderTargetOutline),this.blur&&this.blurPass.render(e,this.renderTargetOutline,this.renderTargetBlurredOutline)):this.time>0&&(this.clearPass.render(e,this.renderTargetMask),this.time=0)}},{key:"setSize",value:function(e,t){this.blurPass.setSize(e,t),this.renderTargetMask.setSize(e,t);var n=this.resolution.width,r=this.resolution.height;this.depthPass.setSize(n,r),this.renderTargetOutline.setSize(n,r),this.renderTargetBlurredOutline.setSize(n,r),this.outlinePass.getFullscreenMaterial().setTexelSize(1/n,1/r)}},{key:"initialize",value:function(e,t,n){this.blurPass.initialize(e,t,d.ywz),void 0!==n&&(this.depthPass.initialize(e,t,n),this.maskPass.initialize(e,t,n),this.outlinePass.initialize(e,t,n))}},{key:"resolution",get:function(){return this.blurPass.resolution}},{key:"width",get:function(){return this.resolution.width},set:function(e){this.resolution.width=e}},{key:"height",get:function(){return this.resolution.height},set:function(e){this.resolution.height=e}},{key:"selectionLayer",get:function(){return this.selection.layer},set:function(e){this.selection.layer=e}},{key:"dithering",get:function(){return this.blurPass.dithering},set:function(e){this.blurPass.dithering=e}},{key:"kernelSize",get:function(){return this.blurPass.kernelSize},set:function(e){this.blurPass.kernelSize=e}},{key:"blur",get:function(){return this.blurPass.enabled},set:function(e){this.blurPass.enabled=e,this.uniforms.get("edgeTexture").value=e?this.renderTargetBlurredOutline.texture:this.renderTargetOutline.texture}},{key:"xRay",get:function(){return this.defines.has("X_RAY")},set:function(e){this.xRay!==e&&(e?this.defines.set("X_RAY","1"):this.defines.delete("X_RAY"),this.setChanged())}}]),n}(Z),ke="void mainImage(const in vec4 inputColor, const in vec2 uv, out vec4 outputColor) {\n\n\toutputColor = LinearTosRGB(max(inputColor, 0.0));\n\n}";function Me(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var Oe=function(e){(0,u.Z)(n,e);var t=Me(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=e.blendFunction,i=void 0===r?M:r;return(0,a.Z)(this,n),t.call(this,"LinearTosRGBEffect",ke,{blendFunction:i})}return n}(Z),Ce=["precision highp float;","","uniform sampler2D tDiffuse;","","uniform vec2 resolution;","","","// FXAA 3.11 implementation by NVIDIA, ported to WebGL by Agost Biro (biro@archilogic.com)","","//----------------------------------------------------------------------------------","// File:        es3-keplerFXAAassetsshaders/FXAA_DefaultES.frag","// SDK Version: v3.00","// Email:       gameworks@nvidia.com","// Site:        http://developer.nvidia.com/","//","// Copyright (c) 2014-2015, NVIDIA CORPORATION. All rights reserved.","//","// Redistribution and use in source and binary forms, with or without","// modification, are permitted provided that the following conditions","// are met:","//  * Redistributions of source code must retain the above copyright","//    notice, this list of conditions and the following disclaimer.","//  * Redistributions in binary form must reproduce the above copyright","//    notice, this list of conditions and the following disclaimer in the","//    documentation and/or other materials provided with the distribution.","//  * Neither the name of NVIDIA CORPORATION nor the names of its","//    contributors may be used to endorse or promote products derived","//    from this software without specific prior written permission.","//","// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS ``AS IS'' AND ANY","// EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE","// IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR","// PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR","// CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,","// EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,","// PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR","// PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY","// OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT","// (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE","// OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.","//","//----------------------------------------------------------------------------------","","#define FXAA_PC 1","#define FXAA_GLSL_100 1","#define FXAA_QUALITY_PRESET 12","","#define FXAA_GREEN_AS_LUMA 1","","/*--------------------------------------------------------------------------*/","#ifndef FXAA_PC_CONSOLE","    //","    // The console algorithm for PC is included","    // for developers targeting really low spec machines.","    // Likely better to just run FXAA_PC, and use a really low preset.","    //","    #define FXAA_PC_CONSOLE 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_GLSL_120","    #define FXAA_GLSL_120 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_GLSL_130","    #define FXAA_GLSL_130 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_HLSL_3","    #define FXAA_HLSL_3 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_HLSL_4","    #define FXAA_HLSL_4 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_HLSL_5","    #define FXAA_HLSL_5 0","#endif","/*==========================================================================*/","#ifndef FXAA_GREEN_AS_LUMA","    //","    // For those using non-linear color,","    // and either not able to get luma in alpha, or not wanting to,","    // this enables FXAA to run using green as a proxy for luma.","    // So with this enabled, no need to pack luma in alpha.","    //","    // This will turn off AA on anything which lacks some amount of green.","    // Pure red and blue or combination of only R and B, will get no AA.","    //","    // Might want to lower the settings for both,","    //    fxaaConsoleEdgeThresholdMin","    //    fxaaQualityEdgeThresholdMin","    // In order to insure AA does not get turned off on colors","    // which contain a minor amount of green.","    //","    // 1 = On.","    // 0 = Off.","    //","    #define FXAA_GREEN_AS_LUMA 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_EARLY_EXIT","    //","    // Controls algorithm's early exit path.","    // On PS3 turning this ON adds 2 cycles to the shader.","    // On 360 turning this OFF adds 10ths of a millisecond to the shader.","    // Turning this off on console will result in a more blurry image.","    // So this defaults to on.","    //","    // 1 = On.","    // 0 = Off.","    //","    #define FXAA_EARLY_EXIT 1","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_DISCARD","    //","    // Only valid for PC OpenGL currently.","    // Probably will not work when FXAA_GREEN_AS_LUMA = 1.","    //","    // 1 = Use discard on pixels which don't need AA.","    //     For APIs which enable concurrent TEX+ROP from same surface.","    // 0 = Return unchanged color on pixels which don't need AA.","    //","    #define FXAA_DISCARD 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_FAST_PIXEL_OFFSET","    //","    // Used for GLSL 120 only.","    //","    // 1 = GL API supports fast pixel offsets","    // 0 = do not use fast pixel offsets","    //","    #ifdef GL_EXT_gpu_shader4","        #define FXAA_FAST_PIXEL_OFFSET 1","    #endif","    #ifdef GL_NV_gpu_shader5","        #define FXAA_FAST_PIXEL_OFFSET 1","    #endif","    #ifdef GL_ARB_gpu_shader5","        #define FXAA_FAST_PIXEL_OFFSET 1","    #endif","    #ifndef FXAA_FAST_PIXEL_OFFSET","        #define FXAA_FAST_PIXEL_OFFSET 0","    #endif","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_GATHER4_ALPHA","    //","    // 1 = API supports gather4 on alpha channel.","    // 0 = API does not support gather4 on alpha channel.","    //","    #if (FXAA_HLSL_5 == 1)","        #define FXAA_GATHER4_ALPHA 1","    #endif","    #ifdef GL_ARB_gpu_shader5","        #define FXAA_GATHER4_ALPHA 1","    #endif","    #ifdef GL_NV_gpu_shader5","        #define FXAA_GATHER4_ALPHA 1","    #endif","    #ifndef FXAA_GATHER4_ALPHA","        #define FXAA_GATHER4_ALPHA 0","    #endif","#endif","","","/*============================================================================","                        FXAA QUALITY - TUNING KNOBS","------------------------------------------------------------------------------","NOTE the other tuning knobs are now in the shader function inputs!","============================================================================*/","#ifndef FXAA_QUALITY_PRESET","    //","    // Choose the quality preset.","    // This needs to be compiled into the shader as it effects code.","    // Best option to include multiple presets is to","    // in each shader define the preset, then include this file.","    //","    // OPTIONS","    // -----------------------------------------------------------------------","    // 10 to 15 - default medium dither (10=fastest, 15=highest quality)","    // 20 to 29 - less dither, more expensive (20=fastest, 29=highest quality)","    // 39       - no dither, very expensive","    //","    // NOTES","    // -----------------------------------------------------------------------","    // 12 = slightly faster then FXAA 3.9 and higher edge quality (default)","    // 13 = about same speed as FXAA 3.9 and better than 12","    // 23 = closest to FXAA 3.9 visually and performance wise","    //  _ = the lowest digit is directly related to performance","    // _  = the highest digit is directly related to style","    //","    #define FXAA_QUALITY_PRESET 12","#endif","","","/*============================================================================","","                           FXAA QUALITY - PRESETS","","============================================================================*/","","/*============================================================================","                     FXAA QUALITY - MEDIUM DITHER PRESETS","============================================================================*/","#if (FXAA_QUALITY_PRESET == 10)","    #define FXAA_QUALITY_PS 3","    #define FXAA_QUALITY_P0 1.5","    #define FXAA_QUALITY_P1 3.0","    #define FXAA_QUALITY_P2 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 11)","    #define FXAA_QUALITY_PS 4","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 3.0","    #define FXAA_QUALITY_P3 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 12)","    #define FXAA_QUALITY_PS 5","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 4.0","    #define FXAA_QUALITY_P4 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 13)","    #define FXAA_QUALITY_PS 6","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 4.0","    #define FXAA_QUALITY_P5 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 14)","    #define FXAA_QUALITY_PS 7","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 4.0","    #define FXAA_QUALITY_P6 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 15)","    #define FXAA_QUALITY_PS 8","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 4.0","    #define FXAA_QUALITY_P7 12.0","#endif","","/*============================================================================","                     FXAA QUALITY - LOW DITHER PRESETS","============================================================================*/","#if (FXAA_QUALITY_PRESET == 20)","    #define FXAA_QUALITY_PS 3","    #define FXAA_QUALITY_P0 1.5","    #define FXAA_QUALITY_P1 2.0","    #define FXAA_QUALITY_P2 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 21)","    #define FXAA_QUALITY_PS 4","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 22)","    #define FXAA_QUALITY_PS 5","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 23)","    #define FXAA_QUALITY_PS 6","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 24)","    #define FXAA_QUALITY_PS 7","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 3.0","    #define FXAA_QUALITY_P6 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 25)","    #define FXAA_QUALITY_PS 8","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 4.0","    #define FXAA_QUALITY_P7 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 26)","    #define FXAA_QUALITY_PS 9","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 4.0","    #define FXAA_QUALITY_P8 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 27)","    #define FXAA_QUALITY_PS 10","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 4.0","    #define FXAA_QUALITY_P9 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 28)","    #define FXAA_QUALITY_PS 11","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 2.0","    #define FXAA_QUALITY_P9 4.0","    #define FXAA_QUALITY_P10 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 29)","    #define FXAA_QUALITY_PS 12","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 2.0","    #define FXAA_QUALITY_P9 2.0","    #define FXAA_QUALITY_P10 4.0","    #define FXAA_QUALITY_P11 8.0","#endif","","/*============================================================================","                     FXAA QUALITY - EXTREME QUALITY","============================================================================*/","#if (FXAA_QUALITY_PRESET == 39)","    #define FXAA_QUALITY_PS 12","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.0","    #define FXAA_QUALITY_P2 1.0","    #define FXAA_QUALITY_P3 1.0","    #define FXAA_QUALITY_P4 1.0","    #define FXAA_QUALITY_P5 1.5","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 2.0","    #define FXAA_QUALITY_P9 2.0","    #define FXAA_QUALITY_P10 4.0","    #define FXAA_QUALITY_P11 8.0","#endif","","","","/*============================================================================","","                                API PORTING","","============================================================================*/","#if (FXAA_GLSL_100 == 1) || (FXAA_GLSL_120 == 1) || (FXAA_GLSL_130 == 1)","    #define FxaaBool bool","    #define FxaaDiscard discard","    #define FxaaFloat float","    #define FxaaFloat2 vec2","    #define FxaaFloat3 vec3","    #define FxaaFloat4 vec4","    #define FxaaHalf float","    #define FxaaHalf2 vec2","    #define FxaaHalf3 vec3","    #define FxaaHalf4 vec4","    #define FxaaInt2 ivec2","    #define FxaaSat(x) clamp(x, 0.0, 1.0)","    #define FxaaTex sampler2D","#else","    #define FxaaBool bool","    #define FxaaDiscard clip(-1)","    #define FxaaFloat float","    #define FxaaFloat2 float2","    #define FxaaFloat3 float3","    #define FxaaFloat4 float4","    #define FxaaHalf half","    #define FxaaHalf2 half2","    #define FxaaHalf3 half3","    #define FxaaHalf4 half4","    #define FxaaSat(x) saturate(x)","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_GLSL_100 == 1)","  #define FxaaTexTop(t, p) texture2D(t, p, 0.0)","  #define FxaaTexOff(t, p, o, r) texture2D(t, p + (o * r), 0.0)","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_GLSL_120 == 1)","    // Requires,","    //  #version 120","    // And at least,","    //  #extension GL_EXT_gpu_shader4 : enable","    //  (or set FXAA_FAST_PIXEL_OFFSET 1 to work like DX9)","    #define FxaaTexTop(t, p) texture2DLod(t, p, 0.0)","    #if (FXAA_FAST_PIXEL_OFFSET == 1)","        #define FxaaTexOff(t, p, o, r) texture2DLodOffset(t, p, 0.0, o)","    #else","        #define FxaaTexOff(t, p, o, r) texture2DLod(t, p + (o * r), 0.0)","    #endif","    #if (FXAA_GATHER4_ALPHA == 1)","        // use #extension GL_ARB_gpu_shader5 : enable","        #define FxaaTexAlpha4(t, p) textureGather(t, p, 3)","        #define FxaaTexOffAlpha4(t, p, o) textureGatherOffset(t, p, o, 3)","        #define FxaaTexGreen4(t, p) textureGather(t, p, 1)","        #define FxaaTexOffGreen4(t, p, o) textureGatherOffset(t, p, o, 1)","    #endif","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_GLSL_130 == 1)",'    // Requires "#version 130" or better',"    #define FxaaTexTop(t, p) textureLod(t, p, 0.0)","    #define FxaaTexOff(t, p, o, r) textureLodOffset(t, p, 0.0, o)","    #if (FXAA_GATHER4_ALPHA == 1)","        // use #extension GL_ARB_gpu_shader5 : enable","        #define FxaaTexAlpha4(t, p) textureGather(t, p, 3)","        #define FxaaTexOffAlpha4(t, p, o) textureGatherOffset(t, p, o, 3)","        #define FxaaTexGreen4(t, p) textureGather(t, p, 1)","        #define FxaaTexOffGreen4(t, p, o) textureGatherOffset(t, p, o, 1)","    #endif","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_HLSL_3 == 1)","    #define FxaaInt2 float2","    #define FxaaTex sampler2D","    #define FxaaTexTop(t, p) tex2Dlod(t, float4(p, 0.0, 0.0))","    #define FxaaTexOff(t, p, o, r) tex2Dlod(t, float4(p + (o * r), 0, 0))","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_HLSL_4 == 1)","    #define FxaaInt2 int2","    struct FxaaTex { SamplerState smpl; Texture2D tex; };","    #define FxaaTexTop(t, p) t.tex.SampleLevel(t.smpl, p, 0.0)","    #define FxaaTexOff(t, p, o, r) t.tex.SampleLevel(t.smpl, p, 0.0, o)","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_HLSL_5 == 1)","    #define FxaaInt2 int2","    struct FxaaTex { SamplerState smpl; Texture2D tex; };","    #define FxaaTexTop(t, p) t.tex.SampleLevel(t.smpl, p, 0.0)","    #define FxaaTexOff(t, p, o, r) t.tex.SampleLevel(t.smpl, p, 0.0, o)","    #define FxaaTexAlpha4(t, p) t.tex.GatherAlpha(t.smpl, p)","    #define FxaaTexOffAlpha4(t, p, o) t.tex.GatherAlpha(t.smpl, p, o)","    #define FxaaTexGreen4(t, p) t.tex.GatherGreen(t.smpl, p)","    #define FxaaTexOffGreen4(t, p, o) t.tex.GatherGreen(t.smpl, p, o)","#endif","","","/*============================================================================","                   GREEN AS LUMA OPTION SUPPORT FUNCTION","============================================================================*/","#if (FXAA_GREEN_AS_LUMA == 0)","    FxaaFloat FxaaLuma(FxaaFloat4 rgba) { return rgba.w; }","#else","    FxaaFloat FxaaLuma(FxaaFloat4 rgba) { return rgba.y; }","#endif","","","","","/*============================================================================","","                             FXAA3 QUALITY - PC","","============================================================================*/","#if (FXAA_PC == 1)","/*--------------------------------------------------------------------------*/","FxaaFloat4 FxaaPixelShader(","    //","    // Use noperspective interpolation here (turn off perspective interpolation).","    // {xy} = center of pixel","    FxaaFloat2 pos,","    //","    // Used only for FXAA Console, and not used on the 360 version.","    // Use noperspective interpolation here (turn off perspective interpolation).","    // {xy_} = upper left of pixel","    // {_zw} = lower right of pixel","    FxaaFloat4 fxaaConsolePosPos,","    //","    // Input color texture.","    // {rgb_} = color in linear or perceptual color space","    // if (FXAA_GREEN_AS_LUMA == 0)","    //     {__a} = luma in perceptual color space (not linear)","    FxaaTex tex,","    //","    // Only used on the optimized 360 version of FXAA Console.",'    // For everything but 360, just use the same input here as for "tex".',"    // For 360, same texture, just alias with a 2nd sampler.","    // This sampler needs to have an exponent bias of -1.","    FxaaTex fxaaConsole360TexExpBiasNegOne,","    //","    // Only used on the optimized 360 version of FXAA Console.",'    // For everything but 360, just use the same input here as for "tex".',"    // For 360, same texture, just alias with a 3nd sampler.","    // This sampler needs to have an exponent bias of -2.","    FxaaTex fxaaConsole360TexExpBiasNegTwo,","    //","    // Only used on FXAA Quality.","    // This must be from a constant/uniform.","    // {x_} = 1.0/screenWidthInPixels","    // {_y} = 1.0/screenHeightInPixels","    FxaaFloat2 fxaaQualityRcpFrame,","    //","    // Only used on FXAA Console.","    // This must be from a constant/uniform.","    // This effects sub-pixel AA quality and inversely sharpness.","    //   Where N ranges between,","    //     N = 0.50 (default)","    //     N = 0.33 (sharper)","    // {x__} = -N/screenWidthInPixels","    // {_y_} = -N/screenHeightInPixels","    // {_z_} =  N/screenWidthInPixels","    // {__w} =  N/screenHeightInPixels","    FxaaFloat4 fxaaConsoleRcpFrameOpt,","    //","    // Only used on FXAA Console.","    // Not used on 360, but used on PS3 and PC.","    // This must be from a constant/uniform.","    // {x__} = -2.0/screenWidthInPixels","    // {_y_} = -2.0/screenHeightInPixels","    // {_z_} =  2.0/screenWidthInPixels","    // {__w} =  2.0/screenHeightInPixels","    FxaaFloat4 fxaaConsoleRcpFrameOpt2,","    //","    // Only used on FXAA Console.","    // Only used on 360 in place of fxaaConsoleRcpFrameOpt2.","    // This must be from a constant/uniform.","    // {x__} =  8.0/screenWidthInPixels","    // {_y_} =  8.0/screenHeightInPixels","    // {_z_} = -4.0/screenWidthInPixels","    // {__w} = -4.0/screenHeightInPixels","    FxaaFloat4 fxaaConsole360RcpFrameOpt2,","    //","    // Only used on FXAA Quality.","    // This used to be the FXAA_QUALITY_SUBPIX define.","    // It is here now to allow easier tuning.","    // Choose the amount of sub-pixel aliasing removal.","    // This can effect sharpness.","    //   1.00 - upper limit (softer)","    //   0.75 - default amount of filtering","    //   0.50 - lower limit (sharper, less sub-pixel aliasing removal)","    //   0.25 - almost off","    //   0.00 - completely off","    FxaaFloat fxaaQualitySubpix,","    //","    // Only used on FXAA Quality.","    // This used to be the FXAA_QUALITY_EDGE_THRESHOLD define.","    // It is here now to allow easier tuning.","    // The minimum amount of local contrast required to apply algorithm.","    //   0.333 - too little (faster)","    //   0.250 - low quality","    //   0.166 - default","    //   0.125 - high quality","    //   0.063 - overkill (slower)","    FxaaFloat fxaaQualityEdgeThreshold,","    //","    // Only used on FXAA Quality.","    // This used to be the FXAA_QUALITY_EDGE_THRESHOLD_MIN define.","    // It is here now to allow easier tuning.","    // Trims the algorithm from processing darks.","    //   0.0833 - upper limit (default, the start of visible unfiltered edges)","    //   0.0625 - high quality (faster)","    //   0.0312 - visible limit (slower)","    // Special notes when using FXAA_GREEN_AS_LUMA,","    //   Likely want to set this to zero.","    //   As colors that are mostly not-green","    //   will appear very dark in the green channel!","    //   Tune by looking at mostly non-green content,","    //   then start at zero and increase until aliasing is a problem.","    FxaaFloat fxaaQualityEdgeThresholdMin,","    //","    // Only used on FXAA Console.","    // This used to be the FXAA_CONSOLE_EDGE_SHARPNESS define.","    // It is here now to allow easier tuning.","    // This does not effect PS3, as this needs to be compiled in.","    //   Use FXAA_CONSOLE_PS3_EDGE_SHARPNESS for PS3.","    //   Due to the PS3 being ALU bound,","    //   there are only three safe values here: 2 and 4 and 8.","    //   These options use the shaders ability to a free *|/ by 2|4|8.","    // For all other platforms can be a non-power of two.","    //   8.0 is sharper (default!!!)","    //   4.0 is softer","    //   2.0 is really soft (good only for vector graphics inputs)","    FxaaFloat fxaaConsoleEdgeSharpness,","    //","    // Only used on FXAA Console.","    // This used to be the FXAA_CONSOLE_EDGE_THRESHOLD define.","    // It is here now to allow easier tuning.","    // This does not effect PS3, as this needs to be compiled in.","    //   Use FXAA_CONSOLE_PS3_EDGE_THRESHOLD for PS3.","    //   Due to the PS3 being ALU bound,","    //   there are only two safe values here: 1/4 and 1/8.","    //   These options use the shaders ability to a free *|/ by 2|4|8.","    // The console setting has a different mapping than the quality setting.","    // Other platforms can use other values.","    //   0.125 leaves less aliasing, but is softer (default!!!)","    //   0.25 leaves more aliasing, and is sharper","    FxaaFloat fxaaConsoleEdgeThreshold,","    //","    // Only used on FXAA Console.","    // This used to be the FXAA_CONSOLE_EDGE_THRESHOLD_MIN define.","    // It is here now to allow easier tuning.","    // Trims the algorithm from processing darks.","    // The console setting has a different mapping than the quality setting.","    // This only applies when FXAA_EARLY_EXIT is 1.","    // This does not apply to PS3,","    // PS3 was simplified to avoid more shader instructions.","    //   0.06 - faster but more aliasing in darks","    //   0.05 - default","    //   0.04 - slower and less aliasing in darks","    // Special notes when using FXAA_GREEN_AS_LUMA,","    //   Likely want to set this to zero.","    //   As colors that are mostly not-green","    //   will appear very dark in the green channel!","    //   Tune by looking at mostly non-green content,","    //   then start at zero and increase until aliasing is a problem.","    FxaaFloat fxaaConsoleEdgeThresholdMin,","    //","    // Extra constants for 360 FXAA Console only.","    // Use zeros or anything else for other platforms.","    // These must be in physical constant registers and NOT immediates.","    // Immediates will result in compiler un-optimizing.","    // {xyzw} = float4(1.0, -1.0, 0.25, -0.25)","    FxaaFloat4 fxaaConsole360ConstDir",") {","/*--------------------------------------------------------------------------*/","    FxaaFloat2 posM;","    posM.x = pos.x;","    posM.y = pos.y;","    #if (FXAA_GATHER4_ALPHA == 1)","        #if (FXAA_DISCARD == 0)","            FxaaFloat4 rgbyM = FxaaTexTop(tex, posM);","            #if (FXAA_GREEN_AS_LUMA == 0)","                #define lumaM rgbyM.w","            #else","                #define lumaM rgbyM.y","            #endif","        #endif","        #if (FXAA_GREEN_AS_LUMA == 0)","            FxaaFloat4 luma4A = FxaaTexAlpha4(tex, posM);","            FxaaFloat4 luma4B = FxaaTexOffAlpha4(tex, posM, FxaaInt2(-1, -1));","        #else","            FxaaFloat4 luma4A = FxaaTexGreen4(tex, posM);","            FxaaFloat4 luma4B = FxaaTexOffGreen4(tex, posM, FxaaInt2(-1, -1));","        #endif","        #if (FXAA_DISCARD == 1)","            #define lumaM luma4A.w","        #endif","        #define lumaE luma4A.z","        #define lumaS luma4A.x","        #define lumaSE luma4A.y","        #define lumaNW luma4B.w","        #define lumaN luma4B.z","        #define lumaW luma4B.x","    #else","        FxaaFloat4 rgbyM = FxaaTexTop(tex, posM);","        #if (FXAA_GREEN_AS_LUMA == 0)","            #define lumaM rgbyM.w","        #else","            #define lumaM rgbyM.y","        #endif","        #if (FXAA_GLSL_100 == 1)","          FxaaFloat lumaS = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 0.0, 1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaE = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 1.0, 0.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaN = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 0.0,-1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaW = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2(-1.0, 0.0), fxaaQualityRcpFrame.xy));","        #else","          FxaaFloat lumaS = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 0, 1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 1, 0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaN = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 0,-1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1, 0), fxaaQualityRcpFrame.xy));","        #endif","    #endif","/*--------------------------------------------------------------------------*/","    FxaaFloat maxSM = max(lumaS, lumaM);","    FxaaFloat minSM = min(lumaS, lumaM);","    FxaaFloat maxESM = max(lumaE, maxSM);","    FxaaFloat minESM = min(lumaE, minSM);","    FxaaFloat maxWN = max(lumaN, lumaW);","    FxaaFloat minWN = min(lumaN, lumaW);","    FxaaFloat rangeMax = max(maxWN, maxESM);","    FxaaFloat rangeMin = min(minWN, minESM);","    FxaaFloat rangeMaxScaled = rangeMax * fxaaQualityEdgeThreshold;","    FxaaFloat range = rangeMax - rangeMin;","    FxaaFloat rangeMaxClamped = max(fxaaQualityEdgeThresholdMin, rangeMaxScaled);","    FxaaBool earlyExit = range < rangeMaxClamped;","/*--------------------------------------------------------------------------*/","    if(earlyExit)","        #if (FXAA_DISCARD == 1)","            FxaaDiscard;","        #else","            return rgbyM;","        #endif","/*--------------------------------------------------------------------------*/","    #if (FXAA_GATHER4_ALPHA == 0)","        #if (FXAA_GLSL_100 == 1)","          FxaaFloat lumaNW = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2(-1.0,-1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSE = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 1.0, 1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaNE = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 1.0,-1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSW = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2(-1.0, 1.0), fxaaQualityRcpFrame.xy));","        #else","          FxaaFloat lumaNW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1,-1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 1, 1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaNE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 1,-1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1, 1), fxaaQualityRcpFrame.xy));","        #endif","    #else","        FxaaFloat lumaNE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(1, -1), fxaaQualityRcpFrame.xy));","        FxaaFloat lumaSW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1, 1), fxaaQualityRcpFrame.xy));","    #endif","/*--------------------------------------------------------------------------*/","    FxaaFloat lumaNS = lumaN + lumaS;","    FxaaFloat lumaWE = lumaW + lumaE;","    FxaaFloat subpixRcpRange = 1.0/range;","    FxaaFloat subpixNSWE = lumaNS + lumaWE;","    FxaaFloat edgeHorz1 = (-2.0 * lumaM) + lumaNS;","    FxaaFloat edgeVert1 = (-2.0 * lumaM) + lumaWE;","/*--------------------------------------------------------------------------*/","    FxaaFloat lumaNESE = lumaNE + lumaSE;","    FxaaFloat lumaNWNE = lumaNW + lumaNE;","    FxaaFloat edgeHorz2 = (-2.0 * lumaE) + lumaNESE;","    FxaaFloat edgeVert2 = (-2.0 * lumaN) + lumaNWNE;","/*--------------------------------------------------------------------------*/","    FxaaFloat lumaNWSW = lumaNW + lumaSW;","    FxaaFloat lumaSWSE = lumaSW + lumaSE;","    FxaaFloat edgeHorz4 = (abs(edgeHorz1) * 2.0) + abs(edgeHorz2);","    FxaaFloat edgeVert4 = (abs(edgeVert1) * 2.0) + abs(edgeVert2);","    FxaaFloat edgeHorz3 = (-2.0 * lumaW) + lumaNWSW;","    FxaaFloat edgeVert3 = (-2.0 * lumaS) + lumaSWSE;","    FxaaFloat edgeHorz = abs(edgeHorz3) + edgeHorz4;","    FxaaFloat edgeVert = abs(edgeVert3) + edgeVert4;","/*--------------------------------------------------------------------------*/","    FxaaFloat subpixNWSWNESE = lumaNWSW + lumaNESE;","    FxaaFloat lengthSign = fxaaQualityRcpFrame.x;","    FxaaBool horzSpan = edgeHorz >= edgeVert;","    FxaaFloat subpixA = subpixNSWE * 2.0 + subpixNWSWNESE;","/*--------------------------------------------------------------------------*/","    if(!horzSpan) lumaN = lumaW;","    if(!horzSpan) lumaS = lumaE;","    if(horzSpan) lengthSign = fxaaQualityRcpFrame.y;","    FxaaFloat subpixB = (subpixA * (1.0/12.0)) - lumaM;","/*--------------------------------------------------------------------------*/","    FxaaFloat gradientN = lumaN - lumaM;","    FxaaFloat gradientS = lumaS - lumaM;","    FxaaFloat lumaNN = lumaN + lumaM;","    FxaaFloat lumaSS = lumaS + lumaM;","    FxaaBool pairN = abs(gradientN) >= abs(gradientS);","    FxaaFloat gradient = max(abs(gradientN), abs(gradientS));","    if(pairN) lengthSign = -lengthSign;","    FxaaFloat subpixC = FxaaSat(abs(subpixB) * subpixRcpRange);","/*--------------------------------------------------------------------------*/","    FxaaFloat2 posB;","    posB.x = posM.x;","    posB.y = posM.y;","    FxaaFloat2 offNP;","    offNP.x = (!horzSpan) ? 0.0 : fxaaQualityRcpFrame.x;","    offNP.y = ( horzSpan) ? 0.0 : fxaaQualityRcpFrame.y;","    if(!horzSpan) posB.x += lengthSign * 0.5;","    if( horzSpan) posB.y += lengthSign * 0.5;","/*--------------------------------------------------------------------------*/","    FxaaFloat2 posN;","    posN.x = posB.x - offNP.x * FXAA_QUALITY_P0;","    posN.y = posB.y - offNP.y * FXAA_QUALITY_P0;","    FxaaFloat2 posP;","    posP.x = posB.x + offNP.x * FXAA_QUALITY_P0;","    posP.y = posB.y + offNP.y * FXAA_QUALITY_P0;","    FxaaFloat subpixD = ((-2.0)*subpixC) + 3.0;","    FxaaFloat lumaEndN = FxaaLuma(FxaaTexTop(tex, posN));","    FxaaFloat subpixE = subpixC * subpixC;","    FxaaFloat lumaEndP = FxaaLuma(FxaaTexTop(tex, posP));","/*--------------------------------------------------------------------------*/","    if(!pairN) lumaNN = lumaSS;","    FxaaFloat gradientScaled = gradient * 1.0/4.0;","    FxaaFloat lumaMM = lumaM - lumaNN * 0.5;","    FxaaFloat subpixF = subpixD * subpixE;","    FxaaBool lumaMLTZero = lumaMM < 0.0;","/*--------------------------------------------------------------------------*/","    lumaEndN -= lumaNN * 0.5;","    lumaEndP -= lumaNN * 0.5;","    FxaaBool doneN = abs(lumaEndN) >= gradientScaled;","    FxaaBool doneP = abs(lumaEndP) >= gradientScaled;","    if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P1;","    if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P1;","    FxaaBool doneNP = (!doneN) || (!doneP);","    if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P1;","    if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P1;","/*--------------------------------------------------------------------------*/","    if(doneNP) {","        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","        doneN = abs(lumaEndN) >= gradientScaled;","        doneP = abs(lumaEndP) >= gradientScaled;","        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P2;","        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P2;","        doneNP = (!doneN) || (!doneP);","        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P2;","        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P2;","/*--------------------------------------------------------------------------*/","        #if (FXAA_QUALITY_PS > 3)","        if(doneNP) {","            if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","            if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","            if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","            if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","            doneN = abs(lumaEndN) >= gradientScaled;","            doneP = abs(lumaEndP) >= gradientScaled;","            if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P3;","            if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P3;","            doneNP = (!doneN) || (!doneP);","            if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P3;","            if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P3;","/*--------------------------------------------------------------------------*/","            #if (FXAA_QUALITY_PS > 4)","            if(doneNP) {","                if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                doneN = abs(lumaEndN) >= gradientScaled;","                doneP = abs(lumaEndP) >= gradientScaled;","                if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P4;","                if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P4;","                doneNP = (!doneN) || (!doneP);","                if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P4;","                if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P4;","/*--------------------------------------------------------------------------*/","                #if (FXAA_QUALITY_PS > 5)","                if(doneNP) {","                    if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                    if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                    if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                    if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                    doneN = abs(lumaEndN) >= gradientScaled;","                    doneP = abs(lumaEndP) >= gradientScaled;","                    if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P5;","                    if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P5;","                    doneNP = (!doneN) || (!doneP);","                    if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P5;","                    if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P5;","/*--------------------------------------------------------------------------*/","                    #if (FXAA_QUALITY_PS > 6)","                    if(doneNP) {","                        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                        doneN = abs(lumaEndN) >= gradientScaled;","                        doneP = abs(lumaEndP) >= gradientScaled;","                        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P6;","                        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P6;","                        doneNP = (!doneN) || (!doneP);","                        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P6;","                        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P6;","/*--------------------------------------------------------------------------*/","                        #if (FXAA_QUALITY_PS > 7)","                        if(doneNP) {","                            if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                            if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                            if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                            if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                            doneN = abs(lumaEndN) >= gradientScaled;","                            doneP = abs(lumaEndP) >= gradientScaled;","                            if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P7;","                            if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P7;","                            doneNP = (!doneN) || (!doneP);","                            if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P7;","                            if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P7;","/*--------------------------------------------------------------------------*/","    #if (FXAA_QUALITY_PS > 8)","    if(doneNP) {","        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","        doneN = abs(lumaEndN) >= gradientScaled;","        doneP = abs(lumaEndP) >= gradientScaled;","        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P8;","        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P8;","        doneNP = (!doneN) || (!doneP);","        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P8;","        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P8;","/*--------------------------------------------------------------------------*/","        #if (FXAA_QUALITY_PS > 9)","        if(doneNP) {","            if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","            if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","            if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","            if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","            doneN = abs(lumaEndN) >= gradientScaled;","            doneP = abs(lumaEndP) >= gradientScaled;","            if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P9;","            if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P9;","            doneNP = (!doneN) || (!doneP);","            if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P9;","            if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P9;","/*--------------------------------------------------------------------------*/","            #if (FXAA_QUALITY_PS > 10)","            if(doneNP) {","                if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                doneN = abs(lumaEndN) >= gradientScaled;","                doneP = abs(lumaEndP) >= gradientScaled;","                if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P10;","                if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P10;","                doneNP = (!doneN) || (!doneP);","                if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P10;","                if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P10;","/*--------------------------------------------------------------------------*/","                #if (FXAA_QUALITY_PS > 11)","                if(doneNP) {","                    if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                    if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                    if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                    if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                    doneN = abs(lumaEndN) >= gradientScaled;","                    doneP = abs(lumaEndP) >= gradientScaled;","                    if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P11;","                    if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P11;","                    doneNP = (!doneN) || (!doneP);","                    if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P11;","                    if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P11;","/*--------------------------------------------------------------------------*/","                    #if (FXAA_QUALITY_PS > 12)","                    if(doneNP) {","                        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                        doneN = abs(lumaEndN) >= gradientScaled;","                        doneP = abs(lumaEndP) >= gradientScaled;","                        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P12;","                        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P12;","                        doneNP = (!doneN) || (!doneP);","                        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P12;","                        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P12;","/*--------------------------------------------------------------------------*/","                    }","                    #endif","/*--------------------------------------------------------------------------*/","                }","                #endif","/*--------------------------------------------------------------------------*/","            }","            #endif","/*--------------------------------------------------------------------------*/","        }","        #endif","/*--------------------------------------------------------------------------*/","    }","    #endif","/*--------------------------------------------------------------------------*/","                        }","                        #endif","/*--------------------------------------------------------------------------*/","                    }","                    #endif","/*--------------------------------------------------------------------------*/","                }","                #endif","/*--------------------------------------------------------------------------*/","            }","            #endif","/*--------------------------------------------------------------------------*/","        }","        #endif","/*--------------------------------------------------------------------------*/","    }","/*--------------------------------------------------------------------------*/","    FxaaFloat dstN = posM.x - posN.x;","    FxaaFloat dstP = posP.x - posM.x;","    if(!horzSpan) dstN = posM.y - posN.y;","    if(!horzSpan) dstP = posP.y - posM.y;","/*--------------------------------------------------------------------------*/","    FxaaBool goodSpanN = (lumaEndN < 0.0) != lumaMLTZero;","    FxaaFloat spanLength = (dstP + dstN);","    FxaaBool goodSpanP = (lumaEndP < 0.0) != lumaMLTZero;","    FxaaFloat spanLengthRcp = 1.0/spanLength;","/*--------------------------------------------------------------------------*/","    FxaaBool directionN = dstN < dstP;","    FxaaFloat dst = min(dstN, dstP);","    FxaaBool goodSpan = directionN ? goodSpanN : goodSpanP;","    FxaaFloat subpixG = subpixF * subpixF;","    FxaaFloat pixelOffset = (dst * (-spanLengthRcp)) + 0.5;","    FxaaFloat subpixH = subpixG * fxaaQualitySubpix;","/*--------------------------------------------------------------------------*/","    FxaaFloat pixelOffsetGood = goodSpan ? pixelOffset : 0.0;","    FxaaFloat pixelOffsetSubpix = max(pixelOffsetGood, subpixH);","    if(!horzSpan) posM.x += pixelOffsetSubpix * lengthSign;","    if( horzSpan) posM.y += pixelOffsetSubpix * lengthSign;","    #if (FXAA_DISCARD == 1)","        return FxaaTexTop(tex, posM);","    #else","        return FxaaFloat4(FxaaTexTop(tex, posM).xyz, lumaM);","    #endif","}","/*==========================================================================*/","#endif","","void mainImage(const in vec4 inputColor, const in vec2 uv, out vec4 outputColor) {","  outputColor = FxaaPixelShader(","    uv,","    vec4(0.0),","    tDiffuse,","    tDiffuse,","    tDiffuse,","    resolution,","    vec4(0.0),","    vec4(0.0),","    vec4(0.0),","    0.75,","    0.166,","    0.0833,","    0.0,","    0.0,","    0.0,","    vec4(0.0)","  );","","  // TODO avoid querying texture twice for same texel","  outputColor.a = texture2D(tDiffuse, vUv).a;","}"].join("\n");function Ue(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var Be={effects:[{effect:function(e){(0,u.Z)(n,e);var t=Ue(n);function n(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=r.blendFunction,o=void 0===i?M:i;return(0,a.Z)(this,n),(e=t.call(this,"FXAAEffect",Ce,{blendFunction:o,uniforms:new Map([["tDiffuse",new d.xWb(null)],["resolution",new d.xWb(new d.FM8)]])})).resolution=new d.FM8,e}return(0,o.Z)(n,[{key:"update",value:function(e,t,n){this.uniforms.get("tDiffuse").value=t}},{key:"setSize",value:function(e,t){this.resolution.set(e,t),this.uniforms.get("resolution").value.set(1/e,1/t)}}]),n}(Z),options:{blendFunction:M}},{effect:Ie,options:{blendFunction:O,patternTexture:null,edgeStrength:1,pulseSpeed:0,visibleEdgeColor:16777215,hiddenEdgeColor:2230538,resolutionScale:.5,width:F.AUTO_SIZE,height:F.AUTO_SIZE,kernelSize:W.VERY_SMALL,blur:!1,xRay:!0}},{effect:ie,options:{blendFunction:O,kernelSize:W.SMALL,luminanceThreshold:1.05,luminanceSmoothing:.1,intensity:1}},{effect:Oe}]};function Xe(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var Ze=function(e){(0,u.Z)(n,e);var t=Xe(n);function n(){var e;return(0,a.Z)(this,n),(e=t.call(this,"ClearMaskPass",null,null)).needsSwap=!1,e}return(0,o.Z)(n,[{key:"render",value:function(e,t,n,r,i){var a=e.state.buffers.stencil;a.setLocked(!1),a.setTest(!1)}}]),n}($);function ze(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var Ge=function(e){(0,u.Z)(n,e);var t=ze(n);function n(e,r){var i;return(0,a.Z)(this,n),(i=t.call(this,"MaskPass",e,r)).needsSwap=!1,i.clearPass=new ge(!1,!1,!0),i.inverse=!1,i}return(0,o.Z)(n,[{key:"render",value:function(e,t,n,r,i){var a=e.getContext(),o=e.state.buffers,s=this.scene,l=this.camera,u=this.clearPass,c=this.inverse?0:1,f=1-c;o.color.setMask(!1),o.depth.setMask(!1),o.color.setLocked(!0),o.depth.setLocked(!0),o.stencil.setTest(!0),o.stencil.setOp(a.REPLACE,a.REPLACE,a.REPLACE),o.stencil.setFunc(a.ALWAYS,c,4294967295),o.stencil.setClear(f),o.stencil.setLocked(!0),this.clear&&(this.renderToScreen?u.render(e,null):(u.render(e,t),u.render(e,n))),this.renderToScreen?(e.setRenderTarget(null),e.render(s,l)):(e.setRenderTarget(t),e.render(s,l),e.setRenderTarget(n),e.render(s,l)),o.color.setLocked(!1),o.depth.setLocked(!1),o.stencil.setLocked(!1),o.stencil.setFunc(a.EQUAL,1,4294967295),o.stencil.setOp(a.KEEP,a.KEEP,a.KEEP),o.stencil.setLocked(!0)}},{key:"clear",get:function(){return this.clearPass.enabled},set:function(e){this.clearPass.enabled=e}}]),n}($);function Ye(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var Qe=function(e){(0,u.Z)(n,e);var t=Ye(n);function n(){var e;return(0,a.Z)(this,n),(e=t.call(this,{type:"CopyMaterial",uniforms:{inputBuffer:new d.xWb(null),opacity:new d.xWb(1)},fragmentShader:"uniform sampler2D inputBuffer;\nuniform float opacity;\n\nvarying vec2 vUv;\n\nvoid main() {\n\n\tvec4 texel = texture2D(inputBuffer, vUv);\n\tgl_FragColor = opacity * texel;\n\n\t#include <encodings_fragment>\n\n}\n",vertexShader:D,depthWrite:!1,depthTest:!1})).toneMapped=!1,e}return n}(d.jyz);function He(e,t){var n;if("undefined"===typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"===typeof e)return Ve(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Ve(e,t)}(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function Ve(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var We={depthBuffer:!0,stencilBuffer:!0,multisampling:!0,frameBufferType:d.cLu},je=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:We;(0,a.Z)(this,e),this.renderer=t;var r=n.depthBuffer,i=n.stencilBuffer,o=n.frameBufferType,s=n.multisampling;this.inputBuffer=null,this.outputBuffer=null,null!==this.renderer&&(this.renderer.autoClear=!1,this.inputBuffer=this.createBuffer(r,i,o,s),this.outputBuffer=this.inputBuffer.clone(),this.enableExtensions()),this.copyPass=new ne(new Qe),this.depthTexture=null,this.passes=[],this.autoRenderToScreen=!0}return(0,o.Z)(e,[{key:"getRenderer",value:function(){return this.renderer}},{key:"enableExtensions",value:function(){var e=this.inputBuffer.texture.type,t=this.renderer.capabilities,n=this.renderer.getContext();e!==d.ywz&&(t.isWebGL2?n.getExtension("EXT_color_buffer_float"):n.getExtension("EXT_color_buffer_half_float"))}},{key:"replaceRenderer",value:function(e){var t,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=this.renderer;if(null!==r&&r!==e){var i=r.getSize(new d.FM8),a=e.getSize(new d.FM8),o=null===(t=r.domElement)||void 0===t?void 0:t.parentNode;this.renderer=e,this.renderer.autoClear=!1,i.equals(a)||this.setSize(a.x,a.y),n&&null!==o&&(o.removeChild(r.domElement),o.appendChild(e.domElement)),this.enableExtensions()}return r}},{key:"createDepthTexture",value:function(){var e=this.depthTexture=new d.$YQ(512,512);return this.inputBuffer.stencilBuffer?(e.format=d.brP,e.type=d.wJv):e.type=d.JQ4,e}},{key:"createBuffer",value:function(e,t,n,r){var i,a=this.renderer.getDrawingBufferSize(new d.FM8),o={format:this.renderer.getContext().getContextAttributes().alpha||n!==d.ywz?d.wk1:d.UCm,minFilter:d.wem,magFilter:d.wem,stencilBuffer:t,depthBuffer:e,type:n},s=window,l=(s.iOS,s.safariWebBrowser);return r>0&&!l?(i=new d.p7A(a.width,a.height,o)).samples=r:i=new d.dd2(a.width,a.height,o),i.texture.name="EffectComposer.Buffer",i.texture.generateMipmaps=!1,i}},{key:"addPass",value:function(e,t){var n=this.passes,r=this.renderer,i=r.getContext().getContextAttributes().alpha,a=this.inputBuffer.texture.type,o=r.getDrawingBufferSize(new d.FM8);if(e.setSize(o.width,o.height),e.initialize(r,i,a),this.autoRenderToScreen&&(n.length>0&&(n[n.length-1].renderToScreen=!1),e.renderToScreen&&(this.autoRenderToScreen=!1)),void 0!==t?n.splice(t,0,e):n.push(e),this.autoRenderToScreen&&(n[n.length-1].renderToScreen=!0),e.needsDepthTexture||null!==this.depthTexture)if(null===this.depthTexture){var s,l=this.createDepthTexture(),u=He(n);try{for(u.s();!(s=u.n()).done;)(e=s.value).setDepthTexture(l)}catch(c){u.e(c)}finally{u.f()}}else e.setDepthTexture(this.depthTexture)}},{key:"removePass",value:function(e){var t=this.passes,n=t.indexOf(e);if(t.splice(n,1).length>0){if(null!==this.depthTexture){if(!t.reduce((function(e,t){return e||t.needsDepthTexture}),!1)){this.depthTexture.dispose(),this.depthTexture=null,this.inputBuffer.depthTexture=null,this.outputBuffer.depthTexture=null,e.setDepthTexture(null);var r,i=He(t);try{for(i.s();!(r=i.n()).done;)(e=r.value).setDepthTexture(null)}catch(a){i.e(a)}finally{i.f()}}}this.autoRenderToScreen&&t.length>0&&n===t.length&&(t[t.length-1].renderToScreen=!0)}}},{key:"render",value:function(e){var t,n,r,i,a=this.renderer,o=this.copyPass,s=this.inputBuffer,l=this.outputBuffer,u=!1,c=He(this.passes);try{for(c.s();!(i=c.n()).done;){var f=i.value;f.enabled&&(f.render(a,s,l,e,u),f.needsSwap&&(u&&(o.renderToScreen=f.renderToScreen,t=a.getContext(),(n=a.state.buffers.stencil).setFunc(t.NOTEQUAL,1,4294967295),o.render(a,s,l,e,u),n.setFunc(t.EQUAL,1,4294967295)),r=s,s=l,l=r),f instanceof Ge?u=!0:f instanceof Ze&&(u=!1))}}catch(d){c.e(d)}finally{c.f()}}},{key:"setSize",value:function(e,t,n){var r=this.renderer;if(void 0===e||void 0===t){var i=r.getSize(new d.FM8);e=i.width,t=i.height}r.setSize(e,t,n);var a=r.getDrawingBufferSize(new d.FM8);this.inputBuffer.setSize(a.width,a.height),this.outputBuffer.setSize(a.width,a.height);var o,s=He(this.passes);try{for(s.s();!(o=s.n()).done;){o.value.setSize(a.width,a.height)}}catch(l){s.e(l)}finally{s.f()}}},{key:"reset",value:function(){var e=this.inputBuffer.clone();this.dispose(),this.inputBuffer=e,this.outputBuffer=e.clone(),this.depthTexture=null,this.copyPass=new ne(new Qe),this.autoRenderToScreen=!0}},{key:"dispose",value:function(){console.warn("DISPOSE EffectComposer");var e,t=He(this.passes);try{for(t.s();!(e=t.n()).done;){e.value.dispose()}}catch(n){t.e(n)}finally{t.f()}this.passes=[],null!==this.inputBuffer&&(this.inputBuffer.dispose(),this.inputBuffer=null),null!==this.outputBuffer&&(this.outputBuffer.dispose(),this.outputBuffer=null),null!==this.depthTexture&&this.depthTexture.dispose(),this.copyPass.dispose()}},{key:"multisampling",get:function(){return this.inputBuffer instanceof d.p7A?this.inputBuffer.samples:0},set:function(e){var t=this.inputBuffer,n=this.multisampling;n>0&&e>0?(this.inputBuffer.samples=e,this.outputBuffer.samples=e):n!==e&&(this.inputBuffer.dispose(),this.outputBuffer.dispose(),this.inputBuffer=this.createBuffer(t.depthBuffer,t.stencilBuffer,t.texture.type,e),this.outputBuffer=this.inputBuffer.clone())}}]),e}(),qe="uniform sampler2D nearColorBuffer;\nuniform sampler2D farColorBuffer;\nuniform sampler2D nearCoCBuffer;\n\nuniform float scale;\n\nvoid mainImage(const in vec4 inputColor, const in vec2 uv, const in float depth, out vec4 outputColor) {\n\n\tvec4 colorNear = texture2D(nearColorBuffer, uv);\n\tvec4 colorFar = texture2D(farColorBuffer, uv);\n\n\tfloat CoCNear = texture2D(nearCoCBuffer, uv).r;\n\tCoCNear = min(CoCNear * scale, 1.0);\n\n\t// The far color buffer has been premultiplied with the CoC buffer.\n\tvec4 result = inputColor * (1.0 - colorFar.a) + colorFar;\n\tresult = mix(result, colorNear, CoCNear);\n\n\toutputColor = result;\n\n}\n";function Ke(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var $e=function(e){(0,u.Z)(n,e);var t=Ke(n);function n(e){var r;return(0,a.Z)(this,n),(r=t.call(this,{type:"CircleOfConfusionMaterial",defines:{DEPTH_PACKING:"0"},uniforms:{depthBuffer:new d.xWb(null),focusDistance:new d.xWb(0),focalLength:new d.xWb(0),cameraNear:new d.xWb(.3),cameraFar:new d.xWb(1e3)},fragmentShader:"#include <common>\n#include <packing>\n\n#ifdef GL_FRAGMENT_PRECISION_HIGH\n\n\tuniform highp sampler2D depthBuffer;\n\n#else\n\n\tuniform mediump sampler2D depthBuffer;\n\n#endif\n\nuniform float focusDistance;\nuniform float focalLength;\nuniform float cameraNear;\nuniform float cameraFar;\n\nvarying vec2 vUv;\n\nfloat readDepth(const in vec2 uv) {\n\n\t#if DEPTH_PACKING == 3201\n\n\t\treturn unpackRGBAToDepth(texture2D(depthBuffer, uv));\n\n\t#else\n\n\t\treturn texture2D(depthBuffer, uv).r;\n\n\t#endif\n\n}\n\nvoid main() {\n\n\tfloat depth = readDepth(vUv);\n\n\t#ifdef PERSPECTIVE_CAMERA\n\n\t\tfloat viewZ = perspectiveDepthToViewZ(depth, cameraNear, cameraFar);\n\t\tfloat linearDepth = viewZToOrthographicDepth(viewZ, cameraNear, cameraFar);\n\n\t#else\n\n\t\tfloat linearDepth = depth;\n\n\t#endif\n\n\tfloat signedDistance = linearDepth - focusDistance;\n\tfloat magnitude = smoothstep(0.0, focalLength, abs(signedDistance));\n\n\tgl_FragColor.rg = vec2(\n\t\tstep(signedDistance, 0.0) * magnitude,\n\t\tstep(0.0, signedDistance) * magnitude\n\t);\n\n}\n",vertexShader:D,depthWrite:!1,depthTest:!1})).toneMapped=!1,r.adoptCameraSettings(e),r}return(0,o.Z)(n,[{key:"adoptCameraSettings",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;null!==e&&(this.uniforms.cameraNear.value=e.near,this.uniforms.cameraFar.value=e.far,e instanceof d.cPb?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0)}},{key:"depthPacking",get:function(){return Number(this.defines.DEPTH_PACKING)},set:function(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}}]),n}(d.jyz),Je=0,et=1,tt=2,nt=3,rt="uniform sampler2D maskTexture;\nuniform sampler2D inputBuffer;\n\n#if MASK_FUNCTION != 0\n\n\tuniform float strength;\n\n#endif\n\nvarying vec2 vUv;\n\nvoid main() {\n\n\t#if COLOR_CHANNEL == 0\n\n\t\tfloat mask = texture2D(maskTexture, vUv).r;\n\n\t#elif COLOR_CHANNEL == 1\n\n\t\tfloat mask = texture2D(maskTexture, vUv).g;\n\n\t#elif COLOR_CHANNEL == 2\n\n\t\tfloat mask = texture2D(maskTexture, vUv).b;\n\n\t#else\n\n\t\tfloat mask = texture2D(maskTexture, vUv).a;\n\n\t#endif\n\n\t#if MASK_FUNCTION == 0\n\n\t\t#ifdef INVERTED\n\n\t\t\tif(mask > 0.0) {\n\n\t\t\t\tdiscard;\n\n\t\t\t}\n\n\t\t#else\n\n\t\t\tif(mask == 0.0) {\n\n\t\t\t\tdiscard;\n\n\t\t\t}\n\n\t\t#endif\n\n\t#else\n\n\t\tmask = clamp(mask * strength, 0.0, 1.0);\n\n\t\t#ifdef INVERTED\n\n\t\t\tmask = (1.0 - mask);\n\n\t\t#endif\n\n\t\t#if MASK_FUNCTION == 1\n\n\t\t\tgl_FragColor = mask * texture2D(inputBuffer, vUv);\n\n\t\t#else\n\n\t\t\tgl_FragColor = vec4(mask * texture2D(inputBuffer, vUv).rgb, mask);\n\n\t\t#endif\n\n\t#endif\n\n}\n";function it(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var at=function(e){(0,u.Z)(n,e);var t=it(n);function n(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return(0,a.Z)(this,n),(e=t.call(this,{type:"MaskMaterial",uniforms:{maskTexture:new d.xWb(r),inputBuffer:new d.xWb(null),strength:new d.xWb(1)},fragmentShader:rt,vertexShader:D,depthWrite:!1,depthTest:!1})).toneMapped=!1,e.colorChannel=Je,e.maskFunction=ot.DISCARD,e}return(0,o.Z)(n,[{key:"maskTexture",set:function(e){this.uniforms.maskTexture.value=e}},{key:"colorChannel",set:function(e){this.defines.COLOR_CHANNEL=e.toFixed(0),this.needsUpdate=!0}},{key:"maskFunction",set:function(e){this.defines.MASK_FUNCTION=e.toFixed(0),this.needsUpdate=!0}},{key:"inverted",get:function(){return void 0!==this.defines.INVERTED},set:function(e){this.inverted&&!e?delete this.defines.INVERTED:e&&(this.defines.INVERTED="1"),this.needsUpdate=!0}},{key:"strength",get:function(){return this.uniforms.strength.value},set:function(e){this.uniforms.strength.value=e}}]),n}(d.jyz),ot={DISCARD:0,MULTIPLY:1,MULTIPLY_RGB_SET_ALPHA:2},st="uniform sampler2D inputBuffer;\nuniform sampler2D cocBuffer;\n\nuniform vec2 texelSize;\nuniform float scale;\n\n#if PASS == 1\n\n\tuniform float kernel64[128];\n\n#else\n\n\tuniform float kernel16[32];\n\n#endif\n\nvarying vec2 vUv;\n\nvoid main() {\n\n\t#ifdef FOREGROUND\n\n\t\tvec2 CoCNearFar = texture2D(cocBuffer, vUv).rg;\n\t\tfloat CoC = CoCNearFar.r * scale;\n\n\t#else\n\n\t\tfloat CoC = texture2D(cocBuffer, vUv).g * scale;\n\n\t#endif\n\n\tif(CoC == 0.0) {\n\n\t\t// Skip blurring.\n\t\tgl_FragColor = texture2D(inputBuffer, vUv);\n\n\t} else {\n\n\t\t#ifdef FOREGROUND\n\n\t\t\t// Use far CoC to avoid weak blurring around foreground objects.\n\t\t\tvec2 step = texelSize * max(CoC, CoCNearFar.g * scale);\n\n\t\t#else\n\n\t\t\tvec2 step = texelSize * CoC;\n\n\t\t#endif\n\n\t\t#if PASS == 1\n\n\t\t\tvec4 acc = vec4(0.0);\n\n\t\t\tfor(int i = 0; i < 128; i += 2) {\n\n\t\t\t\tvec2 uv = step * vec2(kernel64[i], kernel64[i + 1]) + vUv;\n\t\t\t\tacc += texture2D(inputBuffer, uv);\n\n\t\t\t}\n\n\t\t\tgl_FragColor = acc / 64.0;\n\n\t\t#else\n\n\t\t\tvec4 maxValue = texture2D(inputBuffer, vUv);\n\n\t\t\tfor(int i = 0; i < 32; i += 2) {\n\n\t\t\t\tvec2 uv = step * vec2(kernel16[i], kernel16[i + 1]) + vUv;\n\t\t\t\tmaxValue = max(texture2D(inputBuffer, uv), maxValue);\n\n\t\t\t}\n\n\t\t\tgl_FragColor = maxValue;\n\n\t\t#endif\n\n\t}\n\n}\n";function lt(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var ut=function(e){(0,u.Z)(n,e);var t=lt(n);function n(){var e,r=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return(0,a.Z)(this,n),(e=t.call(this,{type:"BokehMaterial",defines:{PASS:r?"2":"1"},uniforms:{kernel64:new d.xWb(new Float32Array(128)),kernel16:new d.xWb(new Float32Array(32)),inputBuffer:new d.xWb(null),cocBuffer:new d.xWb(null),texelSize:new d.xWb(new d.FM8),scale:new d.xWb(1)},fragmentShader:st,vertexShader:D,depthWrite:!1,depthTest:!1})).toneMapped=!1,i&&(e.defines.FOREGROUND="1"),e.generateKernel(),e}return(0,o.Z)(n,[{key:"generateKernel",value:function(){for(var e=this.uniforms.kernel64.value,t=this.uniforms.kernel16.value,n=0,r=0,i=0;i<80;++i){var a=2.39996323*i,o=Math.sqrt(i)/Math.sqrt(80),s=o*Math.cos(a),l=o*Math.sin(a);i%5===0?(t[r++]=s,t[r++]=l):(e[n++]=s,e[n++]=l)}}},{key:"setTexelSize",value:function(e,t){this.uniforms.texelSize.value.set(e,t)}}]),n}(d.jyz);function ct(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var ft=function(e){(0,u.Z)(n,e);var t=ct(n);function n(e){var r,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=i.blendFunction,l=void 0===o?M:o,u=i.focusDistance,c=void 0===u?0:u,f=i.focalLength,h=void 0===f?.1:f,p=i.bokehScale,v=void 0===p?1:p,m=i.width,y=void 0===m?F.AUTO_SIZE:m,g=i.height,x=void 0===g?F.AUTO_SIZE:g;(0,a.Z)(this,n),(r=t.call(this,"DepthOfFieldEffect",qe,{blendFunction:l,attributes:z.DEPTH,uniforms:new Map([["nearColorBuffer",new d.xWb(null)],["farColorBuffer",new d.xWb(null)],["nearCoCBuffer",new d.xWb(null)],["scale",new d.xWb(1)]])})).camera=e,r.renderTarget=new d.dd2(1,1,{minFilter:d.wem,magFilter:d.wem,stencilBuffer:!1,depthBuffer:!1}),r.renderTarget.texture.name="DoF.Intermediate",r.renderTarget.texture.generateMipmaps=!1,r.renderTargetMasked=r.renderTarget.clone(),r.renderTargetMasked.texture.name="DoF.Masked.Far",r.renderTargetNear=r.renderTarget.clone(),r.renderTargetNear.texture.name="DoF.Bokeh.Near",r.uniforms.get("nearColorBuffer").value=r.renderTargetNear.texture,r.renderTargetFar=r.renderTarget.clone(),r.renderTargetFar.texture.name="DoF.Bokeh.Far",r.uniforms.get("farColorBuffer").value=r.renderTargetFar.texture,r.renderTargetCoC=r.renderTarget.clone(),r.renderTargetCoC.texture.format=d.UCm,r.renderTargetCoC.texture.name="DoF.CoC",r.renderTargetCoCBlurred=r.renderTargetCoC.clone(),r.renderTargetCoCBlurred.texture.name="DoF.CoC.Blurred",r.uniforms.get("nearCoCBuffer").value=r.renderTargetCoCBlurred.texture,r.cocPass=new ne(new $e(e));var A=r.circleOfConfusionMaterial;A.uniforms.focusDistance.value=c,A.uniforms.focalLength.value=h,r.blurPass=new ee({width:y,height:x,kernelSize:W.MEDIUM}),r.blurPass.resolution.resizable=(0,s.Z)(r),r.maskPass=new ne(new at(r.renderTargetCoC.texture));var T=r.maskPass.getFullscreenMaterial();return T.maskFunction=ot.MULTIPLY_RGB_SET_ALPHA,T.colorChannel=et,r.bokehNearBasePass=new ne(new ut(!1,!0)),r.bokehNearFillPass=new ne(new ut(!0,!0)),r.bokehFarBasePass=new ne(new ut(!1,!1)),r.bokehFarFillPass=new ne(new ut(!0,!1)),r.bokehScale=v,r.target=null,r}return(0,o.Z)(n,[{key:"calculateFocusDistance",value:function(e){var t=this.camera,n=t.far-t.near,r=t.position.distanceTo(e);return Math.min(Math.max(r/n,0),1)}},{key:"setDepthTexture",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this.circleOfConfusionMaterial;n.uniforms.depthBuffer.value=e,n.depthPacking=t}},{key:"update",value:function(e,t,n){var r=this.renderTarget,i=this.renderTargetCoC,a=this.renderTargetCoCBlurred,o=this.renderTargetMasked,s=this.bokehFarBasePass,l=this.bokehFarFillPass,u=s.getFullscreenMaterial().uniforms,c=l.getFullscreenMaterial().uniforms,f=this.bokehNearBasePass,d=this.bokehNearFillPass,h=f.getFullscreenMaterial().uniforms,p=d.getFullscreenMaterial().uniforms;if(null!==this.target){var v=this.calculateFocusDistance(this.target);this.circleOfConfusionMaterial.uniforms.focusDistance.value=v}this.cocPass.render(e,null,i),this.blurPass.render(e,i,a),this.maskPass.render(e,t,o),u.cocBuffer.value=c.cocBuffer.value=i.texture,s.render(e,o,r),l.render(e,r,this.renderTargetFar),h.cocBuffer.value=p.cocBuffer.value=a.texture,f.render(e,t,r),d.render(e,r,this.renderTargetNear)}},{key:"setSize",value:function(e,t){var n=this.resolution,r=[this.cocPass,this.blurPass,this.maskPass,this.bokehNearBasePass,this.bokehNearFillPass,this.bokehFarBasePass,this.bokehFarFillPass];r.push(this.renderTargetCoC,this.renderTargetMasked),r.forEach((function(n){return n.setSize(e,t)}));var i=n.width,a=n.height;(r=[this.renderTarget,this.renderTargetNear,this.renderTargetFar,this.renderTargetCoCBlurred]).forEach((function(e){return e.setSize(i,a)})),[this.bokehNearBasePass,this.bokehNearFillPass,this.bokehFarBasePass,this.bokehFarFillPass].forEach((function(e){return e.getFullscreenMaterial().setTexelSize(1/i,1/a)}))}},{key:"initialize",value:function(e,t,n){[this.cocPass,this.maskPass,this.bokehNearBasePass,this.bokehNearFillPass,this.bokehFarBasePass,this.bokehFarFillPass].forEach((function(r){return r.initialize(e,t,n)})),this.blurPass.initialize(e,t,d.ywz),t||n!==d.ywz||(this.renderTargetNear.texture.type=d.UCm),void 0!==n&&(this.renderTarget.texture.type=n,this.renderTargetNear.texture.type=n,this.renderTargetFar.texture.type=n,this.renderTargetMasked.texture.type=n)}},{key:"circleOfConfusionMaterial",get:function(){return this.cocPass.getFullscreenMaterial()}},{key:"resolution",get:function(){return this.blurPass.resolution}},{key:"bokehScale",get:function(){return this.uniforms.get("scale").value},set:function(e){[this.bokehNearBasePass,this.bokehNearFillPass,this.bokehFarBasePass,this.bokehFarFillPass].map((function(e){return e.getFullscreenMaterial().uniforms.scale})).forEach((function(t){t.value=e})),this.maskPass.getFullscreenMaterial().uniforms.strength.value=e,this.uniforms.get("scale").value=e}}]),n}(Z);function dt(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var ht=function(e){(0,u.Z)(n,e);var t=dt(n);function n(){var e;return(0,a.Z)(this,n),(e=t.call(this,{type:"DepthDownsamplingMaterial",defines:{DEPTH_PACKING:"0"},uniforms:{depthBuffer:new d.xWb(null),normalBuffer:new d.xWb(null),texelSize:new d.xWb(new d.FM8)},fragmentShader:"#include <packing>\n\n#ifdef GL_FRAGMENT_PRECISION_HIGH\n\n\tuniform highp sampler2D depthBuffer;\n\n#else\n\n\tuniform mediump sampler2D depthBuffer;\n\n#endif\n\n#ifdef DOWNSAMPLE_NORMALS\n\n\tuniform sampler2D normalBuffer;\n\n#endif\n\nvarying vec2 vUv0;\nvarying vec2 vUv1;\nvarying vec2 vUv2;\nvarying vec2 vUv3;\n\nfloat readDepth(const in vec2 uv) {\n\n\t#if DEPTH_PACKING == 3201\n\n\t\treturn unpackRGBAToDepth(texture2D(depthBuffer, uv));\n\n\t#else\n\n\t\treturn texture2D(depthBuffer, uv).r;\n\n\t#endif\n\n}\n\n/**\n * Returns the index of the most representative depth in the 2x2 neighborhood.\n */\n\nint findBestDepth(const in float samples[4]) {\n\n\t// Calculate the centroid.\n\tfloat c = (samples[0] + samples[1] + samples[2] + samples[3]) / 4.0;\n\n\tfloat distances[4] = float[](\n\t\tabs(c - samples[0]), abs(c - samples[1]),\n\t\tabs(c - samples[2]), abs(c - samples[3])\n\t);\n\n\tfloat maxDistance = max(\n\t\tmax(distances[0], distances[1]),\n\t\tmax(distances[2], distances[3])\n\t);\n\n\tint remaining[3];\n\tint rejected[3];\n\n\tint i, j, k;\n\n\tfor(i = 0, j = 0, k = 0; i < 4; ++i) {\n\n\t\tif(distances[i] < maxDistance) {\n\n\t\t\t// Keep the most representative samples.\n\t\t\tremaining[j++] = i;\n\n\t\t} else {\n\n\t\t\t// Discard max distance samples.\n\t\t\trejected[k++] = i;\n\n\t\t}\n\n\t}\n\n\t// Fill up the array in case there were two or more max distance samples.\n\tfor(; j < 3; ++j) {\n\n\t\tremaining[j] = rejected[--k];\n\n\t}\n\n\t// Final candidates.\n\tvec3 s = vec3(\n\t\tsamples[remaining[0]],\n\t\tsamples[remaining[1]],\n\t\tsamples[remaining[2]]\n\t);\n\n\t// Recalculate the controid.\n\tc = (s.x + s.y + s.z) / 3.0;\n\n\tdistances[0] = abs(c - s.x);\n\tdistances[1] = abs(c - s.y);\n\tdistances[2] = abs(c - s.z);\n\n\tfloat minDistance = min(distances[0], min(distances[1], distances[2]));\n\n\t// Determine the index of the min distance sample.\n\tfor(i = 0; i < 3; ++i) {\n\n\t\tif(distances[i] == minDistance) {\n\n\t\t\tbreak;\n\n\t\t}\n\n\t}\n\n\treturn remaining[i];\n\n}\n\nvoid main() {\n\n\t// Gather depth samples in a 2x2 neighborhood.\n\tfloat d[4] = float[](\n\t\treadDepth(vUv0), readDepth(vUv1),\n\t\treadDepth(vUv2), readDepth(vUv3)\n\t);\n\n\tint index = findBestDepth(d);\n\n\t#ifdef DOWNSAMPLE_NORMALS\n\n\t\tvec2 uvs[4] = vec2[](vUv0, vUv1, vUv2, vUv3);\n\t\tvec3 n = texture2D(normalBuffer, uvs[index]).rgb;\n\n\t#else\n\n\t\tvec3 n = vec3(0.0);\n\n\t#endif\n\n\tgl_FragColor = vec4(n, d[index]);\n\n}\n",vertexShader:"uniform vec2 texelSize;\n\nvarying vec2 vUv0;\nvarying vec2 vUv1;\nvarying vec2 vUv2;\nvarying vec2 vUv3;\n\nvoid main() {\n\n\tvec2 uv = position.xy * 0.5 + 0.5;\n\n\tvUv0 = uv;\n\tvUv1 = vec2(uv.x, uv.y + texelSize.y);\n\tvUv2 = vec2(uv.x + texelSize.x, uv.y);\n\tvUv3 = uv + texelSize;\n\n\tgl_Position = vec4(position.xy, 1.0, 1.0);\n\n}\n",depthWrite:!1,depthTest:!1})).toneMapped=!1,e}return(0,o.Z)(n,[{key:"setTexelSize",value:function(e,t){this.uniforms.texelSize.value.set(e,t)}},{key:"depthPacking",get:function(){return Number(this.defines.DEPTH_PACKING)},set:function(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}}]),n}(d.jyz);function pt(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var vt=function(e){(0,u.Z)(n,e);var t=pt(n);function n(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=r.normalBuffer,o=void 0===i?null:i,l=r.resolutionScale,u=void 0===l?.5:l,c=r.width,f=void 0===c?F.AUTO_SIZE:c,h=r.height,p=void 0===h?F.AUTO_SIZE:h;if((0,a.Z)(this,n),(e=t.call(this,"DepthDownsamplingPass")).setFullscreenMaterial(new ht),e.needsDepthTexture=!0,e.needsSwap=!1,null!==o){var v=e.getFullscreenMaterial();v.uniforms.normalBuffer.value=o,v.defines.DOWNSAMPLE_NORMALS="1"}return e.renderTarget=new d.dd2(1,1,{minFilter:d.TyD,magFilter:d.TyD,stencilBuffer:!1,depthBuffer:!1,type:d.VzW}),e.renderTarget.texture.name="DepthDownsamplingPass.Target",e.renderTarget.texture.generateMipmaps=!1,e.resolution=new F((0,s.Z)(e),f,p),e.resolution.scale=u,e}return(0,o.Z)(n,[{key:"setDepthTexture",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this.getFullscreenMaterial();n.uniforms.depthBuffer.value=e,n.depthPacking=t}},{key:"render",value:function(e,t,n,r,i){e.setRenderTarget(this.renderToScreen?null:this.renderTarget),e.render(this.scene,this.camera)}},{key:"setSize",value:function(e,t){var n=this.resolution;n.base.set(e,t),this.getFullscreenMaterial().setTexelSize(1/e,1/t),this.renderTarget.setSize(n.width,n.height)}},{key:"initialize",value:function(e,t,n){e.capabilities.isWebGL2||e.getContext().getExtension("OES_texture_float")}},{key:"texture",get:function(){return this.renderTarget.texture}}]),n}($);function mt(e,t){var n;if("undefined"===typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"===typeof e)return yt(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return yt(e,t)}(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function yt(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function gt(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var xt=function(e){(0,u.Z)(n,e);var t=gt(n);function n(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,l=arguments.length>4&&void 0!==arguments[4]&&arguments[4];return(0,a.Z)(this,n),(e=t.call(this,{type:"EffectMaterial",defines:{DEPTH_PACKING:"0",ENCODE_OUTPUT:"1"},uniforms:{inputBuffer:new d.xWb(null),depthBuffer:new d.xWb(null),resolution:new d.xWb(new d.FM8),texelSize:new d.xWb(new d.FM8),cameraNear:new d.xWb(.3),cameraFar:new d.xWb(1e3),aspect:new d.xWb(1),time:new d.xWb(0)},depthWrite:!1,depthTest:!1,dithering:l})).toneMapped=!1,null!==r&&e.setShaderParts(r),null!==i&&e.setDefines(i),null!==o&&e.setUniforms(o),e.adoptCameraSettings(s),e}return(0,o.Z)(n,[{key:"setShaderParts",value:function(e){return this.fragmentShader="#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n\nuniform sampler2D inputBuffer;\n\n#ifdef GL_FRAGMENT_PRECISION_HIGH\n\n\tuniform highp sampler2D depthBuffer;\n\n#else\n\n\tuniform mediump sampler2D depthBuffer;\n\n#endif\n\nuniform vec2 resolution;\nuniform vec2 texelSize;\n\nuniform float cameraNear;\nuniform float cameraFar;\nuniform float aspect;\nuniform float time;\n\nvarying vec2 vUv;\n\nfloat readDepth(const in vec2 uv) {\n\n\t#if DEPTH_PACKING == 3201\n\n\t\treturn unpackRGBAToDepth(texture2D(depthBuffer, uv));\n\n\t#else\n\n\t\treturn texture2D(depthBuffer, uv).r;\n\n\t#endif\n\n}\n\nfloat getViewZ(const in float depth) {\n\n\t#ifdef PERSPECTIVE_CAMERA\n\n\t\treturn perspectiveDepthToViewZ(depth, cameraNear, cameraFar);\n\n\t#else\n\n\t\treturn orthographicDepthToViewZ(depth, cameraNear, cameraFar);\n\n\t#endif\n\n}\n\nFRAGMENT_HEAD\n\nvoid main() {\n\n\tFRAGMENT_MAIN_UV\n\n\tvec4 color0 = texture2D(inputBuffer, UV);\n\tvec4 color1 = vec4(0.0);\n\n\tFRAGMENT_MAIN_IMAGE\n\n\tgl_FragColor = color0;\n\n\t#ifdef ENCODE_OUTPUT\n\n\t\t#include <encodings_fragment>\n\n\t#endif\n\n\t#include <dithering_fragment>\n\n}\n".replace(At.FRAGMENT_HEAD,e.get(At.FRAGMENT_HEAD)).replace(At.FRAGMENT_MAIN_UV,e.get(At.FRAGMENT_MAIN_UV)).replace(At.FRAGMENT_MAIN_IMAGE,e.get(At.FRAGMENT_MAIN_IMAGE)),this.vertexShader="uniform vec2 resolution;\nuniform vec2 texelSize;\n\nuniform float cameraNear;\nuniform float cameraFar;\nuniform float aspect;\nuniform float time;\n\nvarying vec2 vUv;\n\nVERTEX_HEAD\n\nvoid main() {\n\n\tvUv = position.xy * 0.5 + 0.5;\n\n\tVERTEX_MAIN_SUPPORT\n\n\tgl_Position = vec4(position.xy, 1.0, 1.0);\n\n}\n".replace(At.VERTEX_HEAD,e.get(At.VERTEX_HEAD)).replace(At.VERTEX_MAIN_SUPPORT,e.get(At.VERTEX_MAIN_SUPPORT)),this.needsUpdate=!0,this}},{key:"setDefines",value:function(e){var t,n=mt(e.entries());try{for(n.s();!(t=n.n()).done;){var r=t.value;this.defines[r[0]]=r[1]}}catch(i){n.e(i)}finally{n.f()}return this.needsUpdate=!0,this}},{key:"setUniforms",value:function(e){var t,n=mt(e.entries());try{for(n.s();!(t=n.n()).done;){var r=t.value;this.uniforms[r[0]]=r[1]}}catch(i){n.e(i)}finally{n.f()}return this}},{key:"adoptCameraSettings",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;null!==e&&(this.uniforms.cameraNear.value=e.near,this.uniforms.cameraFar.value=e.far,e instanceof d.cPb?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0)}},{key:"setSize",value:function(e,t){var n=Math.max(e,1),r=Math.max(t,1);this.uniforms.resolution.value.set(n,r),this.uniforms.texelSize.value.set(1/n,1/r),this.uniforms.aspect.value=n/r}},{key:"depthPacking",get:function(){return Number(this.defines.DEPTH_PACKING)},set:function(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}}]),n}(d.jyz),At={FRAGMENT_HEAD:"FRAGMENT_HEAD",FRAGMENT_MAIN_UV:"FRAGMENT_MAIN_UV",FRAGMENT_MAIN_IMAGE:"FRAGMENT_MAIN_IMAGE",VERTEX_HEAD:"VERTEX_HEAD",VERTEX_MAIN_SUPPORT:"VERTEX_MAIN_SUPPORT"};function Tt(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}function St(e,t){var n;if("undefined"===typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"===typeof e)return Et(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Et(e,t)}(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function Et(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Pt(e,t){for(var n,r=[];null!==(n=e.exec(t));)r.push(n[1]);return r}function _t(e,t,n){var r,i,a,o=St(t);try{for(o.s();!(a=o.n()).done;){var s=a.value;r="$1"+e+s.charAt(0).toUpperCase()+s.slice(1),i=new RegExp("([^\\.])(\\b"+s+"\\b)","g");var l,u=St(n.entries());try{for(u.s();!(l=u.n()).done;){var c=l.value;null!==c[1]&&n.set(c[0],c[1].replace(i,r))}}catch(f){u.e(f)}finally{u.f()}}}catch(f){o.e(f)}finally{o.f()}}function wt(e,t,n,r,i,a,o){var s=/(?:\w+\s+(\w+)\([\w\s,]*\)\s*{[^}]+})/g,l=t.blendMode,u=new Map([["fragment",t.getFragmentShader()],["vertex",t.getVertexShader()]]),c=void 0!==u.get("fragment")&&u.get("fragment").indexOf("mainImage")>=0,f=void 0!==u.get("fragment")&&u.get("fragment").indexOf("mainUv")>=0,d=[],h=[],p=!1,v=!1;if(void 0===u.get("fragment"))console.error("Missing fragment shader",t);else if(f&&0!==(o&z.CONVOLUTION))console.error("Effects that transform UV coordinates are incompatible with convolution effects",t);else if(c||f){if(f&&(n.set(At.FRAGMENT_MAIN_UV,n.get(At.FRAGMENT_MAIN_UV)+"\t"+e+"MainUv(UV);\n"),p=!0),null!==u.get("vertex")&&u.get("vertex").indexOf("mainSupport")>=0){var m="\t"+e+"MainSupport(";u.get("vertex").indexOf("uv")>=0&&(m+="vUv"),m+=");\n",n.set(At.VERTEX_MAIN_SUPPORT,n.get(At.VERTEX_MAIN_SUPPORT)+m),d=d.concat(Pt(/(?:varying\s+\w+\s+(\w*))/g,u.get("vertex"))),h=h.concat(d).concat(Pt(s,u.get("vertex")))}if(h=h.concat(Pt(s,u.get("fragment"))).concat(Array.from(t.defines.keys()).map((function(e){return e.replace(/\([\w\s,]*\)/g,"")}))).concat(Array.from(t.uniforms.keys())),t.uniforms.forEach((function(t,n){return a.set(e+n.charAt(0).toUpperCase()+n.slice(1),t)})),t.defines.forEach((function(t,n){return i.set(e+n.charAt(0).toUpperCase()+n.slice(1),t)})),_t(e,h,i),_t(e,h,u),r.set(l.blendFunction,l),c){var y=e+"MainImage(color0, UV, ";0!==(o&z.DEPTH)&&u.get("fragment").indexOf("depth")>=0&&(y+="depth, ",v=!0),y+="color1);\n\t";var g=e+"BlendOpacity";a.set(g,l.opacity),y+="color0 = blend"+l.getBlendFunction()+"(color0, color1, "+g+");\n\n\t",n.set(At.FRAGMENT_MAIN_IMAGE,n.get(At.FRAGMENT_MAIN_IMAGE)+y),n.set(At.FRAGMENT_HEAD,n.get(At.FRAGMENT_HEAD)+"uniform float "+g+";\n\n")}n.set(At.FRAGMENT_HEAD,n.get(At.FRAGMENT_HEAD)+u.get("fragment")+"\n"),null!==u.get("vertex")&&n.set(At.VERTEX_HEAD,n.get(At.VERTEX_HEAD)+u.get("vertex")+"\n")}else console.error("The fragment shader contains neither a mainImage nor a mainUv function",t);return{varyings:d,transformedUv:p,readDepth:v}}var Ft=function(e){(0,u.Z)(n,e);var t=Tt(n);function n(e){var r;(0,a.Z)(this,n),(r=t.call(this,"EffectPass")).setFullscreenMaterial(new xt(null,null,null,e));for(var i=arguments.length,o=new Array(i>1?i-1:0),s=1;s<i;s++)o[s-1]=arguments[s];return r.effects=o.sort((function(e,t){return t.attributes-e.attributes})),r.skipRendering=!1,r.uniforms=0,r.varyings=0,r.minTime=1,r.maxTime=1e3,r}return(0,o.Z)(n,[{key:"verifyResources",value:function(e){var t=e.capabilities,n=Math.min(t.maxFragmentUniforms,t.maxVertexUniforms);this.uniforms>n&&console.warn("The current rendering context doesn't support more than "+n+" uniforms, but "+this.uniforms+" were defined"),n=t.maxVaryings,this.varyings>n&&console.warn("The current rendering context doesn't support more than "+n+" varyings, but "+this.varyings+" were defined")}},{key:"updateMaterial",value:function(){var e,t,n=/\bblend\b/g,r=new Map([[At.FRAGMENT_HEAD,""],[At.FRAGMENT_MAIN_UV,""],[At.FRAGMENT_MAIN_IMAGE,""],[At.VERTEX_HEAD,""],[At.VERTEX_MAIN_SUPPORT,""]]),i=new Map,a=new Map,o=new Map,s=new Set,l=0,u=0,c=0,f=!1,d=!1,h=St(this.effects);try{for(h.s();!(t=h.n()).done;){var p=t.value;if(p.blendMode.getBlendFunction()===L)c|=p.getAttributes()&z.DEPTH;else if(0!==(c&z.CONVOLUTION)&&0!==(p.getAttributes()&z.CONVOLUTION))console.error("Convolution effects cannot be merged",p);else if(c|=p.getAttributes(),u+=(e=wt("e"+l++,p,r,i,a,o,c)).varyings.length,f=f||e.transformedUv,d=d||e.readDepth,null!==p.extensions){var v,m=St(p.extensions);try{for(m.s();!(v=m.n()).done;){var y=v.value;s.add(y)}}catch(_){m.e(_)}finally{m.f()}}}}catch(_){h.e(_)}finally{h.f()}var g,x=St(i.values());try{for(x.s();!(g=x.n()).done;){var A=g.value;r.set(At.FRAGMENT_HEAD,r.get(At.FRAGMENT_HEAD)+A.getShaderCode().replace(n,"blend"+A.getBlendFunction())+"\n")}}catch(_){x.e(_)}finally{x.f()}0!==(c&z.DEPTH)?(d&&r.set(At.FRAGMENT_MAIN_IMAGE,"float depth = readDepth(UV);\n\n\t"+r.get(At.FRAGMENT_MAIN_IMAGE)),this.needsDepthTexture=null===this.getDepthTexture()):this.needsDepthTexture=!1,f?(r.set(At.FRAGMENT_MAIN_UV,"vec2 transformedUv = vUv;\n"+r.get(At.FRAGMENT_MAIN_UV)),a.set("UV","transformedUv")):a.set("UV","vUv"),r.forEach((function(e,t,n){return n.set(t,e.trim().replace(/^#/,"\n#"))})),this.uniforms=o.size,this.varyings=u,this.skipRendering=0===l,this.needsSwap=!this.skipRendering;var T=this.getFullscreenMaterial();if(T.setShaderParts(r).setDefines(a).setUniforms(o),T.extensions={},s.size>0){var S,E=St(s);try{for(E.s();!(S=E.n()).done;){var P=S.value;T.extensions[P]=!0}}catch(_){E.e(_)}finally{E.f()}}this.needsUpdate=!1}},{key:"recompile",value:function(e){this.updateMaterial(),void 0!==e&&this.verifyResources(e)}},{key:"getDepthTexture",value:function(){return this.getFullscreenMaterial().uniforms.depthBuffer.value}},{key:"setDepthTexture",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this.getFullscreenMaterial();n.uniforms.depthBuffer.value=e,n.depthPacking=t,n.needsUpdate=!0;var r,i=St(this.effects);try{for(i.s();!(r=i.n()).done;){var a=r.value;a.setDepthTexture(e,t)}}catch(o){i.e(o)}finally{i.f()}}},{key:"render",value:function(e,t,n,r,i){var a=this.getFullscreenMaterial(),o=a.uniforms.time.value+r;this.needsUpdate&&this.recompile(e);var s,l=St(this.effects);try{for(l.s();!(s=l.n()).done;){s.value.update(e,t,r)}}catch(u){l.e(u)}finally{l.f()}this.skipRendering&&!this.renderToScreen||(a.uniforms.inputBuffer.value=t.texture,a.uniforms.time.value=o<=this.maxTime?o:this.minTime,e.setRenderTarget(this.renderToScreen?null:n),e.render(this.scene,this.camera))}},{key:"setSize",value:function(e,t){this.getFullscreenMaterial().setSize(e,t);var n,r=St(this.effects);try{for(r.s();!(n=r.n()).done;){n.value.setSize(e,t)}}catch(i){r.e(i)}finally{r.f()}}},{key:"initialize",value:function(e,t,n){var r=this;this.capabilities=e.capabilities;var i,a=St(this.effects);try{for(a.s();!(i=a.n()).done;){var o=i.value;o.initialize(e,t,n),o.addEventListener("change",(function(e){return r.handleEvent(e)}))}}catch(s){a.e(s)}finally{a.f()}this.updateMaterial(),this.verifyResources(e)}},{key:"dispose",value:function(){(0,l.Z)((0,f.Z)(n.prototype),"dispose",this).call(this);var e,t=St(this.effects);try{for(t.s();!(e=t.n()).done;){e.value.dispose()}}catch(r){t.e(r)}finally{t.f()}this.effects.length=0}},{key:"handleEvent",value:function(e){switch(e.type){case"change":this.needsUpdate=!0}}},{key:"encodeOutput",get:function(){return void 0!==this.getFullscreenMaterial().defines.ENCODE_OUTPUT},set:function(e){if(this.encodeOutput!==e){var t=this.getFullscreenMaterial();t.needsUpdate=!0,e?t.defines.ENCODE_OUTPUT="1":delete t.defines.ENCODE_OUTPUT}}},{key:"dithering",get:function(){return this.getFullscreenMaterial().dithering},set:function(e){var t=this.getFullscreenMaterial();t.dithering!==e&&(t.dithering=e,t.needsUpdate=!0)}}]),n}($);function bt(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var Dt=function(e){(0,u.Z)(n,e);var t=bt(n);function n(e,r,i){var o,l=i.resolutionScale,u=void 0===l?1:l,c=i.width,f=void 0===c?F.AUTO_SIZE:c,h=i.height,p=void 0===h?F.AUTO_SIZE:h,v=i.renderTarget,m=void 0===v?void 0:v;(0,a.Z)(this,n),(o=t.call(this,"NormalPass")).needsSwap=!1,o.renderPass=new Ae(e,r,new d.RSm({morphTargets:!0,morphNormals:!0,skinning:!0}));var y=o.renderPass.getClearPass();return y.overrideClearColor=new d.Ilk(7829503),y.overrideClearAlpha=1,o.renderTarget=m,void 0===o.renderTarget&&(o.renderTarget=new d.dd2(1,1,{minFilter:d.TyD,magFilter:d.TyD,format:d.UCm,stencilBuffer:!1}),o.renderTarget.texture.name="NormalPass.Target"),o.resolution=new F((0,s.Z)(o),f,p,u),o}return(0,o.Z)(n,[{key:"getResolutionScale",value:function(){return this.resolutionScale}},{key:"setResolutionScale",value:function(e){this.resolutionScale=e,this.setSize(this.resolution.base.x,this.resolution.base.y)}},{key:"render",value:function(e,t,n,r,i){var a=this.renderToScreen?null:this.renderTarget;this.renderPass.render(e,a,a)}},{key:"setSize",value:function(e,t){var n=this.resolution;n.base.set(e,t),this.renderTarget.setSize(n.width,n.height)}},{key:"texture",get:function(){return this.renderTarget.texture}}]),n}($);function Rt(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}function Nt(e,t,n){var r,i=new Map([[d.Y8D,1],[d.hEm,1],[d.av9,2],[d.UCm,3],[d.wk1,4]]);if(i.has(t)||console.error("Invalid noise texture format"),n===d.ywz)for(var a=0,o=(r=new Uint8Array(e*i.get(t))).length;a<o;++a)r[a]=255*Math.random();else for(var s=0,l=(r=new Float32Array(e*i.get(t))).length;s<l;++s)r[s]=Math.random();return r}var Lt=function(e){(0,u.Z)(n,e);var t=Rt(n);function n(e,r){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:d.Y8D,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:d.ywz;return(0,a.Z)(this,n),t.call(this,Nt(e*r,i,o),e,r,i,o)}return n}(d.IEO);function It(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var kt=function(e){(0,u.Z)(n,e);var t=It(n);function n(e){var r;return(0,a.Z)(this,n),(r=t.call(this,{type:"SSAOMaterial",defines:{SAMPLES_INT:"0",SAMPLES_FLOAT:"0.0",SPIRAL_TURNS:"0.0",RADIUS:"1.0",RADIUS_SQ:"1.0",DISTANCE_SCALING:"1",DEPTH_PACKING:"0"},uniforms:{normalBuffer:new d.xWb(null),normalDepthBuffer:new d.xWb(null),noiseTexture:new d.xWb(null),inverseProjectionMatrix:new d.xWb(new d.yGw),projectionMatrix:new d.xWb(new d.yGw),texelSize:new d.xWb(new d.FM8),cameraNear:new d.xWb(0),cameraFar:new d.xWb(0),distanceCutoff:new d.xWb(new d.FM8),proximityCutoff:new d.xWb(new d.FM8),noiseScale:new d.xWb(new d.FM8),minRadiusScale:new d.xWb(.33),intensity:new d.xWb(1),fade:new d.xWb(.01),bias:new d.xWb(0)},fragmentShader:"#include <common>\n#include <packing>\n\n#ifdef GL_FRAGMENT_PRECISION_HIGH\n\n\tuniform highp sampler2D normalDepthBuffer;\n\n#else\n\n\tuniform mediump sampler2D normalDepthBuffer;\n\n#endif\n\n#ifndef NORMAL_DEPTH\n\n\tuniform sampler2D normalBuffer;\n\n\t// The depth texture is bound to normalDepthBuffer.\n\tfloat readDepth(const in vec2 uv) {\n\n\t\t#if DEPTH_PACKING == 3201\n\n\t\t\treturn unpackRGBAToDepth(texture2D(normalDepthBuffer, uv));\n\n\t\t#else\n\n\t\t\treturn texture2D(normalDepthBuffer, uv).r;\n\n\t\t#endif\n\n\t}\n\n#endif\n\nuniform sampler2D noiseTexture;\n\nuniform mat4 inverseProjectionMatrix;\nuniform mat4 projectionMatrix;\nuniform vec2 texelSize;\n\nuniform float cameraNear;\nuniform float cameraFar;\nuniform float minRadiusScale;\nuniform float intensity;\nuniform float fade;\nuniform float bias;\n\nuniform vec2 distanceCutoff;\nuniform vec2 proximityCutoff;\n\nvarying vec2 vUv;\nvarying vec2 vUv2;\n\nfloat getViewZ(const in float depth) {\n\n\t#ifdef PERSPECTIVE_CAMERA\n\n\t\treturn perspectiveDepthToViewZ(depth, cameraNear, cameraFar);\n\n\t#else\n\n\t\treturn orthographicDepthToViewZ(depth, cameraNear, cameraFar);\n\n\t#endif\n\n}\n\nvec3 getViewPosition(const in vec2 screenPosition, const in float depth, const in float viewZ) {\n\n\tfloat clipW = projectionMatrix[2][3] * viewZ + projectionMatrix[3][3];\n\tvec4 clipPosition = vec4((vec3(screenPosition, depth) - 0.5) * 2.0, 1.0);\n\tclipPosition *= clipW; // Unproject.\n\n\treturn (inverseProjectionMatrix * clipPosition).xyz;\n\n}\n\nfloat getAmbientOcclusion(const in vec3 p, const in vec3 n, const in float depth, const in vec2 uv) {\n\n\t#ifdef DISTANCE_SCALING\n\n\t\tfloat radiusScale = 1.0 - smoothstep(0.0, distanceCutoff.y, depth);\n\t\tradiusScale = radiusScale * (1.0 - minRadiusScale) + minRadiusScale;\n\n\t\tfloat radius = RADIUS * radiusScale;\n\n\t#else\n\n\t\tfloat radius = RADIUS;\n\n\t#endif\n\n\t// Use a random starting angle.\n\tfloat noise = texture2D(noiseTexture, vUv2).r;\n\tfloat baseAngle = noise * PI2;\n\n\tfloat inv_samples = 1.0 / SAMPLES_FLOAT;\n\tfloat rings = SPIRAL_TURNS * PI2;\n\n\tfloat occlusion = 0.0;\n\tint taps = 0;\n\n\tfor(int i = 0; i < SAMPLES_INT; ++i) {\n\n\t\tfloat alpha = (float(i) + 0.5) * inv_samples;\n\t\tfloat angle = alpha * rings + baseAngle;\n\n\t\tvec2 coord = alpha * radius * vec2(cos(angle), sin(angle)) * texelSize + uv;\n\n\t\tif(coord.s < 0.0 || coord.s > 1.0 || coord.t < 0.0 || coord.t > 1.0) {\n\n\t\t\t// Skip samples outside the screen.\n\t\t\tcontinue;\n\n\t\t}\n\n\t\t#ifdef NORMAL_DEPTH\n\n\t\t\tfloat sampleDepth = texture2D(normalDepthBuffer, coord).a;\n\n\t\t#else\n\n\t\t\tfloat sampleDepth = readDepth(coord);\n\n\t\t#endif\n\n\t\tfloat viewZ = getViewZ(sampleDepth);\n\n\t\t#ifdef PERSPECTIVE_CAMERA\n\n\t\t\tfloat linearSampleDepth = viewZToOrthographicDepth(viewZ, cameraNear, cameraFar);\n\n\t\t#else\n\n\t\t\tfloat linearSampleDepth = sampleDepth;\n\n\t\t#endif\n\n\t\tfloat proximity = abs(depth - linearSampleDepth);\n\n\t\tif(proximity < proximityCutoff.y) {\n\n\t\t\tfloat falloff = 1.0 - smoothstep(proximityCutoff.x, proximityCutoff.y, proximity);\n\n\t\t\tvec3 Q = getViewPosition(coord, sampleDepth, viewZ);\n\t\t\tvec3 v = Q - p;\n\n\t\t\tfloat vv = dot(v, v);\n\t\t\tfloat vn = dot(v, n) - bias;\n\n\t\t\tfloat f = max(RADIUS_SQ - vv, 0.0) / RADIUS_SQ;\n\t\t\tocclusion += (f * f * f * max(vn / (fade + vv), 0.0)) * falloff;\n\n\t\t}\n\n\t\t++taps;\n\n\t}\n\n\treturn occlusion / (4.0 * max(float(taps), 1.0));\n\n}\n\nvoid main() {\n\n\t#ifdef NORMAL_DEPTH\n\n\t\tvec4 normalDepth = texture2D(normalDepthBuffer, vUv);\n\n\t#else\n\n\t\tvec4 normalDepth = vec4(\n\t\t\ttexture2D(normalBuffer, vUv).rgb,\n\t\t\treadDepth(vUv)\n\t\t);\n\n\t#endif\n\n\tfloat ao = 1.0;\n\tfloat depth = normalDepth.a;\n\tfloat viewZ = getViewZ(depth);\n\n\t#ifdef PERSPECTIVE_CAMERA\n\n\t\tfloat linearDepth = viewZToOrthographicDepth(viewZ, cameraNear, cameraFar);\n\n\t#else\n\n\t\tfloat linearDepth = depth;\n\n\t#endif\n\n\t// Skip fragments that are too far away.\n\tif(linearDepth < distanceCutoff.y) {\n\n\t\tvec3 viewPosition = getViewPosition(vUv, depth, viewZ);\n\t\tvec3 viewNormal = unpackRGBToNormal(normalDepth.rgb);\n\t\tao -= getAmbientOcclusion(viewPosition, viewNormal, linearDepth, vUv);\n\n\t\t// Fade AO based on depth.\n\t\tfloat d = smoothstep(distanceCutoff.x, distanceCutoff.y, linearDepth);\n\t\tao = mix(ao, 1.0, d);\n\n\t\t// Adjust the overall intensity.\n\t\tao = clamp(pow(ao, abs(intensity)), 0.0, 1.0);\n\n\t}\n\n\tgl_FragColor.r = ao;\n\n}\n",vertexShader:"uniform vec2 noiseScale;\n\nvarying vec2 vUv;\nvarying vec2 vUv2;\n\nvoid main() {\n\n\tvUv = position.xy * 0.5 + 0.5;\n\tvUv2 = vUv * noiseScale;\n\n\tgl_Position = vec4(position.xy, 1.0, 1.0);\n\n}\n",depthWrite:!1,depthTest:!1})).toneMapped=!1,r.adoptCameraSettings(e),r}return(0,o.Z)(n,[{key:"setTexelSize",value:function(e,t){this.uniforms.texelSize.value.set(e,t)}},{key:"adoptCameraSettings",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(null!==e){var t=this.uniforms;t.cameraNear.value=e.near,t.cameraFar.value=e.far,e instanceof d.cPb?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0}}},{key:"depthPacking",get:function(){return Number(this.defines.DEPTH_PACKING)},set:function(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}}]),n}(d.jyz),Mt="uniform sampler2D aoBuffer;\nuniform float luminanceInfluence;\n\n#ifdef DEPTH_AWARE_UPSAMPLING\n\n\t#ifdef GL_FRAGMENT_PRECISION_HIGH\n\n\t\tuniform highp sampler2D normalDepthBuffer;\n\n\t#else\n\n\t\tuniform mediump sampler2D normalDepthBuffer;\n\n\t#endif\n\n#endif\n\n#ifdef COLORIZE\n\n\tuniform vec3 color;\n\n#endif\n\nvoid mainImage(const in vec4 inputColor, const in vec2 uv, const in float depth, out vec4 outputColor) {\n\n\tfloat aoLinear = texture2D(aoBuffer, uv).r;\n\n\t#if defined(DEPTH_AWARE_UPSAMPLING) && __VERSION__ == 300\n\n\t\t// Gather normals and depth in a 2x2 neighborhood.\n\t\tvec4 normalDepth[4] = vec4[](\n\t\t\ttextureOffset(normalDepthBuffer, uv, ivec2(0, 0)),\n\t\t\ttextureOffset(normalDepthBuffer, uv, ivec2(0, 1)),\n\t\t\ttextureOffset(normalDepthBuffer, uv, ivec2(1, 0)),\n\t\t\ttextureOffset(normalDepthBuffer, uv, ivec2(1, 1))\n\t\t);\n\n\t\t// Determine the smoothness of the surface around this fragment.\n\t\tfloat dot01 = dot(normalDepth[0].rgb, normalDepth[1].rgb);\n\t\tfloat dot02 = dot(normalDepth[0].rgb, normalDepth[2].rgb);\n\t\tfloat dot03 = dot(normalDepth[0].rgb, normalDepth[3].rgb);\n\n\t\tfloat minDot = min(dot01, min(dot02, dot03));\n\t\tfloat s = step(THRESHOLD, minDot);\n\n\t\t// Find the best AO based on depth.\n\t\tfloat smallestDistance = 1.0;\n\t\tint index;\n\n\t\tfor(int i = 0; i < 4; ++i) {\n\n\t\t\tfloat distance = abs(depth - normalDepth[i].a);\n\n\t\t\tif(distance < smallestDistance) {\n\n\t\t\t\tsmallestDistance = distance;\n\t\t\t\tindex = i;\n\n\t\t\t}\n\n\t\t}\n \n\t\t// Fetch the exact AO texel that corresponds to the best depth.\n\t\tivec2 offsets[4] = ivec2[](\n\t\t\tivec2(0, 0), ivec2(0, 1),\n\t\t\tivec2(1, 0), ivec2(1, 1)\n\t\t);\n\n\t\tivec2 coord = ivec2(uv * vec2(textureSize(aoBuffer, 0))) + offsets[index];\n\t\tfloat aoNearest = texelFetch(aoBuffer, coord, 0).r;\n\n\t\t// Smooth surfaces benefit more from linear filtering.\n\t\tfloat ao = mix(aoNearest, aoLinear, s);\n\n\t#else\n\n\t\tfloat ao = aoLinear;\n\n\t#endif\n\n\t// Fade AO based on luminance.\n\tfloat l = linearToRelativeLuminance(inputColor.rgb);\n\tao = mix(ao, 1.0, l * luminanceInfluence);\n\n\t#ifdef COLORIZE\n\n\t\toutputColor = vec4(1.0 - (1.0 - ao) * (1.0 - color), inputColor.a);\n\n\t#else\n\n\t\toutputColor = vec4(vec3(ao), inputColor.a);\n\n\t#endif\n\n}\n";function Ot(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var Ct=function(e){(0,u.Z)(n,e);var t=Ot(n);function n(e,r){var i,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},l=o.blendFunction,u=void 0===l?k:l,c=o.distanceScaling,f=void 0===c||c,h=o.depthAwareUpsampling,p=void 0===h||h,v=o.normalDepthBuffer,m=void 0===v?null:v,y=o.samples,g=void 0===y?9:y,x=o.rings,A=void 0===x?7:x,T=o.distanceThreshold,S=void 0===T?.97:T,E=o.distanceFalloff,P=void 0===E?.03:E,_=o.rangeThreshold,w=void 0===_?5e-4:_,b=o.rangeFalloff,D=void 0===b?.001:b,R=o.minRadiusScale,N=void 0===R?.33:R,L=o.luminanceInfluence,I=void 0===L?.7:L,M=o.radius,O=void 0===M?.1825:M,C=o.intensity,U=void 0===C?1:C,B=o.bias,X=void 0===B?.025:B,Z=o.fade,G=void 0===Z?.01:Z,Y=o.color,Q=void 0===Y?null:Y,H=o.resolutionScale,V=void 0===H?1:H,W=o.width,j=void 0===W?F.AUTO_SIZE:W,q=o.height,K=void 0===q?F.AUTO_SIZE:q;return(0,a.Z)(this,n),(i=t.call(this,"SSAOEffect",Mt,{blendFunction:u,attributes:z.DEPTH,uniforms:new Map([["aoBuffer",new d.xWb(null)],["normalDepthBuffer",new d.xWb(null)],["luminanceInfluence",new d.xWb(I)],["color",new d.xWb(null)],["scale",new d.xWb(0)]])})).renderTargetAO=new d.dd2(1,1,{minFilter:d.wem,magFilter:d.wem,stencilBuffer:!1,depthBuffer:!1,format:d.UCm}),i.renderTargetAO.texture.name="AO.Target",i.renderTargetAO.texture.generateMipmaps=!1,i.uniforms.get("aoBuffer").value=i.renderTargetAO.texture,i.resolution=new F((0,s.Z)(i),j,K,V),i.r=1,i.camera=e,i.ssaoPass=new ne(function(){var t=new Lt(64,64);t.wrapS=t.wrapT=d.rpg;var n=new kt(e);return n.uniforms.noiseTexture.value=t,n.uniforms.intensity.value=U,n.uniforms.minRadiusScale.value=N,n.uniforms.fade.value=G,n.uniforms.bias.value=X,null!==m?(n.uniforms.normalDepthBuffer.value=m,n.defines.NORMAL_DEPTH="1",p&&(i.depthAwareUpsampling=p,i.uniforms.get("normalDepthBuffer").value=m,i.defines.set("THRESHOLD","0.997"))):n.uniforms.normalBuffer.value=r,n}()),i.distanceScaling=f,i.samples=g,i.rings=A,i.color=Q,i.radius=O>1?O/100:O,i.setDistanceCutoff(S,P),i.setProximityCutoff(w,D),i}return(0,o.Z)(n,[{key:"setDistanceCutoff",value:function(e,t){this.ssaoMaterial.uniforms.distanceCutoff.value.set(Math.min(Math.max(e,0),1),Math.min(Math.max(e+t,0),1))}},{key:"setProximityCutoff",value:function(e,t){this.ssaoMaterial.uniforms.proximityCutoff.value.set(Math.min(Math.max(e,0),1),Math.min(Math.max(e+t,0),1))}},{key:"setDepthTexture",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this.ssaoMaterial;void 0===n.defines.NORMAL_DEPTH&&(n.uniforms.normalDepthBuffer.value=e,n.depthPacking=t)}},{key:"update",value:function(e,t,n){this.ssaoPass.render(e,null,this.renderTargetAO)}},{key:"setSize",value:function(e,t){var n=this.resolution;n.base.set(e,t);var r=n.width,i=n.height;this.renderTargetAO.setSize(r,i),this.ssaoMaterial.setTexelSize(1/r,1/i);var a=this.camera,o=this.ssaoMaterial.uniforms;o.noiseScale.value.set(r,i).divideScalar(64),o.inverseProjectionMatrix.value.getInverse(a.projectionMatrix),o.projectionMatrix.value.copy(a.projectionMatrix),this.radius=this.r}},{key:"ssaoMaterial",get:function(){return this.ssaoPass.getFullscreenMaterial()}},{key:"samples",get:function(){return Number(this.ssaoMaterial.defines.SAMPLES_INT)},set:function(e){var t=this.ssaoMaterial;t.defines.SAMPLES_INT=e.toFixed(0),t.defines.SAMPLES_FLOAT=e.toFixed(1),t.needsUpdate=!0}},{key:"rings",get:function(){return Number(this.ssaoMaterial.defines.SPIRAL_TURNS)},set:function(e){var t=this.ssaoMaterial;t.defines.SPIRAL_TURNS=e.toFixed(1),t.needsUpdate=!0}},{key:"radius",get:function(){return this.r},set:function(e){this.r=Math.min(Math.max(e,1e-6),1);var t=this.r*this.resolution.height,n=this.ssaoMaterial;n.defines.RADIUS=t.toFixed(11),n.defines.RADIUS_SQ=(t*t).toFixed(11),n.needsUpdate=!0}},{key:"depthAwareUpsampling",get:function(){return this.defines.has("DEPTH_AWARE_UPSAMPLING")},set:function(e){this.depthAwareUpsampling!==e&&(e?this.defines.set("DEPTH_AWARE_UPSAMPLING","1"):this.defines.delete("DEPTH_AWARE_UPSAMPLING"),this.setChanged())}},{key:"distanceScaling",get:function(){return void 0!==this.ssaoMaterial.defines.DISTANCE_SCALING},set:function(e){if(this.distanceScaling!==e){var t=this.ssaoMaterial;e?t.defines.DISTANCE_SCALING="1":delete t.defines.DISTANCE_SCALING,t.needsUpdate=!0}}},{key:"color",get:function(){return this.uniforms.get("color").value},set:function(e){var t=this.uniforms,n=this.defines;null===e?n.has("COLORIZE")&&(n.delete("COLORIZE"),t.get("color").value=null,this.setChanged()):n.has("COLORIZE")?t.get("color").value.set(e):(n.set("COLORIZE","1"),t.get("color").value=new d.Ilk(e),this.setChanged())}}]),n}(Z),Ut="uniform sampler2D texture;\n\n#if defined(ASPECT_CORRECTION) || defined(UV_TRANSFORM)\n\n\tvarying vec2 vUv2;\n\n#endif\n\nvoid mainImage(const in vec4 inputColor, const in vec2 uv, out vec4 outputColor) {\n\n\t#if defined(ASPECT_CORRECTION) || defined(UV_TRANSFORM)\n\n\t\tvec4 texel = texelToLinear(texture2D(texture, vUv2));\n\n\t#else\n\n\t\tvec4 texel = texelToLinear(texture2D(texture, uv));\n\n\t#endif\n\n\toutputColor = TEXEL;\n\n}\n",Bt="#ifdef ASPECT_CORRECTION\n\n\tuniform float scale;\n\n#else\n\n\tuniform mat3 uvTransform;\n\n#endif\n\nvarying vec2 vUv2;\n\nvoid mainSupport(const in vec2 uv) {\n\n\t#ifdef ASPECT_CORRECTION\n\n\t\tvUv2 = uv * vec2(aspect, 1.0) * scale;\n\n\t#else\n\n\t\tvUv2 = (uvTransform * vec3(uv, 1.0)).xy;\n\n\t#endif\n\n}\n";function Xt(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var Zt=function(e){(0,u.Z)(n,e);var t=Xt(n);function n(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=r.blendFunction,o=void 0===i?M:i,s=r.texture,l=void 0===s?null:s,u=r.aspectCorrection,c=void 0!==u&&u;return(0,a.Z)(this,n),(e=t.call(this,"TextureEffect",Ut,{blendFunction:o,defines:new Map([["TEXEL","texel"]]),uniforms:new Map([["texture",new d.xWb(null)],["scale",new d.xWb(1)],["uvTransform",new d.xWb(null)]])})).texture=l,e.aspectCorrection=c,e}return(0,o.Z)(n,[{key:"setTextureSwizzleRGBA",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e,i="rgba",a="";e===Je&&t===et&&n===tt&&r===nt||(a=[".",i[e],i[t],i[n],i[r]].join("")),this.defines.set("TEXEL","texel"+a),this.setChanged()}},{key:"update",value:function(e,t,n){var r=this.uniforms.get("texture").value;this.uvTransform&&r.matrixAutoUpdate&&(r.updateMatrix(),this.uniforms.get("uvTransform").value.copy(r.matrix))}},{key:"texture",get:function(){return this.uniforms.get("texture").value},set:function(e){var t=this.texture;if(t!==e){var n=null!==t?t.encoding:null;this.uniforms.get("texture").value=e,null!==e&&(e.encoding===d.knz?this.defines.set("texelToLinear(texel)","sRGBToLinear(texel)"):e.encoding===d.rnI?this.defines.set("texelToLinear(texel)","texel"):console.log("Unsupported encoding: "+e.encoding),n!==e.encoding&&this.setChanged())}}},{key:"aspectCorrection",get:function(){return this.defines.has("ASPECT_CORRECTION")},set:function(e){this.aspectCorrection!==e&&(e?(this.uvTransform&&(this.uvTransform=!1),this.defines.set("ASPECT_CORRECTION","1"),this.setVertexShader(Bt)):(this.defines.delete("ASPECT_CORRECTION"),this.setVertexShader(null)),this.setChanged())}},{key:"uvTransform",get:function(){return this.defines.has("UV_TRANSFORM")},set:function(e){this.uvTransform!==e&&(e?(this.aspectCorrection&&(this.aspectCorrection=!1),this.defines.set("UV_TRANSFORM","1"),this.uniforms.get("uvTransform").value=new d.Vkp,this.setVertexShader(Bt)):(this.defines.delete("UV_TRANSFORM"),this.uniforms.get("uvTransform").value=null,this.setVertexShader(null)),this.setChanged())}}]),n}(Z),zt=n(34452);function Gt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Yt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Gt(Object(n),!0).forEach((function(t){(0,i.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Gt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Qt(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,f.Z)(e);if(t){var i=(0,f.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,c.Z)(this,n)}}var Ht=function(e){(0,u.Z)(n,e);var t=Qt(n);function n(e){var r,i,o;(0,a.Z)(this,n),(r=t.call(this,e)).downgradeTimer=0,r.upgradeTimer=0,r.maxQualityLevel=5,r.qualityLevel=r.maxQualityLevel,r.prevQualityLevel=r.qualityLevel,r.maxRenderDelta=40,r.minRenderDelta=20,n.instance=(0,s.Z)(r),r.onResize=r.onResize.bind((0,s.Z)(r)),r.postProcessingSchema=null!==(i=e.postProcessingSchema)&&void 0!==i?i:Be;var l=e.canvas;try{o=l.getContext("webgl2",{antialias:!0})}catch(h){o=l.getContext("webgl",{antialias:!0})}r.renderContext=o;var u={canvas:l,context:o,antialias:!0,preserveDrawingBuffer:!0},c=window.safariWebBrowser?new d.b5g(u):new d.CP7(u);c.physicallyCorrectLights=!0,c.shadowMap.enabled=!0,c.shadowMap.type=d.ntZ,c.outputEncoding=d.knz,P.D4.renderer=c;var f=new S({cascades:4,lightIntensity:1,shadowMapSize:4096,maxFar:100,camera:P.D4.camera,parent:P.D4.scene});return f.fade=!0,P.D4.csm=f,window.addEventListener("resize",r.onResize,!1),r.onResize(),n.needsResize=!0,r.configurePostProcessing(),Wt(),r.setUsePostProcessing(!0),r.setShadowQuality(r.qualityLevel),r.setResolution(n.scaleFactor),r.setUseAutomatic(n.automatic),zt.NL.instance.addEventListener(n.EVENTS.SET_POST_PROCESSING,(function(e){r.setUsePostProcessing(e.payload)})),zt.NL.instance.addEventListener(n.EVENTS.SET_RESOLUTION,(function(e){r.setResolution(e.payload)})),zt.NL.instance.addEventListener(n.EVENTS.SET_SHADOW_QUALITY,(function(e){r.setShadowQuality(e.payload)})),zt.NL.instance.addEventListener(n.EVENTS.SET_USE_AUTOMATIC,(function(e){r.setUseAutomatic(e.payload)})),zt.NL.instance.addEventListener(zt.NL.EVENTS.ENABLE_SCENE,(function(e){r.enabled=e.enable})),r.isInitialized=!0,r}return(0,o.Z)(n,[{key:"onResize",value:function(){n.needsResize=!0}},{key:"dispose",value:function(){var e;(0,l.Z)((0,f.Z)(n.prototype),"dispose",this).call(this),null===(e=n.composer)||void 0===e||e.dispose(),window.removeEventListener("resize",this.onResize),this.isInitialized=!1}},{key:"configurePostProcessing",value:function(){n.composer=new je(P.D4.renderer),this.renderPass=new Ae(P.D4.scene,P.D4.camera),this.renderPass.scene=P.D4.scene,this.renderPass.camera=P.D4.camera,n.composer.addPass(this.renderPass);var e=[],t=new Dt(this.renderPass.scene,this.renderPass.camera,{renderTarget:new d.dd2(1,1,{minFilter:d.TyD,magFilter:d.TyD,format:d.UCm,stencilBuffer:!1})}),i=new vt({normalBuffer:t.texture,resolutionScale:.5}),a=i.texture;this.postProcessingSchema.effects.forEach((function(r){if(r.effect===Ct)e.push(new r.effect(P.D4.camera,t.texture,Yt(Yt({},r.options),{},{normalDepthBuffer:a})));else if(r.effect===ft)e.push(new r.effect(P.D4.camera,r.options));else if(r.effect===Ie){var i=new r.effect(P.D4.scene,P.D4.camera,r.options);e.push(i),n.composer.outlineEffect=i}else e.push(new r.effect(r.options))}));var o=new Zt({blendFunction:L,texture:i.texture});e.length&&(n.composer.addPass(i),n.composer.addPass((0,r.Z)(Ft,[P.D4.camera].concat(e,[o]))))}},{key:"execute",value:function(e){if(!P.D4.renderer.xr.isPresenting){var t=(0,E.z)();if(this.isInitialized&&n.needsResize){var r=P.D4.renderer.getPixelRatio(),i=window.devicePixelRatio*n.scaleFactor;r!==i&&P.D4.renderer.setPixelRatio(i);var a=window.innerWidth,o=window.innerHeight;if(P.D4.camera.isPerspectiveCamera){var s=P.D4.camera;s.aspect=a/o,s.updateProjectionMatrix()}P.D4.csm.updateFrustums(),P.D4.renderer.setSize(a,o,!1),n.composer.setSize(a,o,!1),n.needsResize=!1}this.doRender(e);var l=(0,E.z)()-t;n.automatic&&this.changeQualityLevel(l)}}},{key:"doRender",value:function(e){P.D4.csm.update(),n.usePostProcessing?n.composer.render(e):P.D4.renderer.render(P.D4.scene,P.D4.camera)}},{key:"changeQualityLevel",value:function(e){if(e>=this.maxRenderDelta)this.downgradeTimer+=e,this.upgradeTimer=0;else{if(!(e<=this.minRenderDelta))return this.upgradeTimer=0,void(this.downgradeTimer=0);this.upgradeTimer+=e,this.downgradeTimer=0}this.downgradeTimer>2e3&&this.qualityLevel>0?(this.qualityLevel--,this.downgradeTimer=0):this.upgradeTimer>1e3&&this.qualityLevel<this.maxQualityLevel&&(this.qualityLevel++,this.upgradeTimer=0),this.prevQualityLevel!==this.qualityLevel&&(this.setShadowQuality(this.qualityLevel),this.setResolution(this.qualityLevel/5),this.setUsePostProcessing(this.qualityLevel>1),this.dispatchSettingsChangeEvent(),Vt(),this.prevQualityLevel=this.qualityLevel)}},{key:"dispatchSettingsChangeEvent",value:function(){zt.NL.instance.dispatchEvent({type:n.EVENTS.QUALITY_CHANGED,shadows:n.shadowQuality,resolution:n.scaleFactor,postProcessing:n.usePostProcessing,pbr:n.usePBR,automatic:!0})}},{key:"setUseAutomatic",value:function(e){n.automatic=e,n.automatic&&(this.prevQualityLevel=-1,this.setShadowQuality(this.qualityLevel),this.setResolution(this.qualityLevel/5),this.setUsePostProcessing(this.qualityLevel>1),this.dispatchSettingsChangeEvent()),Vt()}},{key:"setResolution",value:function(e){n.scaleFactor=e,P.D4.renderer.setPixelRatio(window.devicePixelRatio*n.scaleFactor),n.needsResize=!0,Vt()}},{key:"setShadowQuality",value:function(e){n.shadowQuality=e;var t=512;switch(n.shadowQuality){default:break;case this.maxQualityLevel-2:t=1024;break;case this.maxQualityLevel-1:t=2048;break;case this.maxQualityLevel:t=4096}P.D4.csm.setShadowMapSize(t),Vt()}},{key:"setUsePostProcessing",value:function(e){var t,r;(null===(r=null===(t=P.D4.renderer)||void 0===t?void 0:t.xr)||void 0===r?void 0:r.isPresenting)||(n.usePostProcessing=e,P.D4.renderer.outputEncoding=n.usePostProcessing?d.rnI:d.knz,Vt())}}]),n}(_.x);Ht.EVENTS={QUALITY_CHANGED:"WEBGL_RENDERER_SYSTEM_EVENT_QUALITY_CHANGE",SET_RESOLUTION:"WEBGL_RENDERER_SYSTEM_EVENT_SET_RESOLUTION",SET_SHADOW_QUALITY:"WEBGL_RENDERER_SYSTEM_EVENT_SET_SHADOW_QUALITY",SET_POST_PROCESSING:"WEBGL_RENDERER_SYSTEM_EVENT_SET_POST_PROCESSING",SET_USE_AUTOMATIC:"WEBGL_RENDERER_SYSTEM_EVENT_SET_USE_AUTOMATIC"},Ht.automatic=!0,Ht.usePBR=!0,Ht.usePostProcessing=!0,Ht.shadowQuality=5,Ht.scaleFactor=1;var Vt=function(){},Wt=function(){Ht.instance.dispatchSettingsChangeEvent()};Ht.queries={}},52194:function(e,t,n){"use strict";n.d(t,{T:function(){return N},y:function(){return L}});var r,i,a,o,s,l=n(48533),u=n.n(l),c=n(58700),f=n(49182),d=n(39337),h=n(42828),p=n(13987),v=n(29569),m=n(89306),y=n(36595),g=n(44978),x=n(483),A=n(34452),T=n(88203),S=n(60645),E=n(16090),P=n(77138),_=n(44590),w=function(){var e=(0,c.Z)(u().mark((function e(){var t,n,l;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=x.D4.renderer.xr.getCamera(x.D4.camera),a=x.D4.renderer.xr.getController(0),o=x.D4.renderer.xr.getController(1),x.D4.scene.add(a),x.D4.scene.add(o),[a,o].forEach((function(e){e.addEventListener("select",(function(e){})),e.addEventListener("selectstart",(function(e){})),e.addEventListener("selectend",(function(e){})),e.addEventListener("squeeze",(function(e){})),e.addEventListener("squeezestart",(function(e){})),e.addEventListener("squeezeend",(function(e){})),e.addEventListener("connected",(function(t){if(e.targetRay)e.targetRay.visible=!0;else{var n=F(t.data);e.add(n),e.targetRay=n}})),e.addEventListener("disconnected",(function(t){e.targetRay.visible=!1}))})),i=x.D4.renderer.xr.getControllerGrip(0),s=x.D4.renderer.xr.getControllerGrip(1),(0,E.Tk)(_.V.inputReceiverEntity,P.s,{headPosition:r.position,headRotation:r.rotation,controllerLeft:a,controllerRight:o,controllerPositionLeft:a.position,controllerPositionRight:o.position,controllerRotationLeft:a.quaternion,controllerRotationRight:o.quaternion,controllerGripLeft:i,controllerGripRight:s}),console.warn((0,E.Xr)(_.V.inputReceiverEntity,P.s)),console.warn(a),e.next=14,new Promise((function(e){(0,S.nZ)().load("/models/webxr/controllers/valve_controller_knu_1_0_right.glb",(function(t){e(t)}),console.warn,console.error)}));case 14:return t=e.sent,(n=t.scene.children[2]).material=new y.xoR,n.position.z=-.08,(l=n.clone()).scale.multiply(new y.Pa4(-1,1,1)),i.add(n),x.D4.scene.add(i),s.add(l),x.D4.scene.add(s),console.warn("Loaded Model Controllers Done"),e.abrupt("return",!0);case 28:return e.prev=28,e.t0=e.catch(0),console.log("Could not create VR session",e.t0),e.abrupt("return",!1);case 32:case"end":return e.stop()}}),e,null,[[0,28]])})));return function(){return e.apply(this,arguments)}}(),F=function(e){var t,n;switch(e.targetRayMode){case"tracked-pointer":return(t=new y.u9r).setAttribute("position",new y.a$l([0,0,0,0,0,-1],3)),t.setAttribute("color",new y.a$l([.5,.5,.5,0,0,0],3)),t.setAttribute("alpha",new y.a$l([1,0],1)),n=new y.nls({vertexColors:!0,blending:y.WMw}),new y.x12(t,n);case"gaze":return t=new y.o8S(.02,.04,32).translate(0,0,-1),n=new y.vBJ({opacity:.5,transparent:!0}),new y.Kj0(t,n)}};function b(e,t){var n;if("undefined"===typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"===typeof e)return D(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return D(e,t)}(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function D(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function R(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,m.Z)(e);if(t){var i=(0,m.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,v.Z)(this,n)}}var N=function(e){(0,p.Z)(n,e);var t=R(n);function n(e){var r;return(0,f.Z)(this,n),(r=t.call(this,e)).isRenderering=!1,r.referenceSpace="local-floor",A.NL.instance.addEventListener(n.EVENTS.XR_START,function(){var e=(0,c.Z)(u().mark((function e(t){var i,a;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return x.D4.renderer.outputEncoding=y.knz,i={optionalFeatures:[r.referenceSpace]},e.prev=2,e.next=5,navigator.xr.requestSession("immersive-vr",i);case 5:return a=e.sent,x.D4.xrSession=a,x.D4.renderer.xr.setReferenceSpaceType(r.referenceSpace),x.D4.renderer.xr.setSession(a),g.n2||A.NL.instance.dispatchEvent({type:n.EVENTS.XR_SESSION}),e.next=12,w();case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(2),console.log(e.t0);case 17:case"end":return e.stop()}}),e,null,[[2,14]])})));return function(t){return e.apply(this,arguments)}}()),A.NL.instance.addEventListener(n.EVENTS.XR_END,function(){var e=(0,c.Z)(u().mark((function e(t){return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:x.D4.xrSession&&((0,E.aT)(_.V.inputReceiverEntity,P.s),x.D4.xrSession.end(),x.D4.xrSession=null);case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),r.offscreen=e.offscreen,r.offscreen,r}return(0,d.Z)(n,[{key:"dispose",value:function(){(0,h.Z)((0,m.Z)(n.prototype),"dispose",this).call(this)}},{key:"execute",value:function(e){var t,n;(null===(n=null===(t=x.D4.renderer)||void 0===t?void 0:t.xr)||void 0===n?void 0:n.isPresenting)&&(this.offscreen||x.D4.renderer.render(x.D4.scene,x.D4.camera))}}]),n}(T.x);N.EVENTS={XR_START:"WEBXR_RENDERER_SYSTEM_XR_START",XR_SESSION:"WEBXR_RENDERER_SYSTEM_XR_SESSION",XR_END:"WEBXR_RENDERER_SYSTEM_XR_END"};var L=function(e,t){var n,r=t.session,i=x.D4.renderer.xr.getReferenceSpace(),a=(t.getViewerPose(i),b(r.inputSources));try{for(a.s();!(n=a.n()).done;){var o=n.value;if(o.gamepad)t.getPose(o.gripSpace,i)}}catch(s){a.e(s)}finally{a.f()}};N.queries={}},74745:function(e,t,n){"use strict";n.d(t,{w:function(){return y}});var r=n(49182),i=n(39337),a=n(94780),o=n(13987),s=n(29569),l=n(89306),u=n(88203),c=n(16090),f=n(82552),d=n(96808),h=n(53516),p=n(483),v=n(36595);function m(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,l.Z)(e);if(t){var i=(0,l.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,s.Z)(this,n)}}var y=function(e){(0,o.Z)(n,e);var t=m(n);function n(e){var i;return(0,r.Z)(this,n),(i=t.call(this,e)).spawnPoints=[],i.lastSpawnIndex=0,p.D4.spawnSystem=(0,a.Z)(i),i}return(0,i.Z)(n,[{key:"getRandomSpawnPoint",value:function(){if(this.spawnPoints.length<1)return console.warn("Couldn't spawn entity at spawn point, no spawn points available"),{position:new v.Pa4,rotation:new v._fP};this.lastSpawnIndex=(this.lastSpawnIndex+1)%this.spawnPoints.length;var e=(0,c.Xr)(this.spawnPoints[this.lastSpawnIndex],f.U);return{position:e.position.clone(),rotation:e.rotation.clone()}}},{key:"execute",value:function(){var e,t,n=this;null===(e=this.queryResults.spawnPoint.added)||void 0===e||e.forEach((function(e){if(!(0,c.tu)(e,f.U))return console.warn("Can't add spawn point, no transform component on entity");n.spawnPoints.push(e)})),null===(t=this.queryResults.spawnPoint.removed)||void 0===t||t.forEach((function(e){n.spawnPoints.splice(n.spawnPoints.indexOf(e))}))}}]),n}(u.x);y.queries={toBeSpawned:{components:[h.Z,f.U],listen:{added:!0,removed:!0}},spawnPoint:{components:[d.Z,f.U],listen:{added:!0,removed:!0}}}},50097:function(e,t,n){"use strict";n.d(t,{z:function(){return g}});var r=n(15194),i=n(49182),a=n(39337),o=n(13987),s=n(29569),l=n(89306),u=n(97762),c=n(88203),f=n(16090),d=n(17356),h=n(99010),p=n(55881);function v(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function m(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?v(Object(n),!0).forEach((function(t){(0,r.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):v(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function y(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,l.Z)(e);if(t){var i=(0,l.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,s.Z)(this,n)}}var g=function(e){(0,o.Z)(n,e);var t=y(n);function n(){var e;return(0,i.Z)(this,n),(e=t.apply(this,arguments)).updateType=d.V.Fixed,e}return(0,a.Z)(n,[{key:"execute",value:function(e){var t,n,r=this;null===(t=this.queryResults.state.added)||void 0===t||t.forEach((function(e){if(r._state=(0,f.Xr)(e,p.Z),void 0===r._state)return console.warn("Tried to execute on a newly added input component, but it was undefined");(0,h.I)(e,{state:r._state.schema.default})})),null===(n=this.queryResults.state.all)||void 0===n||n.forEach((function(t){x(t,{phase:"onUpdate"},e)}))}}]),n}(c.x),x=function(e,t,n){var r=(0,f.Xr)(e,p.Z);r.data.forEach((function(t){t.lifecycleState===u.q.STARTED&&void 0!==r.schema.states[t.state]&&(void 0!==r.schema.states[t.state].componentProperties&&r.schema.states[t.state].componentProperties.forEach((function(t){var n=(0,f.Ei)(e,t.component);if(void 0===n)console.warn("Component is undefined, check your state");else for(var r in t.properties)n[r]=t.properties[r]})),void 0!==r.schema.states[t.state].onEntry&&r.schema.states[t.state].onEntry.forEach((function(t){t.behavior(e,t.args,n)}))),void 0!==r.schema.states[t.state]&&void 0!==r.schema.states[t.state].onUpdate&&(t.lifecycleState===u.q.STARTED&&r.data.set(t.state,m(m({},t),{},{lifecycleState:u.q.CONTINUED})),r.schema.states[t.state].onUpdate.forEach((function(t){return t.behavior(e,t.args,n)}))),t.lifecycleState===u.q.ENDED&&void 0!==r.schema.states[t.state]&&void 0!==r.schema.states[t.state].onExit&&(r.schema.states[t.state].onExit.forEach((function(t){return t.behavior(e,t.args,n)})),r.data.delete(t.state))}))};g.queries={state:{components:[p.Z],listen:{added:!0,changed:!0,removed:!0}}}},83659:function(e,t,n){"use strict";n.d(t,{X:function(){return f}});var r=n(49182),i=n(39337),a=n(13987),o=n(29569),s=n(89306),l=n(65648),u=n(52288);function c(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,s.Z)(e);if(t){var i=(0,s.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,o.Z)(this,n)}}var f=function(e){(0,a.Z)(n,e);var t=c(n);function n(){var e;return(0,r.Z)(this,n),(e=t.call(this)).reset(),e}return(0,i.Z)(n,[{key:"copy",value:function(e){return e.position&&(this.position?this.position.copy(e.position):this.position=e.position.clone()),e.rotation&&(this.rotation?this.rotation.copy(e.rotation):this.rotation=e.rotation.clone()),this}},{key:"reset",value:function(){this.position=null,this.rotation=null}}]),n}(l.w);f._schema={position:{default:null,type:u.Yk.Ref},rotation:{default:null,type:u.Yk.Ref},positionRate:{default:1.5,type:u.Yk.Number},rotationRate:{default:3.5,type:u.Yk.Number}}},46428:function(e,t,n){"use strict";n.d(t,{W:function(){return A}});var r=n(49182),i=n(39337),a=n(13987),o=n(29569),s=n(89306),l=n(88203),u=n(16090),c=n(17356),f=n(52020),d=n(75275),h=n(83659),p=n(82552),v=n(65648),m=n(52288);function y(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,s.Z)(e);if(t){var i=(0,s.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,o.Z)(this,n)}}var g=function(e){(0,a.Z)(n,e);var t=y(n);function n(){var e;return(0,r.Z)(this,n),(e=t.apply(this,arguments)).children=[],e}return n}(v.w);function x(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,s.Z)(e);if(t){var i=(0,s.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,o.Z)(this,n)}}g._schema={children:{default:[],type:m.Yk.Array}};var A=function(e){(0,a.Z)(n,e);var t=x(n);function n(){var e;return(0,r.Z)(this,n),(e=t.apply(this,arguments)).updateType=c.V.Fixed,e}return(0,i.Z)(n,[{key:"execute",value:function(e){var t,n,r,i;null===(t=this.queryResults.copyTransform.all)||void 0===t||t.forEach((function(e){var t,n=null===(t=(0,u.Ei)(e,d.z))||void 0===t?void 0:t.input,r=(0,u.Ei)(e,p.U),i=(0,u.Xr)(n,p.U);i&&r&&(r.position.copy(i.position),r.rotation.copy(i.rotation),r.velocity.copy(i.velocity),(0,u.aT)(e,d.z))})),null===(n=this.queryResults.desiredTransforms.all)||void 0===n||n.forEach((function(t){var n=(0,u.Xr)(t,p.U),r=(0,u.Xr)(t,h.X),i=null===r.position||n.position.equals(r.position),a=null===r.rotation||n.rotation.equals(r.rotation);if(!i||!a){if(!i){var o=(0,u.Ei)(t,p.U);n.position.distanceTo(r.position)<=.001?o.position.copy(r.position):o.position.lerp(r.position,r.positionRate*e)}if(!a){var s=(0,u.Ei)(t,p.U);n.rotation.angleTo(r.rotation)<=.001?s.rotation.copy(r.rotation):s.rotation.slerp(r.rotation,r.rotationRate*e)}}})),null===(r=this.queryResults.transforms.all)||void 0===r||r.forEach((function(t){var n=(0,u.Ei)(t,p.U);n.position.addScaledVector(n.velocity,e);var r=(0,u.Ei)(t,f.S);if(r){if(!r.value)return console.warn("object3D component on entity",t.id," is undefined");r.value.position.copy(n.position),r.value.rotation.setFromQuaternion(n.rotation),n.scale&&n.scale.length()>0&&r.value.scale.copy(n.scale),r.value.updateMatrixWorld()}})),null===(i=this.queryResults.parent.all)||void 0===i||i.forEach((function(e){var t=(0,u.Ei)(e,p.U);(0,u.Xr)(e,g).children.forEach((function(e){if((0,u.tu)(e,f.S)){var n=(0,u.Ei)(e,f.S).value,r=n.position,i=n.quaternion,a=(0,u.Xr)(e,p.U);a?(r.copy(a.position),i.copy(a.rotation)):(r.setScalar(0),i.set(0,0,0,0)),r.add(t.position),i.multiply(t.rotation)}}))}))}}]),n}(l.x);A.queries={parent:{components:[g,p.U]},transforms:{components:[p.U],listen:{added:!0,changed:!0}},desiredTransforms:{components:[h.X]},copyTransform:{components:[d.z]}}}}]);