(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3828],{47509:function(e,t,i){"use strict";i.d(t,{uT:function(){return N},xu:function(){return C},kp:function(){return tt},YD:function(){return E},Ab:function(){return Ft},f4:function(){return Tt},F5:function(){return it},JO:function(){return It},_f:function(){return x},Fv:function(){return te},_C:function(){return at},BQ:function(){return Ie},bn:function(){return z},aL:function(){return Rt},np:function(){return Gt},AO:function(){return c},q3:function(){return $n}});var n=i(94780),o=i(13987),r=i(29569),a=i(89306),s=i(49182),l=i(39337);function u(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var i,n=(0,a.Z)(e);if(t){var o=(0,a.Z)(this).constructor;i=Reflect.construct(n,arguments,o)}else i=n.apply(this,arguments);return(0,r.Z)(this,i)}}var h=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[0,0,0,0,0,0,0,0,0];(0,s.Z)(this,e),this.elements=t}return(0,l.Z)(e,[{key:"identity",value:function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1}},{key:"setZero",value:function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e[8]=0}},{key:"setTrace",value:function(e){var t=this.elements;t[0]=e.x,t[4]=e.y,t[8]=e.z}},{key:"getTrace",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new c,t=this.elements;e.x=t[0],e.y=t[4],e.z=t[8]}},{key:"vmult",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new c,i=this.elements,n=e.x,o=e.y,r=e.z;return t.x=i[0]*n+i[1]*o+i[2]*r,t.y=i[3]*n+i[4]*o+i[5]*r,t.z=i[6]*n+i[7]*o+i[8]*r,t}},{key:"smult",value:function(e){for(var t=0;t<this.elements.length;t++)this.elements[t]*=e}},{key:"mmult",value:function(t){for(var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new e,n=t.elements,o=0;o<3;o++)for(var r=0;r<3;r++){for(var a=0,s=0;s<3;s++)a+=n[o+3*s]*this.elements[s+3*r];i.elements[o+3*r]=a}return i}},{key:"scale",value:function(t){for(var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new e,n=this.elements,o=i.elements,r=0;3!==r;r++)o[3*r+0]=t.x*n[3*r+0],o[3*r+1]=t.y*n[3*r+1],o[3*r+2]=t.z*n[3*r+2];return i}},{key:"solve",value:function(e){var t,i,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new c,o=3,r=4,a=[];for(t=0;t<o*r;t++)a.push(0);for(t=0;t<3;t++)for(i=0;i<3;i++)a[t+r*i]=this.elements[t+3*i];a[3]=e.x,a[7]=e.y,a[11]=e.z;var s,l,u=3,h=u,v=4;do{if(0===a[(t=h-u)+r*t])for(i=t+1;i<h;i++)if(0!==a[t+r*i]){s=v;do{a[(l=v-s)+r*t]+=a[l+r*i]}while(--s);break}if(0!==a[t+r*t])for(i=t+1;i<h;i++){var d=a[t+r*i]/a[t+r*t];s=v;do{a[(l=v-s)+r*i]=l<=t?0:a[l+r*i]-a[l+r*t]*d}while(--s)}}while(--u);if(n.z=a[2*r+3]/a[2*r+2],n.y=(a[1*r+3]-a[1*r+2]*n.z)/a[1*r+1],n.x=(a[0*r+3]-a[0*r+2]*n.z-a[0*r+1]*n.y)/a[0*r+0],isNaN(n.x)||isNaN(n.y)||isNaN(n.z)||n.x===1/0||n.y===1/0||n.z===1/0)throw"Could not solve equation! Got x=["+n.toString()+"], b=["+e.toString()+"], A=["+this.toString()+"]";return n}},{key:"e",value:function(e,t,i){if(void 0===i)return this.elements[t+3*e];this.elements[t+3*e]=i}},{key:"copy",value:function(e){for(var t=0;t<e.elements.length;t++)this.elements[t]=e.elements[t];return this}},{key:"toString",value:function(){for(var e="",t=0;t<9;t++)e+=this.elements[t]+",";return e}},{key:"reverse",value:function(){var t,i,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new e,o=3,r=6,a=[];for(t=0;t<o*r;t++)a.push(0);for(t=0;t<3;t++)for(i=0;i<3;i++)a[t+r*i]=this.elements[t+3*i];a[3]=1,a[9]=0,a[15]=0,a[4]=0,a[10]=1,a[16]=0,a[5]=0,a[11]=0,a[17]=1;var s,l,u=3,h=u,c=r;do{if(0===a[(t=h-u)+r*t])for(i=t+1;i<h;i++)if(0!==a[t+r*i]){s=c;do{a[(l=c-s)+r*t]+=a[l+r*i]}while(--s);break}if(0!==a[t+r*t])for(i=t+1;i<h;i++){var v=a[t+r*i]/a[t+r*t];s=c;do{a[(l=c-s)+r*i]=l<=t?0:a[l+r*i]-a[l+r*t]*v}while(--s)}}while(--u);t=2;do{i=t-1;do{var d=a[t+r*i]/a[t+r*t];s=r;do{a[(l=r-s)+r*i]=a[l+r*i]-a[l+r*t]*d}while(--s)}while(i--)}while(--t);t=2;do{var p=1/a[t+r*t];s=r;do{a[(l=r-s)+r*t]=a[l+r*t]*p}while(--s)}while(t--);t=2;do{i=2;do{if(l=a[o+i+r*t],isNaN(l)||l===1/0)throw"Could not reverse! A=["+this.toString()+"]";n.e(t,i,l)}while(i--)}while(t--);return n}},{key:"setRotationFromQuaternion",value:function(e){var t=e.x,i=e.y,n=e.z,o=e.w,r=t+t,a=i+i,s=n+n,l=t*r,u=t*a,h=t*s,c=i*a,v=i*s,d=n*s,p=o*r,y=o*a,f=o*s,m=this.elements;return m[0]=1-(c+d),m[1]=u-f,m[2]=h+y,m[3]=u+f,m[4]=1-(l+d),m[5]=v-p,m[6]=h-y,m[7]=v+p,m[8]=1-(l+c),this}},{key:"transpose",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new e,i=t.elements,n=this.elements,o=0;3!==o;o++)for(var r=0;3!==r;r++)i[3*o+r]=n[3*r+o];return t}}]),e}(),c=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;(0,s.Z)(this,e),this.x=t,this.y=i,this.z=n}return(0,l.Z)(e,[{key:"cross",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new e,n=t.x,o=t.y,r=t.z,a=this.x,s=this.y,l=this.z;return i.x=s*r-l*o,i.y=l*n-a*r,i.z=a*o-s*n,i}},{key:"set",value:function(e,t,i){return this.x=e,this.y=t,this.z=i,this}},{key:"setZero",value:function(){this.x=this.y=this.z=0}},{key:"vadd",value:function(t,i){if(!i)return new e(this.x+t.x,this.y+t.y,this.z+t.z);i.x=t.x+this.x,i.y=t.y+this.y,i.z=t.z+this.z}},{key:"vsub",value:function(t,i){if(!i)return new e(this.x-t.x,this.y-t.y,this.z-t.z);i.x=this.x-t.x,i.y=this.y-t.y,i.z=this.z-t.z}},{key:"crossmat",value:function(){return new h([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])}},{key:"normalize",value:function(){var e=this.x,t=this.y,i=this.z,n=Math.sqrt(e*e+t*t+i*i);if(n>0){var o=1/n;this.x*=o,this.y*=o,this.z*=o}else this.x=0,this.y=0,this.z=0;return n}},{key:"unit",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new e,i=this.x,n=this.y,o=this.z,r=Math.sqrt(i*i+n*n+o*o);return r>0?(r=1/r,t.x=i*r,t.y=n*r,t.z=o*r):(t.x=1,t.y=0,t.z=0),t}},{key:"length",value:function(){var e=this.x,t=this.y,i=this.z;return Math.sqrt(e*e+t*t+i*i)}},{key:"lengthSquared",value:function(){return this.dot(this)}},{key:"distanceTo",value:function(e){var t=this.x,i=this.y,n=this.z,o=e.x,r=e.y,a=e.z;return Math.sqrt((o-t)*(o-t)+(r-i)*(r-i)+(a-n)*(a-n))}},{key:"distanceSquared",value:function(e){var t=this.x,i=this.y,n=this.z,o=e.x,r=e.y,a=e.z;return(o-t)*(o-t)+(r-i)*(r-i)+(a-n)*(a-n)}},{key:"scale",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new e,n=this.x,o=this.y,r=this.z;return i.x=t*n,i.y=t*o,i.z=t*r,i}},{key:"vmul",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new e;return i.x=t.x*this.x,i.y=t.y*this.y,i.z=t.z*this.z,i}},{key:"addScaledVector",value:function(t,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new e;return n.x=this.x+t*i.x,n.y=this.y+t*i.y,n.z=this.z+t*i.z,n}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y+this.z*e.z}},{key:"isZero",value:function(){return 0===this.x&&0===this.y&&0===this.z}},{key:"negate",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new e;return t.x=-this.x,t.y=-this.y,t.z=-this.z,t}},{key:"tangents",value:function(e,t){var i=this.length();if(i>0){var n=v,o=1/i;n.set(this.x*o,this.y*o,this.z*o);var r=d;Math.abs(n.x)<.9?(r.set(1,0,0),n.cross(r,e)):(r.set(0,1,0),n.cross(r,e)),n.cross(e,t)}else e.set(1,0,0),t.set(0,1,0)}},{key:"toString",value:function(){return this.x+","+this.y+","+this.z}},{key:"toArray",value:function(){return[this.x,this.y,this.z]}},{key:"copy",value:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}},{key:"lerp",value:function(e,t,i){var n=this.x,o=this.y,r=this.z;i.x=n+(e.x-n)*t,i.y=o+(e.y-o)*t,i.z=r+(e.z-r)*t}},{key:"almostEquals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e-6;return!(Math.abs(this.x-e.x)>t||Math.abs(this.y-e.y)>t||Math.abs(this.z-e.z)>t)}},{key:"almostZero",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e-6;return!(Math.abs(this.x)>e||Math.abs(this.y)>e||Math.abs(this.z)>e)}},{key:"isAntiparallelTo",value:function(e,t){return this.negate(p),p.almostEquals(e,t)}},{key:"clone",value:function(){return new e(this.x,this.y,this.z)}}]),e}();c.ZERO=new c(0,0,0),c.UNIT_X=new c(1,0,0),c.UNIT_Y=new c(0,1,0),c.UNIT_Z=new c(0,0,1);var v=new c,d=new c,p=new c,y=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,s.Z)(this,e),this.lowerBound=new c,this.upperBound=new c,t.lowerBound&&this.lowerBound.copy(t.lowerBound),t.upperBound&&this.upperBound.copy(t.upperBound)}return(0,l.Z)(e,[{key:"setFromPoints",value:function(e,t,i,n){var o=this.lowerBound,r=this.upperBound,a=i;o.copy(e[0]),a&&a.vmult(o,o),r.copy(o);for(var s=1;s<e.length;s++){var l=e[s];a&&(a.vmult(l,f),l=f),l.x>r.x&&(r.x=l.x),l.x<o.x&&(o.x=l.x),l.y>r.y&&(r.y=l.y),l.y<o.y&&(o.y=l.y),l.z>r.z&&(r.z=l.z),l.z<o.z&&(o.z=l.z)}return t&&(t.vadd(o,o),t.vadd(r,r)),n&&(o.x-=n,o.y-=n,o.z-=n,r.x+=n,r.y+=n,r.z+=n),this}},{key:"copy",value:function(e){return this.lowerBound.copy(e.lowerBound),this.upperBound.copy(e.upperBound),this}},{key:"clone",value:function(){return(new e).copy(this)}},{key:"extend",value:function(e){this.lowerBound.x=Math.min(this.lowerBound.x,e.lowerBound.x),this.upperBound.x=Math.max(this.upperBound.x,e.upperBound.x),this.lowerBound.y=Math.min(this.lowerBound.y,e.lowerBound.y),this.upperBound.y=Math.max(this.upperBound.y,e.upperBound.y),this.lowerBound.z=Math.min(this.lowerBound.z,e.lowerBound.z),this.upperBound.z=Math.max(this.upperBound.z,e.upperBound.z)}},{key:"overlaps",value:function(e){var t=this.lowerBound,i=this.upperBound,n=e.lowerBound,o=e.upperBound,r=n.x<=i.x&&i.x<=o.x||t.x<=o.x&&o.x<=i.x,a=n.y<=i.y&&i.y<=o.y||t.y<=o.y&&o.y<=i.y,s=n.z<=i.z&&i.z<=o.z||t.z<=o.z&&o.z<=i.z;return r&&a&&s}},{key:"volume",value:function(){var e=this.lowerBound,t=this.upperBound;return(t.x-e.x)*(t.y-e.y)*(t.z-e.z)}},{key:"contains",value:function(e){var t=this.lowerBound,i=this.upperBound,n=e.lowerBound,o=e.upperBound;return t.x<=n.x&&i.x>=o.x&&t.y<=n.y&&i.y>=o.y&&t.z<=n.z&&i.z>=o.z}},{key:"getCorners",value:function(e,t,i,n,o,r,a,s){var l=this.lowerBound,u=this.upperBound;e.copy(l),t.set(u.x,l.y,l.z),i.set(u.x,u.y,l.z),n.set(l.x,u.y,u.z),o.set(u.x,l.y,u.z),r.set(l.x,u.y,l.z),a.set(l.x,l.y,u.z),s.copy(u)}},{key:"toLocalFrame",value:function(e,t){var i=m,n=i[0],o=i[1],r=i[2],a=i[3],s=i[4],l=i[5],u=i[6],h=i[7];this.getCorners(n,o,r,a,s,l,u,h);for(var c=0;8!==c;c++){var v=i[c];e.pointToLocal(v,v)}return t.setFromPoints(i)}},{key:"toWorldFrame",value:function(e,t){var i=m,n=i[0],o=i[1],r=i[2],a=i[3],s=i[4],l=i[5],u=i[6],h=i[7];this.getCorners(n,o,r,a,s,l,u,h);for(var c=0;8!==c;c++){var v=i[c];e.pointToWorld(v,v)}return t.setFromPoints(i)}},{key:"overlapsRay",value:function(e){var t=e.direction,i=e.from,n=1/t.x,o=1/t.y,r=1/t.z,a=(this.lowerBound.x-i.x)*n,s=(this.upperBound.x-i.x)*n,l=(this.lowerBound.y-i.y)*o,u=(this.upperBound.y-i.y)*o,h=(this.lowerBound.z-i.z)*r,c=(this.upperBound.z-i.z)*r,v=Math.max(Math.max(Math.min(a,s),Math.min(l,u)),Math.min(h,c)),d=Math.min(Math.min(Math.max(a,s),Math.max(l,u)),Math.max(h,c));return!(d<0)&&!(v>d)}}]),e}(),f=new c,m=[new c,new c,new c,new c,new c,new c,new c,new c],g=function(){function e(){(0,s.Z)(this,e),this.matrix=[]}return(0,l.Z)(e,[{key:"get",value:function(e,t){var i=e.index,n=t.index;if(n>i){var o=n;n=i,i=o}return this.matrix[(i*(i+1)>>1)+n-1]}},{key:"set",value:function(e,t,i){var n=e.index,o=t.index;if(o>n){var r=o;o=n,n=r}this.matrix[(n*(n+1)>>1)+o-1]=i?1:0}},{key:"reset",value:function(){for(var e=0,t=this.matrix.length;e!==t;e++)this.matrix[e]=0}},{key:"setNumObjects",value:function(e){this.matrix.length=e*(e-1)>>1}}]),e}(),w=function(){function e(){(0,s.Z)(this,e)}return(0,l.Z)(e,[{key:"addEventListener",value:function(e,t){void 0===this._listeners&&(this._listeners={});var i=this._listeners;return void 0===i[e]&&(i[e]=[]),i[e].includes(t)||i[e].push(t),this}},{key:"hasEventListener",value:function(e,t){if(void 0===this._listeners)return!1;var i=this._listeners;return!(void 0===i[e]||!i[e].includes(t))}},{key:"hasAnyEventListener",value:function(e){return void 0!==this._listeners&&void 0!==this._listeners[e]}},{key:"removeEventListener",value:function(e,t){if(void 0===this._listeners)return this;var i=this._listeners;if(void 0===i[e])return this;var n=i[e].indexOf(t);return-1!==n&&i[e].splice(n,1),this}},{key:"dispatchEvent",value:function(e){if(void 0===this._listeners)return this;var t=this._listeners[e.type];if(void 0!==t){e.target=this;for(var i=0,n=t.length;i<n;i++)t[i].call(this,e)}return this}}]),e}(),x=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;(0,s.Z)(this,e),this.x=t,this.y=i,this.z=n,this.w=o}return(0,l.Z)(e,[{key:"set",value:function(e,t,i,n){return this.x=e,this.y=t,this.z=i,this.w=n,this}},{key:"toString",value:function(){return this.x+","+this.y+","+this.z+","+this.w}},{key:"toArray",value:function(){return[this.x,this.y,this.z,this.w]}},{key:"setFromAxisAngle",value:function(e,t){var i=Math.sin(.5*t);return this.x=e.x*i,this.y=e.y*i,this.z=e.z*i,this.w=Math.cos(.5*t),this}},{key:"toAxisAngle",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new c;this.normalize();var t=2*Math.acos(this.w),i=Math.sqrt(1-this.w*this.w);return i<.001?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/i,e.y=this.y/i,e.z=this.z/i),[e,t]}},{key:"setFromVectors",value:function(e,t){if(e.isAntiparallelTo(t)){var i=b,n=k;e.tangents(i,n),this.setFromAxisAngle(i,Math.PI)}else{var o=e.cross(t);this.x=o.x,this.y=o.y,this.z=o.z,this.w=Math.sqrt(Math.pow(e.length(),2)*Math.pow(t.length(),2))+e.dot(t),this.normalize()}return this}},{key:"mult",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new e,n=this.x,o=this.y,r=this.z,a=this.w,s=t.x,l=t.y,u=t.z,h=t.w;return i.x=n*h+a*s+o*u-r*l,i.y=o*h+a*l+r*s-n*u,i.z=r*h+a*u+n*l-o*s,i.w=a*h-n*s-o*l-r*u,i}},{key:"inverse",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new e,i=this.x,n=this.y,o=this.z,r=this.w;this.conjugate(t);var a=1/(i*i+n*n+o*o+r*r);return t.x*=a,t.y*=a,t.z*=a,t.w*=a,t}},{key:"conjugate",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new e;return t.x=-this.x,t.y=-this.y,t.z=-this.z,t.w=this.w,t}},{key:"normalize",value:function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return 0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e),this}},{key:"normalizeFast",value:function(){var e=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;return 0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=e,this.y*=e,this.z*=e,this.w*=e),this}},{key:"vmult",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new c,i=e.x,n=e.y,o=e.z,r=this.x,a=this.y,s=this.z,l=this.w,u=l*i+a*o-s*n,h=l*n+s*i-r*o,v=l*o+r*n-a*i,d=-r*i-a*n-s*o;return t.x=u*l+d*-r+h*-s-v*-a,t.y=h*l+d*-a+v*-r-u*-s,t.z=v*l+d*-s+u*-a-h*-r,t}},{key:"copy",value:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}},{key:"toEuler",value:function(e){var t,i,n,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"YZX",r=this.x,a=this.y,s=this.z,l=this.w;switch(o){case"YZX":var u=r*a+s*l;if(u>.499&&(t=2*Math.atan2(r,l),i=Math.PI/2,n=0),u<-.499&&(t=-2*Math.atan2(r,l),i=-Math.PI/2,n=0),void 0===t){var h=r*r,c=a*a,v=s*s;t=Math.atan2(2*a*l-2*r*s,1-2*c-2*v),i=Math.asin(2*u),n=Math.atan2(2*r*l-2*a*s,1-2*h-2*v)}break;default:throw new Error("Euler order "+o+" not supported yet.")}e.y=t,e.z=i,e.x=n}},{key:"setFromEuler",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"XYZ",o=Math.cos(e/2),r=Math.cos(t/2),a=Math.cos(i/2),s=Math.sin(e/2),l=Math.sin(t/2),u=Math.sin(i/2);return"XYZ"===n?(this.x=s*r*a+o*l*u,this.y=o*l*a-s*r*u,this.z=o*r*u+s*l*a,this.w=o*r*a-s*l*u):"YXZ"===n?(this.x=s*r*a+o*l*u,this.y=o*l*a-s*r*u,this.z=o*r*u-s*l*a,this.w=o*r*a+s*l*u):"ZXY"===n?(this.x=s*r*a-o*l*u,this.y=o*l*a+s*r*u,this.z=o*r*u+s*l*a,this.w=o*r*a-s*l*u):"ZYX"===n?(this.x=s*r*a-o*l*u,this.y=o*l*a+s*r*u,this.z=o*r*u-s*l*a,this.w=o*r*a+s*l*u):"YZX"===n?(this.x=s*r*a+o*l*u,this.y=o*l*a+s*r*u,this.z=o*r*u-s*l*a,this.w=o*r*a-s*l*u):"XZY"===n&&(this.x=s*r*a-o*l*u,this.y=o*l*a-s*r*u,this.z=o*r*u+s*l*a,this.w=o*r*a+s*l*u),this}},{key:"clone",value:function(){return new e(this.x,this.y,this.z,this.w)}},{key:"slerp",value:function(t,i){var n,o,r,a,s,l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new e,u=this.x,h=this.y,c=this.z,v=this.w,d=t.x,p=t.y,y=t.z,f=t.w;return(o=u*d+h*p+c*y+v*f)<0&&(o=-o,d=-d,p=-p,y=-y,f=-f),1-o>1e-6?(n=Math.acos(o),r=Math.sin(n),a=Math.sin((1-i)*n)/r,s=Math.sin(i*n)/r):(a=1-i,s=i),l.x=a*u+s*d,l.y=a*h+s*p,l.z=a*c+s*y,l.w=a*v+s*f,l}},{key:"integrate",value:function(t,i,n){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new e,r=t.x*n.x,a=t.y*n.y,s=t.z*n.z,l=this.x,u=this.y,h=this.z,c=this.w,v=.5*i;return o.x+=v*(r*c+a*h-s*u),o.y+=v*(a*c+s*l-r*h),o.z+=v*(s*c+r*u-a*l),o.w+=v*(-r*l-a*u-s*h),o}}]),e}(),b=new c,k=new c,z=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,s.Z)(this,e),this.id=e.idCounter++,this.type=t.type||0,this.boundingSphereRadius=0,this.collisionResponse=!t.collisionResponse||t.collisionResponse,this.collisionFilterGroup=void 0!==t.collisionFilterGroup?t.collisionFilterGroup:1,this.collisionFilterMask=void 0!==t.collisionFilterMask?t.collisionFilterMask:-1,this.material=t.material?t.material:null,this.body=null}return(0,l.Z)(e,[{key:"updateBoundingSphereRadius",value:function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type}},{key:"volume",value:function(){throw"volume() not implemented for shape type "+this.type}},{key:"calculateLocalInertia",value:function(e,t){throw"calculateLocalInertia() not implemented for shape type "+this.type}},{key:"calculateWorldAABB",value:function(e,t,i,n){throw"calculateWorldAABB() not implemented for shape type "+this.type}}]),e}();z.idCounter=0,z.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256};var S=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,s.Z)(this,e),this.position=new c,this.quaternion=new x,t.position&&this.position.copy(t.position),t.quaternion&&this.quaternion.copy(t.quaternion)}return(0,l.Z)(e,[{key:"pointToLocal",value:function(t,i){return e.pointToLocalFrame(this.position,this.quaternion,t,i)}},{key:"pointToWorld",value:function(t,i){return e.pointToWorldFrame(this.position,this.quaternion,t,i)}},{key:"vectorToWorldFrame",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new c;return this.quaternion.vmult(e,t),t}}],[{key:"pointToLocalFrame",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new c;return i.vsub(e,n),t.conjugate(B),B.vmult(n,n),n}},{key:"pointToWorldFrame",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new c;return t.vmult(i,n),n.vadd(e,n),n}},{key:"vectorToWorldFrame",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new c;return e.vmult(t,i),i}},{key:"vectorToLocalFrame",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new c;return t.w*=-1,t.vmult(i,n),t.w*=-1,n}}]),e}(),B=new x,E=function(e){(0,o.Z)(i,e);var t=u(i);function i(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,s.Z)(this,i);var o=n.vertices,r=void 0===o?[]:o,a=n.faces,l=void 0===a?[]:a,u=n.normals,h=void 0===u?[]:u,c=n.axes,v=n.boundingSphereRadius;return(e=t.call(this,{type:z.types.CONVEXPOLYHEDRON})).vertices=r,e.faces=l,e.faceNormals=h,0===e.faceNormals.length&&e.computeNormals(),v?e.boundingSphereRadius=v:e.updateBoundingSphereRadius(),e.worldVertices=[],e.worldVerticesNeedsUpdate=!0,e.worldFaceNormals=[],e.worldFaceNormalsNeedsUpdate=!0,e.uniqueAxes=c?c.slice():null,e.uniqueEdges=[],e.computeEdges(),e}return(0,l.Z)(i,[{key:"computeEdges",value:function(){var e=this.faces,t=this.vertices,i=this.uniqueEdges;i.length=0;for(var n=new c,o=0;o!==e.length;o++)for(var r=e[o],a=r.length,s=0;s!==a;s++){var l=(s+1)%a;t[r[s]].vsub(t[r[l]],n),n.normalize();for(var u=!1,h=0;h!==i.length;h++)if(i[h].almostEquals(n)||i[h].almostEquals(n)){u=!0;break}u||i.push(n.clone())}}},{key:"computeNormals",value:function(){this.faceNormals.length=this.faces.length;for(var e=0;e<this.faces.length;e++){for(var t=0;t<this.faces[e].length;t++)if(!this.vertices[this.faces[e][t]])throw new Error("Vertex "+this.faces[e][t]+" not found!");var i=this.faceNormals[e]||new c;this.getFaceNormal(e,i),i.negate(i),this.faceNormals[e]=i;var n=this.vertices[this.faces[e][0]];if(i.dot(n)<0){console.error(".faceNormals["+e+"] = Vec3("+i.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var o=0;o<this.faces[e].length;o++)console.warn(".vertices["+this.faces[e][o]+"] = Vec3("+this.vertices[this.faces[e][o]].toString()+")")}}}},{key:"getFaceNormal",value:function(e,t){var n=this.faces[e],o=this.vertices[n[0]],r=this.vertices[n[1]],a=this.vertices[n[2]];i.computeNormal(o,r,a,t)}},{key:"clipAgainstHull",value:function(e,t,i,n,o,r,a,s,l){for(var u=new c,h=-1,v=-Number.MAX_VALUE,d=0;d<i.faces.length;d++){u.copy(i.faceNormals[d]),o.vmult(u,u);var p=u.dot(r);p>v&&(v=p,h=d)}for(var y=[],f=0;f<i.faces[h].length;f++){var m=i.vertices[i.faces[h][f]],g=new c;g.copy(m),o.vmult(g,g),n.vadd(g,g),y.push(g)}h>=0&&this.clipFaceAgainstHull(r,e,t,y,a,s,l)}},{key:"findSeparatingAxis",value:function(e,t,i,n,o,r,a,s){var l=new c,u=new c,h=new c,v=new c,d=new c,p=new c,y=Number.MAX_VALUE,f=this;if(f.uniqueAxes)for(var m=0;m!==f.uniqueAxes.length;m++){i.vmult(f.uniqueAxes[m],l);var g=f.testSepAxis(l,e,t,i,n,o);if(!1===g)return!1;g<y&&(y=g,r.copy(l))}else for(var w=a?a.length:f.faces.length,x=0;x<w;x++){var b=a?a[x]:x;l.copy(f.faceNormals[b]),i.vmult(l,l);var k=f.testSepAxis(l,e,t,i,n,o);if(!1===k)return!1;k<y&&(y=k,r.copy(l))}if(e.uniqueAxes)for(var z=0;z!==e.uniqueAxes.length;z++){o.vmult(e.uniqueAxes[z],u);var S=f.testSepAxis(u,e,t,i,n,o);if(!1===S)return!1;S<y&&(y=S,r.copy(u))}else for(var B=s?s.length:e.faces.length,E=0;E<B;E++){var A=s?s[E]:E;u.copy(e.faceNormals[A]),o.vmult(u,u);var M=f.testSepAxis(u,e,t,i,n,o);if(!1===M)return!1;M<y&&(y=M,r.copy(u))}for(var C=0;C!==f.uniqueEdges.length;C++){i.vmult(f.uniqueEdges[C],v);for(var R=0;R!==e.uniqueEdges.length;R++)if(o.vmult(e.uniqueEdges[R],d),v.cross(d,p),!p.almostZero()){p.normalize();var F=f.testSepAxis(p,e,t,i,n,o);if(!1===F)return!1;F<y&&(y=F,r.copy(p))}}return n.vsub(t,h),h.dot(r)>0&&r.negate(r),!0}},{key:"testSepAxis",value:function(e,t,n,o,r,a){i.project(this,e,n,o,A),i.project(t,e,r,a,M);var s=A[0],l=A[1],u=M[0],h=M[1];if(s<h||u<l)return!1;var c=s-h,v=u-l;return c<v?c:v}},{key:"calculateLocalInertia",value:function(e,t){var i=new c,n=new c;this.computeLocalAABB(n,i);var o=i.x-n.x,r=i.y-n.y,a=i.z-n.z;t.x=1/12*e*(2*r*2*r+2*a*2*a),t.y=1/12*e*(2*o*2*o+2*a*2*a),t.z=1/12*e*(2*r*2*r+2*o*2*o)}},{key:"getPlaneConstantOfFace",value:function(e){var t=this.faces[e],i=this.faceNormals[e],n=this.vertices[t[0]];return-i.dot(n)}},{key:"clipFaceAgainstHull",value:function(e,t,i,n,o,r,a){for(var s=new c,l=new c,u=new c,h=new c,v=new c,d=new c,p=new c,y=new c,f=this,m=n,g=[],w=-1,x=Number.MAX_VALUE,b=0;b<f.faces.length;b++){s.copy(f.faceNormals[b]),i.vmult(s,s);var k=s.dot(e);k<x&&(x=k,w=b)}if(!(w<0)){var z=f.faces[w];z.connectedFaces=[];for(var S=0;S<f.faces.length;S++)for(var B=0;B<f.faces[S].length;B++)-1!==z.indexOf(f.faces[S][B])&&S!==w&&-1===z.connectedFaces.indexOf(S)&&z.connectedFaces.push(S);for(var E=z.length,A=0;A<E;A++){var M=f.vertices[z[A]],C=f.vertices[z[(A+1)%E]];M.vsub(C,l),u.copy(l),i.vmult(u,u),t.vadd(u,u),h.copy(this.faceNormals[w]),i.vmult(h,h),t.vadd(h,h),u.cross(h,v),v.negate(v),d.copy(M),i.vmult(d,d),t.vadd(d,d);var R=z.connectedFaces[A];p.copy(this.faceNormals[R]);var F=this.getPlaneConstantOfFace(R);y.copy(p),i.vmult(y,y);var I=F-y.dot(t);for(this.clipFaceAgainstPlane(m,g,y,I);m.length;)m.shift();for(;g.length;)m.push(g.shift())}p.copy(this.faceNormals[w]);var P=this.getPlaneConstantOfFace(w);y.copy(p),i.vmult(y,y);for(var T=P-y.dot(t),N=0;N<m.length;N++){var L=y.dot(m[N])+T;if(L<=o&&(console.log("clamped: depth="+L+" to minDist="+o),L=o),L<=r){var q=m[N];if(L<=1e-6){var W={point:q,normal:y,depth:L};a.push(W)}}}}}},{key:"clipFaceAgainstPlane",value:function(e,t,i,n){var o,r,a=e.length;if(a<2)return t;var s=e[e.length-1],l=e[0];o=i.dot(s)+n;for(var u=0;u<a;u++){if(l=e[u],r=i.dot(l)+n,o<0)if(r<0){var h=new c;h.copy(l),t.push(h)}else{var v=new c;s.lerp(l,o/(o-r),v),t.push(v)}else if(r<0){var d=new c;s.lerp(l,o/(o-r),d),t.push(d),t.push(l)}s=l,o=r}return t}},{key:"computeWorldVertices",value:function(e,t){for(;this.worldVertices.length<this.vertices.length;)this.worldVertices.push(new c);for(var i=this.vertices,n=this.worldVertices,o=0;o!==this.vertices.length;o++)t.vmult(i[o],n[o]),e.vadd(n[o],n[o]);this.worldVerticesNeedsUpdate=!1}},{key:"computeLocalAABB",value:function(e,t){var i=this.vertices;e.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),t.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var n=0;n<this.vertices.length;n++){var o=i[n];o.x<e.x?e.x=o.x:o.x>t.x&&(t.x=o.x),o.y<e.y?e.y=o.y:o.y>t.y&&(t.y=o.y),o.z<e.z?e.z=o.z:o.z>t.z&&(t.z=o.z)}}},{key:"computeWorldFaceNormals",value:function(e){for(var t=this.faceNormals.length;this.worldFaceNormals.length<t;)this.worldFaceNormals.push(new c);for(var i=this.faceNormals,n=this.worldFaceNormals,o=0;o!==t;o++)e.vmult(i[o],n[o]);this.worldFaceNormalsNeedsUpdate=!1}},{key:"updateBoundingSphereRadius",value:function(){for(var e=0,t=this.vertices,i=0;i!==t.length;i++){var n=t[i].lengthSquared();n>e&&(e=n)}this.boundingSphereRadius=Math.sqrt(e)}},{key:"calculateWorldAABB",value:function(e,t,i,n){for(var o,r,a,s,l,u,h=this.vertices,v=new c,d=0;d<h.length;d++){v.copy(h[d]),t.vmult(v,v),e.vadd(v,v);var p=v;(void 0===o||p.x<o)&&(o=p.x),(void 0===s||p.x>s)&&(s=p.x),(void 0===r||p.y<r)&&(r=p.y),(void 0===l||p.y>l)&&(l=p.y),(void 0===a||p.z<a)&&(a=p.z),(void 0===u||p.z>u)&&(u=p.z)}i.set(o,r,a),n.set(s,l,u)}},{key:"volume",value:function(){return 4*Math.PI*this.boundingSphereRadius/3}},{key:"getAveragePointLocal",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new c,t=this.vertices,i=0;i<t.length;i++)e.vadd(t[i],e);return e.scale(1/t.length,e),e}},{key:"transformAllPoints",value:function(e,t){var i=this.vertices.length,n=this.vertices;if(t){for(var o=0;o<i;o++){var r=n[o];t.vmult(r,r)}for(var a=0;a<this.faceNormals.length;a++){var s=this.faceNormals[a];t.vmult(s,s)}}if(e)for(var l=0;l<i;l++){var u=n[l];u.vadd(e,u)}}},{key:"pointIsInside",value:function(e){var t=this.vertices,i=this.faces,n=this.faceNormals,o=new c;this.getAveragePointLocal(o);for(var r=0;r<this.faces.length;r++){var a=n[r],s=t[i[r][0]],l=new c;e.vsub(s,l);var u=a.dot(l),h=new c;o.vsub(s,h);var v=a.dot(h);if(u<0&&v>0||u>0&&v<0)return!1}return-1}}]),i}(z);E.computeNormal=function(e,t,i,n){var o=new c,r=new c;t.vsub(e,r),i.vsub(t,o),o.cross(r,n),n.isZero()||n.normalize()};var A=[],M=[];E.project=function(e,t,i,n,o){var r=e.vertices.length,a=new c,s=0,l=0,u=new c,h=e.vertices;u.setZero(),S.vectorToLocalFrame(i,n,t,a),S.pointToLocalFrame(i,n,u,u);var v=u.dot(a);l=s=h[0].dot(a);for(var d=1;d<r;d++){var p=h[d].dot(a);p>s&&(s=p),p<l&&(l=p)}if((l-=v)>(s-=v)){var y=l;l=s,s=y}o[0]=s,o[1]=l};var C=function(e){(0,o.Z)(i,e);var t=u(i);function i(e){var n;return(0,s.Z)(this,i),(n=t.call(this,{type:z.types.BOX})).halfExtents=e,n.convexPolyhedronRepresentation=null,n.updateConvexPolyhedronRepresentation(),n.updateBoundingSphereRadius(),n}return(0,l.Z)(i,[{key:"updateConvexPolyhedronRepresentation",value:function(){var e=this.halfExtents.x,t=this.halfExtents.y,i=this.halfExtents.z,n=c,o=[new n(-e,-t,-i),new n(e,-t,-i),new n(e,t,-i),new n(-e,t,-i),new n(-e,-t,i),new n(e,-t,i),new n(e,t,i),new n(-e,t,i)],r=[new n(0,0,1),new n(0,1,0),new n(1,0,0)],a=new E({vertices:o,faces:[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]],axes:r});this.convexPolyhedronRepresentation=a,a.material=this.material}},{key:"calculateLocalInertia",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new c;return i.calculateInertia(this.halfExtents,e,t),t}},{key:"getSideNormals",value:function(e,t){var i=e,n=this.halfExtents;if(i[0].set(n.x,0,0),i[1].set(0,n.y,0),i[2].set(0,0,n.z),i[3].set(-n.x,0,0),i[4].set(0,-n.y,0),i[5].set(0,0,-n.z),void 0!==t)for(var o=0;o!==i.length;o++)t.vmult(i[o],i[o]);return i}},{key:"volume",value:function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z}},{key:"updateBoundingSphereRadius",value:function(){this.boundingSphereRadius=this.halfExtents.length()}},{key:"forEachWorldCorner",value:function(e,t,i){for(var n=this.halfExtents,o=[[n.x,n.y,n.z],[-n.x,n.y,n.z],[-n.x,-n.y,n.z],[-n.x,-n.y,-n.z],[n.x,-n.y,-n.z],[n.x,n.y,-n.z],[-n.x,n.y,-n.z],[n.x,-n.y,n.z]],r=0;r<o.length;r++)R.set(o[r][0],o[r][1],o[r][2]),t.vmult(R,R),e.vadd(R,R),i(R.x,R.y,R.z)}},{key:"calculateWorldAABB",value:function(e,t,i,n){var o=this.halfExtents;F[0].set(o.x,o.y,o.z),F[1].set(-o.x,o.y,o.z),F[2].set(-o.x,-o.y,o.z),F[3].set(-o.x,-o.y,-o.z),F[4].set(o.x,-o.y,-o.z),F[5].set(o.x,o.y,-o.z),F[6].set(-o.x,o.y,-o.z),F[7].set(o.x,-o.y,o.z);var r=F[0];t.vmult(r,r),e.vadd(r,r),n.copy(r),i.copy(r);for(var a=1;a<8;a++){var s=F[a];t.vmult(s,s),e.vadd(s,s);var l=s.x,u=s.y,h=s.z;l>n.x&&(n.x=l),u>n.y&&(n.y=u),h>n.z&&(n.z=h),l<i.x&&(i.x=l),u<i.y&&(i.y=u),h<i.z&&(i.z=h)}}}]),i}(z);C.calculateInertia=function(e,t,i){var n=e;i.x=1/12*t*(2*n.y*2*n.y+2*n.z*2*n.z),i.y=1/12*t*(2*n.x*2*n.x+2*n.z*2*n.z),i.z=1/12*t*(2*n.y*2*n.y+2*n.x*2*n.x)};var R=new c,F=[new c,new c,new c,new c,new c,new c,new c,new c],I=0,P=1,T=2,N=function(e){(0,o.Z)(i,e);var t=u(i);function i(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,s.Z)(this,i),(e=t.call(this)).id=i.idCounter++,e.index=-1,e.world=null,e.preStep=null,e.postStep=null,e.vlambda=new c,e.collisionFilterGroup="number"===typeof n.collisionFilterGroup?n.collisionFilterGroup:1,e.collisionFilterMask="number"===typeof n.collisionFilterMask?n.collisionFilterMask:-1,e.collisionResponse="boolean"!==typeof n.collisionResponse||n.collisionResponse,e.position=new c,e.previousPosition=new c,e.interpolatedPosition=new c,e.initPosition=new c,n.position&&(e.position.copy(n.position),e.previousPosition.copy(n.position),e.interpolatedPosition.copy(n.position),e.initPosition.copy(n.position)),e.velocity=new c,n.velocity&&e.velocity.copy(n.velocity),e.initVelocity=new c,e.force=new c;var o="number"===typeof n.mass?n.mass:0;return e.mass=o,e.invMass=o>0?1/o:0,e.material=n.material||null,e.linearDamping="number"===typeof n.linearDamping?n.linearDamping:.01,e.type=o<=0?i.STATIC:i.DYNAMIC,typeof n.type===typeof i.STATIC&&(e.type=n.type),e.allowSleep="undefined"===typeof n.allowSleep||n.allowSleep,e.sleepState=0,e.sleepSpeedLimit="undefined"!==typeof n.sleepSpeedLimit?n.sleepSpeedLimit:.1,e.sleepTimeLimit="undefined"!==typeof n.sleepTimeLimit?n.sleepTimeLimit:1,e.timeLastSleepy=0,e.wakeUpAfterNarrowphase=!1,e.torque=new c,e.quaternion=new x,e.initQuaternion=new x,e.previousQuaternion=new x,e.interpolatedQuaternion=new x,n.quaternion&&(e.quaternion.copy(n.quaternion),e.initQuaternion.copy(n.quaternion),e.previousQuaternion.copy(n.quaternion),e.interpolatedQuaternion.copy(n.quaternion)),e.angularVelocity=new c,n.angularVelocity&&e.angularVelocity.copy(n.angularVelocity),e.initAngularVelocity=new c,e.shapes=[],e.shapeOffsets=[],e.shapeOrientations=[],e.inertia=new c,e.invInertia=new c,e.invInertiaWorld=new h,e.invMassSolve=0,e.invInertiaSolve=new c,e.invInertiaWorldSolve=new h,e.fixedRotation="undefined"!==typeof n.fixedRotation&&n.fixedRotation,e.angularDamping="undefined"!==typeof n.angularDamping?n.angularDamping:.01,e.linearFactor=new c(1,1,1),n.linearFactor&&e.linearFactor.copy(n.linearFactor),e.angularFactor=new c(1,1,1),n.angularFactor&&e.angularFactor.copy(n.angularFactor),e.aabb=new y,e.aabbNeedsUpdate=!0,e.boundingRadius=0,e.wlambda=new c,n.shape&&e.addShape(n.shape),e.updateMassProperties(),e}return(0,l.Z)(i,[{key:"wakeUp",value:function(){var e=this.sleepState;this.sleepState=0,this.wakeUpAfterNarrowphase=!1,e===i.SLEEPING&&this.dispatchEvent(i.wakeupEvent)}},{key:"sleep",value:function(){this.sleepState=i.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.wakeUpAfterNarrowphase=!1}},{key:"sleepTick",value:function(e){if(this.allowSleep){var t=this.sleepState,n=this.velocity.lengthSquared()+this.angularVelocity.lengthSquared(),o=Math.pow(this.sleepSpeedLimit,2);t===i.AWAKE&&n<o?(this.sleepState=i.SLEEPY,this.timeLastSleepy=e,this.dispatchEvent(i.sleepyEvent)):t===i.SLEEPY&&n>o?this.wakeUp():t===i.SLEEPY&&e-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(i.sleepEvent))}}},{key:"updateSolveMassProperties",value:function(){this.sleepState===i.SLEEPING||this.type===i.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))}},{key:"pointToLocalFrame",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new c;return e.vsub(this.position,t),this.quaternion.conjugate().vmult(t,t),t}},{key:"vectorToLocalFrame",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new c;return this.quaternion.conjugate().vmult(e,t),t}},{key:"pointToWorldFrame",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new c;return this.quaternion.vmult(e,t),t.vadd(this.position,t),t}},{key:"vectorToWorldFrame",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new c;return this.quaternion.vmult(e,t),t}},{key:"addShape",value:function(e,t,i){var n=new c,o=new x;return t&&n.copy(t),i&&o.copy(i),this.shapes.push(e),this.shapeOffsets.push(n),this.shapeOrientations.push(o),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,e.body=this,this}},{key:"updateBoundingRadius",value:function(){for(var e=this.shapes,t=this.shapeOffsets,i=e.length,n=0,o=0;o!==i;o++){var r=e[o];r.updateBoundingSphereRadius();var a=t[o].length(),s=r.boundingSphereRadius;a+s>n&&(n=a+s)}this.boundingRadius=n}},{key:"computeAABB",value:function(){for(var e=this.shapes,t=this.shapeOffsets,i=this.shapeOrientations,n=e.length,o=L,r=q,a=this.quaternion,s=this.aabb,l=W,u=0;u!==n;u++){var h=e[u];a.vmult(t[u],o),o.vadd(this.position,o),a.mult(i[u],r),h.calculateWorldAABB(o,r,l.lowerBound,l.upperBound),0===u?s.copy(l):s.extend(l)}this.aabbNeedsUpdate=!1}},{key:"updateInertiaWorld",value:function(e){var t=this.invInertia;if(t.x!==t.y||t.y!==t.z||e){var i=V,n=j;i.setRotationFromQuaternion(this.quaternion),i.transpose(n),i.scale(t,i),i.mmult(n,this.invInertiaWorld)}else;}},{key:"applyForce",value:function(e,t){if(this.type===i.DYNAMIC){var n=Z;t.cross(e,n),this.force.vadd(e,this.force),this.torque.vadd(n,this.torque)}}},{key:"applyLocalForce",value:function(e,t){if(this.type===i.DYNAMIC){var n=O,o=_;this.vectorToWorldFrame(e,n),this.vectorToWorldFrame(t,o),this.applyForce(n,o)}}},{key:"applyImpulse",value:function(e,t){if(this.type===i.DYNAMIC){var n=t,o=H;o.copy(e),o.scale(this.invMass,o),this.velocity.vadd(o,this.velocity);var r=D;n.cross(e,r),this.invInertiaWorld.vmult(r,r),this.angularVelocity.vadd(r,this.angularVelocity)}}},{key:"applyLocalImpulse",value:function(e,t){if(this.type===i.DYNAMIC){var n=U,o=X;this.vectorToWorldFrame(e,n),this.vectorToWorldFrame(t,o),this.applyImpulse(n,o)}}},{key:"updateMassProperties",value:function(){var e=G;this.invMass=this.mass>0?1/this.mass:0;var t=this.inertia,i=this.fixedRotation;this.computeAABB(),e.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),C.calculateInertia(e,this.mass,t),this.invInertia.set(t.x>0&&!i?1/t.x:0,t.y>0&&!i?1/t.y:0,t.z>0&&!i?1/t.z:0),this.updateInertiaWorld(!0)}},{key:"getVelocityAtWorldPoint",value:function(e,t){var i=new c;return e.vsub(this.position,i),this.angularVelocity.cross(i,t),this.velocity.vadd(t,t),t}},{key:"integrate",value:function(e,t,n){if(this.previousPosition.copy(this.position),this.previousQuaternion.copy(this.quaternion),(this.type===i.DYNAMIC||this.type===i.KINEMATIC)&&this.sleepState!==i.SLEEPING){var o=this.velocity,r=this.angularVelocity,a=this.position,s=this.force,l=this.torque,u=this.quaternion,h=this.invMass,c=this.invInertiaWorld,v=this.linearFactor,d=h*e;o.x+=s.x*d*v.x,o.y+=s.y*d*v.y,o.z+=s.z*d*v.z;var p=c.elements,y=this.angularFactor,f=l.x*y.x,m=l.y*y.y,g=l.z*y.z;r.x+=e*(p[0]*f+p[1]*m+p[2]*g),r.y+=e*(p[3]*f+p[4]*m+p[5]*g),r.z+=e*(p[6]*f+p[7]*m+p[8]*g),a.x+=o.x*e,a.y+=o.y*e,a.z+=o.z*e,u.integrate(this.angularVelocity,e,this.angularFactor,u),t&&(n?u.normalizeFast():u.normalize()),this.aabbNeedsUpdate=!0,this.updateInertiaWorld()}}}]),i}(w);N.COLLIDE_EVENT_NAME="collide",N.DYNAMIC=1,N.STATIC=2,N.KINEMATIC=4,N.AWAKE=I,N.SLEEPY=P,N.SLEEPING=T,N.idCounter=0,N.wakeupEvent={type:"wakeup"},N.sleepyEvent={type:"sleepy"},N.sleepEvent={type:"sleep"};var L=new c,q=new x,W=new y,V=new h,j=new h,Z=new c,O=new c,_=new c,H=new c,D=new c,U=new c,X=new c,G=new c,Y=function(){function e(){(0,s.Z)(this,e),this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}return(0,l.Z)(e,[{key:"collisionPairs",value:function(e,t,i){throw new Error("collisionPairs not implemented for this BroadPhase class!")}},{key:"needBroadphaseCollision",value:function(e,t){return 0!==(e.collisionFilterGroup&t.collisionFilterMask)&&0!==(t.collisionFilterGroup&e.collisionFilterMask)&&(0===(e.type&N.STATIC)&&e.sleepState!==N.SLEEPING||0===(t.type&N.STATIC)&&t.sleepState!==N.SLEEPING)}},{key:"intersectionTest",value:function(e,t,i,n){this.useBoundingBoxes?this.doBoundingBoxBroadphase(e,t,i,n):this.doBoundingSphereBroadphase(e,t,i,n)}},{key:"doBoundingSphereBroadphase",value:function(e,t,i,n){var o=K;t.position.vsub(e.position,o);var r=Math.pow(e.boundingRadius+t.boundingRadius,2);o.lengthSquared()<r&&(i.push(e),n.push(t))}},{key:"doBoundingBoxBroadphase",value:function(e,t,i,n){e.aabbNeedsUpdate&&e.computeAABB(),t.aabbNeedsUpdate&&t.computeAABB(),e.aabb.overlaps(t.aabb)&&(i.push(e),n.push(t))}},{key:"makePairsUnique",value:function(e,t){for(var i=Q,n=J,o=$,r=e.length,a=0;a!==r;a++)n[a]=e[a],o[a]=t[a];e.length=0,t.length=0;for(var s=0;s!==r;s++){var l=n[s].id,u=o[s].id,h=l<u?l+","+u:u+","+l;i[h]=s,i.keys.push(h)}for(var c=0;c!==i.keys.length;c++){var v=i.keys.pop(),d=i[v];e.push(n[d]),t.push(o[d]),delete i[v]}}},{key:"setWorld",value:function(e){}},{key:"aabbQuery",value:function(e,t,i){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}}]),e}(),K=new c,Q={keys:[]},J=[],$=[];Y.boundingSphereCheck=function(e,t){var i=new c;e.position.vsub(t.position,i);var n=e.shapes[0],o=t.shapes[0];return Math.pow(n.boundingSphereRadius+o.boundingSphereRadius,2)>i.lengthSquared()};new c;var ee=function(e){(0,o.Z)(i,e);var t=u(i);function i(){return(0,s.Z)(this,i),t.call(this)}return(0,l.Z)(i,[{key:"collisionPairs",value:function(e,t,i){for(var n,o,r=e.bodies,a=r.length,s=0;s!==a;s++)for(var l=0;l!==s;l++)n=r[s],o=r[l],this.needBroadphaseCollision(n,o)&&this.intersectionTest(n,o,t,i)}},{key:"aabbQuery",value:function(e,t){for(var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],n=0;n<e.bodies.length;n++){var o=e.bodies[n];o.aabbNeedsUpdate&&o.computeAABB(),o.aabb.overlaps(t)&&i.push(o)}return i}}]),i}(Y),te=function(){function e(){(0,s.Z)(this,e),this.rayFromWorld=new c,this.rayToWorld=new c,this.hitNormalWorld=new c,this.hitPointWorld=new c,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this.shouldStop=!1}return(0,l.Z)(e,[{key:"reset",value:function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this.shouldStop=!1}},{key:"abort",value:function(){this.shouldStop=!0}},{key:"set",value:function(e,t,i,n,o,r,a){this.rayFromWorld.copy(e),this.rayToWorld.copy(t),this.hitNormalWorld.copy(i),this.hitPointWorld.copy(n),this.shape=o,this.body=r,this.distance=a}}]),e}(),ie=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new c,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new c;(0,s.Z)(this,e),this.from=t.clone(),this.to=i.clone(),this.direction=new c,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=e.ANY,this.result=new te,this.hasHit=!1,this.callback=function(e){}}return(0,l.Z)(e,[{key:"intersectWorld",value:function(t,i){return this.mode=i.mode||e.ANY,this.result=i.result||new te,this.skipBackfaces=!!i.skipBackfaces,this.collisionFilterMask="undefined"!==typeof i.collisionFilterMask?i.collisionFilterMask:-1,this.collisionFilterGroup="undefined"!==typeof i.collisionFilterGroup?i.collisionFilterGroup:-1,this.checkCollisionResponse="undefined"===typeof i.checkCollisionResponse||i.checkCollisionResponse,i.from&&this.from.copy(i.from),i.to&&this.to.copy(i.to),this.callback=i.callback||function(){},this.hasHit=!1,this.result.reset(),this.updateDirection(),this.getAABB(ne),oe.length=0,t.broadphase.aabbQuery(t,ne,oe),this.intersectBodies(oe),this.hasHit}},{key:"intersectBody",value:function(e,t){t&&(this.result=t,this.updateDirection());var i=this.checkCollisionResponse;if((!i||e.collisionResponse)&&0!==(this.collisionFilterGroup&e.collisionFilterMask)&&0!==(e.collisionFilterGroup&this.collisionFilterMask))for(var n=le,o=ue,r=0,a=e.shapes.length;r<a;r++){var s=e.shapes[r];if((!i||s.collisionResponse)&&(e.quaternion.mult(e.shapeOrientations[r],o),e.quaternion.vmult(e.shapeOffsets[r],n),n.vadd(e.position,n),this.intersectShape(s,o,n,e),this.result.shouldStop))break}}},{key:"intersectBodies",value:function(e,t){t&&(this.result=t,this.updateDirection());for(var i=0,n=e.length;!this.result.shouldStop&&i<n;i++)this.intersectBody(e[i])}},{key:"updateDirection",value:function(){this.to.vsub(this.from,this.direction),this.direction.normalize()}},{key:"intersectShape",value:function(e,t,i,n){if(!(function(e,t,i){i.vsub(e,Re);var n=Re.dot(t);return t.scale(n,Fe),Fe.vadd(e,Fe),i.distanceTo(Fe)}(this.from,this.direction,i)>e.boundingSphereRadius)){var o=this[e.type];o&&o.call(this,e,t,i,n,e)}}},{key:"_intersectBox",value:function(e,t,i,n,o){return this._intersectConvex(e.convexPolyhedronRepresentation,t,i,n,o)}},{key:"_intersectPlane",value:function(e,t,i,n,o){var r=this.from,a=this.to,s=this.direction,l=new c(0,0,1);t.vmult(l,l);var u=new c;r.vsub(i,u);var h=u.dot(l);if(a.vsub(i,u),!(h*u.dot(l)>0)&&!(r.distanceTo(a)<h)){var v=l.dot(s);if(!(Math.abs(v)<this.precision)){var d=new c,p=new c,y=new c;r.vsub(i,d);var f=-l.dot(d)/v;s.scale(f,p),r.vadd(p,y),this.reportIntersection(l,y,o,n,-1)}}}},{key:"getAABB",value:function(e){var t=e.lowerBound,i=e.upperBound,n=this.to,o=this.from;t.x=Math.min(n.x,o.x),t.y=Math.min(n.y,o.y),t.z=Math.min(n.z,o.z),i.x=Math.max(n.x,o.x),i.y=Math.max(n.y,o.y),i.z=Math.max(n.z,o.z)}},{key:"_intersectHeightfield",value:function(e,t,i,n,o){e.data,e.elementSize;var r=fe;r.from.copy(this.from),r.to.copy(this.to),S.pointToLocalFrame(i,t,r.from,r.from),S.pointToLocalFrame(i,t,r.to,r.to),r.updateDirection();var a,s,l,u,h=me;a=s=0,l=u=e.data.length-1;var c=new y;r.getAABB(c),e.getIndexOfPosition(c.lowerBound.x,c.lowerBound.y,h,!0),a=Math.max(a,h[0]),s=Math.max(s,h[1]),e.getIndexOfPosition(c.upperBound.x,c.upperBound.y,h,!0),l=Math.min(l,h[0]+1),u=Math.min(u,h[1]+1);for(var v=a;v<l;v++)for(var d=s;d<u;d++){if(this.result.shouldStop)return;if(e.getAabbAtIndex(v,d,c),c.overlapsRay(r)){if(e.getConvexTrianglePillar(v,d,!1),S.pointToWorldFrame(i,t,e.pillarOffset,ye),this._intersectConvex(e.pillarConvex,t,ye,n,o,pe),this.result.shouldStop)return;e.getConvexTrianglePillar(v,d,!0),S.pointToWorldFrame(i,t,e.pillarOffset,ye),this._intersectConvex(e.pillarConvex,t,ye,n,o,pe)}}}},{key:"_intersectSphere",value:function(e,t,i,n,o){var r=this.from,a=this.to,s=e.radius,l=Math.pow(a.x-r.x,2)+Math.pow(a.y-r.y,2)+Math.pow(a.z-r.z,2),u=2*((a.x-r.x)*(r.x-i.x)+(a.y-r.y)*(r.y-i.y)+(a.z-r.z)*(r.z-i.z)),h=Math.pow(r.x-i.x,2)+Math.pow(r.y-i.y,2)+Math.pow(r.z-i.z,2)-Math.pow(s,2),c=Math.pow(u,2)-4*l*h,v=ge,d=we;if(!(c<0))if(0===c)r.lerp(a,c,v),v.vsub(i,d),d.normalize(),this.reportIntersection(d,v,o,n,-1);else{var p=(-u-Math.sqrt(c))/(2*l),y=(-u+Math.sqrt(c))/(2*l);if(p>=0&&p<=1&&(r.lerp(a,p,v),v.vsub(i,d),d.normalize(),this.reportIntersection(d,v,o,n,-1)),this.result.shouldStop)return;y>=0&&y<=1&&(r.lerp(a,y,v),v.vsub(i,d),d.normalize(),this.reportIntersection(d,v,o,n,-1))}}},{key:"_intersectConvex",value:function(e,t,i,n,o,r){for(var a=xe,s=be,l=r&&r.faceList||null,u=e.faces,h=e.vertices,c=e.faceNormals,v=this.direction,d=this.from,p=this.to,y=d.distanceTo(p),f=l?l.length:u.length,m=this.result,g=0;!m.shouldStop&&g<f;g++){var w=l?l[g]:g,x=u[w],b=c[w],k=t,z=i;s.copy(h[x[0]]),k.vmult(s,s),s.vadd(z,s),s.vsub(d,s),k.vmult(b,a);var S=v.dot(a);if(!(Math.abs(S)<this.precision)){var B=a.dot(s)/S;if(!(B<0)){v.scale(B,he),he.vadd(d,he),ce.copy(h[x[0]]),k.vmult(ce,ce),z.vadd(ce,ce);for(var E=1;!m.shouldStop&&E<x.length-1;E++){ve.copy(h[x[E]]),de.copy(h[x[E+1]]),k.vmult(ve,ve),k.vmult(de,de),z.vadd(ve,ve),z.vadd(de,de);var A=he.distanceTo(d);!se(he,ce,ve,de)&&!se(he,ve,ce,de)||A>y||this.reportIntersection(a,he,o,n,w)}}}}}},{key:"_intersectTrimesh",value:function(e,t,i,n,o,r){var a=ke,s=Me,l=Ce,u=be,h=ze,c=Se,v=Be,d=Ae,p=Ee,y=(r&&r.faceList,e.indices),f=(e.vertices,this.from),m=this.to,g=this.direction;l.position.copy(i),l.quaternion.copy(t),S.vectorToLocalFrame(i,t,g,h),S.pointToLocalFrame(i,t,f,c),S.pointToLocalFrame(i,t,m,v),v.x*=e.scale.x,v.y*=e.scale.y,v.z*=e.scale.z,c.x*=e.scale.x,c.y*=e.scale.y,c.z*=e.scale.z,v.vsub(c,h),h.normalize();var w=c.distanceSquared(v);e.tree.rayQuery(this,l,s);for(var x=0,b=s.length;!this.result.shouldStop&&x!==b;x++){var k=s[x];e.getNormal(k,a),e.getVertex(y[3*k],ce),ce.vsub(c,u);var z=h.dot(a),B=a.dot(u)/z;if(!(B<0)){h.scale(B,he),he.vadd(c,he),e.getVertex(y[3*k+1],ve),e.getVertex(y[3*k+2],de);var E=he.distanceSquared(c);!se(he,ve,ce,de)&&!se(he,ce,ve,de)||E>w||(S.vectorToWorldFrame(t,a,p),S.pointToWorldFrame(i,t,he,d),this.reportIntersection(p,d,o,n,k))}}s.length=0}},{key:"reportIntersection",value:function(t,i,n,o,r){var a=this.from,s=this.to,l=a.distanceTo(i),u=this.result;if(!(this.skipBackfaces&&t.dot(this.direction)>0))switch(u.hitFaceIndex="undefined"!==typeof r?r:-1,this.mode){case e.ALL:this.hasHit=!0,u.set(a,s,t,i,n,o,l),u.hasHit=!0,this.callback(u);break;case e.CLOSEST:(l<u.distance||!u.hasHit)&&(this.hasHit=!0,u.hasHit=!0,u.set(a,s,t,i,n,o,l));break;case e.ANY:this.hasHit=!0,u.hasHit=!0,u.set(a,s,t,i,n,o,l),u.shouldStop=!0}}}]),e}();ie.CLOSEST=1,ie.ANY=2,ie.ALL=4;var ne=new y,oe=[],re=new c,ae=new c;function se(e,t,i,n){n.vsub(t,Re),i.vsub(t,re),e.vsub(t,ae);var o,r,a=Re.dot(Re),s=Re.dot(re),l=Re.dot(ae),u=re.dot(re),h=re.dot(ae);return(o=u*l-s*h)>=0&&(r=a*h-s*l)>=0&&o+r<a*u-s*s}ie.pointInTriangle=se;var le=new c,ue=new x,he=new c,ce=new c,ve=new c,de=new c;ie.prototype[z.types.BOX]=ie.prototype._intersectBox,ie.prototype[z.types.PLANE]=ie.prototype._intersectPlane;var pe={faceList:[0]},ye=new c,fe=new ie,me=[];ie.prototype[z.types.HEIGHTFIELD]=ie.prototype._intersectHeightfield;var ge=new c,we=new c;ie.prototype[z.types.SPHERE]=ie.prototype._intersectSphere;var xe=new c,be=new c;ie.prototype[z.types.CONVEXPOLYHEDRON]=ie.prototype._intersectConvex;var ke=new c,ze=new c,Se=new c,Be=new c,Ee=new c,Ae=new c,Me=(new y,[]),Ce=new S;ie.prototype[z.types.TRIMESH]=ie.prototype._intersectTrimesh;var Re=new c,Fe=new c;var Ie=function(e){(0,o.Z)(i,e);var t=u(i);function i(e){var n;(0,s.Z)(this,i),(n=t.call(this)).axisList=[],n.world=null,n.axisIndex=0;var o=n.axisList;return n._addBodyHandler=function(e){o.push(e.body)},n._removeBodyHandler=function(e){var t=o.indexOf(e.body);-1!==t&&o.splice(t,1)},e&&n.setWorld(e),n}return(0,l.Z)(i,[{key:"setWorld",value:function(e){this.axisList.length=0;for(var t=0;t<e.bodies.length;t++)this.axisList.push(e.bodies[t]);e.removeEventListener("addBody",this._addBodyHandler),e.removeEventListener("removeBody",this._removeBodyHandler),e.addEventListener("addBody",this._addBodyHandler),e.addEventListener("removeBody",this._removeBodyHandler),this.world=e,this.dirty=!0}},{key:"collisionPairs",value:function(e,t,n){var o,r,a=this.axisList,s=a.length,l=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),o=0;o!==s;o++){var u=a[o];for(r=o+1;r<s;r++){var h=a[r];if(this.needBroadphaseCollision(u,h)){if(!i.checkBounds(u,h,l))break;this.intersectionTest(u,h,t,n)}}}}},{key:"sortList",value:function(){for(var e=this.axisList,t=this.axisIndex,n=e.length,o=0;o!==n;o++){var r=e[o];r.aabbNeedsUpdate&&r.computeAABB()}0===t?i.insertionSortX(e):1===t?i.insertionSortY(e):2===t&&i.insertionSortZ(e)}},{key:"autoDetectAxis",value:function(){for(var e=0,t=0,i=0,n=0,o=0,r=0,a=this.axisList,s=a.length,l=1/s,u=0;u!==s;u++){var h=a[u],c=h.position.x;e+=c,t+=c*c;var v=h.position.y;i+=v,n+=v*v;var d=h.position.z;o+=d,r+=d*d}var p=t-e*e*l,y=n-i*i*l,f=r-o*o*l;this.axisIndex=p>y?p>f?0:2:y>f?1:2}},{key:"aabbQuery",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];this.dirty&&(this.sortList(),this.dirty=!1);var n=this.axisIndex,o="x";1===n&&(o="y"),2===n&&(o="z");for(var r=this.axisList,a=(t.lowerBound[o],t.upperBound[o],0);a<r.length;a++){var s=r[a];s.aabbNeedsUpdate&&s.computeAABB(),s.aabb.overlaps(t)&&i.push(s)}return i}}]),i}(Y);function Pe(){}Ie.insertionSortX=function(e){for(var t=1,i=e.length;t<i;t++){var n=e[t],o=void 0;for(o=t-1;o>=0&&!(e[o].aabb.lowerBound.x<=n.aabb.lowerBound.x);o--)e[o+1]=e[o];e[o+1]=n}return e},Ie.insertionSortY=function(e){for(var t=1,i=e.length;t<i;t++){var n=e[t],o=void 0;for(o=t-1;o>=0&&!(e[o].aabb.lowerBound.y<=n.aabb.lowerBound.y);o--)e[o+1]=e[o];e[o+1]=n}return e},Ie.insertionSortZ=function(e){for(var t=1,i=e.length;t<i;t++){var n=e[t],o=void 0;for(o=t-1;o>=0&&!(e[o].aabb.lowerBound.z<=n.aabb.lowerBound.z);o--)e[o+1]=e[o];e[o+1]=n}return e},Ie.checkBounds=function(e,t,i){var n,o;0===i?(n=e.position.x,o=t.position.x):1===i?(n=e.position.y,o=t.position.y):2===i&&(n=e.position.z,o=t.position.z);var r=e.boundingRadius;return o-t.boundingRadius<n+r},Pe.defaults=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0;for(var i in t)i in e||(e[i]=t[i]);return e};var Te=function(){function e(t,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};(0,s.Z)(this,e),n=Pe.defaults(n,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=t,this.bodyB=i,this.id=e.idCounter++,this.collideConnected=n.collideConnected,n.wakeUpBodies&&(t&&t.wakeUp(),i&&i.wakeUp())}return(0,l.Z)(e,[{key:"update",value:function(){throw new Error("method update() not implmemented in this Constraint subclass!")}},{key:"enable",value:function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!0}},{key:"disable",value:function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!1}}]),e}();Te.idCounter=0;var Ne=function(){function e(){(0,s.Z)(this,e),this.spatial=new c,this.rotational=new c}return(0,l.Z)(e,[{key:"multiplyElement",value:function(e){return e.spatial.dot(this.spatial)+e.rotational.dot(this.rotational)}},{key:"multiplyVectors",value:function(e,t){return e.dot(this.spatial)+t.dot(this.rotational)}}]),e}(),Le=function(){function e(t,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1e6,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1e6;(0,s.Z)(this,e),this.id=e.id++,this.minForce=n,this.maxForce=o,this.bi=t,this.bj=i,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new Ne,this.jacobianElementB=new Ne,this.enabled=!0,this.multiplier=0,this.setSpookParams(1e7,4,1/60)}return(0,l.Z)(e,[{key:"setSpookParams",value:function(e,t,i){var n=t,o=e,r=i;this.a=4/(r*(1+4*n)),this.b=4*n/(1+4*n),this.eps=4/(r*r*o*(1+4*n))}},{key:"computeB",value:function(e,t,i){var n=this.computeGW();return-this.computeGq()*e-n*t-this.computeGiMf()*i}},{key:"computeGq",value:function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,o=i.position,r=n.position;return e.spatial.dot(o)+t.spatial.dot(r)}},{key:"computeGW",value:function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,o=i.velocity,r=n.velocity,a=i.angularVelocity,s=n.angularVelocity;return e.multiplyVectors(o,a)+t.multiplyVectors(r,s)}},{key:"computeGWlambda",value:function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,o=i.vlambda,r=n.vlambda,a=i.wlambda,s=n.wlambda;return e.multiplyVectors(o,a)+t.multiplyVectors(r,s)}},{key:"computeGiMf",value:function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,o=i.force,r=i.torque,a=n.force,s=n.torque,l=i.invMassSolve,u=n.invMassSolve;return o.scale(l,qe),a.scale(u,We),i.invInertiaWorldSolve.vmult(r,Ve),n.invInertiaWorldSolve.vmult(s,je),e.multiplyVectors(qe,Ve)+t.multiplyVectors(We,je)}},{key:"computeGiMGt",value:function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,o=i.invMassSolve,r=n.invMassSolve,a=i.invInertiaWorldSolve,s=n.invInertiaWorldSolve,l=o+r;return a.vmult(e.rotational,Ze),l+=Ze.dot(e.rotational),s.vmult(t.rotational,Ze),l+=Ze.dot(t.rotational)}},{key:"addToWlambda",value:function(e){var t=this.jacobianElementA,i=this.jacobianElementB,n=this.bi,o=this.bj,r=Oe;n.vlambda.addScaledVector(n.invMassSolve*e,t.spatial,n.vlambda),o.vlambda.addScaledVector(o.invMassSolve*e,i.spatial,o.vlambda),n.invInertiaWorldSolve.vmult(t.rotational,r),n.wlambda.addScaledVector(e,r,n.wlambda),o.invInertiaWorldSolve.vmult(i.rotational,r),o.wlambda.addScaledVector(e,r,o.wlambda)}},{key:"computeC",value:function(){return this.computeGiMGt()+this.eps}}]),e}();Le.id=0;var qe=new c,We=new c,Ve=new c,je=new c,Ze=new c,Oe=new c,_e=function(e){(0,o.Z)(i,e);var t=u(i);function i(e,n){var o,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e6;return(0,s.Z)(this,i),(o=t.call(this,e,n,0,r)).restitution=0,o.ri=new c,o.rj=new c,o.ni=new c,o}return(0,l.Z)(i,[{key:"computeB",value:function(e){var t=this.a,i=this.b,n=this.bi,o=this.bj,r=this.ri,a=this.rj,s=He,l=De,u=n.velocity,h=n.angularVelocity,c=(n.force,n.torque,o.velocity),v=o.angularVelocity,d=(o.force,o.torque,Ue),p=this.jacobianElementA,y=this.jacobianElementB,f=this.ni;r.cross(f,s),a.cross(f,l),f.negate(p.spatial),s.negate(p.rotational),y.spatial.copy(f),y.rotational.copy(l),d.copy(o.position),d.vadd(a,d),d.vsub(n.position,d),d.vsub(r,d);var m=f.dot(d),g=this.restitution+1;return-m*t-(g*c.dot(f)-g*u.dot(f)+v.dot(l)-h.dot(s))*i-e*this.computeGiMf()}},{key:"getImpactVelocityAlongNormal",value:function(){var e=Xe,t=Ge,i=Ye,n=Ke,o=Qe;return this.bi.position.vadd(this.ri,i),this.bj.position.vadd(this.rj,n),this.bi.getVelocityAtWorldPoint(i,e),this.bj.getVelocityAtWorldPoint(n,t),e.vsub(t,o),this.ni.dot(o)}}]),i}(Le),He=new c,De=new c,Ue=new c,Xe=new c,Ge=new c,Ye=new c,Ke=new c,Qe=new c,Je=(new c,new c,new c,new c,new c,new c,function(e){(0,o.Z)(i,e);var t=u(i);function i(e,n,o){var r;return(0,s.Z)(this,i),(r=t.call(this,e,n,-o,o)).ri=new c,r.rj=new c,r.t=new c,r}return(0,l.Z)(i,[{key:"computeB",value:function(e){this.a;var t=this.b,i=(this.bi,this.bj,this.ri),n=this.rj,o=$e,r=et,a=this.t;i.cross(a,o),n.cross(a,r);var s=this.jacobianElementA,l=this.jacobianElementB;return a.negate(s.spatial),o.negate(s.rotational),l.spatial.copy(a),l.rotational.copy(r),-this.computeGW()*t-e*this.computeGiMf()}}]),i}(Le)),$e=new c,et=new c,tt=function e(t,i,n){(0,s.Z)(this,e),n=Pe.defaults(n,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=e.idCounter++,this.materials=[t,i],this.friction=n.friction,this.restitution=n.restitution,this.contactEquationStiffness=n.contactEquationStiffness,this.contactEquationRelaxation=n.contactEquationRelaxation,this.frictionEquationStiffness=n.frictionEquationStiffness,this.frictionEquationRelaxation=n.frictionEquationRelaxation};tt.idCounter=0;var it=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,s.Z)(this,e);var i="";"string"===typeof t&&(i=t,t={}),this.name=i,this.id=e.idCounter++,this.friction="undefined"!==typeof t.friction?t.friction:-1,this.restitution="undefined"!==typeof t.restitution?t.restitution:-1};it.idCounter=0;new c,new c,new c,new c,new c,new c,new c,new c,new c,new c,new c;var nt=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,s.Z)(this,e),t=Pe.defaults(t,{chassisConnectionPointLocal:new c,chassisConnectionPointWorld:new c,directionLocal:new c,directionWorld:new c,axleLocal:new c,axleWorld:new c,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,slipInfo:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=t.maxSuspensionTravel,this.customSlidingRotationalSpeed=t.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=t.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=t.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=t.chassisConnectionPointWorld.clone(),this.directionLocal=t.directionLocal.clone(),this.directionWorld=t.directionWorld.clone(),this.axleLocal=t.axleLocal.clone(),this.axleWorld=t.axleWorld.clone(),this.suspensionRestLength=t.suspensionRestLength,this.suspensionMaxLength=t.suspensionMaxLength,this.radius=t.radius,this.suspensionStiffness=t.suspensionStiffness,this.dampingCompression=t.dampingCompression,this.dampingRelaxation=t.dampingRelaxation,this.frictionSlip=t.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=t.rollInfluence,this.maxSuspensionForce=t.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=t.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.slipInfo=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new te,this.worldTransform=new S,this.isInContact=!1}return(0,l.Z)(e,[{key:"updateWheel",value:function(e){var t=this.raycastResult;if(this.isInContact){var i=t.hitNormalWorld.dot(t.directionWorld);t.hitPointWorld.vsub(e.position,rt),e.getVelocityAtWorldPoint(rt,ot);var n=t.hitNormalWorld.dot(ot);if(i>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var o=-1/i;this.suspensionRelativeVelocity=n*o,this.clippedInvContactDotSuspension=o}}else t.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,t.directionWorld.scale(-1,t.hitNormalWorld),this.clippedInvContactDotSuspension=1}}]),e}(),ot=new c,rt=new c,at=function(){function e(t){(0,s.Z)(this,e),this.chassisBody=t.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis="undefined"!==typeof t.indexRightAxis?t.indexRightAxis:1,this.indexForwardAxis="undefined"!==typeof t.indexForwardAxis?t.indexForwardAxis:0,this.indexUpAxis="undefined"!==typeof t.indexUpAxis?t.indexUpAxis:2,this.constraints=[],this.preStepCallback=function(){},this.currentVehicleSpeedKmHour=0}return(0,l.Z)(e,[{key:"addWheel",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=new nt(e),i=this.wheelInfos.length;return this.wheelInfos.push(t),i}},{key:"setSteeringValue",value:function(e,t){this.wheelInfos[t].steering=e}},{key:"applyEngineForce",value:function(e,t){this.wheelInfos[t].engineForce=e}},{key:"setBrake",value:function(e,t){this.wheelInfos[t].brake=e}},{key:"addToWorld",value:function(e){this.constraints;e.addBody(this.chassisBody);var t=this;this.preStepCallback=function(){t.updateVehicle(e.dt)},e.addEventListener("preStep",this.preStepCallback),this.world=e}},{key:"getVehicleAxisWorld",value:function(e,t){t.set(0===e?1:0,1===e?1:0,2===e?1:0),this.chassisBody.vectorToWorldFrame(t,t)}},{key:"updateVehicle",value:function(e){for(var t=this.wheelInfos,i=t.length,n=this.chassisBody,o=0;o<i;o++)this.updateWheelTransform(o);this.currentVehicleSpeedKmHour=3.6*n.velocity.length();var r=new c;this.getVehicleAxisWorld(this.indexForwardAxis,r),r.dot(n.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1);for(var a=0;a<i;a++)this.castRay(t[a]);this.updateSuspension(e);for(var s=new c,l=new c,u=0;u<i;u++){var h=t[u],v=h.suspensionForce;v>h.maxSuspensionForce&&(v=h.maxSuspensionForce),h.raycastResult.hitNormalWorld.scale(v*e,s),h.raycastResult.hitPointWorld.vsub(n.position,l),n.applyImpulse(s,l)}this.updateFriction(e);for(var d=new c,p=new c,y=new c,f=0;f<i;f++){var m=t[f];n.getVelocityAtWorldPoint(m.chassisConnectionPointWorld,y);var g=1;switch(this.indexUpAxis){case 1:g=-1}if(m.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,p);var w=p.dot(m.raycastResult.hitNormalWorld);m.raycastResult.hitNormalWorld.scale(w,d),p.vsub(d,p);var x=p.dot(y);m.deltaRotation=g*x*e/m.radius}!m.sliding&&m.isInContact||0===m.engineForce||!m.useCustomSlidingRotationalSpeed||(m.deltaRotation=(m.engineForce>0?1:-1)*m.customSlidingRotationalSpeed*e),Math.abs(m.brake)>Math.abs(m.engineForce)&&(m.deltaRotation=0),m.rotation+=m.deltaRotation,m.deltaRotation*=.99}}},{key:"updateSuspension",value:function(e){for(var t=this.chassisBody.mass,i=this.wheelInfos,n=i.length,o=0;o<n;o++){var r=i[o];if(r.isInContact){var a=void 0,s=r.suspensionRestLength-r.suspensionLength;a=r.suspensionStiffness*s*r.clippedInvContactDotSuspension;var l=r.suspensionRelativeVelocity;a-=(l<0?r.dampingCompression:r.dampingRelaxation)*l,r.suspensionForce=a*t,r.suspensionForce<0&&(r.suspensionForce=0)}else r.suspensionForce=0}}},{key:"removeFromWorld",value:function(e){this.constraints;e.removeBody(this.chassisBody),e.removeEventListener("preStep",this.preStepCallback),this.world=null}},{key:"castRay",value:function(e){var t=ht,i=ct;this.updateWheelTransformWorld(e);var n=this.chassisBody,o=-1,r=e.suspensionRestLength+e.radius;e.directionWorld.scale(r,t);var a=e.chassisConnectionPointWorld;a.vadd(t,i);var s=e.raycastResult;s.reset();var l=n.collisionResponse;n.collisionResponse=!1,this.world.rayTest(a,i,s),n.collisionResponse=l;var u=s.body;if(e.raycastResult.groundObject=0,u){o=s.distance,e.raycastResult.hitNormalWorld=s.hitNormalWorld,e.isInContact=!0;var h=s.distance;e.suspensionLength=h-e.radius;var v=e.suspensionRestLength-e.maxSuspensionTravel,d=e.suspensionRestLength+e.maxSuspensionTravel;e.suspensionLength<v&&(e.suspensionLength=v),e.suspensionLength>d&&(e.suspensionLength=d,e.raycastResult.reset());var p=e.raycastResult.hitNormalWorld.dot(e.directionWorld),y=new c;n.getVelocityAtWorldPoint(e.raycastResult.hitPointWorld,y);var f=e.raycastResult.hitNormalWorld.dot(y);if(p>=-.1)e.suspensionRelativeVelocity=0,e.clippedInvContactDotSuspension=10;else{var m=-1/p;e.suspensionRelativeVelocity=f*m,e.clippedInvContactDotSuspension=m}}else e.suspensionLength=e.suspensionRestLength+0*e.maxSuspensionTravel,e.suspensionRelativeVelocity=0,e.directionWorld.scale(-1,e.raycastResult.hitNormalWorld),e.clippedInvContactDotSuspension=1;return o}},{key:"updateWheelTransformWorld",value:function(e){e.isInContact=!1;var t=this.chassisBody;t.pointToWorldFrame(e.chassisConnectionPointLocal,e.chassisConnectionPointWorld),t.vectorToWorldFrame(e.directionLocal,e.directionWorld),t.vectorToWorldFrame(e.axleLocal,e.axleWorld)}},{key:"updateWheelTransform",value:function(e){var t=st,i=lt,n=ut,o=this.wheelInfos[e];this.updateWheelTransformWorld(o),o.directionLocal.scale(-1,t),i.copy(o.axleLocal),t.cross(i,n),n.normalize(),i.normalize();var r=o.steering,a=new x;a.setFromAxisAngle(t,r);var s=new x;s.setFromAxisAngle(i,o.rotation);var l=o.worldTransform.quaternion;this.chassisBody.quaternion.mult(a,l),l.mult(s,l),l.normalize();var u=o.worldTransform.position;u.copy(o.directionWorld),u.scale(o.suspensionLength,u),u.vadd(o.chassisConnectionPointWorld,u)}},{key:"getWheelTransformWorld",value:function(e){return this.wheelInfos[e].worldTransform}},{key:"updateFriction",value:function(e){for(var t=dt,i=this.wheelInfos,n=i.length,o=this.chassisBody,r=yt,a=pt,s=0;s<n;s++){var l=i[s];l.raycastResult.body;l.sideImpulse=0,l.forwardImpulse=0,r[s]||(r[s]=new c),a[s]||(a[s]=new c)}for(var u=0;u<n;u++){var h=i[u],v=h.raycastResult.body;if(v){var d=a[u];this.getWheelTransformWorld(u).vectorToWorldFrame(vt[this.indexRightAxis],d);var p=h.raycastResult.hitNormalWorld,y=d.dot(p);p.scale(y,t),d.vsub(t,d),d.normalize(),p.cross(d,r[u]),r[u].normalize(),h.sideImpulse=Ct(o,h.raycastResult.hitPointWorld,v,h.raycastResult.hitPointWorld,d),h.sideImpulse*=ft}}this.sliding=!1;for(var f=0;f<n;f++){var m=i[f],g=m.raycastResult.body,w=0;if(m.slipInfo=1,g){var x=m.brake?m.brake:0;w=xt(o,g,m.raycastResult.hitPointWorld,r[f],x);var b=x/(w+=m.engineForce*e);m.slipInfo*=b}if(m.forwardImpulse=0,m.skidInfo=1,g){m.skidInfo=1;var k=m.suspensionForce*e*m.frictionSlip,z=k*k;m.forwardImpulse=w;var S=.5*m.forwardImpulse,B=1*m.sideImpulse,E=S*S+B*B;if(m.sliding=!1,E>z){this.sliding=!0,m.sliding=!0;var A=k/Math.sqrt(E);m.skidInfo*=A}}}if(this.sliding)for(var M=0;M<n;M++){var C=i[M];0!==C.sideImpulse&&C.skidInfo<1&&(C.forwardImpulse*=C.skidInfo,C.sideImpulse*=C.skidInfo)}for(var R=0;R<n;R++){var F=i[R],I=new c;if(F.raycastResult.hitPointWorld.vsub(o.position,I),0!==F.forwardImpulse){var P=new c;r[R].scale(F.forwardImpulse,P),o.applyImpulse(P,I)}if(0!==F.sideImpulse){var T=F.raycastResult.body,N=new c;F.raycastResult.hitPointWorld.vsub(T.position,N);var L=new c;a[R].scale(F.sideImpulse,L),o.vectorToLocalFrame(I,I),I["xyz"[this.indexUpAxis]]*=F.rollInfluence,o.vectorToWorldFrame(I,I),o.applyImpulse(L,I),L.scale(-1,L),T.applyImpulse(L,N)}}}}]),e}(),st=new c,lt=new c,ut=new c,ht=(new ie,new c),ct=new c,vt=[new c(1,0,0),new c(0,1,0),new c(0,0,1)],dt=new c,pt=[],yt=[],ft=1,mt=new c,gt=new c,wt=new c;function xt(e,t,i,n,o){var r=0,a=i,s=mt,l=gt,u=wt;e.getVelocityAtWorldPoint(a,s),t.getVelocityAtWorldPoint(a,l),s.vsub(l,u);return o<(r=-n.dot(u)*(1/(Bt(e,i,n)+Bt(t,i,n))))&&(r=o),r<-o&&(r=-o),r}var bt=new c,kt=new c,zt=new c,St=new c;function Bt(e,t,i){var n=bt,o=kt,r=zt,a=St;return t.vsub(e.position,n),n.cross(i,o),e.invInertiaWorld.vmult(o,a),a.cross(n,r),e.invMass+i.dot(r)}var Et=new c,At=new c,Mt=new c;function Ct(e,t,i,n,o){if(o.lengthSquared()>1.1)return 0;var r=Et,a=At,s=Mt;e.getVelocityAtWorldPoint(t,r),i.getVelocityAtWorldPoint(n,a),r.vsub(a,s);return-.2*o.dot(s)*(1/(e.invMass+i.invMass))}var Rt=function(e){(0,o.Z)(i,e);var t=u(i);function i(e){var n;if((0,s.Z)(this,i),(n=t.call(this,{type:z.types.SPHERE})).radius=void 0!==e?e:1,n.radius<0)throw new Error("The sphere radius cannot be negative.");return n.updateBoundingSphereRadius(),n}return(0,l.Z)(i,[{key:"calculateLocalInertia",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new c,i=2*e*this.radius*this.radius/5;return t.x=i,t.y=i,t.z=i,t}},{key:"volume",value:function(){return 4*Math.PI*Math.pow(this.radius,3)/3}},{key:"updateBoundingSphereRadius",value:function(){this.boundingSphereRadius=this.radius}},{key:"calculateWorldAABB",value:function(e,t,i,n){for(var o=this.radius,r=["x","y","z"],a=0;a<r.length;a++){var s=r[a];i[s]=e[s]-o,n[s]=e[s]+o}}}]),i}(z),Ft=(new c,new c,new c,new c,new c,new c,new c,new c,new c,function(e){(0,o.Z)(i,e);var t=u(i);function i(e,n,o,r){(0,s.Z)(this,i);var a=r,l=[],u=[],h=[],v=[],d=[],p=Math.cos,y=Math.sin;l.push(new c(-n*y(0),.5*-o,n*p(0))),v.push(0),l.push(new c(-e*y(0),.5*o,e*p(0))),d.push(1);for(var f=0;f<a;f++){var m=2*Math.PI/a*(f+1),g=2*Math.PI/a*(f+.5);f<a-1?(l.push(new c(-n*y(m),.5*-o,n*p(m))),v.push(2*f+2),l.push(new c(-e*y(m),.5*o,e*p(m))),d.push(2*f+3),h.push([2*f,2*f+1,2*f+3,2*f+2])):h.push([2*f,2*f+1,1,0]),(a%2===1||f<a/2)&&u.push(new c(-y(g),0,p(g)))}h.push(v),u.push(new c(0,1,0));for(var w=[],x=0;x<d.length;x++)w.push(d[d.length-x-1]);return h.push(w),t.call(this,{vertices:l,faces:h,axes:u})}return i}(E)),It=function(e){(0,o.Z)(i,e);var t=u(i);function i(){var e;return(0,s.Z)(this,i),(e=t.call(this,{type:z.types.PLANE})).worldNormal=new c,e.worldNormalNeedsUpdate=!0,e.boundingSphereRadius=Number.MAX_VALUE,e}return(0,l.Z)(i,[{key:"computeWorldNormal",value:function(e){var t=this.worldNormal;t.set(0,0,1),e.vmult(t,t),this.worldNormalNeedsUpdate=!1}},{key:"calculateLocalInertia",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new c;return t}},{key:"volume",value:function(){return Number.MAX_VALUE}},{key:"calculateWorldAABB",value:function(e,t,i,n){Pt.set(0,0,1),t.vmult(Pt,Pt);var o=Number.MAX_VALUE;i.set(-o,-o,-o),n.set(o,o,o),1===Pt.x?n.x=e.x:-1===Pt.x&&(i.x=e.x),1===Pt.y?n.y=e.y:-1===Pt.y&&(i.y=e.y),1===Pt.z?n.z=e.z:-1===Pt.z&&(i.z=e.z)}},{key:"updateBoundingSphereRadius",value:function(){this.boundingSphereRadius=Number.MAX_VALUE}}]),i}(z),Pt=new c,Tt=function(e){(0,o.Z)(i,e);var t=u(i);function i(e){var n,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,s.Z)(this,i),o=Pe.defaults(o,{maxValue:null,minValue:null,elementSize:1}),(n=t.call(this,{type:z.types.HEIGHTFIELD})).data=e,n.maxValue=o.maxValue,n.minValue=o.minValue,n.elementSize=o.elementSize,null===o.minValue&&n.updateMinValue(),null===o.maxValue&&n.updateMaxValue(),n.cacheEnabled=!0,n.pillarConvex=new E,n.pillarOffset=new c,n.updateBoundingSphereRadius(),n._cachedPillars={},n}return(0,l.Z)(i,[{key:"update",value:function(){this._cachedPillars={}}},{key:"updateMinValue",value:function(){for(var e=this.data,t=e[0][0],i=0;i!==e.length;i++)for(var n=0;n!==e[i].length;n++){var o=e[i][n];o<t&&(t=o)}this.minValue=t}},{key:"updateMaxValue",value:function(){for(var e=this.data,t=e[0][0],i=0;i!==e.length;i++)for(var n=0;n!==e[i].length;n++){var o=e[i][n];o>t&&(t=o)}this.maxValue=t}},{key:"setHeightValueAtIndex",value:function(e,t,i){this.data[e][t]=i,this.clearCachedConvexTrianglePillar(e,t,!1),e>0&&(this.clearCachedConvexTrianglePillar(e-1,t,!0),this.clearCachedConvexTrianglePillar(e-1,t,!1)),t>0&&(this.clearCachedConvexTrianglePillar(e,t-1,!0),this.clearCachedConvexTrianglePillar(e,t-1,!1)),t>0&&e>0&&this.clearCachedConvexTrianglePillar(e-1,t-1,!0)}},{key:"getRectMinMax",value:function(e,t,i,n){for(var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],r=this.data,a=this.minValue,s=e;s<=i;s++)for(var l=t;l<=n;l++){var u=r[s][l];u>a&&(a=u)}o[0]=this.minValue,o[1]=a}},{key:"getIndexOfPosition",value:function(e,t,i,n){var o=this.elementSize,r=this.data,a=Math.floor(e/o),s=Math.floor(t/o);return i[0]=a,i[1]=s,n&&(a<0&&(a=0),s<0&&(s=0),a>=r.length-1&&(a=r.length-1),s>=r[0].length-1&&(s=r[0].length-1)),!(a<0||s<0||a>=r.length-1||s>=r[0].length-1)}},{key:"getTriangleAt",value:function(e,t,i,n,o,r){var a=Nt;this.getIndexOfPosition(e,t,a,i);var s=a[0],l=a[1],u=this.data;i&&(s=Math.min(u.length-2,Math.max(0,s)),l=Math.min(u[0].length-2,Math.max(0,l)));var h=this.elementSize,c=Math.pow(e/h-s,2)+Math.pow(t/h-l,2)>Math.pow(e/h-(s+1),2)+Math.pow(t/h-(l+1),2);return this.getTriangle(s,l,c,n,o,r),c}},{key:"getNormalAt",value:function(e,t,i,n){var o=jt,r=Zt,a=Ot,s=_t,l=Ht;this.getTriangleAt(e,t,i,o,r,a),r.vsub(o,s),a.vsub(o,l),s.cross(l,n),n.normalize()}},{key:"getAabbAtIndex",value:function(e,t,i){var n=i.lowerBound,o=i.upperBound,r=this.data,a=this.elementSize;n.set(e*a,t*a,r[e][t]),o.set((e+1)*a,(t+1)*a,r[e+1][t+1])}},{key:"getHeightAt",value:function(e,t,i){var n=this.data,o=qt,r=Wt,a=Vt,s=Nt;this.getIndexOfPosition(e,t,s,i);var l=s[0],u=s[1];i&&(l=Math.min(n.length-2,Math.max(0,l)),u=Math.min(n[0].length-2,Math.max(0,u)));var h=this.getTriangleAt(e,t,i,o,r,a);!function(e,t,i,n,o,r,a,s,l){l.x=((r-s)*(e-a)+(a-o)*(t-s))/((r-s)*(i-a)+(a-o)*(n-s)),l.y=((s-n)*(e-a)+(i-a)*(t-s))/((r-s)*(i-a)+(a-o)*(n-s)),l.z=1-l.x-l.y}(e,t,o.x,o.y,r.x,r.y,a.x,a.y,Lt);var c=Lt;return h?n[l+1][u+1]*c.x+n[l][u+1]*c.y+n[l+1][u]*c.z:n[l][u]*c.x+n[l+1][u]*c.y+n[l][u+1]*c.z}},{key:"getCacheConvexTrianglePillarKey",value:function(e,t,i){return e+"_"+t+"_"+(i?1:0)}},{key:"getCachedConvexTrianglePillar",value:function(e,t,i){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]}},{key:"setCachedConvexTrianglePillar",value:function(e,t,i,n,o){this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]={convex:n,offset:o}}},{key:"clearCachedConvexTrianglePillar",value:function(e,t,i){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]}},{key:"getTriangle",value:function(e,t,i,n,o,r){var a=this.data,s=this.elementSize;i?(n.set((e+1)*s,(t+1)*s,a[e+1][t+1]),o.set(e*s,(t+1)*s,a[e][t+1]),r.set((e+1)*s,t*s,a[e+1][t])):(n.set(e*s,t*s,a[e][t]),o.set((e+1)*s,t*s,a[e+1][t]),r.set(e*s,(t+1)*s,a[e][t+1]))}},{key:"getConvexTrianglePillar",value:function(e,t,i){var n=this.pillarConvex,o=this.pillarOffset;if(this.cacheEnabled){var r=this.getCachedConvexTrianglePillar(e,t,i);if(r)return this.pillarConvex=r.convex,void(this.pillarOffset=r.offset);n=new E,o=new c,this.pillarConvex=n,this.pillarOffset=o}var a=this.data,s=this.elementSize,l=n.faces;n.vertices.length=6;for(var u=0;u<6;u++)n.vertices[u]||(n.vertices[u]=new c);l.length=5;for(var h=0;h<5;h++)l[h]||(l[h]=[]);var v=n.vertices,d=(Math.min(a[e][t],a[e+1][t],a[e][t+1],a[e+1][t+1])-this.minValue)/2+this.minValue;i?(o.set((e+.75)*s,(t+.75)*s,d),v[0].set(.25*s,.25*s,a[e+1][t+1]-d),v[1].set(-.75*s,.25*s,a[e][t+1]-d),v[2].set(.25*s,-.75*s,a[e+1][t]-d),v[3].set(.25*s,.25*s,-Math.abs(d)-1),v[4].set(-.75*s,.25*s,-Math.abs(d)-1),v[5].set(.25*s,-.75*s,-Math.abs(d)-1),l[0][0]=0,l[0][1]=1,l[0][2]=2,l[1][0]=5,l[1][1]=4,l[1][2]=3,l[2][0]=2,l[2][1]=5,l[2][2]=3,l[2][3]=0,l[3][0]=3,l[3][1]=4,l[3][2]=1,l[3][3]=0,l[4][0]=1,l[4][1]=4,l[4][2]=5,l[4][3]=2):(o.set((e+.25)*s,(t+.25)*s,d),v[0].set(-.25*s,-.25*s,a[e][t]-d),v[1].set(.75*s,-.25*s,a[e+1][t]-d),v[2].set(-.25*s,.75*s,a[e][t+1]-d),v[3].set(-.25*s,-.25*s,-Math.abs(d)-1),v[4].set(.75*s,-.25*s,-Math.abs(d)-1),v[5].set(-.25*s,.75*s,-Math.abs(d)-1),l[0][0]=0,l[0][1]=1,l[0][2]=2,l[1][0]=5,l[1][1]=4,l[1][2]=3,l[2][0]=0,l[2][1]=2,l[2][2]=5,l[2][3]=3,l[3][0]=1,l[3][1]=0,l[3][2]=3,l[3][3]=4,l[4][0]=4,l[4][1]=5,l[4][2]=2,l[4][3]=1),n.computeNormals(),n.computeEdges(),n.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(e,t,i,n,o)}},{key:"calculateLocalInertia",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new c;return t.set(0,0,0),t}},{key:"volume",value:function(){return Number.MAX_VALUE}},{key:"calculateWorldAABB",value:function(e,t,i,n){i.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),n.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)}},{key:"updateBoundingSphereRadius",value:function(){var e=this.data,t=this.elementSize;this.boundingSphereRadius=new c(e.length*t,e[0].length*t,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).length()}},{key:"setHeightsFromImage",value:function(e,t){var i=t.x,n=t.z,o=t.y,r=document.createElement("canvas");r.width=e.width,r.height=e.height;var a=r.getContext("2d");a.drawImage(e,0,0);var s=a.getImageData(0,0,e.width,e.height),l=this.data;l.length=0,this.elementSize=Math.abs(i)/s.width;for(var u=0;u<s.height;u++){for(var h=[],c=0;c<s.width;c++){var v=(s.data[4*(u*s.height+c)]+s.data[4*(u*s.height+c)+1]+s.data[4*(u*s.height+c)+2])/4/255*n;i<0?h.push(v):h.unshift(v)}o<0?l.unshift(h):l.push(h)}this.updateMaxValue(),this.updateMinValue(),this.update()}}]),i}(z),Nt=[],Lt=new c,qt=new c,Wt=new c,Vt=new c,jt=new c,Zt=new c,Ot=new c,_t=new c,Ht=new c;var Dt=function(e){(0,o.Z)(i,e);var t=u(i);function i(e){var n,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,s.Z)(this,i),(n=t.call(this,{root:null,aabb:e})).maxDepth="undefined"!==typeof o.maxDepth?o.maxDepth:8,n}return i}(function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,s.Z)(this,e),this.root=t.root||null,this.aabb=t.aabb?t.aabb.clone():new y,this.data=[],this.children=[]}return(0,l.Z)(e,[{key:"reset",value:function(){this.children.length=this.data.length=0}},{key:"insert",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=this.data;if(!this.aabb.contains(e))return!1;var o=this.children,r=this.maxDepth||this.root.maxDepth;if(i<r){var a=!1;o.length||(this.subdivide(),a=!0);for(var s=0;8!==s;s++)if(o[s].insert(e,t,i+1))return!0;a&&(o.length=0)}return n.push(t),!0}},{key:"subdivide",value:function(){var t=this.aabb,i=t.lowerBound,n=t.upperBound,o=this.children;o.push(new e({aabb:new y({lowerBound:new c(0,0,0)})}),new e({aabb:new y({lowerBound:new c(1,0,0)})}),new e({aabb:new y({lowerBound:new c(1,1,0)})}),new e({aabb:new y({lowerBound:new c(1,1,1)})}),new e({aabb:new y({lowerBound:new c(0,1,1)})}),new e({aabb:new y({lowerBound:new c(0,0,1)})}),new e({aabb:new y({lowerBound:new c(1,0,1)})}),new e({aabb:new y({lowerBound:new c(0,1,0)})})),n.vsub(i,Ut),Ut.scale(.5,Ut);for(var r=this.root||this,a=0;8!==a;a++){var s=o[a];s.root=r;var l=s.aabb.lowerBound;l.x*=Ut.x,l.y*=Ut.y,l.z*=Ut.z,l.vadd(i,l),l.vadd(Ut,s.aabb.upperBound)}}},{key:"aabbQuery",value:function(e,t){this.data,this.children;for(var i=[this];i.length;){var n=i.pop();n.aabb.overlaps(e)&&Array.prototype.push.apply(t,n.data),Array.prototype.push.apply(i,n.children)}return t}},{key:"rayQuery",value:function(e,t,i){return e.getAABB(Xt),Xt.toLocalFrame(t,Xt),this.aabbQuery(Xt,i),i}},{key:"removeEmptyNodes",value:function(){for(var e=this.children.length-1;e>=0;e--)this.children[e].removeEmptyNodes(),this.children[e].children.length||this.children[e].data.length||this.children.splice(e,1)}}]),e}()),Ut=new c,Xt=new y,Gt=function(e){(0,o.Z)(i,e);var t=u(i);function i(e,n){var o;return(0,s.Z)(this,i),(o=t.call(this,{type:z.types.TRIMESH})).vertices=new Float32Array(e),o.indices=new Int16Array(n),o.normals=new Float32Array(n.length),o.aabb=new y,o.edges=null,o.scale=new c(1,1,1),o.tree=new Dt,o.updateEdges(),o.updateNormals(),o.updateAABB(),o.updateBoundingSphereRadius(),o.updateTree(),o}return(0,l.Z)(i,[{key:"updateTree",value:function(){var e=this.tree;e.reset(),e.aabb.copy(this.aabb);var t=this.scale;e.aabb.lowerBound.x*=1/t.x,e.aabb.lowerBound.y*=1/t.y,e.aabb.lowerBound.z*=1/t.z,e.aabb.upperBound.x*=1/t.x,e.aabb.upperBound.y*=1/t.y,e.aabb.upperBound.z*=1/t.z;for(var i=new y,n=new c,o=new c,r=new c,a=[n,o,r],s=0;s<this.indices.length/3;s++){var l=3*s;this._getUnscaledVertex(this.indices[l],n),this._getUnscaledVertex(this.indices[l+1],o),this._getUnscaledVertex(this.indices[l+2],r),i.setFromPoints(a),e.insert(i,s)}e.removeEmptyNodes()}},{key:"getTrianglesInAABB",value:function(e,t){Kt.copy(e);var i=this.scale,n=i.x,o=i.y,r=i.z,a=Kt.lowerBound,s=Kt.upperBound;return a.x/=n,a.y/=o,a.z/=r,s.x/=n,s.y/=o,s.z/=r,this.tree.aabbQuery(Kt,t)}},{key:"setScale",value:function(e){var t=this.scale.x===this.scale.y&&this.scale.y===this.scale.z,i=e.x===e.y&&e.y===e.z;t&&i||this.updateNormals(),this.scale.copy(e),this.updateAABB(),this.updateBoundingSphereRadius()}},{key:"updateNormals",value:function(){for(var e=Yt,t=this.normals,n=0;n<this.indices.length/3;n++){var o=3*n,r=this.indices[o],a=this.indices[o+1],s=this.indices[o+2];this.getVertex(r,ti),this.getVertex(a,ii),this.getVertex(s,ni),i.computeNormal(ii,ti,ni,e),t[o]=e.x,t[o+1]=e.y,t[o+2]=e.z}}},{key:"updateEdges",value:function(){for(var e={},t=function(t,i){e[t<i?t+"_"+i:i+"_"+t]=!0},i=0;i<this.indices.length/3;i++){var n=3*i,o=this.indices[n],r=this.indices[n+1],a=this.indices[n+2];t(o,r),t(r,a),t(a,o)}var s=Object.keys(e);this.edges=new Int16Array(2*s.length);for(var l=0;l<s.length;l++){var u=s[l].split("_");this.edges[2*l]=parseInt(u[0],10),this.edges[2*l+1]=parseInt(u[1],10)}}},{key:"getEdgeVertex",value:function(e,t,i){var n=this.edges[2*e+(t?1:0)];this.getVertex(n,i)}},{key:"getEdgeVector",value:function(e,t){var i=Qt,n=Jt;this.getEdgeVertex(e,0,i),this.getEdgeVertex(e,1,n),n.vsub(i,t)}},{key:"getVertex",value:function(e,t){var i=this.scale;return this._getUnscaledVertex(e,t),t.x*=i.x,t.y*=i.y,t.z*=i.z,t}},{key:"_getUnscaledVertex",value:function(e,t){var i=3*e,n=this.vertices;return t.set(n[i],n[i+1],n[i+2])}},{key:"getWorldVertex",value:function(e,t,i,n){return this.getVertex(e,n),S.pointToWorldFrame(t,i,n,n),n}},{key:"getTriangleVertices",value:function(e,t,i,n){var o=3*e;this.getVertex(this.indices[o],t),this.getVertex(this.indices[o+1],i),this.getVertex(this.indices[o+2],n)}},{key:"getNormal",value:function(e,t){var i=3*e;return t.set(this.normals[i],this.normals[i+1],this.normals[i+2])}},{key:"calculateLocalInertia",value:function(e,t){this.computeLocalAABB(oi);var i=oi.upperBound.x-oi.lowerBound.x,n=oi.upperBound.y-oi.lowerBound.y,o=oi.upperBound.z-oi.lowerBound.z;return t.set(1/12*e*(2*n*2*n+2*o*2*o),1/12*e*(2*i*2*i+2*o*2*o),1/12*e*(2*n*2*n+2*i*2*i))}},{key:"computeLocalAABB",value:function(e){var t=e.lowerBound,i=e.upperBound,n=this.vertices.length,o=(this.vertices,ri);this.getVertex(0,o),t.copy(o),i.copy(o);for(var r=0;r!==n;r++)this.getVertex(r,o),o.x<t.x?t.x=o.x:o.x>i.x&&(i.x=o.x),o.y<t.y?t.y=o.y:o.y>i.y&&(i.y=o.y),o.z<t.z?t.z=o.z:o.z>i.z&&(i.z=o.z)}},{key:"updateAABB",value:function(){this.computeLocalAABB(this.aabb)}},{key:"updateBoundingSphereRadius",value:function(){for(var e=0,t=this.vertices,i=new c,n=0,o=t.length/3;n!==o;n++){this.getVertex(n,i);var r=i.lengthSquared();r>e&&(e=r)}this.boundingSphereRadius=Math.sqrt(e)}},{key:"calculateWorldAABB",value:function(e,t,i,n){var o=ai,r=si;o.position=e,o.quaternion=t,this.aabb.toWorldFrame(o,r),i.copy(r.lowerBound),n.copy(r.upperBound)}},{key:"volume",value:function(){return 4*Math.PI*this.boundingSphereRadius/3}}]),i}(z),Yt=new c,Kt=new y,Qt=new c,Jt=new c,$t=new c,ei=new c;Gt.computeNormal=function(e,t,i,n){t.vsub(e,ei),i.vsub(t,$t),$t.cross(ei,n),n.isZero()||n.normalize()};var ti=new c,ii=new c,ni=new c,oi=new y,ri=new c,ai=new S,si=new y;Gt.createTorus=function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:8,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:6,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:2*Math.PI,r=[],a=[],s=0;s<=i;s++)for(var l=0;l<=n;l++){var u=l/n*o,h=s/i*Math.PI*2,c=(e+t*Math.cos(h))*Math.cos(u),v=(e+t*Math.cos(h))*Math.sin(u),d=t*Math.sin(h);r.push(c,v,d)}for(var p=1;p<=i;p++)for(var y=1;y<=n;y++){var f=(n+1)*p+y-1,m=(n+1)*(p-1)+y-1,g=(n+1)*(p-1)+y,w=(n+1)*p+y;a.push(f,m,w),a.push(m,g,w)}return new Gt(r,a)};var li=function(){function e(){(0,s.Z)(this,e),this.equations=[]}return(0,l.Z)(e,[{key:"solve",value:function(e,t){return 0}},{key:"addEquation",value:function(e){e.enabled&&this.equations.push(e)}},{key:"removeEquation",value:function(e){var t=this.equations,i=t.indexOf(e);-1!==i&&t.splice(i,1)}},{key:"removeAllEquations",value:function(){this.equations.length=0}}]),e}(),ui=function(e){(0,o.Z)(i,e);var t=u(i);function i(){var e;return(0,s.Z)(this,i),(e=t.call(this)).iterations=10,e.tolerance=1e-7,e}return(0,l.Z)(i,[{key:"solve",value:function(e,t){var i,n,o,r,a,s=0,l=this.iterations,u=this.tolerance*this.tolerance,h=this.equations,c=h.length,v=t.bodies,d=v.length,p=e;if(0!==c)for(var y=0;y!==d;y++)v[y].updateSolveMassProperties();var f=ci,m=vi,g=hi;f.length=c,m.length=c,g.length=c;for(var w=0;w!==c;w++){var x=h[w];g[w]=0,m[w]=x.computeB(p),f[w]=1/x.computeC()}if(0!==c){for(var b=0;b!==d;b++){var k=v[b],z=k.vlambda,S=k.wlambda;z.set(0,0,0),S.set(0,0,0)}for(s=0;s!==l;s++){r=0;for(var B=0;B!==c;B++){var E=h[B];i=m[B],n=f[B],(a=g[B])+(o=n*(i-E.computeGWlambda()-E.eps*a))<E.minForce?o=E.minForce-a:a+o>E.maxForce&&(o=E.maxForce-a),g[B]+=o,r+=o>0?o:-o,E.addToWlambda(o)}if(r*r<u)break}for(var A=0;A!==d;A++){var M=v[A],C=M.velocity,R=M.angularVelocity;M.vlambda.vmul(M.linearFactor,M.vlambda),C.vadd(M.vlambda,C),M.wlambda.vmul(M.angularFactor,M.wlambda),R.vadd(M.wlambda,R)}for(var F=h.length,I=1/p;F--;)h[F].multiplier=g[F]*I}return s}}]),i}(li),hi=[],ci=[],vi=[];N.STATIC;var di=function(e){(0,o.Z)(i,e);var t=u(i);function i(){var e;return(0,s.Z)(this,i),(e=t.call(this)).type=c,e}return(0,l.Z)(i,[{key:"constructObject",value:function(){return new c}}]),i}(function(){function e(){(0,s.Z)(this,e),this.objects=[],this.type=Object}return(0,l.Z)(e,[{key:"release",value:function(){for(var e=arguments.length,t=0;t!==e;t++)this.objects.push(t<0||arguments.length<=t?void 0:arguments[t]);return this}},{key:"get",value:function(){return 0===this.objects.length?this.constructObject():this.objects.pop()}},{key:"constructObject",value:function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{key:"resize",value:function(e){for(var t=this.objects;t.length>e;)t.pop();for(;t.length<e;)t.push(this.constructObject());return this}}]),e}()),pi=z.types.SPHERE,yi=z.types.SPHERE|z.types.PLANE,fi=z.types.BOX|z.types.BOX,mi=z.types.SPHERE|z.types.BOX,gi=z.types.PLANE|z.types.BOX,wi=z.types.CONVEXPOLYHEDRON,xi=z.types.SPHERE|z.types.CONVEXPOLYHEDRON,bi=z.types.PLANE|z.types.CONVEXPOLYHEDRON,ki=z.types.BOX|z.types.CONVEXPOLYHEDRON,zi=z.types.SPHERE|z.types.HEIGHTFIELD,Si=z.types.BOX|z.types.HEIGHTFIELD,Bi=z.types.CONVEXPOLYHEDRON|z.types.HEIGHTFIELD,Ei=z.types.PARTICLE|z.types.SPHERE,Ai=z.types.PLANE|z.types.PARTICLE,Mi=z.types.BOX|z.types.PARTICLE,Ci=z.types.PARTICLE|z.types.CONVEXPOLYHEDRON,Ri=z.types.SPHERE|z.types.TRIMESH,Fi=z.types.PLANE|z.types.TRIMESH,Ii=function(){function e(t){(0,s.Z)(this,e),this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new di,this.world=t,this.currentContactMaterial=t.defaultContactMaterial,this.enableFrictionReduction=!1}return(0,l.Z)(e,[{key:"createContactEquation",value:function(e,t,i,n,o,r){var a;this.contactPointPool.length?((a=this.contactPointPool.pop()).bi=e,a.bj=t):a=new _e(e,t),a.enabled=e.collisionResponse&&t.collisionResponse&&i.collisionResponse&&n.collisionResponse;var s=this.currentContactMaterial;a.restitution=s.restitution,a.setSpookParams(s.contactEquationStiffness,s.contactEquationRelaxation,this.world.dt);var l=i.material||e.material,u=n.material||t.material;return l&&u&&l.restitution>=0&&u.restitution>=0&&(a.restitution=l.restitution*u.restitution),a.si=o||i,a.sj=r||n,a}},{key:"createFrictionEquationsFromContact",value:function(e,t){var i=e.bi,n=e.bj,o=e.si,r=e.sj,a=this.world,s=this.currentContactMaterial,l=s.friction,u=o.material||i.material,h=r.material||n.material;if(u&&h&&u.friction>=0&&h.friction>=0&&(l=u.friction*h.friction),l>0){var c=l*a.gravity.length(),v=i.invMass+n.invMass;v>0&&(v=1/v);var d=this.frictionEquationPool,p=d.length?d.pop():new Je(i,n,c*v),y=d.length?d.pop():new Je(i,n,c*v);return p.bi=y.bi=i,p.bj=y.bj=n,p.minForce=y.minForce=-c*v,p.maxForce=y.maxForce=c*v,p.ri.copy(e.ri),p.rj.copy(e.rj),y.ri.copy(e.ri),y.rj.copy(e.rj),e.ni.tangents(p.t,y.t),p.setSpookParams(s.frictionEquationStiffness,s.frictionEquationRelaxation,a.dt),y.setSpookParams(s.frictionEquationStiffness,s.frictionEquationRelaxation,a.dt),p.enabled=y.enabled=e.enabled,t.push(p,y),!0}return!1}},{key:"createFrictionFromAverage",value:function(e){var t=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(t,this.frictionResult)&&1!==e){var i=this.frictionResult[this.frictionResult.length-2],n=this.frictionResult[this.frictionResult.length-1];Pi.setZero(),Ti.setZero(),Ni.setZero();for(var o=t.bi,r=(t.bj,0);r!==e;r++)(t=this.result[this.result.length-1-r]).bi!==o?(Pi.vadd(t.ni,Pi),Ti.vadd(t.ri,Ti),Ni.vadd(t.rj,Ni)):(Pi.vsub(t.ni,Pi),Ti.vadd(t.rj,Ti),Ni.vadd(t.ri,Ni));var a=1/e;Ti.scale(a,i.ri),Ni.scale(a,i.rj),n.ri.copy(i.ri),n.rj.copy(i.rj),Pi.normalize(),Pi.tangents(i.t,n.t)}}},{key:"getContacts",value:function(e,t,i,n,o,r,a){this.contactPointPool=o,this.frictionEquationPool=a,this.result=n,this.frictionResult=r;for(var s=Wi,l=Vi,u=Li,h=qi,c=0,v=e.length;c!==v;c++){var d=e[c],p=t[c],y=null;d.material&&p.material&&(y=i.getContactMaterial(d.material,p.material)||null);for(var f=d.type&N.KINEMATIC&&p.type&N.STATIC||d.type&N.STATIC&&p.type&N.KINEMATIC||d.type&N.KINEMATIC&&p.type&N.KINEMATIC,m=0;m<d.shapes.length;m++){d.quaternion.mult(d.shapeOrientations[m],s),d.quaternion.vmult(d.shapeOffsets[m],u),u.vadd(d.position,u);for(var g=d.shapes[m],w=0;w<p.shapes.length;w++){p.quaternion.mult(p.shapeOrientations[w],l),p.quaternion.vmult(p.shapeOffsets[w],h),h.vadd(p.position,h);var x=p.shapes[w];if(g.collisionFilterMask&x.collisionFilterGroup&&x.collisionFilterMask&g.collisionFilterGroup&&!(u.distanceTo(h)>g.boundingSphereRadius+x.boundingSphereRadius)){var b=null;g.material&&x.material&&(b=i.getContactMaterial(g.material,x.material)||null),this.currentContactMaterial=b||y||i.defaultContactMaterial;var k=this[g.type|x.type];if(k){(g.type<x.type?k.call(this,g,x,u,h,s,l,d,p,g,x,f):k.call(this,x,g,h,u,l,s,p,d,g,x,f))&&f&&(i.shapeOverlapKeeper.set(g.id,x.id),i.bodyOverlapKeeper.set(d.id,p.id))}}}}}}},{key:"sphereSphere",value:function(e,t,i,n,o,r,a,s,l,u,h){if(h)return i.distanceSquared(n)<Math.pow(e.radius+t.radius,2);var c=this.createContactEquation(a,s,e,t,l,u);n.vsub(i,c.ni),c.ni.normalize(),c.ri.copy(c.ni),c.rj.copy(c.ni),c.ri.scale(e.radius,c.ri),c.rj.scale(-t.radius,c.rj),c.ri.vadd(i,c.ri),c.ri.vsub(a.position,c.ri),c.rj.vadd(n,c.rj),c.rj.vsub(s.position,c.rj),this.result.push(c),this.createFrictionEquationsFromContact(c,this.frictionResult)}},{key:"spherePlane",value:function(e,t,i,n,o,r,a,s,l,u,h){var c=this.createContactEquation(a,s,e,t,l,u);if(c.ni.set(0,0,1),r.vmult(c.ni,c.ni),c.ni.negate(c.ni),c.ni.normalize(),c.ni.scale(e.radius,c.ri),i.vsub(n,rn),c.ni.scale(c.ni.dot(rn),an),rn.vsub(an,c.rj),-rn.dot(c.ni)<=e.radius){if(h)return!0;var v=c.ri,d=c.rj;v.vadd(i,v),v.vsub(a.position,v),d.vadd(n,d),d.vsub(s.position,d),this.result.push(c),this.createFrictionEquationsFromContact(c,this.frictionResult)}}},{key:"boxBox",value:function(e,t,i,n,o,r,a,s,l,u,h){return e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t.convexPolyhedronRepresentation,i,n,o,r,a,s,e,t,h)}},{key:"sphereBox",value:function(e,t,i,n,o,r,a,s,l,u,h){var c=this.v3pool,v=yn;i.vsub(n,cn),t.getSideNormals(v,r);for(var d=e.radius,p=!1,y=mn,f=gn,m=wn,g=null,w=0,x=0,b=0,k=null,z=0,S=v.length;z!==S&&!1===p;z++){var B=vn;B.copy(v[z]);var E=B.length();B.normalize();var A=cn.dot(B);if(A<E+d&&A>0){var M=dn,C=pn;M.copy(v[(z+1)%3]),C.copy(v[(z+2)%3]);var R=M.length(),F=C.length();M.normalize(),C.normalize();var I=cn.dot(M),P=cn.dot(C);if(I<R&&I>-R&&P<F&&P>-F){var T=Math.abs(A-E-d);if((null===k||T<k)&&(k=T,x=I,b=P,g=E,y.copy(B),f.copy(M),m.copy(C),w++,h))return!0}}}if(w){p=!0;var N=this.createContactEquation(a,s,e,t,l,u);y.scale(-d,N.ri),N.ni.copy(y),N.ni.negate(N.ni),y.scale(g,y),f.scale(x,f),y.vadd(f,y),m.scale(b,m),y.vadd(m,N.rj),N.ri.vadd(i,N.ri),N.ri.vsub(a.position,N.ri),N.rj.vadd(n,N.rj),N.rj.vsub(s.position,N.rj),this.result.push(N),this.createFrictionEquationsFromContact(N,this.frictionResult)}for(var L=c.get(),q=fn,W=0;2!==W&&!p;W++)for(var V=0;2!==V&&!p;V++)for(var j=0;2!==j&&!p;j++)if(L.set(0,0,0),W?L.vadd(v[0],L):L.vsub(v[0],L),V?L.vadd(v[1],L):L.vsub(v[1],L),j?L.vadd(v[2],L):L.vsub(v[2],L),n.vadd(L,q),q.vsub(i,q),q.lengthSquared()<d*d){if(h)return!0;p=!0;var Z=this.createContactEquation(a,s,e,t,l,u);Z.ri.copy(q),Z.ri.normalize(),Z.ni.copy(Z.ri),Z.ri.scale(d,Z.ri),Z.rj.copy(L),Z.ri.vadd(i,Z.ri),Z.ri.vsub(a.position,Z.ri),Z.rj.vadd(n,Z.rj),Z.rj.vsub(s.position,Z.rj),this.result.push(Z),this.createFrictionEquationsFromContact(Z,this.frictionResult)}c.release(L),L=null;for(var O=c.get(),_=c.get(),H=c.get(),D=c.get(),U=c.get(),X=v.length,G=0;G!==X&&!p;G++)for(var Y=0;Y!==X&&!p;Y++)if(G%3!==Y%3){v[Y].cross(v[G],O),O.normalize(),v[G].vadd(v[Y],_),H.copy(i),H.vsub(_,H),H.vsub(n,H);var K=H.dot(O);O.scale(K,D);for(var Q=0;Q===G%3||Q===Y%3;)Q++;U.copy(i),U.vsub(D,U),U.vsub(_,U),U.vsub(n,U);var J=Math.abs(K),$=U.length();if(J<v[Q].length()&&$<d){if(h)return!0;p=!0;var ee=this.createContactEquation(a,s,e,t,l,u);_.vadd(D,ee.rj),ee.rj.copy(ee.rj),U.negate(ee.ni),ee.ni.normalize(),ee.ri.copy(ee.rj),ee.ri.vadd(n,ee.ri),ee.ri.vsub(i,ee.ri),ee.ri.normalize(),ee.ri.scale(d,ee.ri),ee.ri.vadd(i,ee.ri),ee.ri.vsub(a.position,ee.ri),ee.rj.vadd(n,ee.rj),ee.rj.vsub(s.position,ee.rj),this.result.push(ee),this.createFrictionEquationsFromContact(ee,this.frictionResult)}}c.release(O,_,H,D,U)}},{key:"planeBox",value:function(e,t,i,n,o,r,a,s,l,u,h){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,t.convexPolyhedronRepresentation.id=t.id,this.planeConvex(e,t.convexPolyhedronRepresentation,i,n,o,r,a,s,e,t,h)}},{key:"convexConvex",value:function(e,t,i,n,o,r,a,s,l,u,h,c,v){var d=Tn;if(!(i.distanceTo(n)>e.boundingSphereRadius+t.boundingSphereRadius)&&e.findSeparatingAxis(t,i,o,n,r,d,c,v)){var p=[],y=Nn;e.clipAgainstHull(i,o,t,n,r,d,-100,100,p);for(var f=0,m=0;m!==p.length;m++){if(h)return!0;var g=this.createContactEquation(a,s,e,t,l,u),w=g.ri,x=g.rj;d.negate(g.ni),p[m].normal.negate(y),y.scale(p[m].depth,y),p[m].point.vadd(y,w),x.copy(p[m].point),w.vsub(i,w),x.vsub(n,x),w.vadd(i,w),w.vsub(a.position,w),x.vadd(n,x),x.vsub(s.position,x),this.result.push(g),f++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(g,this.frictionResult)}this.enableFrictionReduction&&f&&this.createFrictionFromAverage(f)}}},{key:"sphereConvex",value:function(e,t,i,n,o,r,a,s,l,u,h){var c=this.v3pool;i.vsub(n,xn);for(var v=t.faceNormals,d=t.faces,p=t.vertices,y=e.radius,f=!1,m=0;m!==p.length;m++){var g=p[m],w=Sn;r.vmult(g,w),n.vadd(w,w);var x=zn;if(w.vsub(i,x),x.lengthSquared()<y*y){if(h)return!0;f=!0;var b=this.createContactEquation(a,s,e,t,l,u);return b.ri.copy(x),b.ri.normalize(),b.ni.copy(b.ri),b.ri.scale(y,b.ri),w.vsub(n,b.rj),b.ri.vadd(i,b.ri),b.ri.vsub(a.position,b.ri),b.rj.vadd(n,b.rj),b.rj.vsub(s.position,b.rj),this.result.push(b),void this.createFrictionEquationsFromContact(b,this.frictionResult)}}for(var k=0,z=d.length;k!==z&&!1===f;k++){var S=v[k],B=d[k],E=Bn;r.vmult(S,E);var A=En;r.vmult(p[B[0]],A),A.vadd(n,A);var M=An;E.scale(-y,M),i.vadd(M,M);var C=Mn;M.vsub(A,C);var R=C.dot(E),F=Cn;if(i.vsub(A,F),R<0&&F.dot(E)>0){for(var I=[],P=0,T=B.length;P!==T;P++){var N=c.get();r.vmult(p[B[P]],N),n.vadd(N,N),I.push(N)}if(hn(I,E,i)){if(h)return!0;f=!0;var L=this.createContactEquation(a,s,e,t,l,u);E.scale(-y,L.ri),E.negate(L.ni);var q=c.get();E.scale(-R,q);var W=c.get();E.scale(-y,W),i.vsub(n,L.rj),L.rj.vadd(W,L.rj),L.rj.vadd(q,L.rj),L.rj.vadd(n,L.rj),L.rj.vsub(s.position,L.rj),L.ri.vadd(i,L.ri),L.ri.vsub(a.position,L.ri),c.release(q),c.release(W),this.result.push(L),this.createFrictionEquationsFromContact(L,this.frictionResult);for(var V=0,j=I.length;V!==j;V++)c.release(I[V]);return}for(var Z=0;Z!==B.length;Z++){var O=c.get(),_=c.get();r.vmult(p[B[(Z+1)%B.length]],O),r.vmult(p[B[(Z+2)%B.length]],_),n.vadd(O,O),n.vadd(_,_);var H=bn;_.vsub(O,H);var D=kn;H.unit(D);var U=c.get(),X=c.get();i.vsub(O,X);var G=X.dot(D);D.scale(G,U),U.vadd(O,U);var Y=c.get();if(U.vsub(i,Y),G>0&&G*G<H.lengthSquared()&&Y.lengthSquared()<y*y){if(h)return!0;var K=this.createContactEquation(a,s,e,t,l,u);U.vsub(n,K.rj),U.vsub(i,K.ni),K.ni.normalize(),K.ni.scale(y,K.ri),K.rj.vadd(n,K.rj),K.rj.vsub(s.position,K.rj),K.ri.vadd(i,K.ri),K.ri.vsub(a.position,K.ri),this.result.push(K),this.createFrictionEquationsFromContact(K,this.frictionResult);for(var Q=0,J=I.length;Q!==J;Q++)c.release(I[Q]);return c.release(O),c.release(_),c.release(U),c.release(Y),void c.release(X)}c.release(O),c.release(_),c.release(U),c.release(Y),c.release(X)}for(var $=0,ee=I.length;$!==ee;$++)c.release(I[$])}}}},{key:"planeConvex",value:function(e,t,i,n,o,r,a,s,l,u,h){var c=Rn,v=Fn;v.set(0,0,1),o.vmult(v,v);for(var d=0,p=In,y=0;y!==t.vertices.length;y++){if(c.copy(t.vertices[y]),r.vmult(c,c),n.vadd(c,c),c.vsub(i,p),v.dot(p)<=0){if(h)return!0;var f=this.createContactEquation(a,s,e,t,l,u),m=Pn;v.scale(v.dot(p),m),c.vsub(m,m),m.vsub(i,f.ri),f.ni.copy(v),c.vsub(n,f.rj),f.ri.vadd(i,f.ri),f.ri.vsub(a.position,f.ri),f.rj.vadd(n,f.rj),f.rj.vsub(s.position,f.rj),this.result.push(f),d++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(f,this.frictionResult)}}this.enableFrictionReduction&&d&&this.createFrictionFromAverage(d)}},{key:"boxConvex",value:function(e,t,i,n,o,r,a,s,l,u,h){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t,i,n,o,r,a,s,e,t,h)}},{key:"sphereHeightfield",value:function(e,t,i,n,o,r,a,s,l,u,h){var c=t.data,v=e.radius,d=t.elementSize,p=Yn,y=Gn;S.pointToLocalFrame(n,r,i,y);var f=Math.floor((y.x-v)/d)-1,m=Math.ceil((y.x+v)/d)+1,g=Math.floor((y.y-v)/d)-1,w=Math.ceil((y.y+v)/d)+1;if(!(m<0||w<0||f>c.length||g>c[0].length)){f<0&&(f=0),m<0&&(m=0),g<0&&(g=0),w<0&&(w=0),f>=c.length&&(f=c.length-1),m>=c.length&&(m=c.length-1),w>=c[0].length&&(w=c[0].length-1),g>=c[0].length&&(g=c[0].length-1);var x=[];t.getRectMinMax(f,g,m,w,x);var b=x[0],k=x[1];if(!(y.z-v>k||y.z+v<b))for(var z=this.result,B=f;B<m;B++)for(var E=g;E<w;E++){var A=z.length,M=!1;if(t.getConvexTrianglePillar(B,E,!1),S.pointToWorldFrame(n,r,t.pillarOffset,p),i.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(M=this.sphereConvex(e,t.pillarConvex,i,p,o,r,a,s,e,t,h)),h&&M)return!0;if(t.getConvexTrianglePillar(B,E,!0),S.pointToWorldFrame(n,r,t.pillarOffset,p),i.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(M=this.sphereConvex(e,t.pillarConvex,i,p,o,r,a,s,e,t,h)),h&&M)return!0;if(z.length-A>2)return}}}},{key:"boxHeightfield",value:function(e,t,i,n,o,r,a,s,l,u,h){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexHeightfield(e.convexPolyhedronRepresentation,t,i,n,o,r,a,s,e,t,h)}},{key:"convexHeightfield",value:function(e,t,i,n,o,r,a,s,l,u,h){var c=t.data,v=t.elementSize,d=e.boundingSphereRadius,p=Un,y=Xn,f=Dn;S.pointToLocalFrame(n,r,i,f);var m=Math.floor((f.x-d)/v)-1,g=Math.ceil((f.x+d)/v)+1,w=Math.floor((f.y-d)/v)-1,x=Math.ceil((f.y+d)/v)+1;if(!(g<0||x<0||m>c.length||w>c[0].length)){m<0&&(m=0),g<0&&(g=0),w<0&&(w=0),x<0&&(x=0),m>=c.length&&(m=c.length-1),g>=c.length&&(g=c.length-1),x>=c[0].length&&(x=c[0].length-1),w>=c[0].length&&(w=c[0].length-1);var b=[];t.getRectMinMax(m,w,g,x,b);var k=b[0],z=b[1];if(!(f.z-d>z||f.z+d<k))for(var B=m;B<g;B++)for(var E=w;E<x;E++){var A=!1;if(t.getConvexTrianglePillar(B,E,!1),S.pointToWorldFrame(n,r,t.pillarOffset,p),i.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(A=this.convexConvex(e,t.pillarConvex,i,p,o,r,a,s,null,null,h,y,null)),h&&A)return!0;if(t.getConvexTrianglePillar(B,E,!0),S.pointToWorldFrame(n,r,t.pillarOffset,p),i.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(A=this.convexConvex(e,t.pillarConvex,i,p,o,r,a,s,null,null,h,y,null)),h&&A)return!0}}}},{key:"sphereParticle",value:function(e,t,i,n,o,r,a,s,l,u,h){var c=Vn;if(c.set(0,0,1),n.vsub(i,c),c.lengthSquared()<=e.radius*e.radius){if(h)return!0;var v=this.createContactEquation(s,a,t,e,l,u);c.normalize(),v.rj.copy(c),v.rj.scale(e.radius,v.rj),v.ni.copy(c),v.ni.negate(v.ni),v.ri.set(0,0,0),this.result.push(v),this.createFrictionEquationsFromContact(v,this.frictionResult)}}},{key:"planeParticle",value:function(e,t,i,n,o,r,a,s,l,u,h){var c=Ln;c.set(0,0,1),a.quaternion.vmult(c,c);var v=qn;if(n.vsub(a.position,v),c.dot(v)<=0){if(h)return!0;var d=this.createContactEquation(s,a,t,e,l,u);d.ni.copy(c),d.ni.negate(d.ni),d.ri.set(0,0,0);var p=Wn;c.scale(c.dot(n),p),n.vsub(p,p),d.rj.copy(p),this.result.push(d),this.createFrictionEquationsFromContact(d,this.frictionResult)}}},{key:"boxParticle",value:function(e,t,i,n,o,r,a,s,l,u,h){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexParticle(e.convexPolyhedronRepresentation,t,i,n,o,r,a,s,e,t,h)}},{key:"convexParticle",value:function(e,t,i,n,o,r,a,s,l,u,h){var c=-1,v=On,d=Hn,p=null,y=Zn;if(y.copy(n),y.vsub(i,y),o.conjugate(jn),jn.vmult(y,y),e.pointIsInside(y)){e.worldVerticesNeedsUpdate&&e.computeWorldVertices(i,o),e.worldFaceNormalsNeedsUpdate&&e.computeWorldFaceNormals(o);for(var f=0,m=e.faces.length;f!==m;f++){var g=[e.worldVertices[e.faces[f][0]]],w=e.worldFaceNormals[f];n.vsub(g[0],_n);var x=-w.dot(_n);if(null===p||Math.abs(x)<Math.abs(p)){if(h)return!0;p=x,c=f,v.copy(w)}}if(-1!==c){var b=this.createContactEquation(s,a,t,e,l,u);v.scale(p,d),d.vadd(n,d),d.vsub(i,d),b.rj.copy(d),v.negate(b.ni),b.ri.set(0,0,0);var k=b.ri,z=b.rj;k.vadd(n,k),k.vsub(s.position,k),z.vadd(i,z),z.vsub(a.position,z),this.result.push(b),this.createFrictionEquationsFromContact(b,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}}},{key:"sphereTrimesh",value:function(e,t,i,n,o,r,a,s,l,u,h){var c=Xi,v=Gi,d=Yi,p=Ki,y=Qi,f=Ji,m=nn,g=Ui,w=Hi,x=on;S.pointToLocalFrame(n,r,i,y);var b=e.radius;m.lowerBound.set(y.x-b,y.y-b,y.z-b),m.upperBound.set(y.x+b,y.y+b,y.z+b),t.getTrianglesInAABB(m,x);for(var k=Di,z=e.radius*e.radius,B=0;B<x.length;B++)for(var E=0;E<3;E++)if(t.getVertex(t.indices[3*x[B]+E],k),k.vsub(y,w),w.lengthSquared()<=z){if(g.copy(k),S.pointToWorldFrame(n,r,g,k),k.vsub(i,w),h)return!0;var A=this.createContactEquation(a,s,e,t,l,u);A.ni.copy(w),A.ni.normalize(),A.ri.copy(A.ni),A.ri.scale(e.radius,A.ri),A.ri.vadd(i,A.ri),A.ri.vsub(a.position,A.ri),A.rj.copy(k),A.rj.vsub(s.position,A.rj),this.result.push(A),this.createFrictionEquationsFromContact(A,this.frictionResult)}for(var M=0;M<x.length;M++)for(var C=0;C<3;C++){t.getVertex(t.indices[3*x[M]+C],c),t.getVertex(t.indices[3*x[M]+(C+1)%3],v),v.vsub(c,d),y.vsub(v,f);var R=f.dot(d);y.vsub(c,f);var F=f.dot(d);if(F>0&&R<0)if(y.vsub(c,f),p.copy(d),p.normalize(),F=f.dot(p),p.scale(F,f),f.vadd(c,f),f.distanceTo(y)<e.radius){if(h)return!0;var I=this.createContactEquation(a,s,e,t,l,u);f.vsub(y,I.ni),I.ni.normalize(),I.ni.scale(e.radius,I.ri),I.ri.vadd(i,I.ri),I.ri.vsub(a.position,I.ri),S.pointToWorldFrame(n,r,f,f),f.vsub(s.position,I.rj),S.vectorToWorldFrame(r,I.ni,I.ni),S.vectorToWorldFrame(r,I.ri,I.ri),this.result.push(I),this.createFrictionEquationsFromContact(I,this.frictionResult)}}for(var P=$i,T=en,N=tn,L=_i,q=0,W=x.length;q!==W;q++){t.getTriangleVertices(x[q],P,T,N),t.getNormal(x[q],L),y.vsub(P,f);var V=f.dot(L);if(L.scale(V,f),y.vsub(f,f),V=f.distanceTo(y),ie.pointInTriangle(f,P,T,N)&&V<e.radius){if(h)return!0;var j=this.createContactEquation(a,s,e,t,l,u);f.vsub(y,j.ni),j.ni.normalize(),j.ni.scale(e.radius,j.ri),j.ri.vadd(i,j.ri),j.ri.vsub(a.position,j.ri),S.pointToWorldFrame(n,r,f,f),f.vsub(s.position,j.rj),S.vectorToWorldFrame(r,j.ni,j.ni),S.vectorToWorldFrame(r,j.ri,j.ri),this.result.push(j),this.createFrictionEquationsFromContact(j,this.frictionResult)}}x.length=0}},{key:"planeTrimesh",value:function(e,t,i,n,o,r,a,s,l,u,h){var v=new c,d=ji;d.set(0,0,1),o.vmult(d,d);for(var p=0;p<t.vertices.length/3;p++){t.getVertex(p,v);var y=new c;y.copy(v),S.pointToWorldFrame(n,r,y,v);var f=Zi;if(v.vsub(i,f),d.dot(f)<=0){if(h)return!0;var m=this.createContactEquation(a,s,e,t,l,u);m.ni.copy(d);var g=Oi;d.scale(f.dot(d),g),v.vsub(g,g),m.ri.copy(g),m.ri.vsub(a.position,m.ri),m.rj.copy(v),m.rj.vsub(s.position,m.rj),this.result.push(m),this.createFrictionEquationsFromContact(m,this.frictionResult)}}}}]),e}(),Pi=new c,Ti=new c,Ni=new c,Li=new c,qi=new c,Wi=new x,Vi=new x;Ii.prototype[fi]=Ii.prototype.boxBox,Ii.prototype[ki]=Ii.prototype.boxConvex,Ii.prototype[Mi]=Ii.prototype.boxParticle,Ii.prototype[pi]=Ii.prototype.sphereSphere;var ji=new c,Zi=new c,Oi=new c;Ii.prototype[Fi]=Ii.prototype.planeTrimesh;var _i=new c,Hi=new c,Di=new c,Ui=new c,Xi=new c,Gi=new c,Yi=new c,Ki=new c,Qi=new c,Ji=new c,$i=new c,en=new c,tn=new c,nn=new y,on=[];Ii.prototype[Ri]=Ii.prototype.sphereTrimesh;var rn=new c,an=new c;Ii.prototype[yi]=Ii.prototype.spherePlane;var sn=new c,ln=new c,un=new c;function hn(e,t,i){for(var n=null,o=e.length,r=0;r!==o;r++){var a=e[r],s=sn;e[(r+1)%o].vsub(a,s);var l=ln;s.cross(t,l);var u=un;i.vsub(a,u);var h=l.dot(u);if(!(null===n||h>0&&!0===n||h<=0&&!1===n))return!1;null===n&&(n=h>0)}return!0}var cn=new c,vn=new c,dn=new c,pn=new c,yn=[new c,new c,new c,new c,new c,new c],fn=new c,mn=new c,gn=new c,wn=new c;Ii.prototype[mi]=Ii.prototype.sphereBox;var xn=new c,bn=new c,kn=new c,zn=new c,Sn=new c,Bn=new c,En=new c,An=new c,Mn=new c,Cn=new c;Ii.prototype[xi]=Ii.prototype.sphereConvex,Ii.prototype[gi]=Ii.prototype.planeBox;var Rn=new c,Fn=new c,In=new c,Pn=new c;Ii.prototype[bi]=Ii.prototype.planeConvex;var Tn=new c,Nn=new c;Ii.prototype[wi]=Ii.prototype.convexConvex;var Ln=new c,qn=new c,Wn=new c;Ii.prototype[Ai]=Ii.prototype.planeParticle;var Vn=new c;Ii.prototype[Ei]=Ii.prototype.sphereParticle;var jn=new x,Zn=new c,On=new c,_n=new c,Hn=new c;Ii.prototype[Ci]=Ii.prototype.convexParticle,Ii.prototype[Si]=Ii.prototype.boxHeightfield;var Dn=new c,Un=new c,Xn=[0];Ii.prototype[Bi]=Ii.prototype.convexHeightfield;var Gn=new c,Yn=new c;Ii.prototype[zi]=Ii.prototype.sphereHeightfield;var Kn=function(){function e(){(0,s.Z)(this,e),this.current=[],this.previous=[]}return(0,l.Z)(e,[{key:"getKey",value:function(e,t){if(t<e){var i=t;t=e,e=i}return e<<16|t}},{key:"set",value:function(e,t){for(var i=this.getKey(e,t),n=this.current,o=0;i>n[o];)o++;if(i!==n[o]){for(var r=n.length-1;r>=o;r--)n[r+1]=n[r];n[o]=i}}},{key:"tick",value:function(){var e=this.current;this.current=this.previous,this.previous=e,this.current.length=0}},{key:"getDiff",value:function(e,t){for(var i=this.current,n=this.previous,o=i.length,r=n.length,a=0,s=0;s<o;s++){for(var l=i[s];l>n[a];)a++;l===n[a]||Qn(e,l)}a=0;for(var u=0;u<r;u++){for(var h=n[u];h>i[a];)a++;i[a]===h||Qn(t,h)}}}]),e}();function Qn(e,t){e.push((4294901760&t)>>16,65535&t)}var Jn=function(){function e(){(0,s.Z)(this,e),this.data={keys:[]}}return(0,l.Z)(e,[{key:"get",value:function(e,t){if(e>t){var i=t;t=e,e=i}return this.data[e+"-"+t]}},{key:"set",value:function(e,t,i){if(e>t){var n=t;t=e,e=n}var o=e+"-"+t;this.get(e,t)||this.data.keys.push(o),this.data[o]=i}},{key:"reset",value:function(){for(var e=this.data,t=e.keys;t.length>0;){delete e[t.pop()]}}}]),e}(),$n=function(e){(0,o.Z)(i,e);var t=u(i);function i(){var e,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,s.Z)(this,i),(e=t.call(this)).dt=-1,e.allowSleep=!!o.allowSleep,e.contacts=[],e.frictionEquations=[],e.quatNormalizeSkip=void 0!==o.quatNormalizeSkip?o.quatNormalizeSkip:0,e.quatNormalizeFast=void 0!==o.quatNormalizeFast&&o.quatNormalizeFast,e.time=0,e.stepnumber=0,e.default_dt=1/60,e.nextId=0,e.gravity=new c,o.gravity&&e.gravity.copy(o.gravity),e.broadphase=void 0!==o.broadphase?o.broadphase:new ee,e.bodies=[],e.hasActiveBodies=!1,e.solver=void 0!==o.solver?o.solver:new ui,e.constraints=[],e.narrowphase=new Ii((0,n.Z)(e)),e.collisionMatrix=new g,e.collisionMatrixPrevious=new g,e.bodyOverlapKeeper=new Kn,e.shapeOverlapKeeper=new Kn,e.materials=[],e.contactmaterials=[],e.contactMaterialTable=new Jn,e.defaultMaterial=new it("default"),e.defaultContactMaterial=new tt(e.defaultMaterial,e.defaultMaterial,{friction:.3,restitution:0}),e.doProfiling=!1,e.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},e.accumulator=0,e.subsystems=[],e.addBodyEvent={type:"addBody",body:null},e.removeBodyEvent={type:"removeBody",body:null},e.idToBodyMap={},e.broadphase.setWorld((0,n.Z)(e)),e}return(0,l.Z)(i,[{key:"getContactMaterial",value:function(e,t){return this.contactMaterialTable.get(e.id,t.id)}},{key:"numObjects",value:function(){return this.bodies.length}},{key:"collisionMatrixTick",value:function(){var e=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=e,this.collisionMatrix.reset(),this.bodyOverlapKeeper.tick(),this.shapeOverlapKeeper.tick()}},{key:"addConstraint",value:function(e){this.constraints.push(e)}},{key:"removeConstraint",value:function(e){var t=this.constraints.indexOf(e);-1!==t&&this.constraints.splice(t,1)}},{key:"rayTest",value:function(e,t,i){i instanceof te?this.raycastClosest(e,t,{skipBackfaces:!0},i):this.raycastAll(e,t,{skipBackfaces:!0},i)}},{key:"raycastAll",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3?arguments[3]:void 0;return i.mode=ie.ALL,i.from=e,i.to=t,i.callback=n,eo.intersectWorld(this,i)}},{key:"raycastAny",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3?arguments[3]:void 0;return i.mode=ie.ANY,i.from=e,i.to=t,i.result=n,eo.intersectWorld(this,i)}},{key:"raycastClosest",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3?arguments[3]:void 0;return i.mode=ie.CLOSEST,i.from=e,i.to=t,i.result=n,eo.intersectWorld(this,i)}},{key:"addBody",value:function(e){this.bodies.includes(e)||(e.index=this.bodies.length,this.bodies.push(e),e.world=this,e.initPosition.copy(e.position),e.initVelocity.copy(e.velocity),e.timeLastSleepy=this.time,e instanceof N&&(e.initAngularVelocity.copy(e.angularVelocity),e.initQuaternion.copy(e.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=e,this.idToBodyMap[e.id]=e,this.dispatchEvent(this.addBodyEvent))}},{key:"removeBody",value:function(e){e.world=null;var t=this.bodies.length-1,i=this.bodies,n=i.indexOf(e);if(-1!==n){i.splice(n,1);for(var o=0;o!==i.length;o++)i[o].index=o;this.collisionMatrix.setNumObjects(t),this.removeBodyEvent.body=e,delete this.idToBodyMap[e.id],this.dispatchEvent(this.removeBodyEvent)}}},{key:"getBodyById",value:function(e){return this.idToBodyMap[e]}},{key:"getShapeById",value:function(e){for(var t=this.bodies,i=0,n=t.length;i<n;i++)for(var o=t[i].shapes,r=0,a=o.length;r<a;r++){var s=o[r];if(s.id===e)return s}}},{key:"addMaterial",value:function(e){this.materials.push(e)}},{key:"addContactMaterial",value:function(e){this.contactmaterials.push(e),this.contactMaterialTable.set(e.materials[0].id,e.materials[1].id,e)}},{key:"step",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;if(void 0===t)this.internalStep(e),this.time+=e;else{this.accumulator+=t;for(var n=to.now(),o=0;this.accumulator>=e&&o<i&&(this.internalStep(e),this.accumulator-=e,o++,!(to.now()-n>2*e*1e3)););this.accumulator=this.accumulator%e;for(var r=this.accumulator/e,a=0;a!==this.bodies.length;a++){var s=this.bodies[a];s.previousPosition.lerp(s.position,r,s.interpolatedPosition),s.previousQuaternion.slerp(s.quaternion,r,s.interpolatedQuaternion),s.previousQuaternion.normalize()}this.time+=t}}},{key:"internalStep",value:function(e){this.dt=e;var t=this.contacts,i=lo,n=uo,o=this.numObjects(),r=this.bodies,a=this.solver,s=this.gravity,l=this.doProfiling,u=this.profile,h=N.DYNAMIC,c=-1/0,v=this.constraints,d=so,p=(s.length(),s.x),y=s.y,f=s.z,m=0;for(l&&(c=to.now()),m=0;m!==o;m++){var g=r[m];if(g.type===h){var w=g.force,x=g.mass;w.x+=x*p,w.y+=x*y,w.z+=x*f}}for(var b=0,k=this.subsystems.length;b!==k;b++)this.subsystems[b].update();l&&(c=to.now()),i.length=0,n.length=0,this.broadphase.collisionPairs(this,i,n),l&&(u.broadphase=to.now()-c);var z=v.length;for(m=0;m!==z;m++){var S=v[m];if(!S.collideConnected)for(var B=i.length-1;B>=0;B-=1)(S.bodyA===i[B]&&S.bodyB===n[B]||S.bodyB===i[B]&&S.bodyA===n[B])&&(i.splice(B,1),n.splice(B,1))}this.collisionMatrixTick(),l&&(c=to.now());var E=ao,A=t.length;for(m=0;m!==A;m++)E.push(t[m]);t.length=0;var M=this.frictionEquations.length;for(m=0;m!==M;m++)d.push(this.frictionEquations[m]);for(this.frictionEquations.length=0,this.narrowphase.getContacts(i,n,this,t,E,this.frictionEquations,d),l&&(u.narrowphase=to.now()-c),l&&(c=to.now()),m=0;m<this.frictionEquations.length;m++)a.addEquation(this.frictionEquations[m]);for(var C=t.length,R=0;R!==C;R++){var F=t[R],I=F.bi,P=F.bj,T=F.si,L=F.sj;(I.material&&P.material&&this.getContactMaterial(I.material,P.material)||this.defaultContactMaterial).friction;if(I.material&&P.material&&(I.material.friction>=0&&P.material.friction>=0&&I.material.friction*P.material.friction,I.material.restitution>=0&&P.material.restitution>=0&&(F.restitution=I.material.restitution*P.material.restitution)),a.addEquation(F),I.allowSleep&&I.type===N.DYNAMIC&&I.sleepState===N.SLEEPING&&P.sleepState===N.AWAKE&&P.type!==N.STATIC)P.velocity.lengthSquared()+P.angularVelocity.lengthSquared()>=2*Math.pow(P.sleepSpeedLimit,2)&&(I.wakeUpAfterNarrowphase=!0);if(P.allowSleep&&P.type===N.DYNAMIC&&P.sleepState===N.SLEEPING&&I.sleepState===N.AWAKE&&I.type!==N.STATIC)I.velocity.lengthSquared()+I.angularVelocity.lengthSquared()>=2*Math.pow(I.sleepSpeedLimit,2)&&(P.wakeUpAfterNarrowphase=!0);this.collisionMatrix.set(I,P,!0),this.collisionMatrixPrevious.get(I,P)||(ro.body=P,ro.contact=F,I.dispatchEvent(ro),ro.body=I,P.dispatchEvent(ro)),this.bodyOverlapKeeper.set(I.id,P.id),this.shapeOverlapKeeper.set(T.id,L.id)}for(this.emitContactEvents(),l&&(u.makeContactConstraints=to.now()-c,c=to.now()),m=0;m!==o;m++){var q=r[m];q.wakeUpAfterNarrowphase&&(q.wakeUp(),q.wakeUpAfterNarrowphase=!1)}for(z=v.length,m=0;m!==z;m++){var W=v[m];W.update();for(var V=0,j=W.equations.length;V!==j;V++){var Z=W.equations[V];a.addEquation(Z)}}a.solve(e,this),l&&(u.solve=to.now()-c),a.removeAllEquations();var O=Math.pow;for(m=0;m!==o;m++){var _=r[m];if(_.type&h){var H=O(1-_.linearDamping,e),D=_.velocity;D.scale(H,D);var U=_.angularVelocity;if(U){var X=O(1-_.angularDamping,e);U.scale(X,U)}}}for(this.dispatchEvent(oo),m=0;m!==o;m++){var G=r[m];G.preStep&&G.preStep.call(G)}l&&(c=to.now());var Y=this.stepnumber%(this.quatNormalizeSkip+1)===0,K=this.quatNormalizeFast;for(m=0;m!==o;m++)r[m].integrate(e,Y,K);for(this.clearForces(),this.broadphase.dirty=!0,l&&(u.integrate=to.now()-c),this.time+=e,this.stepnumber+=1,this.dispatchEvent(no),m=0;m!==o;m++){var Q=r[m],J=Q.postStep;J&&J.call(Q)}var $=!0;if(this.allowSleep)for($=!1,m=0;m!==o;m++){var ee=r[m];ee.sleepTick(this.time),ee.sleepState!==N.SLEEPING&&($=!0)}this.hasActiveBodies=$}},{key:"clearForces",value:function(){for(var e=this.bodies,t=e.length,i=0;i!==t;i++){var n=e[i];n.force,n.torque;n.force.set(0,0,0),n.torque.set(0,0,0)}}}]),i}(w),eo=(new y,new ie),to=globalThis.performance||{};if(!to.now){var io=Date.now();to.timing&&to.timing.navigationStart&&(io=to.timing.navigationStart),to.now=function(){return Date.now()-io}}var no={type:"postStep"},oo={type:"preStep"},ro={type:N.COLLIDE_EVENT_NAME,body:null,contact:null},ao=[],so=[],lo=[],uo=[];$n.prototype.emitContactEvents=function(){var e=[],t=[],i={type:"beginContact",bodyA:null,bodyB:null},n={type:"endContact",bodyA:null,bodyB:null},o={type:"beginShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null},r={type:"endShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null};return function(){var a=this.hasAnyEventListener("beginContact"),s=this.hasAnyEventListener("endContact");if((a||s)&&this.bodyOverlapKeeper.getDiff(e,t),a){for(var l=0,u=e.length;l<u;l+=2)i.bodyA=this.getBodyById(e[l]),i.bodyB=this.getBodyById(e[l+1]),this.dispatchEvent(i);i.bodyA=i.bodyB=null}if(s){for(var h=0,c=t.length;h<c;h+=2)n.bodyA=this.getBodyById(t[h]),n.bodyB=this.getBodyById(t[h+1]),this.dispatchEvent(n);n.bodyA=n.bodyB=null}e.length=t.length=0;var v=this.hasAnyEventListener("beginShapeContact"),d=this.hasAnyEventListener("endShapeContact");if((v||d)&&this.shapeOverlapKeeper.getDiff(e,t),v){for(var p=0,y=e.length;p<y;p+=2){var f=this.getShapeById(e[p]),m=this.getShapeById(e[p+1]);o.shapeA=f,o.shapeB=m,o.bodyA=f.body,o.bodyB=m.body,this.dispatchEvent(o)}o.bodyA=o.bodyB=o.shapeA=o.shapeB=null}if(d){for(var g=0,w=t.length;g<w;g+=2){var x=this.getShapeById(t[g]),b=this.getShapeById(t[g+1]);r.shapeA=x,r.shapeB=b,r.bodyA=x.body,r.bodyB=b.body,this.dispatchEvent(r)}r.bodyA=r.bodyB=r.shapeA=r.shapeB=null}}}()}}]);